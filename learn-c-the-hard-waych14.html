<html><head><title>Exercise 13: Switch 语句</title><meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="generator"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="originator"></meta><!-- index=1,2,next,fn-in,charset=utf-8,NoFonts,html --><meta content="learn-c-the-hard-way.tex" name="src"></meta><meta content="2012-04-11 10:56:00" name="date"></meta><link href="learn-c-the-hard-way.css" rel="stylesheet" type="text/css"></link></head><body>
    <!--l. 1--><div class="crosslinks"><p class="noindent">[<a>prev</a>] [<a href="#taillearn-c-the-hard-way">prev-tail</a>] [<a href="#tail">tail</a>] [<a href="# ">up</a>] </p></div>
    <h2 class="chapterHead"><span class="titlemark">Chapter 14</span><br><a id="x19-6700014"></a>Exercise 13: Switch 语句</h2>
<!--l. 3--><p class="noindent">在其他诸如 Ruby 这样的语言里，你可以在 switch   中用任何形式的语句，在另外一些像 Python 这样的语言则不提供 switch   ，因为 if   就能起到相同的作用。对这些语言来说，switch 只是将 if   换了一种写法而已，而两者的内部工作原理也是一样的。
<!--l. 8--></p><p class="indent">    而在 C 语言里，switch   是完全不一样的东西，它其实是一个“跳转表”。
你只能把结果是整数的表达式放到 switch   中，而不是随便的布尔表达式都可以，这些整数被用作和 switch 语句头部的值比较，如果两者匹配，代码就会跳到子句的位置继续运行。以下是一些我们将要来分析和理解”跳转表”概念的代码。
                                                                  

                                                                  
<!--l. 13--></p><p class="indent">    </p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<a id="x19-67001r35"></a>
<div class="caption"><span class="id">Source 35: </span><span class="content">                                                                                                            ex13.c</span></div><!--tex4ht:label?: x19-67001r35 -->
<div class="fancyvrb" id="fancyvrb16"><a id="x19-67003r1"></a>1  <span id="textcolor708">#</span><span id="textcolor709">include <stdio.h></stdio.h></span><br class="fancyvrb"><a id="x19-67005r2"></a>2  <br class="fancyvrb"><a id="x19-67007r3"></a>3  <span id="textcolor710">int</span> <span id="textcolor711">main</span>(<span id="textcolor712">int</span> argc, <span id="textcolor713">char</span> ⋆argv[])<br class="fancyvrb"><a id="x19-67009r4"></a>4  {
<br class="fancyvrb"><a id="x19-67011r5"></a>5      <span id="textcolor714">if</span>(argc != <span id="textcolor715">2</span>) {<br class="fancyvrb"><a id="x19-67013r6"></a>6          printf(<span class="colorbox" id="colorbox716"><span id="textcolor717">"</span></span><span class="colorbox" id="colorbox718"><span id="textcolor719">ERROR: You need one argument.</span></span><span class="colorbox" id="colorbox720"><span id="textcolor721">\n</span></span><span class="colorbox" id="colorbox722"><span id="textcolor723">"</span></span>);
<br class="fancyvrb"><a id="x19-67015r7"></a>7          <span id="textcolor724">// this is how you abort a program</span><br class="fancyvrb"><a id="x19-67017r8"></a>8          <span id="textcolor725">return</span> <span id="textcolor726">1</span>;
<br class="fancyvrb"><a id="x19-67019r9"></a>9      }<br class="fancyvrb"><a id="x19-67021r10"></a>10  <br class="fancyvrb"><a id="x19-67023r11"></a>11      <span id="textcolor727">int</span> i = <span id="textcolor728">0</span>;<br class="fancyvrb"><a id="x19-67025r12"></a>12      <span id="textcolor729">for</span>(i = <span id="textcolor730">0</span>; argv[<span id="textcolor731">1</span>][i] != <span class="colorbox" id="colorbox732"><span id="textcolor733">’\0’</span></span>; i++) {
<br class="fancyvrb"><a id="x19-67027r13"></a>13          <span id="textcolor734">char</span> letter = argv[<span id="textcolor735">1</span>][i];<br class="fancyvrb"><a id="x19-67029r14"></a>14  <br class="fancyvrb"><a id="x19-67031r15"></a>15          <span id="textcolor736">switch</span>(letter) {<br class="fancyvrb"><a id="x19-67033r16"></a>16              <span id="textcolor737">case</span> <span class="colorbox" id="colorbox738"><span id="textcolor739">’a’</span></span>:
<br class="fancyvrb"><a id="x19-67035r17"></a>17              <span id="textcolor740">case</span> <span class="colorbox" id="colorbox741"><span id="textcolor742">’A’</span></span>:<br class="fancyvrb"><a id="x19-67037r18"></a>18                  printf(<span class="colorbox" id="colorbox743"><span id="textcolor744">"</span></span><span class="colorbox" id="colorbox745"><span id="textcolor746">%d: ’A’</span></span><span class="colorbox" id="colorbox747"><span id="textcolor748">\n</span></span><span class="colorbox" id="colorbox749"><span id="textcolor750">"</span></span>, i);
<br class="fancyvrb"><a id="x19-67039r19"></a>19                  <span id="textcolor751">break</span>;<br class="fancyvrb"><a id="x19-67041r20"></a>20  <br class="fancyvrb"><a id="x19-67043r21"></a>21              <span id="textcolor752">case</span> <span class="colorbox" id="colorbox753"><span id="textcolor754">’e’</span></span>:<br class="fancyvrb"><a id="x19-67045r22"></a>22              <span id="textcolor755">case</span> <span class="colorbox" id="colorbox756"><span id="textcolor757">’E’</span></span>:
<br class="fancyvrb"><a id="x19-67047r23"></a>23                  printf(<span class="colorbox" id="colorbox758"><span id="textcolor759">"</span></span><span class="colorbox" id="colorbox760"><span id="textcolor761">%d: ’E’</span></span><span class="colorbox" id="colorbox762"><span id="textcolor763">\n</span></span><span class="colorbox" id="colorbox764"><span id="textcolor765">"</span></span>, i);<br class="fancyvrb"><a id="x19-67049r24"></a>24                  <span id="textcolor766">break</span>;<br class="fancyvrb"><a id="x19-67051r25"></a>25  
<br class="fancyvrb"><a id="x19-67053r26"></a>26              <span id="textcolor767">case</span> <span class="colorbox" id="colorbox768"><span id="textcolor769">’i’</span></span>:<br class="fancyvrb"><a id="x19-67055r27"></a>27              <span id="textcolor770">case</span> <span class="colorbox" id="colorbox771"><span id="textcolor772">’I’</span></span>:<br class="fancyvrb"><a id="x19-67057r28"></a>28                  printf(<span class="colorbox" id="colorbox773"><span id="textcolor774">"</span></span><span class="colorbox" id="colorbox775"><span id="textcolor776">%d: ’I’</span></span><span class="colorbox" id="colorbox777"><span id="textcolor778">\n</span></span><span class="colorbox" id="colorbox779"><span id="textcolor780">"</span></span>, i);
<br class="fancyvrb"><a id="x19-67059r29"></a>29                  <span id="textcolor781">break</span>;<br class="fancyvrb"><a id="x19-67061r30"></a>30  <br class="fancyvrb"><a id="x19-67063r31"></a>31              <span id="textcolor782">case</span> <span class="colorbox" id="colorbox783"><span id="textcolor784">’o’</span></span>:<br class="fancyvrb"><a id="x19-67065r32"></a>32              <span id="textcolor785">case</span> <span class="colorbox" id="colorbox786"><span id="textcolor787">’O’</span></span>:
<br class="fancyvrb"><a id="x19-67067r33"></a>33                  printf(<span class="colorbox" id="colorbox788"><span id="textcolor789">"</span></span><span class="colorbox" id="colorbox790"><span id="textcolor791">%d: ’O’</span></span><span class="colorbox" id="colorbox792"><span id="textcolor793">\n</span></span><span class="colorbox" id="colorbox794"><span id="textcolor795">"</span></span>, i);<br class="fancyvrb"><a id="x19-67069r34"></a>34                  <span id="textcolor796">break</span>;<br class="fancyvrb"><a id="x19-67071r35"></a>35  
<br class="fancyvrb"><a id="x19-67073r36"></a>36              <span id="textcolor797">case</span> <span class="colorbox" id="colorbox798"><span id="textcolor799">’u’</span></span>:<br class="fancyvrb"><a id="x19-67075r37"></a>37              <span id="textcolor800">case</span> <span class="colorbox" id="colorbox801"><span id="textcolor802">’U’</span></span>:<br class="fancyvrb"><a id="x19-67077r38"></a>38                  printf(<span class="colorbox" id="colorbox803"><span id="textcolor804">"</span></span><span class="colorbox" id="colorbox805"><span id="textcolor806">%d: ’U’</span></span><span class="colorbox" id="colorbox807"><span id="textcolor808">\n</span></span><span class="colorbox" id="colorbox809"><span id="textcolor810">"</span></span>, i);
<br class="fancyvrb"><a id="x19-67079r39"></a>39                  <span id="textcolor811">break</span>;<br class="fancyvrb"><a id="x19-67081r40"></a>40  <br class="fancyvrb"><a id="x19-67083r41"></a>41              <span id="textcolor812">case</span> <span class="colorbox" id="colorbox813"><span id="textcolor814">’y’</span></span>:<br class="fancyvrb"><a id="x19-67085r42"></a>42              <span id="textcolor815">case</span> <span class="colorbox" id="colorbox816"><span id="textcolor817">’Y’</span></span>:
<br class="fancyvrb"><a id="x19-67087r43"></a>43                  <span id="textcolor818">if</span>(i &gt; <span id="textcolor819">2</span>) {<br class="fancyvrb"><a id="x19-67089r44"></a>44                      <span id="textcolor820">// it’s only sometimes Y</span>
<br class="fancyvrb"><a id="x19-67091r45"></a>45                      printf(<span class="colorbox" id="colorbox821"><span id="textcolor822">"</span></span><span class="colorbox" id="colorbox823"><span id="textcolor824">%d: ’Y’</span></span><span class="colorbox" id="colorbox825"><span id="textcolor826">\n</span></span><span class="colorbox" id="colorbox827"><span id="textcolor828">"</span></span>, i);<br class="fancyvrb"><a id="x19-67093r46"></a>46                  }
<br class="fancyvrb"><a id="x19-67095r47"></a>47                  <span id="textcolor829">break</span>;<br class="fancyvrb"><a id="x19-67097r48"></a>48  <br class="fancyvrb"><a id="x19-67099r49"></a>49              <span id="textcolor830">default:</span>
<br class="fancyvrb"><a id="x19-67101r50"></a>50                  printf(<span class="colorbox" id="colorbox831"><span id="textcolor832">"</span></span><span class="colorbox" id="colorbox833"><span id="textcolor834">%d: %c is not a vowel</span></span><span class="colorbox" id="colorbox835"><span id="textcolor836">\n</span></span><span class="colorbox" id="colorbox837"><span id="textcolor838">"</span></span>, i, letter);
<br class="fancyvrb"><a id="x19-67103r51"></a>51          }<br class="fancyvrb"><a id="x19-67105r52"></a>52      }<br class="fancyvrb"><a id="x19-67107r53"></a>53  <br class="fancyvrb"><a id="x19-67109r54"></a>54      <span id="textcolor839">return</span> <span id="textcolor840">0</span>;<br class="fancyvrb"><a id="x19-67111r55"></a>55  }</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 74--><p class="indent">    在这个程序里我们从命令行参数获得一个参数，然后输出参数里所有的元音字母，
这是一个乏味的演示如何使用 switch 语句的例子。让我们来看看它是怎么工作的：
     </p><ol class="enumerate1"><li class="enumerate" id="x19-67113x1">编译器会在程序中 switch   开始的地方做一个标记，我们记这个位置为 Y。
     </li>
     <li class="enumerate" id="x19-67115x2">然后它会评估 <span class="obeylines-h"><span class="verb">switch(letter)</span></span> 表达式并从中得到一个值。在我们的例子中，这个值是命令行参数 <span class="obeylines-h"><span class="verb">argv[1]</span></span>中的某个字母对应的原始 ASCII
     码。
     </li>
     <li class="enumerate" id="x19-67117x3">编译器对于像 <span class="obeylines-h"><span class="verb">case ’A’:</span></span>这样的 case 块也会产生一个相对于位置 Y 的偏移值，这个偏移值就是’A’。所以对于在 <span class="obeylines-h"><span class="verb">case ’A’</span></span>下的代码来说，它们在程序中的位置是 Y + ’A’。
     </li>
     <li class="enumerate" id="x19-67119x4">然后它将会做数学运算来得出 Y+letter 对应于 switch 语句中的位置，
     如果得到的位置太远(即没有找到匹配的值),  它将会把这个位置值置为 Y+default。
     </li>
     <li class="enumerate" id="x19-67121x5">一旦程序知道了这个位置，就会跳转到代码中的那个点，然后继续运行。
     这就是为什么有的代码块有 break 语句而有的没有。<span class="footnote-mark"><a id="fn1x15-bk"><sup class="textsuperscript">1</sup></a></span><a id="x19-67122f1"></a>
     </li>
     <li class="enumerate" id="x19-67124x6">如果输入了’a’，那么程序将会跳转到 <span class="obeylines-h"><span class="verb">case ’a’</span></span>，这里没有 break 语句，
     所以它将会继续往下执行，进入 <span class="obeylines-h"><span class="verb">case ’A’</span></span> 代码块，那里有一些代码和 break 语句。
     </li>
     <li class="enumerate" id="x19-67126x7">最终，它会运行该代码块，碰到 break 语句，然后退出整个 switch 语句。
     </li></ol><!--l. 87--><p class="indent">    这是对 switch 语句如何工作的一个比较深入的研究，不过在实际应用时你只要记住这些简单的规则：
                                                                  

                                                                  
     </p><ol class="enumerate1"><li class="enumerate" id="x19-67128x1">每次都包含一个 defaule:分支，这样就能捕捉到任何没有预料到的输入。
     </li>
     <li class="enumerate" id="x19-67130x2">除非你真的需要，否则不要允许代码中出现”运行所有分支(fall  through)”这样的现象。如果你使用了，那就添加一个注释 <span class="obeylines-h"><span class="verb">//fallthrough</span></span>，这样其他人就知道这是你特意而为，而不是因为疏忽。
     </li>
     <li class="enumerate" id="x19-67132x3">在你写具体的分支代码之前，最好始终同时写好 case 语句和 break 语句(<span class="footnote-mark"><a id="fn2x15-bk"><sup class="textsuperscript">2</sup></a></span><a id="x19-67133f2"></a>)。
     </li>
     <li class="enumerate" id="x19-67135x4">如果可以的话，就用 if 语句来取代使用 switch 语句。</li></ol><h3 class="sectionHead"><span class="titlemark">14.1    </span> <a id="x19-6800014.1"></a>你会看到什么</h3>
<!--l. 100--><p class="noindent">下面是我如何使用这个程序的例子，同时来演示几种不同的给程序传递参数的方式。
                                                                  

                                                                  
<!--l. 101--></p><p class="indent">    </p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<a id="x19-68001r36"></a>
<div class="caption"><span class="id">Source 36: </span><span class="content">                                                                                                      ex13 的输出</span></div><!--tex4ht:label?: x19-68001r36 -->
<!--l. 102-->
<div class="lstlisting" id="listing-24"><span class="label"><a id="x19-68002r1"></a>1</span>$ make ex13 <br><span class="label"><a id="x19-68003r2"></a>2</span>cc -Wall -g    ex13.c   -o ex13 <br><span class="label"><a id="x19-68004r3"></a>3</span>$ ./ex13 <br><span class="label"><a id="x19-68005r4"></a>4</span>ERROR: You need one argument. <br><span class="label"><a id="x19-68006r5"></a>5</span>$ <br><span class="label"><a id="x19-68007r6"></a>6</span>$ ./ex13 Zed <br><span class="label"><a id="x19-68008r7"></a>7</span>0: Z is not a vowel <br><span class="label"><a id="x19-68009r8"></a>8</span>1: ’E’ <br><span class="label"><a id="x19-68010r9"></a>9</span>2: d is not a vowel <br><span class="label"><a id="x19-68011r10"></a>10</span>$ <br><span class="label"><a id="x19-68012r11"></a>11</span>$ ./ex13 Zed Shaw <br><span class="label"><a id="x19-68013r12"></a>12</span>ERROR: You need one argument. <br><span class="label"><a id="x19-68014r13"></a>13</span>$ <br><span class="label"><a id="x19-68015r14"></a>14</span>$ ./ex13 "Zed Shaw" <br><span class="label"><a id="x19-68016r15"></a>15</span>0: Z is not a vowel <br><span class="label"><a id="x19-68017r16"></a>16</span>1: ’E’ <br><span class="label"><a id="x19-68018r17"></a>17</span>2: d is not a vowel <br><span class="label"><a id="x19-68019r18"></a>18</span>3:   is not a vowel <br><span class="label"><a id="x19-68020r19"></a>19</span>4: S is not a vowel <br><span class="label"><a id="x19-68021r20"></a>20</span>5: h is not a vowel <br><span class="label"><a id="x19-68022r21"></a>21</span>6: ’A’ <br><span class="label"><a id="x19-68023r22"></a>22</span>7: w is not a vowel <br><span class="label"><a id="x19-68024r23"></a>23</span>$
</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 130--><p class="indent">    注意在代码的最开始部分，有一个 <span class="obeylines-h"><span class="verb">return 1;</span></span>语句，它可以保证在你没有提供足够的参数时退出程序。使用一个不为 0 的返回值可以通知操作系统该程序发生了错误。任何大于 0 的返回值可以被脚本和其他程序用来检查到底发生了什么。
    </p><h3 class="sectionHead"><span class="titlemark">14.2    </span> <a id="x19-6900014.2"></a>让程序出错</h3>
<!--l. 136--><p class="noindent">要破坏一个 switch 语句的正常运行是非常简单的，以下就是一些你可以把事情搞糟的方法:
     </p><ol class="enumerate1"><li class="enumerate" id="x19-69002x1">忘记 break 语句，程序将会运行两个或者更多你本不期望运行的代码块。
     </li>
     <li class="enumerate" id="x19-69004x2">忘记 default 语句，它就会默默地忽略那些你没考虑到的值。
     </li>
     <li class="enumerate" id="x19-69006x3">不小心放一个值为未预期的变量在 switch 语句中，比如一个值很怪异的 int 值。
     </li>
     <li class="enumerate" id="x19-69008x4">在 switch 语句中使用未初始化的变量。</li></ol><!--l. 144--><p class="indent">    你也可以用其他方法来使程序出错，看看你能否破坏它。
<!--l. 146--></p><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">14.3    </span> <a id="x19-7000014.3"></a>加分习题</h3>
<!--l. 147--><p class="noindent">
     </p><ol class="enumerate1"><li class="enumerate" id="x19-70002x1">写一个新程序，对字母做一些数学操作，使他们成为小写字母，然后去除 switch 中的那些多余的大写字母的分支。
     </li>
     <li class="enumerate" id="x19-70004x2">使用 <span class="obeylines-h"><span class="verb">’,’</span></span> (逗号)来初始化 for   中的 letter。
     </li>
     <li class="enumerate" id="x19-70006x3">使它能处理你使用一个 for   传递的所有参数。
     </li>
     <li class="enumerate" id="x19-70008x4">把这个 switch 表达式用 if 语句改写，你更喜欢哪一个呢？
     </li>
     <li class="enumerate" id="x19-70010x5">在’Y’ 这个分支中，我把 break 放在 if 语句外面。如果把它放在 if 语句里面会有什么影响？证明一下你的猜想是正确的。</li></ol><div class="footnotes"><!--l. 82--><p class="noindent"><span class="footnote-mark"><a id="fn1x15"><sup class="textsuperscript">1</sup></a></span>译者注：作者的意思应该是没有 break 语句的话程序将会继续执行下面的 case 语句，反之则跳出 switch 代码块。
<!--l. 94--></p><p class="noindent"><span class="footnote-mark"><a id="fn2x15"><sup class="textsuperscript">2</sup></a></span>译者注：通过这种方式能很大程序上减少遗忘 break 语句而带来的麻烦                </p></div><!--l. 1--><div class="crosslinks"><p class="noindent">[<a>prev</a>]
[<a href="#taillearn-c-the-hard-way">prev-tail</a>] [<a>front</a>] [<a href="# ">up</a>] </p></div>
<!--l. 1--><p class="indent">    <a id="tail"></a>   
</p></body></html>