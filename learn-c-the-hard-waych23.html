<html><head><title>Exercise 22: The Stack, Scope, And Globals</title><meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="generator"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="originator"></meta><!-- index=1,2,next,fn-in,charset=utf-8,NoFonts,html --><meta content="learn-c-the-hard-way.tex" name="src"></meta><meta content="2012-04-11 11:32:00" name="date"></meta><link href="learn-c-the-hard-way.css" rel="stylesheet" type="text/css"></link></head><body>
    <!--l. 1--><div class="crosslinks"><p class="noindent">[<a href="learn-c-the-hard-waych24.html">next</a>] [<a href="learn-c-the-hard-waych22.html">prev</a>] [<a href="learn-c-the-hard-waych22.html#taillearn-c-the-hard-waych22.html">prev-tail</a>] [<a href="#taillearn-c-the-hard-waych23.html">tail</a>] [<a href="learn-c-the-hard-waypa1.html#learn-c-the-hard-waych23.html">up</a>] </p></div>
    <h2 class="chapterHead"><span class="titlemark">Chapter 23</span><br><a id="x28-12700023"></a>Exercise 22: The Stack, Scope, And Globals</h2>
<!--l. 3--><p class="noindent">The concept of ”scope” seems to confuse quite a few people when they first start
programming. Originally it came from the use of the system stack (which we
lightly covered earlier) and how it was used to store temporary variables. In
this exercise, we’ll learn about scope by learning about how a stack data
structure works, and then feeding that concept back in to how modern C does
scoping.
<!--l. 10--></p><p class="indent">    The real purpose of this exercise though is to learn where the hell things live in
C. When someone doesn’t grasp the concept of scope, it’s almost always a failure in
understanding where variables are created, exist, and die. Once you know where
things are, the concept of scope becomes easier.
<!--l. 15--></p><p class="indent">    This exercise will require three files:
     </p><dl class="description"><dt class="description">
ex22.h </dt><dd class="description">A header file that sets up some external variables and some functions.
     </dd><dt class="description">
ex22.c </dt><dd class="description">Not your main like normal, but instead a source file that will become
     a object file ex22.o which will have some functions and variables in it
     defined from ex22.h.
     </dd><dt class="description">
ex22_main.c </dt><dd class="description">The actual main that will include the other two and demonstrate
     what they contain as well as other scope concepts.</dd></dl><h4 class="subsectionHead"><span class="titlemark">23.0.2    </span> <a id="x28-12800023.0.2"></a>ex22.h and ex22.c</h4>
<!--l. 28--><p class="noindent">Your first step is to create your own header file named ex22.h which defines the
functions and ”extern” variables you need:
                                                                  

                                                                  
<!--l. 31--></p><p class="indent">    <a id="x28-128001r58"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 58: </span><span class="content">                                                                                                            ex22.h</span></div><!--tex4ht:label?: x28-128001r58 -->
<div class="fancyvrb" id="fancyvrb30"><a id="x28-128003r1"></a>1  <span id="textcolor2321">#</span><span id="textcolor2322">ifndef _ex22_h</span><br class="fancyvrb"><a id="x28-128005r2"></a>2  <span id="textcolor2323">#</span><span id="textcolor2324">define _ex22_h</span><br class="fancyvrb"><a id="x28-128007r3"></a>3  
<br class="fancyvrb"><a id="x28-128009r4"></a>4  <span id="textcolor2325">// makes THE_SIZE in ex22.c available to other .c files</span><br class="fancyvrb"><a id="x28-128011r5"></a>5  <span id="textcolor2326">extern</span> <span id="textcolor2327">int</span> THE_SIZE;
<br class="fancyvrb"><a id="x28-128013r6"></a>6  <br class="fancyvrb"><a id="x28-128015r7"></a>7  <span id="textcolor2328">// gets and sets an internal static variable in ex22.c</span><br class="fancyvrb"><a id="x28-128017r8"></a>8  <span id="textcolor2329">int</span> get_age();
<br class="fancyvrb"><a id="x28-128019r9"></a>9  <span id="textcolor2330">void</span> set_age(<span id="textcolor2331">int</span> age);<br class="fancyvrb"><a id="x28-128021r10"></a>10  <br class="fancyvrb"><a id="x28-128023r11"></a>11  <span id="textcolor2332">// updates a static variable that’s inside update_ratio</span>
<br class="fancyvrb"><a id="x28-128025r12"></a>12  <span id="textcolor2333">double</span> update_ratio(<span id="textcolor2334">double</span> ratio);<br class="fancyvrb"><a id="x28-128027r13"></a>13  <br class="fancyvrb"><a id="x28-128029r14"></a>14  <span id="textcolor2335">void</span> print_size();<br class="fancyvrb"><a id="x28-128031r15"></a>15  <br class="fancyvrb"><a id="x28-128033r16"></a>16  <span id="textcolor2336">#</span><span id="textcolor2337">endif</span></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 53--><p class="indent">    The important thing to see is the use of <span class="obeylines-h"><span class="verb">extern int THE_SIZE</span></span>, which I’ll
explain after you also create the matching ex22.c:
                                                                  

                                                                  
<!--l. 56--></p><p class="indent">    <a id="x28-128034r59"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 59: </span><span class="content">                                                                                                            ex22.c</span></div><!--tex4ht:label?: x28-128034r59 -->
<div class="fancyvrb" id="fancyvrb31"><a id="x28-128036r1"></a>1  <span id="textcolor2338">#</span><span id="textcolor2339">include <stdio.h></stdio.h></span><br class="fancyvrb"><a id="x28-128038r2"></a>2  <span id="textcolor2340">#</span><span id="textcolor2341">include "ex22.h"</span><br class="fancyvrb"><a id="x28-128040r3"></a>3  <span id="textcolor2342">#</span><span id="textcolor2343">include "dbg.h"</span><br class="fancyvrb"><a id="x28-128042r4"></a>4  
<br class="fancyvrb"><a id="x28-128044r5"></a>5  <span id="textcolor2344">int</span> THE_SIZE = <span id="textcolor2345">1000</span>;<br class="fancyvrb"><a id="x28-128046r6"></a>6  <br class="fancyvrb"><a id="x28-128048r7"></a>7  <span id="textcolor2346">static</span> <span id="textcolor2347">int</span> THE_AGE = <span id="textcolor2348">37</span>;<br class="fancyvrb"><a id="x28-128050r8"></a>8  <br class="fancyvrb"><a id="x28-128052r9"></a>9  <span id="textcolor2349">int</span> <span id="textcolor2350">get_age</span>()<br class="fancyvrb"><a id="x28-128054r10"></a>10  {
<br class="fancyvrb"><a id="x28-128056r11"></a>11      <span id="textcolor2351">return</span> THE_AGE;<br class="fancyvrb"><a id="x28-128058r12"></a>12  }<br class="fancyvrb"><a id="x28-128060r13"></a>13  <br class="fancyvrb"><a id="x28-128062r14"></a>14  <span id="textcolor2352">void</span> <span id="textcolor2353">set_age</span>(<span id="textcolor2354">int</span> age)<br class="fancyvrb"><a id="x28-128064r15"></a>15  {<br class="fancyvrb"><a id="x28-128066r16"></a>16      THE_AGE = age;<br class="fancyvrb"><a id="x28-128068r17"></a>17  }<br class="fancyvrb"><a id="x28-128070r18"></a>18  <br class="fancyvrb"><a id="x28-128072r19"></a>19  
<br class="fancyvrb"><a id="x28-128074r20"></a>20  <span id="textcolor2355">double</span> <span id="textcolor2356">update_ratio</span>(<span id="textcolor2357">double</span> new_ratio)<br class="fancyvrb"><a id="x28-128076r21"></a>21  {<br class="fancyvrb"><a id="x28-128078r22"></a>22      <span id="textcolor2358">static</span> <span id="textcolor2359">double</span> ratio = <span id="textcolor2360">1.0</span>;<br class="fancyvrb"><a id="x28-128080r23"></a>23  
<br class="fancyvrb"><a id="x28-128082r24"></a>24      <span id="textcolor2361">double</span> old_ratio = ratio;<br class="fancyvrb"><a id="x28-128084r25"></a>25      ratio = new_ratio;<br class="fancyvrb"><a id="x28-128086r26"></a>26  <br class="fancyvrb"><a id="x28-128088r27"></a>27      <span id="textcolor2362">return</span> old_ratio;
<br class="fancyvrb"><a id="x28-128090r28"></a>28  }<br class="fancyvrb"><a id="x28-128092r29"></a>29  <br class="fancyvrb"><a id="x28-128094r30"></a>30  <span id="textcolor2363">void</span> <span id="textcolor2364">print_size</span>()<br class="fancyvrb"><a id="x28-128096r31"></a>31  {<br class="fancyvrb"><a id="x28-128098r32"></a>32      log_info(<span class="colorbox" id="colorbox2365"><span id="textcolor2366">"</span></span><span class="colorbox" id="colorbox2367"><span id="textcolor2368">I think size is: %d</span></span><span class="colorbox" id="colorbox2369"><span id="textcolor2370">"</span></span>, THE_SIZE);<br class="fancyvrb"><a id="x28-128100r33"></a>33  }</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 95--><p class="indent">    These two files introduce some new kinds of storage for variables:
     </p><dl class="description"><dt class="description">
extern </dt><dd class="description">This  keyword  is  a  way  to  tell  the  compiler  ”the  variable  exists,  but
     it’s in another ’external’ location”. Typically this means that one .c file is
     going to use a variable that’s been defined in another .c file. In this case,
     we’re saying ex22.c has a variable THE_SIZE that will be accessed from
     ex22_main.c.
     </dd><dt class="description">
static (file) </dt><dd class="description">This keyword is kind of the inverse of extern and says that the
     variable is only used in this .c file, and should not be available to other
     parts of the program. Keep in mind that static at the file level (as with
     THE_AGE here) is different than in other places.
     </dd><dt class="description">
static (function) </dt><dd class="description">If  you  declare  a  variable  in  a  function  static,  then  that
     variable acts like a static defined in the file, but it’s only accessible from
     that function. It’s a way of creating constant state for a function, but in
     reality it’s rarely used in modern C programming because they are hard
     to use with threads.</dd></dl><!--l. 114--><p class="indent">    In these two files then, you have the following variables and functions that you
should understand:
     </p><dl class="description"><dt class="description">
THE_SIZE </dt><dd class="description">This  is  the  variable  you  declared  extern that  you’ll  play  with
     from ex22_main.c.
     </dd><dt class="description">
get_age and set_age </dt><dd class="description">These   are   taking   the   static   variable   THE_AGE,   but
     exposing it to other parts of the program through functions. You couldn’t
     access THE_AGE directly, but these functions can.
     </dd><dt class="description">
update_ratio </dt><dd class="description">This takes a new ratio value, and returns the old one. It uses
     a  function  level  static  variable  ratio to  keep  track  of  what  the  ratio
                                                                  

                                                                  
     currently is.
     </dd><dt class="description">
print_size </dt><dd class="description">Prints out what ex22.c thinks THE_SIZE is currently.</dd></dl><h4 class="subsectionHead"><span class="titlemark">23.0.3    </span> <a id="x28-12900023.0.3"></a>ex22_main.c</h4>
<!--l. 132--><p class="noindent">Once you have that file written, you can then make the main function which uses all
of these and demonstrates some more scope conventions:
                                                                  

                                                                  
<!--l. 135--></p><p class="indent">    <a id="x28-129001r60"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 60: </span><span class="content">                                                                                                  ex22_main.c</span></div><!--tex4ht:label?: x28-129001r60 -->
<div class="fancyvrb" id="fancyvrb32"><a id="x28-129003r1"></a>1  <span id="textcolor2371">#</span><span id="textcolor2372">include "ex22.h"</span><br class="fancyvrb"><a id="x28-129005r2"></a>2  <span id="textcolor2373">#</span><span id="textcolor2374">include "dbg.h"</span><br class="fancyvrb"><a id="x28-129007r3"></a>3  <br class="fancyvrb"><a id="x28-129009r4"></a>4  <span id="textcolor2375">const</span> <span id="textcolor2376">char</span> ⋆MY_NAME = <span class="colorbox" id="colorbox2377"><span id="textcolor2378">"</span></span><span class="colorbox" id="colorbox2379"><span id="textcolor2380">Zed A. Shaw</span></span><span class="colorbox" id="colorbox2381"><span id="textcolor2382">"</span></span>;
<br class="fancyvrb"><a id="x28-129011r5"></a>5  <br class="fancyvrb"><a id="x28-129013r6"></a>6  <span id="textcolor2383">void</span> <span id="textcolor2384">scope_demo</span>(<span id="textcolor2385">int</span> count)<br class="fancyvrb"><a id="x28-129015r7"></a>7  {<br class="fancyvrb"><a id="x28-129017r8"></a>8      log_info(<span class="colorbox" id="colorbox2386"><span id="textcolor2387">"</span></span><span class="colorbox" id="colorbox2388"><span id="textcolor2389">count is: %d</span></span><span class="colorbox" id="colorbox2390"><span id="textcolor2391">"</span></span>, count);
<br class="fancyvrb"><a id="x28-129019r9"></a>9  <br class="fancyvrb"><a id="x28-129021r10"></a>10      <span id="textcolor2392">if</span>(count &gt; <span id="textcolor2393">10</span>) {<br class="fancyvrb"><a id="x28-129023r11"></a>11          <span id="textcolor2394">int</span> count = <span id="textcolor2395">100</span>;  <span id="textcolor2396">// BAD! BUGS!</span><br class="fancyvrb"><a id="x28-129025r12"></a>12  
<br class="fancyvrb"><a id="x28-129027r13"></a>13          log_info(<span class="colorbox" id="colorbox2397"><span id="textcolor2398">"</span></span><span class="colorbox" id="colorbox2399"><span id="textcolor2400">count in this scope is %d</span></span><span class="colorbox" id="colorbox2401"><span id="textcolor2402">"</span></span>, count);<br class="fancyvrb"><a id="x28-129029r14"></a>14      }<br class="fancyvrb"><a id="x28-129031r15"></a>15  
<br class="fancyvrb"><a id="x28-129033r16"></a>16      log_info(<span class="colorbox" id="colorbox2403"><span id="textcolor2404">"</span></span><span class="colorbox" id="colorbox2405"><span id="textcolor2406">count is at exit: %d</span></span><span class="colorbox" id="colorbox2407"><span id="textcolor2408">"</span></span>, count);<br class="fancyvrb"><a id="x28-129035r17"></a>17  <br class="fancyvrb"><a id="x28-129037r18"></a>18      count = <span id="textcolor2409">3000</span>;
<br class="fancyvrb"><a id="x28-129039r19"></a>19  <br class="fancyvrb"><a id="x28-129041r20"></a>20      log_info(<span class="colorbox" id="colorbox2410"><span id="textcolor2411">"</span></span><span class="colorbox" id="colorbox2412"><span id="textcolor2413">count after assign: %d</span></span><span class="colorbox" id="colorbox2414"><span id="textcolor2415">"</span></span>, count);<br class="fancyvrb"><a id="x28-129043r21"></a>21  }<br class="fancyvrb"><a id="x28-129045r22"></a>22  
<br class="fancyvrb"><a id="x28-129047r23"></a>23  <span id="textcolor2416">int</span> <span id="textcolor2417">main</span>(<span id="textcolor2418">int</span> argc, <span id="textcolor2419">char</span> ⋆argv[])<br class="fancyvrb"><a id="x28-129049r24"></a>24  {<br class="fancyvrb"><a id="x28-129051r25"></a>25      <span id="textcolor2420">// test out THE_AGE accessors</span>
<br class="fancyvrb"><a id="x28-129053r26"></a>26      log_info(<span class="colorbox" id="colorbox2421"><span id="textcolor2422">"</span></span><span class="colorbox" id="colorbox2423"><span id="textcolor2424">My name: %s, age: %d</span></span><span class="colorbox" id="colorbox2425"><span id="textcolor2426">"</span></span>, MY_NAME, get_age());<br class="fancyvrb"><a id="x28-129055r27"></a>27  <br class="fancyvrb"><a id="x28-129057r28"></a>28      set_age(<span id="textcolor2427">100</span>);<br class="fancyvrb"><a id="x28-129059r29"></a>29  
<br class="fancyvrb"><a id="x28-129061r30"></a>30      log_info(<span class="colorbox" id="colorbox2428"><span id="textcolor2429">"</span></span><span class="colorbox" id="colorbox2430"><span id="textcolor2431">My age is now: %d</span></span><span class="colorbox" id="colorbox2432"><span id="textcolor2433">"</span></span>, get_age());<br class="fancyvrb"><a id="x28-129063r31"></a>31  <br class="fancyvrb"><a id="x28-129065r32"></a>32      <span id="textcolor2434">// test out THE_SIZE extern</span>
<br class="fancyvrb"><a id="x28-129067r33"></a>33      log_info(<span class="colorbox" id="colorbox2435"><span id="textcolor2436">"</span></span><span class="colorbox" id="colorbox2437"><span id="textcolor2438">THE_SIZE is: %d</span></span><span class="colorbox" id="colorbox2439"><span id="textcolor2440">"</span></span>, THE_SIZE);<br class="fancyvrb"><a id="x28-129069r34"></a>34      print_size();<br class="fancyvrb"><a id="x28-129071r35"></a>35  
<br class="fancyvrb"><a id="x28-129073r36"></a>36      THE_SIZE = <span id="textcolor2441">9</span>;<br class="fancyvrb"><a id="x28-129075r37"></a>37  <br class="fancyvrb"><a id="x28-129077r38"></a>38      log_info(<span class="colorbox" id="colorbox2442"><span id="textcolor2443">"</span></span><span class="colorbox" id="colorbox2444"><span id="textcolor2445">THE SIZE is now: %d</span></span><span class="colorbox" id="colorbox2446"><span id="textcolor2447">"</span></span>, THE_SIZE);
<br class="fancyvrb"><a id="x28-129079r39"></a>39      print_size();<br class="fancyvrb"><a id="x28-129081r40"></a>40  <br class="fancyvrb"><a id="x28-129083r41"></a>41      <span id="textcolor2448">// test the ratio function static</span>
<br class="fancyvrb"><a id="x28-129085r42"></a>42      log_info(<span class="colorbox" id="colorbox2449"><span id="textcolor2450">"</span></span><span class="colorbox" id="colorbox2451"><span id="textcolor2452">Ratio at first: %f</span></span><span class="colorbox" id="colorbox2453"><span id="textcolor2454">"</span></span>, update_ratio(<span id="textcolor2455">2.0</span>));
<br class="fancyvrb"><a id="x28-129087r43"></a>43      log_info(<span class="colorbox" id="colorbox2456"><span id="textcolor2457">"</span></span><span class="colorbox" id="colorbox2458"><span id="textcolor2459">Ratio again: %f</span></span><span class="colorbox" id="colorbox2460"><span id="textcolor2461">"</span></span>, update_ratio(<span id="textcolor2462">10.0</span>));
<br class="fancyvrb"><a id="x28-129089r44"></a>44      log_info(<span class="colorbox" id="colorbox2463"><span id="textcolor2464">"</span></span><span class="colorbox" id="colorbox2465"><span id="textcolor2466">Ratio once more: %f</span></span><span class="colorbox" id="colorbox2467"><span id="textcolor2468">"</span></span>, update_ratio(<span id="textcolor2469">300.0</span>));<br class="fancyvrb"><a id="x28-129091r45"></a>45  <br class="fancyvrb"><a id="x28-129093r46"></a>46      <span id="textcolor2470">// test the scope demo</span>
<br class="fancyvrb"><a id="x28-129095r47"></a>47      <span id="textcolor2471">int</span> count = <span id="textcolor2472">4</span>;<br class="fancyvrb"><a id="x28-129097r48"></a>48      scope_demo(count);<br class="fancyvrb"><a id="x28-129099r49"></a>49      scope_demo(count ⋆ <span id="textcolor2473">20</span>);<br class="fancyvrb"><a id="x28-129101r50"></a>50  
<br class="fancyvrb"><a id="x28-129103r51"></a>51      log_info(<span class="colorbox" id="colorbox2474"><span id="textcolor2475">"</span></span><span class="colorbox" id="colorbox2476"><span id="textcolor2477">count after calling scope_demo: %d</span></span><span class="colorbox" id="colorbox2478"><span id="textcolor2479">"</span></span>, count);<br class="fancyvrb"><a id="x28-129105r52"></a>52  <br class="fancyvrb"><a id="x28-129107r53"></a>53      <span id="textcolor2480">return</span> <span id="textcolor2481">0</span>;<br class="fancyvrb"><a id="x28-129109r54"></a>54  }</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 195--><p class="indent">    I’ll break this file down line-by-line, and as I do you should find each variable I
mention and where it lives.
     </p><dl class="description"><dt class="description">
ex22_main.c:4 </dt><dd class="description">Making a const which stands for constant and is an alternative
     to using a define to create a constant variable.
     </dd><dt class="description">
ex22_main.c:6 </dt><dd class="description">A  simple  function  that  demonstrates  more  scope  issues  in  a
     function.
     </dd><dt class="description">
ex22_main.c:8 </dt><dd class="description">Prints out the value of count as it is at the top of the function.
     </dd><dt class="description">
ex22_main.c:10 </dt><dd class="description">An if-statement that starts a new scope block, and then has
     another count variable in it. This version of count is actually a whole
     new variable. It’s kind of like the if-statement started a new ”mini
     function”.
     </dd><dt class="description">
ex22_main.c:11 </dt><dd class="description">The count that is local to this block is actually different from
     the  one  in  the  function’s  parameter  list.  What  what  happens  as  we
     continue.
     </dd><dt class="description">
ex22_main.c:13 </dt><dd class="description">Prints it out so you can see it’s actually 100 here, not what was
     passed to scope_demo.
     </dd><dt class="description">
ex22_main.c:16 </dt><dd class="description">Now  for  the  freaky  part.  You  have  count in  two  places:
     the   parameters   to   this   function,   and   in   the   if-statement.   The
     if-statement created a new block, so the count on line 11 does not
     impact the parameter with the same name. This line prints it out and you’ll
     see that it prints the value of the parameter, not 100.
     </dd><dt class="description">
ex22_main.c:18-20 </dt><dd class="description">Then I set the parameter count to 3000 and print that out,
                                                                  

                                                                  
     which  will  demonstrate  that  you  can  change  function  parameters  and
     they don’t impact the caller’s version of the variable.</dd></dl><!--l. 223--><p class="indent">    Make sure you trace through this function, but don’t think that you
understand scope quite yet. Just start to realize that if you make a variable inside a
block (as in if-statements or while-loops), then those variables are
new variables that exist only in that block. This is crucial to understand,
and is also a source of many bugs. We’ll address why you shouldn’t do this
shortly.
<!--l. 230--></p><p class="indent">    The rest of the ex22_main.c then demonstrates all of these by manipulating
and printing them out:
     </p><dl class="description"><dt class="description">
ex22_main.c:26 </dt><dd class="description">Prints out the current values of MY_NAME and gets THE_AGE
     from ex22.c using the accessor function get_age.
     </dd><dt class="description">
ex22_main.c:27-30 </dt><dd class="description">Uses  set_age in  ex22.c to  change  THE_AGE and  then
     print it out.
     </dd><dt class="description">
ex22_main.c:33-39 </dt><dd class="description">Then I do the same thing to THE_SIZE from ex22.c, but
     this time I’m accessing it directly, and also demonstrating that it’s actually
     changing in that file by printing it here and with print_size.
     </dd><dt class="description">
ex22_main.c:42-44 </dt><dd class="description">Show      how      the      static      variable      ratio  inside
     update_ratio is maintained between function calls.
     </dd><dt class="description">
ex22_main.c:46-51 </dt><dd class="description">Finally running scope_demo a few times so you can see
     the scope in action. Big thing to notice is that the local count variable
     remains unchanged. You must get that passing in a variable like this will
     not let you change it in the function. To do that you need our old friend
     the pointer. If you were to pass a pointer to this count, then the called
     function has the address of it and can change it.</dd></dl><!--l. 252--><p class="indent">    That explains what’s going on in all of these files, but you should trace
                                                                  

                                                                  
through them and make sure you know where everything is as you study
it.
    </p><h3 class="sectionHead"><span class="titlemark">23.1    </span> <a id="x28-13000023.1"></a>What You Should See</h3>
<!--l. 257--><p class="noindent">This time, instead of using your Makefile I want you to build these two files
manually so you can see how they are actually put together by the compiler. Here’s
what you should do and what you should see for output.
                                                                  

                                                                  
<!--l. 261--></p><p class="indent">    <a id="x28-130001r61"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 61: </span><span class="content">                                                                                                               ex22
output</span></div><!--tex4ht:label?: x28-130001r61 -->
<!--l. 262-->
<div class="lstlisting" id="listing-40"><span class="label"><a id="x28-130002r1"></a>1</span>$ cc -Wall -g -DNDEBUG   -c -o ex22.o ex22.c <br><span class="label"><a id="x28-130003r2"></a>2</span>$ cc -Wall -g -DNDEBUG    ex22_main.c ex22.o   -o ex22_main <br><span class="label"><a id="x28-130004r3"></a>3</span>$ ./ex22_main <br><span class="label"><a id="x28-130005r4"></a>4</span>[INFO] (ex22_main.c:26) My name: Zed A. Shaw, age: 37 <br><span class="label"><a id="x28-130006r5"></a>5</span>[INFO] (ex22_main.c:30) My age is now: 100 <br><span class="label"><a id="x28-130007r6"></a>6</span>[INFO] (ex22_main.c:33) THE_SIZE is: 1000 <br><span class="label"><a id="x28-130008r7"></a>7</span>[INFO] (ex22.c:32) I think size is: 1000 <br><span class="label"><a id="x28-130009r8"></a>8</span>[INFO] (ex22_main.c:38) THE SIZE is now: 9 <br><span class="label"><a id="x28-130010r9"></a>9</span>[INFO] (ex22.c:32) I think size is: 9 <br><span class="label"><a id="x28-130011r10"></a>10</span>[INFO] (ex22_main.c:42) Ratio at first: 1.000000 <br><span class="label"><a id="x28-130012r11"></a>11</span>[INFO] (ex22_main.c:43) Ratio again: 2.000000 <br><span class="label"><a id="x28-130013r12"></a>12</span>[INFO] (ex22_main.c:44) Ratio once more: 10.000000 <br><span class="label"><a id="x28-130014r13"></a>13</span>[INFO] (ex22_main.c:8) count is: 4 <br><span class="label"><a id="x28-130015r14"></a>14</span>[INFO] (ex22_main.c:16) count is at exit: 4 <br><span class="label"><a id="x28-130016r15"></a>15</span>[INFO] (ex22_main.c:20) count after assign: 3000 <br><span class="label"><a id="x28-130017r16"></a>16</span>[INFO] (ex22_main.c:8) count is: 80 <br><span class="label"><a id="x28-130018r17"></a>17</span>[INFO] (ex22_main.c:13) count in this scope is 100 <br><span class="label"><a id="x28-130019r18"></a>18</span>[INFO] (ex22_main.c:16) count is at exit: 80 <br><span class="label"><a id="x28-130020r19"></a>19</span>[INFO] (ex22_main.c:20) count after assign: 3000 <br><span class="label"><a id="x28-130021r20"></a>20</span>[INFO] (ex22_main.c:51) count after calling scope_demo: 4
</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 287--><p class="indent">    Make sure you trace how each variable is changing and match it to the line that
gets output. I’m using log_info from the dbg.h macros so you can get the
exact line number where each variable is printed and find it in the files for
tracing.
    </p><h3 class="sectionHead"><span class="titlemark">23.2    </span> <a id="x28-13100023.2"></a>Scope, Stack, And Bugs</h3>
<!--l. 294--><p class="noindent">If you’ve done this right you should now see many of the different ways you can
place variables in your C code. You can use extern or access functions like
get_age to create globals. You can make new variables inside any blocks, and
they’ll retain their own values until that block exits, leaving the outer variables
alone. You also can pass a value to a function, and change the parameter but not
change the caller’s version of it.
<!--l. 302--></p><p class="indent">    The most important thing to realize though is that all of this causes bugs. C’s
ability to place things in many places in your machine and then let you access
it in those places means you get confused easily about where something
lives. If you don’t where it lives then there’s a chance you’ll not manage it
properly.
<!--l. 308--></p><p class="indent">    With that in mind, here’s some rules to follow when writing C code so you
avoid bugs related to the stack:
<!--l. 311--></p><p class="indent">
     </p><ol class="enumerate1"><li class="enumerate" id="x28-131002x1">Do   not   ”shadow”   a   variable   like   I’ve   done   here   with   count in
     scope_demo. It leaves you open to subtle and hidden bugs where you
     think you’re changing a value and you actually aren’t.
     </li>
     <li class="enumerate" id="x28-131004x2">Avoid too many globals, especially if across multiple files. If you have
     to then use accessor functions like I’ve done with get_age. This doesn’t
     apply to constants, since those are read-only. I’m talking about variables
                                                                  

                                                                  
     like  THE_SIZE.  If  you  want  people  to  modify  or  set  this,  then  make
     accessor functions.
     </li>
     <li class="enumerate" id="x28-131006x3">When in doubt, put it on the heap. Don’t rely on the semantics of the
     stack or specialized locations and instead just create things with malloc.
     </li>
     <li class="enumerate" id="x28-131008x4">Don’t use function static variables like I did in update_ratio. They’re
     rarely useful and end up being a huge pain when you need to make your
     code concurrent in threads. They are also hard as hell to find compared
     to a well done global variable.
     </li>
     <li class="enumerate" id="x28-131010x5">Avoid reusing function parameters as it’s confusing whether you’re just
     reusing it or if you think you’re changing the caller’s version of it.</li></ol><!--l. 332--><p class="indent">    As with all things, these rules can be broken when it’s practical. In fact, I
guarantee you’ll run into code that breaks all of these rules and is perfectly fine. The
constraints of different platforms makes it necessary sometimes.
<!--l. 336--></p><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">23.3    </span> <a id="x28-13200023.3"></a>How To Break It</h3>
<!--l. 338--><p class="noindent">For this exercise, breaking the program involves trying to access or change things
you can’t:
<!--l. 341--></p><p class="indent">
     </p><ol class="enumerate1"><li class="enumerate" id="x28-132002x1">Try  to  directly  access  variables  in  ex22.c from  ex22_main.c that
     you  think  you  can’t.  For  example,  you  can’t  get  at  ratio inside
     update_ratio? What if you had a pointer to it?
     </li>
     <li class="enumerate" id="x28-132004x2">Ditch the extern declaration in ex22.h to see what you get for errors
     or warnings.
                                                                  

                                                                  
     </li>
     <li class="enumerate" id="x28-132006x3">Add static or const specifiers to different variables and then try to
     change them.</li></ol><!--l. 352--><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">23.4    </span> <a id="x28-13300023.4"></a>Extra Credit</h3>
<!--l. 354--><p class="noindent">
     </p><ol class="enumerate1"><li class="enumerate" id="x28-133002x1">Research the concept of ”pass by value” vs. ”pass by reference”. Write an
     example of both.
     </li>
     <li class="enumerate" id="x28-133004x2">Use pointers to gain access to things you shouldn’t have access to.
     </li>
     <li class="enumerate" id="x28-133006x3">Use valgrind to see what this kind of access looks like when you do it
     wrong.
     </li>
     <li class="enumerate" id="x28-133008x4">Write  a  recursive  function  that  causes  a  stack  overflow.  Don’t  know
     what a recursive function is? Try calling scope_demo at the bottom of
     scope_demo itself so that it loops.
     </li>
     <li class="enumerate" id="x28-133010x5">Rewrite the Makefile so that it can build this.</li></ol><!--l. 1--><p class="noindent">﻿<!--l. 1--></p><div class="crosslinks"><p class="noindent">[<a href="learn-c-the-hard-waych24.html">next</a>] [<a href="learn-c-the-hard-waych22.html">prev</a>] [<a href="learn-c-the-hard-waych22.html#taillearn-c-the-hard-waych22.html">prev-tail</a>] [<a href="learn-c-the-hard-waych23.html">front</a>] [<a href="learn-c-the-hard-waypa1.html#learn-c-the-hard-waych23.html">up</a>] </p></div>
<!--l. 1--><p class="indent">    <a id="taillearn-c-the-hard-waych23.html"></a>   
</p></body></html>