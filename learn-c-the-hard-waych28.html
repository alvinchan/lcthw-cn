<html><head><title>习题27: 创造性与防御性编程</title><meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="generator"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="originator"></meta><!-- index=1,2,next,fn-in,charset=utf-8,NoFonts,html --><meta content="learn-c-the-hard-way.tex" name="src"></meta><meta content="2012-04-11 11:32:00" name="date"></meta><link href="learn-c-the-hard-way.css" rel="stylesheet" type="text/css"></link></head><body>
    <!--l. 1--><div class="crosslinks"><p class="noindent">[<a href="learn-c-the-hard-waych29.html">next</a>] [<a href="learn-c-the-hard-waypa2.html">prev</a>] [<a href="learn-c-the-hard-waypa2.html#taillearn-c-the-hard-waypa2.html">prev-tail</a>] [<a href="#taillearn-c-the-hard-waych28.html">tail</a>] [<a href="learn-c-the-hard-waypa2.html#learn-c-the-hard-waych28.html">up</a>] </p></div>
                                                                  

                                                                  
    <h2 class="chapterHead"><span class="titlemark">Chapter 28</span><br><a id="x34-16700028"></a>习题27: 创造性与防御性编程</h2>
<!--l. 3--><p class="noindent">You have now learned most of the basics of C programming and are ready to start
becoming a serious programmer. This is where you go from beginner to expert, both
with C and hopefully with core computer science concepts. I will be teaching you
a few of the core data structures and algorithms that every programmer
should know, and then a few very interesting ones I’ve used in real software
for years. 你已经学习了大部分 C 语言编程的基础知识，已经可以开始做一个真正的程序员了。这正是你从入门到专家的起点，依靠 C 还有计算机科学的核心概念。我会传教你一些每个程序员都应该知道的关键的数据结构和算法，然后就是一些我在这些年实际软件编程中觉得有意思的东西。
<!--l. 11--></p><p class="indent">    Before I can do that I have to teach you some basic skills and ideas that will help
you make better software. Exercises 27 through 31 will teach you advanced concepts
and feature more talking than code, but after those you’ll apply what you learn to
making a core library of useful data structures. 在开始之前，我不得不先教一些基础的技巧和思想，可以帮助你更好的编程。习题 27 到 32 会通过较多的文字稍少的代码来教你一些高级的概念和特性，但在这之后，你应该用你所学去做一个有用的数据结构的核心库。
<!--l. 18--></p><p class="indent">    The first step in getting better at writing C code (and really any language) is to
learn a new mindset called ”defensive programming”. Defensive programming
assumes that you are going to make many mistakes and then attempts to prevent
them at every possible step. In this exercise I’m going to teach you how to think
about programming defensively. 要写出更好的 C 代码（任何语言），第一步就是要学习一种叫做“防御性编程”的思维模式。防御性编程是设想你会出很多错误而且你应该在任何可能的步骤中尝试阻止错误发生。在本次习题中，我将教给你如何去思考防御性的编程。
    </p><h3 class="sectionHead"><span class="titlemark">28.1    </span> <a id="x34-16800028.1"></a>The Creative Programmer Mindset</h3>
<!--l. 28--><p class="noindent">It’s not possible to tell you how to be creative in a short exercise like this, but I will
tell you that creativity involves taking risks and being open minded. Fear will
quickly kill creativity, so the mindset I adopt, and many programmers adopt on,
accident is designed to make me unafraid of taking chances and looking like an
                                                                  

                                                                  
idiot: 在这样一个简短的练习中不可能叫你富有创造性，但是我会告诉你创造力包含了冒风险与发散思维。害怕失败或者出错会扼杀创造力，所以我采用的思维模式也是大多数程序员采取的思维模式就是事故或者失误的发生就是为了让我不惧风险并且看起来像个白痴：
<!--l. 37--></p><p class="indent">
     </p><ol class="enumerate1"><li class="enumerate" id="x34-168002x1">我一个错误也不会有。
     </li>
     <li class="enumerate" id="x34-168004x2">无所谓大家怎么在想。
     </li>
     <li class="enumerate" id="x34-168006x3">所有我脑海中的点子都是伟大的。</li></ol><!--l. 43--><p class="indent">    I only adopt this mindset temporarily, and even have little tricks to turn it on. By
doing this I can come up with ideas, find creative solutions, open my thoughts to
odd connections, and just generally invent weirdness without fear. In this mindset I
will typically write a horrible first version of something just to get the idea out. 我是暂时这么想，而且是有技巧的让自己这么想。通过这样做，我可以让自己思维迸发，
找到创新的解决方法，触类旁通毫无畏惧大胆思考。在这种思维模式下，
我会很典型的写出一些糟糕的初版代码，只是为了将自己的想法表达出来。
<!--l. 51--></p><p class="indent">    However, when I’ve finished my creative prototype I will throw it out and get
serious about making it solid. Where other people make a mistake is carrying the
creative mindset into their implementation phase. This then leads to a very different
destructive mindset that is the dark side of the creative mindset: 然而，当我完成了创新的原型我会丢掉这种心态开始认真的将它充实起来。而其他人会错误的将这种创造性思维模式带入到实现阶段。这会导致一种破坏性的心态，这是创新性思维模式的黑暗面：
<!--l. 59--></p><p class="indent">
     </p><ol class="enumerate1"><li class="enumerate" id="x34-168008x1">写出完美的软件是有可能的。
     </li>
     <li class="enumerate" id="x34-168010x2">My brain tells me the truth, and it can’t find any errors, therefore I have
                                                                  

                                                                  
     written perfect software.我的大脑总是正确的，既然我没发现任何错误，
     那么我所写的就是完美的软件。
     </li>
     <li class="enumerate" id="x34-168012x3">My code is who I am and people who criticize its perfection are criticizing
     me.代码如人，批评我代码完美的人就是在批评我。</li></ol><!--l. 65--><p class="indent">    These are lies. You will frequently run into programmers who feel intense
pride about what they’ve created, which is natural, but this pride gets in
the way of their ability to objectively improve their craft. Because of pride
and attachment to what they’ve written, they can continue to believe that
what they write is perfect. As long as they ignore other people’s criticism of
their code they can protect their fragile ego and never improve. 这些都是谎言。你会经常遇到一些程序员对他们所创造的东西感到强烈的自豪，这很正常，但是这种自豪感阻碍了他们客观的提高自己手艺的能力。因为骄傲以及他们已经取得的成绩，他们一直相信他们写的代码是完美的。只要忽视了别人对他们代码的批评，他们就能保护脆弱的自我并且不再进步。
<!--l. 73--></p><p class="indent">    The trick to being creative and making solid software is to also be able to adopt a
defensive programming mindset. 让自己富有创造力并写出扎实的软件的技巧也能够使用防御性编程的思维模式。
<!--l. 77--></p><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">28.2    </span> <a id="x34-16900028.2"></a>The Defensive Programmer Mindset 防御性编程思维模式</h3>
<!--l. 79--><p class="noindent">After you have a working creative prototype and you’re feeling good about the idea,
it’s time to switch to being a defensive programmer. The defensive programmer
basically hates your code and believes these things: 在你已经有了一个可以工作的创新性的原型并且你对这个主意感觉良好的时候，就到了该切换成一名防御性的程序员的时候了。防御性程序员基本上是讨厌你的代码并且深信以下几点：
<!--l. 85--></p><p class="indent">
                                                                  

                                                                  
     </p><ol class="enumerate1"><li class="enumerate" id="x34-169002x1">Software has errors. 软件会出错。
     </li>
     <li class="enumerate" id="x34-169004x2">You are not your software, yet you are are responsible for the errors.人不代表代码，但是你要对代码出错负责。
     </li>
     <li class="enumerate" id="x34-169006x3">You can never remove the errors, only reduce their probability. 你不可能消除错误，只能降低发生的概率。</li></ol><!--l. 91--><p class="indent">    This mindset lets you be honest about your work and critically analyze it for
improvements. Notice that it doesn’t say you are full of errors? It says your code is
full of errors. This is a significant thing to understand because it gives you the power
of objectivity for the next implementation. 这种思维模式让你诚实对待自己的工作并且能够批判性的分析进而改进。注意这不是说你充满错误，而是说的是你的代码代码充满错误。明白这一点非常的重要，因为它给了你接下来的实现以客观的力量。
<!--l. 98--></p><p class="indent">    Just like the creative mindset, the defensive programming mindset has a dark
side as well. The defensive programmer is a paranoid who is afraid of everything,
and this fear prevents them from possibly being wrong or making mistakes.
That’s great when you are trying to be ruthlessly consistent and correct, but
it is murder on creative energy and concentration. 如同创造性的思维模式，防御性编程的思维模式也有其阴暗面。防御性编程者是一个处处担心的偏执狂，这种担心使得他们可以免于出错或者失误。当你需要绝对的统一以及保证正确的时候，这样做很好，但是它会扼杀创造力和专注力。
<!--l. 107--></p><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">28.3    </span> <a id="x34-17000028.3"></a>八个防御性编程的策略</h3>
<!--l. 109--><p class="noindent">Once you’ve adopted this mindset, you can then rewrite your prototype and follow a
set of eight strategies I use to make my code as solid as I can. While I work on the
”real” version I ruthlessly follow these strategies and try to remove as many errors
                                                                  

                                                                  
as I can, thinking like someone who wants to break the software. 一旦你采用了这种思维模式，你就可以遵循我常用的这八个策略来重写你的原型使其更加的充实。当我在完成这个“真实”版本的时候，我会一边严格的遵循这些策略并且尽可能的减少错误，一边幻想有人在试图突破这个软件。
     </p><dl class="description"><dt class="description">
从不信任输入 </dt><dd class="description">Never trust the data you are given and always validate it.从不信任得到的数据，并且总是进行验证。
     </dd><dt class="description">
预防错误 </dt><dd class="description">If an error is possible, no matter how probable, try to prevent it.如果有可能出错，就算可能性再小，也要试图预防。
     </dd><dt class="description">
出错要尽早且有错误输出 </dt><dd class="description">Fail      early,      cleanly,      and      openly,      stating
     what happened, where and how to fix it.较早的凸显错误，出错信息要清晰开放，表明出了什么错，在哪里出错以及如何修正。
     </dd><dt class="description">
前提建档 </dt><dd class="description">Clearly state the pre-conditions, post-conditions, and invariants.清晰的记录前提条件，后置条件以及不变量。
     </dd><dt class="description">
靠预防措施不靠文档说明 </dt><dd class="description">Do  not  do  with  documentation,  that  which  can  be
     done with code or avoided completely.可以完全用代码解决或者避免的问题就不用靠文档去做说明。
     </dd><dt class="description">
自动化 </dt><dd class="description">全部自动化，尤其是测试。
     </dd><dt class="description">
简洁明了 </dt><dd class="description">Always simplify the code to the smallest, cleanest form that works
     without sacrificing safety.要在不牺牲安全性的前提下简化代码到最精简最整洁形式。
     </dd><dt class="description">
质疑权威 </dt><dd class="description">Do not blindly follow or reject rules. 不要盲从或者盲目排斥任何规则。</dd></dl><!--l. 128--><p class="indent">    These aren’t the only ones, but they’re the core things I feel programmers have
to focus on when trying to make good solid code. Notice that I don’t really say
exactly how to do these. I’ll go into each of these in more detail, and some of the
exercises actually cover them extensively. 这些不是全部，但是这些是我觉得程序员在试图写出扎实代码时必须要关注的核心策略。需要注意我并没有详细说出如何去做。我会更详细的介绍每一个，并且有一些练习题很好的覆盖了这些策略。
<!--l. 135--></p><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">28.4    </span> <a id="x34-17100028.4"></a>Applying The Eight Strategies 应用八大策略</h3>
<!--l. 137--><p class="noindent">I’ll now go through each of the eight strategies and give some basic advice and
examples on how to use them in real code. This will help you understand these
better since they may be vague or misinterpreted. 现在我就依次介绍这八个策略，就如何在实战中使用给出简单建议和例子。这样会让你加深理解，因为这几点可能不太明确或被误解。
<!--l. 141--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">28.4.1    </span> <a id="x34-17200028.4.1"></a>Never Trust Input 从不信任输入</h4>
<!--l. 143--><p class="noindent">Explain untrusted inputs. Use a few examples from the real world, maybe the recent
Rails and Github attack. Show a simple C examples using C strings taken from a
socket. 解释什么是不被信任的输入。可以找一些真实的例子，比如最近的 Rails 和 Github 的攻击。用来自 socket 的 C string 做一个简单的 C 代码例子。
<!--l. 147--></p><p class="noindent">
                                                                  

                                                                  
    </p><h4 class="subsectionHead"><span class="titlemark">28.4.2    </span> <a id="x34-17300028.4.2"></a>Prevent Errors 预防错误</h4>
<!--l. 149--><p class="noindent">Discuss the difference between a possible error and a probable error, then how
humans are very bad at determining probability, therefore you should try to
block all the possible errors you can. 讨论一下可能错误与概率错误的差别，以及人类在确定概率上是多么的糟糕，因此你应该尽可能阻止可能错误。
<!--l. 153--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">28.4.3    </span> <a id="x34-17400028.4.3"></a>Fail Early And Openly 出错要尽早且有错误输出</h4>
<!--l. 155--><p class="noindent">Show how my awesome macros help you do this and discuss good error messages.
Make sure they understand that you should try to explain how to maybe fix
it, or report the defect. 展示了用我的宏来帮你做到这一点并讨论了优秀的错误信息。你应该尝试解释如何修正错误或者提出问题以确保他们明白。
<!--l. 159--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">28.4.4    </span> <a id="x34-17500028.4.4"></a>Document Assumptions 前提建档</h4>
<!--l. 161--><p class="noindent">Explain design by contract and how you can use it to create pre-conditions,
post-conditions, and invariants. Show a simple example of this with a function that
has it all.
<!--l. 164--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">28.4.5    </span> <a id="x34-17600028.4.5"></a>Prevention Over Documentation 靠预防措施不靠文档说明</h4>
<!--l. 166--><p class="noindent">Talk about how programmers think that a documented flaw means there is no flaw
and that they should just remove the flaw.
                                                                  

                                                                  
<!--l. 169--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">28.4.6    </span> <a id="x34-17700028.4.6"></a>Automate Everything 自动化</h4>
<!--l. 171--><p class="noindent">Discuss the advantages of automated testing and how I’ll teach that in a later
exercise.
<!--l. 173--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">28.4.7    </span> <a id="x34-17800028.4.7"></a>Simplify And Clarify 简洁明了</h4>
<!--l. 175--><p class="noindent">Talk about how simpler code wins over more complex code because it reduces the
probability of an error by reducing the number of branches and couplings in the
code.
<!--l. 178--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">28.4.8    </span> <a id="x34-17900028.4.8"></a>Question Authority 质疑权威</h4>
<!--l. 180--><p class="noindent">The final strategy is the most important because it breaks you out of the defensive
programming mindset and lets you transition into the creative mindset. Defensive
programming is authoritarian and it can be cruel. The job of this mindset is to
make you follow rules because without them you’ll miss something or get
distracted.
<!--l. 186--></p><p class="indent">    This authoritarian attitude has the disadvantage of disabling independent
creative thought. Rules are necessary for getting things done, but being a slave to
them will kill your creativity.
<!--l. 190--></p><p class="indent">    This final strategy means you should question the rules you follow
periodically and assume that they could be wrong, just like the software
you are reviewing. What I will typically do is, after a session of defensive
programming, I’ll go take a non-programming break and let the rules go. Then I’ll
                                                                  

                                                                  
be ready to do some creative work or do more defensive coding if need
to.
<!--l. 196--></p><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">28.5    </span> <a id="x34-18000028.5"></a>Order Is Not Important 秩序不重要</h3>
<!--l. 198--><p class="noindent">The final thing I’ll say on this philosophy is that I’m not telling you to do this in a
strict oder of ”CREATE! DEFEND! CREATE! DEFEND!” At first you may
want to do that, but I will actually do either in varying amounts depend on
what I want to do, and I may even meld them together with no defined
boundary.
<!--l. 203--></p><p class="indent">    I also don’t think one mindset is better than another, or that there are
strict separation between them. You need both creativity and strictness to do
programming well, so work on both if you want to improve.
<!--l. 208--></p><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">28.6    </span> <a id="x34-18100028.6"></a>加分题</h3>
<!--l. 210--><p class="noindent">
     </p><ol class="enumerate1"><li class="enumerate" id="x34-181002x1">The code in the book up to this point (and for the rest of it) potentially
     violates these rules. Go back through and apply what you’ve learned to
     one exercise to see if you can improve it or find bugs.
     </li>
     <li class="enumerate" id="x34-181004x2">Find  an  open  source  project  and  give  some  of  the  files  a  similar  code
     review. Submit a patch that fixes a bug if you find it.</li></ol><!--l. 1--><div class="crosslinks"><p class="noindent">[<a href="learn-c-the-hard-waych29.html">next</a>] [<a href="learn-c-the-hard-waypa2.html">prev</a>] [<a href="learn-c-the-hard-waypa2.html#taillearn-c-the-hard-waypa2.html">prev-tail</a>] [<a href="learn-c-the-hard-waych28.html">front</a>] [<a href="learn-c-the-hard-waypa2.html#learn-c-the-hard-waych28.html">up</a>] </p></div>
<!--l. 1--><p class="indent">    <a id="taillearn-c-the-hard-waych28.html"></a>   
</p></body></html>