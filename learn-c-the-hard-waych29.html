<html><head><title>习题26: 第一个真正的程序</title><meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="generator"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="originator"></meta><!-- index=1,2,next,fn-in,charset=utf-8,NoFonts,html --><meta content="learn-c-the-hard-way.tex" name="src"></meta><meta content="2012-04-01 17:12:00" name="date"></meta><link href="learn-c-the-hard-way.css" rel="stylesheet" type="text/css"></link></head><body>
    <!--l. 1--><div class="crosslinks"><p class="noindent">[<a href="learn-c-the-hard-waypa2.html">next</a>] [<a href="learn-c-the-hard-waych28.html">prev</a>] [<a href="learn-c-the-hard-waych28.html#taillearn-c-the-hard-waych28.html">prev-tail</a>] [<a href="#taillearn-c-the-hard-waych29.html">tail</a>] [<a href="learn-c-the-hard-waypa1.html#learn-c-the-hard-waych29.html">up</a>] </p></div>
    <h2 class="chapterHead"><span class="titlemark">Chapter 29</span><br><a id="x34-15400029"></a>习题26: 第一个真正的程序</h2>
<!--l. 3--><p class="noindent">到这里正好是本书的一半，你也该参加一次期中考核了。这次考核我要求你把我专为本书写的一个叫 devpkg 的程序重写一遍，然后你要用一些关键方法改进代码，最重要的方法就是为它写一些单元测试。
                                                                  

                                                                  
<!--l. 7--></p><p class="indent">    <a id="x34-154001r8"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Note 8: </span><span class="content">                                                                                     WARNING: Beta Draft
Content</span></div><!--tex4ht:label?: x34-154001r8 -->
     <div class="quote">
     <!--l. 8--><p class="indent">   I  wrote  this  exercise  before  writing  some  of  the  exercises  you
     might need to complete this. If you are attempting this one now,
     please  keep  in  mind  that  the  software  may  have  bugs,  that  you
     might have problems because of my mistakes, and that you might
     not  know  everything  you  need  to  finish  it.  If  so,  tell  me  at
     help@learncodethehardway.org  and  then  wait  until  I  finish  the
     other exercises. </p></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><h3 class="sectionHead"><span class="titlemark">29.1    </span> <a id="x34-15500029.1"></a>什么是devpkg?</h3>
<!--l. 18--><p class="noindent">Devpkg 是一个简单的 C 程序，它的功能是用来安装别的软件。这个软件是我专为这本书写的，目的是教你学习真正的软件项目是怎样构架的，以及学习怎样重复使用别人写的 library。它使用了一个称作 <a href="http://apr.apache.org/">The Apache Portable
Runtime (APR)</a> 可移植性library，它里边有很多好用适用于很多平台（包
括Windows）的C 函数。除此之外，它所做的就是从网上或者本地抓到代码，然后执
行一下我们每个人都会的 <span class="obeylines-h"><span class="verb">./configure ; make ; make install</span></span> 而已。
<!--l. 25--></p><p class="indent">    本节习题中你的任务是从源代码 build devpkg，完成我给你的每一个挑战，然后通过阅读源代码来理解 devpkg 的功能和原理。
<!--l. 28--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">29.1.1    </span> <a id="x34-15600029.1.1"></a>What We Want To Make</h4>
<!--l. 30--><p class="noindent">我们要做一个工具，它有三条命令:
<!--l. 32--></p><p class="indent">
     </p><ol class="enumerate1"><li class="enumerate" id="x34-156001x29.1.1">执行软件的全新安装。
     </li>
     <li class="enumerate" id="x34-156002x29.1.1">通过 URL 安装软件。
     </li>
     <li class="enumerate" id="x34-156003x29.1.1">列出所有安装了的软件。
     </li>
     <li class="enumerate" id="x34-156004x29.1.1">下载源代码以供手动 build。
     </li>
                                                                  

                                                                  
     <li class="enumerate" id="x34-156005x29.1.1">下载源代码，build 并且安装软件，即使在软件已被安装的情况下也会再装一遍。</li></ol><!--l. 40--><p class="indent">    我们要求 devpkg 能够识别绝大部分的 URL，识别出这个 URL 对应的是哪个项目，然后下载并且安装软件，最后记录下来它下载了哪个软件。我们还要求 devpkg
能够处理一份简单的需求列表(dependency list)，这样它就能同时将当前要安装的软件依赖的软件也安装起来。
<!--l. 44--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">29.1.2    </span> <a id="x34-15700029.1.2"></a>软件设计</h4>
<!--l. 46--><p class="noindent">我们将通过非常简单的设计来达到我们的目的：
     </p><dl class="description"><dt class="description">
使用外部命令 </dt><dd class="description">你的大部分工作将通过外部命令诸如 curl、git、tar 来完成。
     这样可以减少实现 devpkg 所需的代码量。
     </dd><dt class="description">
简单的文件数据库 </dt><dd class="description">要做复杂也不难，不过起始阶段你只要建立一个单个文件的简单数据库/usr/local/.devpkg/db，用来记录所安装的软件即可。
     </dd><dt class="description">
只适用/usr/local </dt><dd class="description">这里你也可以做得更高级，不过初始阶段我们就假设所有的东西都装到/usr/local 好了，这也是大部分 Unix 下软件的标准安装路径。
     </dd><dt class="description">
configure, make, make install </dt><dd class="description">我们假设绝大部分软件可以通过执行 configure; make; make install 来安装，而 configure 可能不是必须的一步。如果你要安装的软件不支持这些基本的安装方式，那你可以通过一个选项来修改安装命令，不过更多的东西 devpkg 就不去理会了。
     </dd><dt class="description">
用户可以是root </dt><dd class="description">我们将假设用户可以通过 sudo 命令得到 root 权限，不过在执行完安装命令以后他们将回到普通用户级别。</dd></dl><!--l. 63--><p class="indent">    这样我们可以让程序的初始体积比较小，而功能也都能实现，这样我们就能顺利进行后面的学习，而以后你也能够进一步修改它。
<!--l. 66--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">29.1.3    </span> <a id="x34-15800029.1.3"></a>Apache Portable Runtime</h4>
<!--l. 68--><p class="noindent">接下来你要做的是利用 <a href="http://apr.apache.org/">Apache Portable Runtime (APR)</a> 里一成套的可移植函数库以
完成本项目。APR 不是必须项，就算不用它你也可以完成本程序，只不过你需要写更
多的代码罢了。我要求你使用APR 的原因是让你习惯于链接并使用别的库文件。最后
要说的一点是，APR 在Windows 下也能工作，所以你学的APL 技能可以用在很多别
的平台上面。
<!--l. 73--></p><p class="indent">    你需要下载 apr-1.4.5 和 apr-util-1.3 这两个函数库，同时阅读一下 <a href="http://apr.apache.org/">APR 主
站</a>提供的文档。
<!--l. 76--></p><p class="indent">    下面是一个用来安装的 shell 脚本，你需要将这个脚本手动誊写一遍，然后运行它，直到它能毫不出错地安装 APR 为止。
                                                                  

                                                                  
<!--l. 79--></p><p class="indent">    <a id="x34-158001r67"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 67: </span><span class="content">                                                                                                 APR 安装脚本</span></div><!--tex4ht:label?: x34-158001r67 -->
<div class="fancyvrb" id="fancyvrb36"><a id="x34-158003r1"></a>1  <span id="textcolor3158">set</span> -e<br class="fancyvrb"><a id="x34-158005r2"></a>2  <br class="fancyvrb"><a id="x34-158007r3"></a>3  <span id="textcolor3159"># go somewhere safe</span><br class="fancyvrb"><a id="x34-158009r4"></a>4  <span id="textcolor3160">cd</span> /tmp<br class="fancyvrb"><a id="x34-158011r5"></a>5  <br class="fancyvrb"><a id="x34-158013r6"></a>6  <span id="textcolor3161"># get the source to base APR 1.4.5</span>
<br class="fancyvrb"><a id="x34-158015r7"></a>7  curl -L -O http://download.nextag.com/apache//apr/apr-1.4.5.tar.gz
<br class="fancyvrb"><a id="x34-158017r8"></a>8  <br class="fancyvrb"><a id="x34-158019r9"></a>9  <span id="textcolor3162"># extract it and go into the source</span><br class="fancyvrb"><a id="x34-158021r10"></a>10  tar -xzvf apr-1.4.5.tar.gz
<br class="fancyvrb"><a id="x34-158023r11"></a>11  <span id="textcolor3163">cd </span>apr-1.4.5<br class="fancyvrb"><a id="x34-158025r12"></a>12  <br class="fancyvrb"><a id="x34-158027r13"></a>13  <span id="textcolor3164"># configure, make, make install</span><br class="fancyvrb"><a id="x34-158029r14"></a>14  ./configure
<br class="fancyvrb"><a id="x34-158031r15"></a>15  make<br class="fancyvrb"><a id="x34-158033r16"></a>16  sudo make install<br class="fancyvrb"><a id="x34-158035r17"></a>17  <br class="fancyvrb"><a id="x34-158037r18"></a>18  <span id="textcolor3165"># reset and cleanup</span><br class="fancyvrb"><a id="x34-158039r19"></a>19  <span id="textcolor3166">cd</span> /tmp
<br class="fancyvrb"><a id="x34-158041r20"></a>20  rm -rf apr-1.4.5 apr-1.4.5.tar.gz<br class="fancyvrb"><a id="x34-158043r21"></a>21  <br class="fancyvrb"><a id="x34-158045r22"></a>22  <span id="textcolor3167"># do the same with apr-util</span>
<br class="fancyvrb"><a id="x34-158047r23"></a>23  curl -L -O http://download.nextag.com/apache//apr/apr-util-1.3.12.tar.gz
<br class="fancyvrb"><a id="x34-158049r24"></a>24  <br class="fancyvrb"><a id="x34-158051r25"></a>25  <span id="textcolor3168"># extract</span><br class="fancyvrb"><a id="x34-158053r26"></a>26  tar -xzvf apr-util-1.3.12.tar.gz<br class="fancyvrb"><a id="x34-158055r27"></a>27  <span id="textcolor3169">cd </span>apr-util-1.3.12<br class="fancyvrb"><a id="x34-158057r28"></a>28  
<br class="fancyvrb"><a id="x34-158059r29"></a>29  <span id="textcolor3170"># configure, make, make install</span><br class="fancyvrb"><a id="x34-158061r30"></a>30  ./configure --with-apr=/usr/local/apr
<br class="fancyvrb"><a id="x34-158063r31"></a>31  <span id="textcolor3171"># you need that extra parameter to configure because</span>
<br class="fancyvrb"><a id="x34-158065r32"></a>32  <span id="textcolor3172"># apr-util can’t really find it because...who knows.</span><br class="fancyvrb"><a id="x34-158067r33"></a>33  <br class="fancyvrb"><a id="x34-158069r34"></a>34  make
<br class="fancyvrb"><a id="x34-158071r35"></a>35  sudo make install<br class="fancyvrb"><a id="x34-158073r36"></a>36  <br class="fancyvrb"><a id="x34-158075r37"></a>37  <span id="textcolor3173">#cleanup</span><br class="fancyvrb"><a id="x34-158077r38"></a>38  <span id="textcolor3174">cd</span> /tmp<br class="fancyvrb"><a id="x34-158079r39"></a>39  rm -rf apr-util-1.3.12⋆ apr-1.4.5⋆</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 124--><p class="indent">    我要求你写这个脚本是因为 devpkg 实现的功能和这个脚本一样，只不过参数更多，功能也更完善而已。其实你可以用 shell 完全实现本项目，而且这样做代码量更少，不过在一本 C 语言的书里教你 shell 程序还是有些不合适吧？
<!--l. 128--></p><p class="indent">    运行这个脚本，如果有错就修改过来，直到它能正常工作为止。这样你就装好了实现剩余项目所需的函数库。
    </p><h3 class="sectionHead"><span class="titlemark">29.2    </span> <a id="x34-15900029.2"></a>项目结构</h3>
<!--l. 132--><p class="noindent">你需要通过建立一些文件来开始一个新项目。以下是我通常建立新项目的方法：
                                                                  

                                                                  
<!--l. 134--></p><p class="indent">    <a id="x34-159001r68"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 68: </span><span class="content">                                                                                                  项目骨架目录</span></div><!--tex4ht:label?: x34-159001r68 -->
<div class="fancyvrb" id="fancyvrb37"><a id="x34-159003r1"></a>1  mkdir devpkg<br class="fancyvrb"><a id="x34-159005r2"></a>2  <span id="textcolor3175">cd </span>devpkg<br class="fancyvrb"><a id="x34-159007r3"></a>3  touch README Makefile</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><h4 class="subsectionHead"><span class="titlemark">29.2.1    </span> <a id="x34-16000029.2.1"></a>其他需求</h4>
<!--l. 145--><p class="noindent">你应该已经装了 APR 和 APR-util，所以现在你还需要几个文件作为基本 dependency：
<!--l. 147--></p><p class="indent">
     </p><ol class="enumerate1"><li class="enumerate" id="x34-160002x1">习题 20 中的 dbg.h
     </li>
     <li class="enumerate" id="x34-160004x2">bstrlib.h 和 bstrlib.c，它们来自 <a href="http://bstring.sourceforge.net/">http://bstring.sourceforge.net/</a>。
     下载并解压.zip 文件，把这两个文件复制出来即可。
     </li>
     <li class="enumerate" id="x34-160006x3">键入命令 <span class="obeylines-h"><span class="verb">make bstrlib.o</span></span>，如果执行失败，请阅读下面的“解决 bstring 的问题”。</li></ol><!--l. 154--><p class="indent">    <a id="x34-160007r9"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Note 9: </span><span class="content">                                                                                               解决 bstring 的问题</span></div><!--tex4ht:label?: x34-160007r9 -->
     <div class="quote">
     <!--l. 155--><p class="indent"> 有些平台上面 bstring.c 会出现如下的错误：
      <!--l. 157-->
</p><div class="lstlisting" id="listing-43"><span class="label"><a id="x34-160008r1"></a>1</span>bstrlib.c:2762: error: expected declaration specifiers or ’...’ before numeric constant
      </div>
     <!--l. 161--><p class="indent"> 这是因为 bstrlib.c 的作者用了一个有问题的 define 语句，这个语句有时不能正常工作。只要把这个 <span class="obeylines-h"><span class="verb">#ifdef</span></span> 删掉并且重新编译即可。
     </p></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 165--><p class="indent">    上述步骤完成以后，你应该准备了以下文件：Makefile、README、dbg.h、
bstrlib.h、bstrlib.c。现在你可以继续了。
    </p><h3 class="sectionHead"><span class="titlemark">29.3    </span> <a id="x34-16100029.3"></a>Makefile</h3>
<!--l. 170--><p class="noindent">Makefile 是一个很好的开始着手点，这样你可以计划好要 build 的内容，以及你需要建立的代码文件。
                                                                  

                                                                  
<!--l. 173--></p><p class="indent">    <a id="x34-161001r69"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 69: </span><span class="content">                                                                                                        Makefile</span></div><!--tex4ht:label?: x34-161001r69 -->
<!--l. 174-->
<div class="lstlisting" id="listing-44"><span class="label"><a id="x34-161002r1"></a>1</span>PREFIX?=/usr/local <br><span class="label"><a id="x34-161003r2"></a>2</span>CFLAGS=-g -Wall -I${PREFIX}/apr/include/apr-1  -I${PREFIX}/apr/include/apr-util-1 <br><span class="label"><a id="x34-161004r3"></a>3</span>LDFLAGS=-lapr-1 -pthread -laprutil-1 <br><span class="label"><a id="x34-161005r4"></a>4</span> <br><span class="label"><a id="x34-161006r5"></a>5</span>all: devpkg <br><span class="label"><a id="x34-161007r6"></a>6</span> <br><span class="label"><a id="x34-161008r7"></a>7</span>devpkg: bstrlib.o db.o shell.o commands.o <br><span class="label"><a id="x34-161009r8"></a>8</span> <br><span class="label"><a id="x34-161010r9"></a>9</span>install: all <br><span class="label"><a id="x34-161011r10"></a>10</span>        install -d $(DESTDIR)/$(PREFIX)/bin/ <br><span class="label"><a id="x34-161012r11"></a>11</span>        install devpkg $(DESTDIR)/$(PREFIX)/bin/ <br><span class="label"><a id="x34-161013r12"></a>12</span> <br><span class="label"><a id="x34-161014r13"></a>13</span>clean: <br><span class="label"><a id="x34-161015r14"></a>14</span>        rm -f ⋆.o <br><span class="label"><a id="x34-161016r15"></a>15</span>        rm -f devpkg <br><span class="label"><a id="x34-161017r16"></a>16</span>        rm -rf ⋆.dSYM
</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 196--><p class="indent">    除了这个奇怪的 <span class="obeylines-h"><span class="verb">?=</span></span>语法以外，这里基本没有你没见过的东西。这个表达式的意思是“如果 PREFIX 的值还没被设定，那么就将 PREFIX 设为该值”。
    </p><h3 class="sectionHead"><span class="titlemark">29.4    </span> <a id="x34-16200029.4"></a>代码文件</h3>
<!--l. 201--><p class="noindent">从 Makefile 里我们可以看出 devpkg 需要以下四个 dependency：
     </p><dl class="description"><dt class="description">
bstrlib.o </dt><dd class="description">，编译自你下载的 bstlib.c 和 bstlib.h。
     </dd><dt class="description">
db.o </dt><dd class="description">，编译自 db.c 和 db.h 头文件。它包含我们即将需要的“数据库”功能。
     </dd><dt class="description">
shell.o </dt><dd class="description">，编译自 shell.c 和 shell.h，它里边包含一些方便运行外部命令
    （例如 curl）的辅助函数。
     </dd><dt class="description">
commands.o </dt><dd class="description">，编译自 command.c 和 command.h，它包含了实现 devpkg 命令行功能所须的各种函数。
     </dd><dt class="description">
devpkg </dt><dd class="description">我们并没有特别提及它，不过其实它是这部分 Makefile 的 build target
    （就在最左边）。它是由 devpkg.c 编译而来，该文件包含了整个程序的 main 函数。</dd></dl><!--l. 214--><p class="indent">    你现在的任务是创建上面提到的每个文件，键入必须的代码并确保正确。
                                                                  

                                                                  
<!--l. 216--></p><p class="indent">    <a id="x34-162001r10"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Note 10: </span><span class="content">                                                                                     别被这场魔法秀忽悠了</span></div><!--tex4ht:label?: x34-162001r10 -->
     <div class="quote">
     <!--l. 217--><p class="indent"> 读到这里也许你会想：“神啊，Zed 怎么能这么牛，这么多东西随便搞搞就弄出来了？！我这辈子都做不到。”其实我并不是用我强悍的编程技术妙笔生花般地地写出这个 devpkg 结构的，我做的是下面这些事情：
    </p><ol class="enumerate1"><li class="enumerate" id="x34-162003x1">我写了一个短小的 README 用来梳理思路，从而决定了我要为 devpkg 实现什么样的功能。
    </li>
    <li class="enumerate" id="x34-162005x2">我创建了一个简单的 Bash 脚本（跟你刚写的那个类似），用以找出所有要实现的细节。
    </li>
    <li class="enumerate" id="x34-162007x3">我创建了一个.c 文件，并且花了几天时间去实现它的功能。
    </li>
    <li class="enumerate" id="x34-162009x4">待到功能基本实现，bug 基本没有了的时候，我接着就把一整个大文件分割成了这四个文件。
    </li>
    <li class="enumerate" id="x34-162011x5">分割完以后，我把里边的函数和数据结构该重命名的重命名，
    该完善的完善，从而让它们的逻辑更完整，而且更“美观”。
    </li>
    <li class="enumerate" id="x34-162013x6">最后，等我让这个重新构架过的程序成功运行起来之后，我又加了一些诸如 -F 和 -B 这样的命令行选项。</li></ol><!--l. 233--><p class="indent"> 你读到的是我想要教你的顺序，不过其实这也不是我固定使用的顺序。有时我对主题了解比较明确，所以会花比较长的时间做更多计划，有时我会直接把想法写成代码看它是否能工作。有时我会写出一个项目再把它丢掉，然后重新设计并写出一个更好的来。一切都取决于我的个人经验带来的感觉，或者是编程的灵感。
                                                                  

                                                                  
     <!--l. 237--></p><p class="indent"> 如果你碰到一个“高手”说一个编程问题只有一种方法解决，那他是在骗你。要吗他们其实用了多种方法，要么他们其实不是高手。
     </p></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><h4 class="subsectionHead"><span class="titlemark">29.4.1    </span> <a id="x34-16300029.4.1"></a>数据库函数</h4>
<!--l. 243--><p class="noindent">我们有必要把安装过的软件的 URL 用某种方式记录下来，并且能够随时列出这些 URL，并通过这些记检查并跳过那些安装过的软件。我采用的是一个单个文件的数据库，并通过 bstrlib.h 这个头文件来实现它的功能。
<!--l. 247--></p><p class="indent">    首先创建 db.h 以供你实现必要的功能：
                                                                  

                                                                  
<!--l. 249--></p><p class="indent">    <a id="x34-163001r70"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 70: </span><span class="content">                                                                                                               db.h</span></div><!--tex4ht:label?: x34-163001r70 -->
<div class="fancyvrb" id="fancyvrb38"><a id="x34-163003r1"></a>1  <span id="textcolor3176">#</span><span id="textcolor3177">ifndef _db_h</span><br class="fancyvrb"><a id="x34-163005r2"></a>2  <span id="textcolor3178">#</span><span id="textcolor3179">define _db_h</span><br class="fancyvrb"><a id="x34-163007r3"></a>3  <br class="fancyvrb"><a id="x34-163009r4"></a>4  <span id="textcolor3180">#</span><span id="textcolor3181">define DB_FILE "</span><span id="textcolor3182">/</span><span id="textcolor3183">usr</span><span id="textcolor3184">/</span><span id="textcolor3185">local</span><span id="textcolor3186">/</span><span id="textcolor3187">.devpkg</span><span id="textcolor3188">/</span><span id="textcolor3189">db"</span>
<br class="fancyvrb"><a id="x34-163011r5"></a>5  <span id="textcolor3190">#</span><span id="textcolor3191">define DB_DIR "</span><span id="textcolor3192">/</span><span id="textcolor3193">usr</span><span id="textcolor3194">/</span><span id="textcolor3195">local</span><span id="textcolor3196">/</span><span id="textcolor3197">.devpkg"</span><br class="fancyvrb"><a id="x34-163013r6"></a>6  <br class="fancyvrb"><a id="x34-163015r7"></a>7  <br class="fancyvrb"><a id="x34-163017r8"></a>8  <span id="textcolor3198">int</span> DB_init();<br class="fancyvrb"><a id="x34-163019r9"></a>9  <span id="textcolor3199">int</span> DB_list();
<br class="fancyvrb"><a id="x34-163021r10"></a>10  <span id="textcolor3200">int</span> DB_update(<span id="textcolor3201">const</span> <span id="textcolor3202">char</span> ⋆url);<br class="fancyvrb"><a id="x34-163023r11"></a>11  <span id="textcolor3203">int</span> DB_find(<span id="textcolor3204">const</span> <span id="textcolor3205">char</span> ⋆url);<br class="fancyvrb"><a id="x34-163025r12"></a>12  <br class="fancyvrb"><a id="x34-163027r13"></a>13  <span id="textcolor3206">#</span><span id="textcolor3207">endif</span></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 268--><p class="indent">    然后在 db.c 中实现这些函数，在你 build 它的时候，使用 make 来实现干净的编译，就跟你以前学过的一样。
                                                                  

                                                                  
<!--l. 271--></p><p class="indent">    <a id="x34-163028r71"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 71: </span><span class="content">                                                                                                                db.c</span></div><!--tex4ht:label?: x34-163028r71 -->
<div class="fancyvrb" id="fancyvrb39"><a id="x34-163030r1"></a>1  <span id="textcolor3208">#</span><span id="textcolor3209">include <unistd.h></unistd.h></span><br class="fancyvrb"><a id="x34-163032r2"></a>2  <span id="textcolor3210">#</span><span id="textcolor3211">include <apr_errno.h></apr_errno.h></span><br class="fancyvrb"><a id="x34-163034r3"></a>3  <span id="textcolor3212">#</span><span id="textcolor3213">include <apr_file_io.h></apr_file_io.h></span>
<br class="fancyvrb"><a id="x34-163036r4"></a>4  <br class="fancyvrb"><a id="x34-163038r5"></a>5  <span id="textcolor3214">#</span><span id="textcolor3215">include "db.h"</span><br class="fancyvrb"><a id="x34-163040r6"></a>6  <span id="textcolor3216">#</span><span id="textcolor3217">include "bstrlib.h"</span><br class="fancyvrb"><a id="x34-163042r7"></a>7  <span id="textcolor3218">#</span><span id="textcolor3219">include "dbg.h"</span><br class="fancyvrb"><a id="x34-163044r8"></a>8  
<br class="fancyvrb"><a id="x34-163046r9"></a>9  <span id="textcolor3220">static</span> <span id="textcolor3221">FILE</span> ⋆<span id="textcolor3222">DB_open</span>(<span id="textcolor3223">const</span> <span id="textcolor3224">char</span> ⋆path, <span id="textcolor3225">const</span> <span id="textcolor3226">char</span> ⋆mode)<br class="fancyvrb"><a id="x34-163048r10"></a>10  {
<br class="fancyvrb"><a id="x34-163050r11"></a>11      <span id="textcolor3227">return</span> fopen(path, mode);<br class="fancyvrb"><a id="x34-163052r12"></a>12  }<br class="fancyvrb"><a id="x34-163054r13"></a>13  <br class="fancyvrb"><a id="x34-163056r14"></a>14  <br class="fancyvrb"><a id="x34-163058r15"></a>15  <span id="textcolor3228">static</span> <span id="textcolor3229">void</span> <span id="textcolor3230">DB_close</span>(<span id="textcolor3231">FILE</span> ⋆db)<br class="fancyvrb"><a id="x34-163060r16"></a>16  {
<br class="fancyvrb"><a id="x34-163062r17"></a>17      fclose(db);<br class="fancyvrb"><a id="x34-163064r18"></a>18  }<br class="fancyvrb"><a id="x34-163066r19"></a>19  <br class="fancyvrb"><a id="x34-163068r20"></a>20  <br class="fancyvrb"><a id="x34-163070r21"></a>21  <span id="textcolor3232">static</span> bstring <span id="textcolor3233">DB_load</span>()<br class="fancyvrb"><a id="x34-163072r22"></a>22  {<br class="fancyvrb"><a id="x34-163074r23"></a>23      <span id="textcolor3234">FILE</span> ⋆db = <span id="textcolor3235">NULL</span>;
<br class="fancyvrb"><a id="x34-163076r24"></a>24      bstring data = <span id="textcolor3236">NULL</span>;<br class="fancyvrb"><a id="x34-163078r25"></a>25  <br class="fancyvrb"><a id="x34-163080r26"></a>26      db = DB_open(DB_FILE, <span class="colorbox" id="colorbox3237"><span id="textcolor3238">"</span></span><span class="colorbox" id="colorbox3239"><span id="textcolor3240">r</span></span><span class="colorbox" id="colorbox3241"><span id="textcolor3242">"</span></span>);
<br class="fancyvrb"><a id="x34-163082r27"></a>27      check(db, <span class="colorbox" id="colorbox3243"><span id="textcolor3244">"</span></span><span class="colorbox" id="colorbox3245"><span id="textcolor3246">Failed to open database: %s</span></span><span class="colorbox" id="colorbox3247"><span id="textcolor3248">"</span></span>, DB_FILE);
<br class="fancyvrb"><a id="x34-163084r28"></a>28  <br class="fancyvrb"><a id="x34-163086r29"></a>29      data = bread((bNread)fread, db);
<br class="fancyvrb"><a id="x34-163088r30"></a>30      check(data, <span class="colorbox" id="colorbox3249"><span id="textcolor3250">"</span></span><span class="colorbox" id="colorbox3251"><span id="textcolor3252">Failed to read from db file: %s</span></span><span class="colorbox" id="colorbox3253"><span id="textcolor3254">"</span></span>, DB_FILE);<br class="fancyvrb"><a id="x34-163090r31"></a>31  <br class="fancyvrb"><a id="x34-163092r32"></a>32      DB_close(db);
<br class="fancyvrb"><a id="x34-163094r33"></a>33      <span id="textcolor3255">return</span> data;<br class="fancyvrb"><a id="x34-163096r34"></a>34  <br class="fancyvrb"><a id="x34-163098r35"></a>35  <span id="textcolor3256">error:</span><br class="fancyvrb"><a id="x34-163100r36"></a>36      <span id="textcolor3257">if</span>(db) DB_close(db);<br class="fancyvrb"><a id="x34-163102r37"></a>37      <span id="textcolor3258">if</span>(data) bdestroy(data);
<br class="fancyvrb"><a id="x34-163104r38"></a>38      <span id="textcolor3259">return</span> <span id="textcolor3260">NULL</span>;<br class="fancyvrb"><a id="x34-163106r39"></a>39  }<br class="fancyvrb"><a id="x34-163108r40"></a>40  <br class="fancyvrb"><a id="x34-163110r41"></a>41  <br class="fancyvrb"><a id="x34-163112r42"></a>42  <span id="textcolor3261">int</span> <span id="textcolor3262">DB_update</span>(<span id="textcolor3263">const</span> <span id="textcolor3264">char</span> ⋆url)<br class="fancyvrb"><a id="x34-163114r43"></a>43  {<br class="fancyvrb"><a id="x34-163116r44"></a>44      <span id="textcolor3265">if</span>(DB_find(url)) {
<br class="fancyvrb"><a id="x34-163118r45"></a>45          log_info(<span class="colorbox" id="colorbox3266"><span id="textcolor3267">"</span></span><span class="colorbox" id="colorbox3268"><span id="textcolor3269">Already recorded as installed: %s</span></span><span class="colorbox" id="colorbox3270"><span id="textcolor3271">"</span></span>, url);
<br class="fancyvrb"><a id="x34-163120r46"></a>46      }<br class="fancyvrb"><a id="x34-163122r47"></a>47  <br class="fancyvrb"><a id="x34-163124r48"></a>48      <span id="textcolor3272">FILE</span> ⋆db = DB_open(DB_FILE, <span class="colorbox" id="colorbox3273"><span id="textcolor3274">"</span></span><span class="colorbox" id="colorbox3275"><span id="textcolor3276">a+</span></span><span class="colorbox" id="colorbox3277"><span id="textcolor3278">"</span></span>);
<br class="fancyvrb"><a id="x34-163126r49"></a>49      check(db, <span class="colorbox" id="colorbox3279"><span id="textcolor3280">"</span></span><span class="colorbox" id="colorbox3281"><span id="textcolor3282">Failed to open DB file: %s</span></span><span class="colorbox" id="colorbox3283"><span id="textcolor3284">"</span></span>, DB_FILE);<br class="fancyvrb"><a id="x34-163128r50"></a>50  
<br class="fancyvrb"><a id="x34-163130r51"></a>51      bstring line = bfromcstr(url);<br class="fancyvrb"><a id="x34-163132r52"></a>52      bconchar(line, <span class="colorbox" id="colorbox3285"><span id="textcolor3286">’\n’</span></span>);
<br class="fancyvrb"><a id="x34-163134r53"></a>53      <span id="textcolor3287">int</span> rc = fwrite(line-&gt;data, blength(line), <span id="textcolor3288">1</span>, db);
<br class="fancyvrb"><a id="x34-163136r54"></a>54      check(rc == <span id="textcolor3289">1</span>, <span class="colorbox" id="colorbox3290"><span id="textcolor3291">"</span></span><span class="colorbox" id="colorbox3292"><span id="textcolor3293">Failed to append to the db.</span></span><span class="colorbox" id="colorbox3294"><span id="textcolor3295">"</span></span>);<br class="fancyvrb"><a id="x34-163138r55"></a>55  <br class="fancyvrb"><a id="x34-163140r56"></a>56      <span id="textcolor3296">return</span> <span id="textcolor3297">0</span>;<br class="fancyvrb"><a id="x34-163142r57"></a>57  <span id="textcolor3298">error:</span>
<br class="fancyvrb"><a id="x34-163144r58"></a>58      <span id="textcolor3299">if</span>(db) DB_close(db);<br class="fancyvrb"><a id="x34-163146r59"></a>59      <span id="textcolor3300">return</span> -<span id="textcolor3301">1</span>;<br class="fancyvrb"><a id="x34-163148r60"></a>60  }<br class="fancyvrb"><a id="x34-163150r61"></a>61  <br class="fancyvrb"><a id="x34-163152r62"></a>62  <br class="fancyvrb"><a id="x34-163154r63"></a>63  <span id="textcolor3302">int</span> <span id="textcolor3303">DB_find</span>(<span id="textcolor3304">const</span> <span id="textcolor3305">char</span> ⋆url)<br class="fancyvrb"><a id="x34-163156r64"></a>64  {
<br class="fancyvrb"><a id="x34-163158r65"></a>65      bstring data = <span id="textcolor3306">NULL</span>;<br class="fancyvrb"><a id="x34-163160r66"></a>66      bstring line = bfromcstr(url);<br class="fancyvrb"><a id="x34-163162r67"></a>67      <span id="textcolor3307">int</span> res = -<span id="textcolor3308">1</span>;
<br class="fancyvrb"><a id="x34-163164r68"></a>68  <br class="fancyvrb"><a id="x34-163166r69"></a>69      data = DB_load(DB_FILE);<br class="fancyvrb"><a id="x34-163168r70"></a>70      check(data, <span class="colorbox" id="colorbox3309"><span id="textcolor3310">"</span></span><span class="colorbox" id="colorbox3311"><span id="textcolor3312">Failed to load: %s</span></span><span class="colorbox" id="colorbox3313"><span id="textcolor3314">"</span></span>, DB_FILE);
<br class="fancyvrb"><a id="x34-163170r71"></a>71  <br class="fancyvrb"><a id="x34-163172r72"></a>72      <span id="textcolor3315">if</span>(binstr(data, <span id="textcolor3316">0</span>, line) == BSTR_ERR) {<br class="fancyvrb"><a id="x34-163174r73"></a>73          res = <span id="textcolor3317">0</span>;
<br class="fancyvrb"><a id="x34-163176r74"></a>74      } <span id="textcolor3318">else</span> {<br class="fancyvrb"><a id="x34-163178r75"></a>75          res = <span id="textcolor3319">1</span>;<br class="fancyvrb"><a id="x34-163180r76"></a>76      }<br class="fancyvrb"><a id="x34-163182r77"></a>77  <br class="fancyvrb"><a id="x34-163184r78"></a>78  <span id="textcolor3320">error:</span> <span id="textcolor3321">// fallthrough</span>
<br class="fancyvrb"><a id="x34-163186r79"></a>79      <span id="textcolor3322">if</span>(data) bdestroy(data);<br class="fancyvrb"><a id="x34-163188r80"></a>80      <span id="textcolor3323">if</span>(line) bdestroy(line);<br class="fancyvrb"><a id="x34-163190r81"></a>81  <br class="fancyvrb"><a id="x34-163192r82"></a>82      <span id="textcolor3324">return</span> res;
<br class="fancyvrb"><a id="x34-163194r83"></a>83  }<br class="fancyvrb"><a id="x34-163196r84"></a>84  <br class="fancyvrb"><a id="x34-163198r85"></a>85  <br class="fancyvrb"><a id="x34-163200r86"></a>86  <span id="textcolor3325">int</span> <span id="textcolor3326">DB_init</span>()<br class="fancyvrb"><a id="x34-163202r87"></a>87  {<br class="fancyvrb"><a id="x34-163204r88"></a>88      apr_pool_t ⋆p = <span id="textcolor3327">NULL</span>;<br class="fancyvrb"><a id="x34-163206r89"></a>89      apr_pool_initialize();
<br class="fancyvrb"><a id="x34-163208r90"></a>90      apr_pool_create(&amp;p, <span id="textcolor3328">NULL</span>);<br class="fancyvrb"><a id="x34-163210r91"></a>91  <br class="fancyvrb"><a id="x34-163212r92"></a>92      <span id="textcolor3329">if</span>(access(DB_DIR, W_OK | X_OK) == -<span id="textcolor3330">1</span>) {
<br class="fancyvrb"><a id="x34-163214r93"></a>93          apr_status_t rc = apr_dir_make_recursive(DB_DIR,
<br class="fancyvrb"><a id="x34-163216r94"></a>94                  APR_UREAD | APR_UWRITE | APR_UEXECUTE |
<br class="fancyvrb"><a id="x34-163218r95"></a>95                  APR_GREAD | APR_GWRITE | APR_GEXECUTE, p);
<br class="fancyvrb"><a id="x34-163220r96"></a>96          check(rc == APR_SUCCESS, <span class="colorbox" id="colorbox3331"><span id="textcolor3332">"</span></span><span class="colorbox" id="colorbox3333"><span id="textcolor3334">Failed to make database dir: %s</span></span><span class="colorbox" id="colorbox3335"><span id="textcolor3336">"</span></span>, DB_DIR);<br class="fancyvrb"><a id="x34-163222r97"></a>97      }
<br class="fancyvrb"><a id="x34-163224r98"></a>98  <br class="fancyvrb"><a id="x34-163226r99"></a>99      <span id="textcolor3337">if</span>(access(DB_FILE, W_OK) == -<span id="textcolor3338">1</span>) {<br class="fancyvrb"><a id="x34-163228r100"></a>100          <span id="textcolor3339">FILE</span> ⋆db = DB_open(DB_FILE, <span class="colorbox" id="colorbox3340"><span id="textcolor3341">"</span></span><span class="colorbox" id="colorbox3342"><span id="textcolor3343">w</span></span><span class="colorbox" id="colorbox3344"><span id="textcolor3345">"</span></span>);
<br class="fancyvrb"><a id="x34-163230r101"></a>101          check(db, <span class="colorbox" id="colorbox3346"><span id="textcolor3347">"</span></span><span class="colorbox" id="colorbox3348"><span id="textcolor3349">Cannot open database: %s</span></span><span class="colorbox" id="colorbox3350"><span id="textcolor3351">"</span></span>, DB_FILE);<br class="fancyvrb"><a id="x34-163232r102"></a>102          DB_close(db);
<br class="fancyvrb"><a id="x34-163234r103"></a>103      }<br class="fancyvrb"><a id="x34-163236r104"></a>104  <br class="fancyvrb"><a id="x34-163238r105"></a>105      apr_pool_destroy(p);<br class="fancyvrb"><a id="x34-163240r106"></a>106      <span id="textcolor3352">return</span> <span id="textcolor3353">0</span>;<br class="fancyvrb"><a id="x34-163242r107"></a>107  <br class="fancyvrb"><a id="x34-163244r108"></a>108  <span id="textcolor3354">error:</span><br class="fancyvrb"><a id="x34-163246r109"></a>109      apr_pool_destroy(p);
<br class="fancyvrb"><a id="x34-163248r110"></a>110      <span id="textcolor3355">return</span> -<span id="textcolor3356">1</span>;<br class="fancyvrb"><a id="x34-163250r111"></a>111  }<br class="fancyvrb"><a id="x34-163252r112"></a>112  <br class="fancyvrb"><a id="x34-163254r113"></a>113  <br class="fancyvrb"><a id="x34-163256r114"></a>114  <span id="textcolor3357">int</span> <span id="textcolor3358">DB_list</span>()<br class="fancyvrb"><a id="x34-163258r115"></a>115  {<br class="fancyvrb"><a id="x34-163260r116"></a>116      bstring data = DB_load(DB_FILE);
<br class="fancyvrb"><a id="x34-163262r117"></a>117      check(data, <span class="colorbox" id="colorbox3359"><span id="textcolor3360">"</span></span><span class="colorbox" id="colorbox3361"><span id="textcolor3362">Failed to read load: %s</span></span><span class="colorbox" id="colorbox3363"><span id="textcolor3364">"</span></span>, DB_FILE);<br class="fancyvrb"><a id="x34-163264r118"></a>118  <br class="fancyvrb"><a id="x34-163266r119"></a>119      printf(<span class="colorbox" id="colorbox3365"><span id="textcolor3366">"</span></span><span class="colorbox" id="colorbox3367"><span id="textcolor3368">%s</span></span><span class="colorbox" id="colorbox3369"><span id="textcolor3370">"</span></span>, bdata(data));
<br class="fancyvrb"><a id="x34-163268r120"></a>120      bdestroy(data);<br class="fancyvrb"><a id="x34-163270r121"></a>121      <span id="textcolor3371">return</span> <span id="textcolor3372">0</span>;<br class="fancyvrb"><a id="x34-163272r122"></a>122  <br class="fancyvrb"><a id="x34-163274r123"></a>123  <span id="textcolor3373">error:</span><br class="fancyvrb"><a id="x34-163276r124"></a>124      <span id="textcolor3374">return</span> -<span id="textcolor3375">1</span>;<br class="fancyvrb"><a id="x34-163278r125"></a>125  }</div>
                                                                  

                                                                  
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><h5 class="subsubsectionHead"><a id="x34-16400029.4.1"></a>挑战1: 代码审查</h5>
<!--l. 404--><p class="noindent">继续下一步之前，仔细阅读每一行代码，确认你输入的内容和书里的完全相同。练习倒着一行一行读回去，你还要检查每一处函数调用，确认你使用了 check 来检查返回值。最后，如果你有不认识或者不了解的函数，你需要到 APR 网站的文档中，或者在 bstrlib.h 和 bstrlib.c 这两个代码文件中寻找答案。
<!--l. 410--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">29.4.2    </span> <a id="x34-16500029.4.2"></a>Shell 函数</h4>
<!--l. 412--><p class="noindent">devpkg 设计最关键的一个设计决策就是使用外部工具来实现大部分功能，例如 curl、tar、git 等程序。我们其实也能找到需要的函数库，在不借用外部工具的情况下实现这个项目，不过如果我们需要的只是这些程序的基本功能，那么使用函数库是没必要的，再说在 Unix 下多运行几条命令也不是啥丢人的事情。
<!--l. 417--></p><p class="indent">    为了达到目的，我将使用 apr_thread_proc.h 里的函数来运行外部程序，不过我还想创建一个简单的“模板”系统。我将使用 struct Shell 来存储运行程序必须的所有信息，不过我会在参数列表中留出“空位”，实际用到的参数将被填入到这些空位中。
<!--l. 421--></p><p class="indent">    从下面的 shell.h 文件中你可以看到我们需要使用的结构和命令。我用了 extern 来表示别的.c 文件可以访问到我在 shell.c 中定义的变量。
                                                                  

                                                                  
<!--l. 424--></p><p class="indent">    <a id="x34-165001r72"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 72: </span><span class="content">                                                                                                            shell.h</span></div><!--tex4ht:label?: x34-165001r72 -->
<div class="fancyvrb" id="fancyvrb40"><a id="x34-165003r1"></a>1  <span id="textcolor3376">#</span><span id="textcolor3377">ifndef _shell_h</span><br class="fancyvrb"><a id="x34-165005r2"></a>2  <span id="textcolor3378">#</span><span id="textcolor3379">define _shell_h</span><br class="fancyvrb"><a id="x34-165007r3"></a>3  <br class="fancyvrb"><a id="x34-165009r4"></a>4  <span id="textcolor3380">#</span><span id="textcolor3381">define MAX_COMMAND_ARGS 100</span>
<br class="fancyvrb"><a id="x34-165011r5"></a>5  <br class="fancyvrb"><a id="x34-165013r6"></a>6  <span id="textcolor3382">#</span><span id="textcolor3383">include <apr_thread_proc.h></apr_thread_proc.h></span><br class="fancyvrb"><a id="x34-165015r7"></a>7  <br class="fancyvrb"><a id="x34-165017r8"></a>8  <span id="textcolor3384">typedef</span> <span id="textcolor3385">struct</span> Shell {
<br class="fancyvrb"><a id="x34-165019r9"></a>9      <span id="textcolor3386">const</span> <span id="textcolor3387">char</span> ⋆dir;<br class="fancyvrb"><a id="x34-165021r10"></a>10      <span id="textcolor3388">const</span> <span id="textcolor3389">char</span> ⋆exe;<br class="fancyvrb"><a id="x34-165023r11"></a>11  <br class="fancyvrb"><a id="x34-165025r12"></a>12      apr_procattr_t ⋆attr;
<br class="fancyvrb"><a id="x34-165027r13"></a>13      apr_proc_t proc;<br class="fancyvrb"><a id="x34-165029r14"></a>14      apr_exit_why_e exit_why;<br class="fancyvrb"><a id="x34-165031r15"></a>15      <span id="textcolor3390">int</span> exit_code;
<br class="fancyvrb"><a id="x34-165033r16"></a>16  <br class="fancyvrb"><a id="x34-165035r17"></a>17      <span id="textcolor3391">const</span> <span id="textcolor3392">char</span> ⋆args[MAX_COMMAND_ARGS];<br class="fancyvrb"><a id="x34-165037r18"></a>18  } Shell;<br class="fancyvrb"><a id="x34-165039r19"></a>19  
<br class="fancyvrb"><a id="x34-165041r20"></a>20  <span id="textcolor3393">int</span> Shell_run(apr_pool_t ⋆p, Shell ⋆cmd);<br class="fancyvrb"><a id="x34-165043r21"></a>21  <span id="textcolor3394">int</span> Shell_exec(Shell cmd, ...);
<br class="fancyvrb"><a id="x34-165045r22"></a>22  <br class="fancyvrb"><a id="x34-165047r23"></a>23  <span id="textcolor3395">extern</span> Shell CLEANUP_SH;<br class="fancyvrb"><a id="x34-165049r24"></a>24  <span id="textcolor3396">extern</span> Shell GIT_SH;<br class="fancyvrb"><a id="x34-165051r25"></a>25  <span id="textcolor3397">extern</span> Shell TAR_SH;
<br class="fancyvrb"><a id="x34-165053r26"></a>26  <span id="textcolor3398">extern</span> Shell CURL_SH;<br class="fancyvrb"><a id="x34-165055r27"></a>27  <span id="textcolor3399">extern</span> Shell CONFIGURE_SH;<br class="fancyvrb"><a id="x34-165057r28"></a>28  <span id="textcolor3400">extern</span> Shell MAKE_SH;
<br class="fancyvrb"><a id="x34-165059r29"></a>29  <span id="textcolor3401">extern</span> Shell INSTALL_SH;<br class="fancyvrb"><a id="x34-165061r30"></a>30  <br class="fancyvrb"><a id="x34-165063r31"></a>31  <span id="textcolor3402">#</span><span id="textcolor3403">endif</span></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 461--><p class="indent">    确认你一字不差地创建了 shell.h，而且获得了一样名称和数量的 extern
Shell 变量。这些变量将被 Shell_run 函数和 Shell_exec 函数用以执行外部命令。我定义了这两个函数，然后在 shell.c 中创建了真正用到的变量。
                                                                  

                                                                  
<!--l. 465--></p><p class="indent">    <a id="x34-165064r73"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 73: </span><span class="content">                                                                                                            shell.c</span></div><!--tex4ht:label?: x34-165064r73 -->
<div class="fancyvrb" id="fancyvrb41"><a id="x34-165066r1"></a>1  <span id="textcolor3404">#</span><span id="textcolor3405">include "shell.h"</span><br class="fancyvrb"><a id="x34-165068r2"></a>2  <span id="textcolor3406">#</span><span id="textcolor3407">include "dbg.h"</span><br class="fancyvrb"><a id="x34-165070r3"></a>3  <span id="textcolor3408">#</span><span id="textcolor3409">include <stdarg.h></stdarg.h></span><br class="fancyvrb"><a id="x34-165072r4"></a>4  
<br class="fancyvrb"><a id="x34-165074r5"></a>5  <span id="textcolor3410">int</span> <span id="textcolor3411">Shell_exec</span>(Shell template, ...)<br class="fancyvrb"><a id="x34-165076r6"></a>6  {<br class="fancyvrb"><a id="x34-165078r7"></a>7      apr_pool_t ⋆p = <span id="textcolor3412">NULL</span>;<br class="fancyvrb"><a id="x34-165080r8"></a>8      <span id="textcolor3413">int</span> rc = -<span id="textcolor3414">1</span>;
<br class="fancyvrb"><a id="x34-165082r9"></a>9      apr_status_t rv = APR_SUCCESS;<br class="fancyvrb"><a id="x34-165084r10"></a>10      <span id="textcolor3415">va_list</span> argp;<br class="fancyvrb"><a id="x34-165086r11"></a>11      <span id="textcolor3416">const</span> <span id="textcolor3417">char</span> ⋆key = <span id="textcolor3418">NULL</span>;
<br class="fancyvrb"><a id="x34-165088r12"></a>12      <span id="textcolor3419">const</span> <span id="textcolor3420">char</span> ⋆arg = <span id="textcolor3421">NULL</span>;<br class="fancyvrb"><a id="x34-165090r13"></a>13      <span id="textcolor3422">int</span> i = <span id="textcolor3423">0</span>;<br class="fancyvrb"><a id="x34-165092r14"></a>14  <br class="fancyvrb"><a id="x34-165094r15"></a>15      rv = apr_pool_create(&amp;p, <span id="textcolor3424">NULL</span>);
<br class="fancyvrb"><a id="x34-165096r16"></a>16      check(rv == APR_SUCCESS, <span class="colorbox" id="colorbox3425"><span id="textcolor3426">"</span></span><span class="colorbox" id="colorbox3427"><span id="textcolor3428">Failed to create pool.</span></span><span class="colorbox" id="colorbox3429"><span id="textcolor3430">"</span></span>);<br class="fancyvrb"><a id="x34-165098r17"></a>17  
<br class="fancyvrb"><a id="x34-165100r18"></a>18      va_start(argp, template);<br class="fancyvrb"><a id="x34-165102r19"></a>19  <br class="fancyvrb"><a id="x34-165104r20"></a>20      <span id="textcolor3431">for</span>(key = va_arg(argp, <span id="textcolor3432">const</span> <span id="textcolor3433">char</span> ⋆);
<br class="fancyvrb"><a id="x34-165106r21"></a>21          key != <span id="textcolor3434">NULL</span>;<br class="fancyvrb"><a id="x34-165108r22"></a>22          key = va_arg(argp, <span id="textcolor3435">const</span> <span id="textcolor3436">char</span> ⋆))
<br class="fancyvrb"><a id="x34-165110r23"></a>23      {<br class="fancyvrb"><a id="x34-165112r24"></a>24          arg = va_arg(argp, <span id="textcolor3437">const</span> <span id="textcolor3438">char</span> ⋆);<br class="fancyvrb"><a id="x34-165114r25"></a>25  
<br class="fancyvrb"><a id="x34-165116r26"></a>26          <span id="textcolor3439">for</span>(i = <span id="textcolor3440">0</span>; template.args[i] != <span id="textcolor3441">NULL</span>; i++) {
<br class="fancyvrb"><a id="x34-165118r27"></a>27              <span id="textcolor3442">if</span>(strcmp(template.args[i], key) == <span id="textcolor3443">0</span>) {
<br class="fancyvrb"><a id="x34-165120r28"></a>28                  template.args[i] = arg;<br class="fancyvrb"><a id="x34-165122r29"></a>29                  <span id="textcolor3444">break</span>; <span id="textcolor3445">// found it</span>
<br class="fancyvrb"><a id="x34-165124r30"></a>30              }<br class="fancyvrb"><a id="x34-165126r31"></a>31          }<br class="fancyvrb"><a id="x34-165128r32"></a>32      }<br class="fancyvrb"><a id="x34-165130r33"></a>33  <br class="fancyvrb"><a id="x34-165132r34"></a>34      rc = Shell_run(p, &amp;template);
<br class="fancyvrb"><a id="x34-165134r35"></a>35      apr_pool_destroy(p);<br class="fancyvrb"><a id="x34-165136r36"></a>36      va_end(argp);<br class="fancyvrb"><a id="x34-165138r37"></a>37      <span id="textcolor3446">return</span> rc;
<br class="fancyvrb"><a id="x34-165140r38"></a>38  <span id="textcolor3447">error:</span><br class="fancyvrb"><a id="x34-165142r39"></a>39      <span id="textcolor3448">if</span>(p) {<br class="fancyvrb"><a id="x34-165144r40"></a>40          apr_pool_destroy(p);<br class="fancyvrb"><a id="x34-165146r41"></a>41      }
<br class="fancyvrb"><a id="x34-165148r42"></a>42      <span id="textcolor3449">return</span> rc;<br class="fancyvrb"><a id="x34-165150r43"></a>43  }<br class="fancyvrb"><a id="x34-165152r44"></a>44  <br class="fancyvrb"><a id="x34-165154r45"></a>45  <span id="textcolor3450">int</span> <span id="textcolor3451">Shell_run</span>(apr_pool_t ⋆p, Shell ⋆cmd)
<br class="fancyvrb"><a id="x34-165156r46"></a>46  {<br class="fancyvrb"><a id="x34-165158r47"></a>47      apr_procattr_t ⋆attr;<br class="fancyvrb"><a id="x34-165160r48"></a>48      apr_status_t rv;
<br class="fancyvrb"><a id="x34-165162r49"></a>49      apr_proc_t newproc;<br class="fancyvrb"><a id="x34-165164r50"></a>50  <br class="fancyvrb"><a id="x34-165166r51"></a>51      rv = apr_procattr_create(&amp;attr, p);
<br class="fancyvrb"><a id="x34-165168r52"></a>52      check(rv == APR_SUCCESS, <span class="colorbox" id="colorbox3452"><span id="textcolor3453">"</span></span><span class="colorbox" id="colorbox3454"><span id="textcolor3455">Failed to create proc attr.</span></span><span class="colorbox" id="colorbox3456"><span id="textcolor3457">"</span></span>);<br class="fancyvrb"><a id="x34-165170r53"></a>53  
<br class="fancyvrb"><a id="x34-165172r54"></a>54      rv = apr_procattr_io_set(attr, APR_NO_PIPE, APR_NO_PIPE,<br class="fancyvrb"><a id="x34-165174r55"></a>55              APR_NO_PIPE);
<br class="fancyvrb"><a id="x34-165176r56"></a>56      check(rv == APR_SUCCESS, <span class="colorbox" id="colorbox3458"><span id="textcolor3459">"</span></span><span class="colorbox" id="colorbox3460"><span id="textcolor3461">Failed to set IO of command.</span></span><span class="colorbox" id="colorbox3462"><span id="textcolor3463">"</span></span>);
<br class="fancyvrb"><a id="x34-165178r57"></a>57  <br class="fancyvrb"><a id="x34-165180r58"></a>58      rv = apr_procattr_dir_set(attr, cmd-&gt;dir);
<br class="fancyvrb"><a id="x34-165182r59"></a>59      check(rv == APR_SUCCESS, <span class="colorbox" id="colorbox3464"><span id="textcolor3465">"</span></span><span class="colorbox" id="colorbox3466"><span id="textcolor3467">Failed to set root to %s</span></span><span class="colorbox" id="colorbox3468"><span id="textcolor3469">"</span></span>, cmd-&gt;dir);
<br class="fancyvrb"><a id="x34-165184r60"></a>60  <br class="fancyvrb"><a id="x34-165186r61"></a>61      rv = apr_procattr_cmdtype_set(attr, APR_PROGRAM_PATH);
<br class="fancyvrb"><a id="x34-165188r62"></a>62      check(rv == APR_SUCCESS, <span class="colorbox" id="colorbox3470"><span id="textcolor3471">"</span></span><span class="colorbox" id="colorbox3472"><span id="textcolor3473">Failed to set cmd type.</span></span><span class="colorbox" id="colorbox3474"><span id="textcolor3475">"</span></span>);<br class="fancyvrb"><a id="x34-165190r63"></a>63  
<br class="fancyvrb"><a id="x34-165192r64"></a>64      rv = apr_proc_create(&amp;newproc, cmd-&gt;exe, cmd-&gt;args, <span id="textcolor3476">NULL</span>, attr, p);
<br class="fancyvrb"><a id="x34-165194r65"></a>65      check(rv == APR_SUCCESS, <span class="colorbox" id="colorbox3477"><span id="textcolor3478">"</span></span><span class="colorbox" id="colorbox3479"><span id="textcolor3480">Failed to run command.</span></span><span class="colorbox" id="colorbox3481"><span id="textcolor3482">"</span></span>);<br class="fancyvrb"><a id="x34-165196r66"></a>66  
<br class="fancyvrb"><a id="x34-165198r67"></a>67      rv = apr_proc_wait(&amp;newproc, &amp;cmd-&gt;exit_code, &amp;cmd-&gt;exit_why, APR_WAIT);
<br class="fancyvrb"><a id="x34-165200r68"></a>68      check(rv == APR_CHILD_DONE, <span class="colorbox" id="colorbox3483"><span id="textcolor3484">"</span></span><span class="colorbox" id="colorbox3485"><span id="textcolor3486">Failed to wait.</span></span><span class="colorbox" id="colorbox3487"><span id="textcolor3488">"</span></span>);<br class="fancyvrb"><a id="x34-165202r69"></a>69  
<br class="fancyvrb"><a id="x34-165204r70"></a>70      check(cmd-&gt;exit_code == <span id="textcolor3489">0</span>, <span class="colorbox" id="colorbox3490"><span id="textcolor3491">"</span></span><span class="colorbox" id="colorbox3492"><span id="textcolor3493">%s exited badly.</span></span><span class="colorbox" id="colorbox3494"><span id="textcolor3495">"</span></span>, cmd-&gt;exe);
<br class="fancyvrb"><a id="x34-165206r71"></a>71      check(cmd-&gt;exit_why == APR_PROC_EXIT, <span class="colorbox" id="colorbox3496"><span id="textcolor3497">"</span></span><span class="colorbox" id="colorbox3498"><span id="textcolor3499">%s was killed or crashed</span></span><span class="colorbox" id="colorbox3500"><span id="textcolor3501">"</span></span>, cmd-&gt;exe);
<br class="fancyvrb"><a id="x34-165208r72"></a>72  <br class="fancyvrb"><a id="x34-165210r73"></a>73      <span id="textcolor3502">return</span> <span id="textcolor3503">0</span>;<br class="fancyvrb"><a id="x34-165212r74"></a>74  <br class="fancyvrb"><a id="x34-165214r75"></a>75  <span id="textcolor3504">error:</span><br class="fancyvrb"><a id="x34-165216r76"></a>76      <span id="textcolor3505">return</span> -<span id="textcolor3506">1</span>;<br class="fancyvrb"><a id="x34-165218r77"></a>77  }<br class="fancyvrb"><a id="x34-165220r78"></a>78  
<br class="fancyvrb"><a id="x34-165222r79"></a>79  Shell CLEANUP_SH = {<br class="fancyvrb"><a id="x34-165224r80"></a>80      .exe = <span class="colorbox" id="colorbox3507"><span id="textcolor3508">"</span></span><span class="colorbox" id="colorbox3509"><span id="textcolor3510">rm</span></span><span class="colorbox" id="colorbox3511"><span id="textcolor3512">"</span></span>,<br class="fancyvrb"><a id="x34-165226r81"></a>81      .dir = <span class="colorbox" id="colorbox3513"><span id="textcolor3514">"</span></span><span class="colorbox" id="colorbox3515"><span id="textcolor3516">/tmp</span></span><span class="colorbox" id="colorbox3517"><span id="textcolor3518">"</span></span>,
<br class="fancyvrb"><a id="x34-165228r82"></a>82      .args = {<span class="colorbox" id="colorbox3519"><span id="textcolor3520">"</span></span><span class="colorbox" id="colorbox3521"><span id="textcolor3522">rm</span></span><span class="colorbox" id="colorbox3523"><span id="textcolor3524">"</span></span>, <span class="colorbox" id="colorbox3525"><span id="textcolor3526">"</span></span><span class="colorbox" id="colorbox3527"><span id="textcolor3528">-rf</span></span><span class="colorbox" id="colorbox3529"><span id="textcolor3530">"</span></span>, <span class="colorbox" id="colorbox3531"><span id="textcolor3532">"</span></span><span class="colorbox" id="colorbox3533"><span id="textcolor3534">/tmp/pkg-build</span></span><span class="colorbox" id="colorbox3535"><span id="textcolor3536">"</span></span>, <span class="colorbox" id="colorbox3537"><span id="textcolor3538">"</span></span><span class="colorbox" id="colorbox3539"><span id="textcolor3540">/tmp/pkg-src.tar.gz</span></span><span class="colorbox" id="colorbox3541"><span id="textcolor3542">"</span></span>,
<br class="fancyvrb"><a id="x34-165230r83"></a>83          <span class="colorbox" id="colorbox3543"><span id="textcolor3544">"</span></span><span class="colorbox" id="colorbox3545"><span id="textcolor3546">/tmp/pkg-src.tar.bz2</span></span><span class="colorbox" id="colorbox3547"><span id="textcolor3548">"</span></span>, <span class="colorbox" id="colorbox3549"><span id="textcolor3550">"</span></span><span class="colorbox" id="colorbox3551"><span id="textcolor3552">/tmp/DEPENDS</span></span><span class="colorbox" id="colorbox3553"><span id="textcolor3554">"</span></span>, <span id="textcolor3555">NULL</span>}<br class="fancyvrb"><a id="x34-165232r84"></a>84  };
<br class="fancyvrb"><a id="x34-165234r85"></a>85  <br class="fancyvrb"><a id="x34-165236r86"></a>86  Shell GIT_SH = {<br class="fancyvrb"><a id="x34-165238r87"></a>87      .dir = <span class="colorbox" id="colorbox3556"><span id="textcolor3557">"</span></span><span class="colorbox" id="colorbox3558"><span id="textcolor3559">/tmp</span></span><span class="colorbox" id="colorbox3560"><span id="textcolor3561">"</span></span>,<br class="fancyvrb"><a id="x34-165240r88"></a>88      .exe = <span class="colorbox" id="colorbox3562"><span id="textcolor3563">"</span></span><span class="colorbox" id="colorbox3564"><span id="textcolor3565">git</span></span><span class="colorbox" id="colorbox3566"><span id="textcolor3567">"</span></span>,
<br class="fancyvrb"><a id="x34-165242r89"></a>89      .args = {<span class="colorbox" id="colorbox3568"><span id="textcolor3569">"</span></span><span class="colorbox" id="colorbox3570"><span id="textcolor3571">git</span></span><span class="colorbox" id="colorbox3572"><span id="textcolor3573">"</span></span>, <span class="colorbox" id="colorbox3574"><span id="textcolor3575">"</span></span><span class="colorbox" id="colorbox3576"><span id="textcolor3577">clone</span></span><span class="colorbox" id="colorbox3578"><span id="textcolor3579">"</span></span>, <span class="colorbox" id="colorbox3580"><span id="textcolor3581">"</span></span><span class="colorbox" id="colorbox3582"><span id="textcolor3583">URL</span></span><span class="colorbox" id="colorbox3584"><span id="textcolor3585">"</span></span>, <span class="colorbox" id="colorbox3586"><span id="textcolor3587">"</span></span><span class="colorbox" id="colorbox3588"><span id="textcolor3589">pkg-build</span></span><span class="colorbox" id="colorbox3590"><span id="textcolor3591">"</span></span>, <span id="textcolor3592">NULL</span>}<br class="fancyvrb"><a id="x34-165244r90"></a>90  };<br class="fancyvrb"><a id="x34-165246r91"></a>91  
                                                                  

                                                                  
<br class="fancyvrb"><a id="x34-165248r92"></a>92  Shell TAR_SH = {<br class="fancyvrb"><a id="x34-165250r93"></a>93      .dir = <span class="colorbox" id="colorbox3593"><span id="textcolor3594">"</span></span><span class="colorbox" id="colorbox3595"><span id="textcolor3596">/tmp/pkg-build</span></span><span class="colorbox" id="colorbox3597"><span id="textcolor3598">"</span></span>,<br class="fancyvrb"><a id="x34-165252r94"></a>94      .exe = <span class="colorbox" id="colorbox3599"><span id="textcolor3600">"</span></span><span class="colorbox" id="colorbox3601"><span id="textcolor3602">tar</span></span><span class="colorbox" id="colorbox3603"><span id="textcolor3604">"</span></span>,
<br class="fancyvrb"><a id="x34-165254r95"></a>95      .args = {<span class="colorbox" id="colorbox3605"><span id="textcolor3606">"</span></span><span class="colorbox" id="colorbox3607"><span id="textcolor3608">tar</span></span><span class="colorbox" id="colorbox3609"><span id="textcolor3610">"</span></span>, <span class="colorbox" id="colorbox3611"><span id="textcolor3612">"</span></span><span class="colorbox" id="colorbox3613"><span id="textcolor3614">-xzf</span></span><span class="colorbox" id="colorbox3615"><span id="textcolor3616">"</span></span>, <span class="colorbox" id="colorbox3617"><span id="textcolor3618">"</span></span><span class="colorbox" id="colorbox3619"><span id="textcolor3620">FILE</span></span><span class="colorbox" id="colorbox3621"><span id="textcolor3622">"</span></span>, <span class="colorbox" id="colorbox3623"><span id="textcolor3624">"</span></span><span class="colorbox" id="colorbox3625"><span id="textcolor3626">--strip-components</span></span><span class="colorbox" id="colorbox3627"><span id="textcolor3628">"</span></span>, <span class="colorbox" id="colorbox3629"><span id="textcolor3630">"</span></span><span class="colorbox" id="colorbox3631"><span id="textcolor3632">1</span></span><span class="colorbox" id="colorbox3633"><span id="textcolor3634">"</span></span>, <span id="textcolor3635">NULL</span>}
<br class="fancyvrb"><a id="x34-165256r96"></a>96  };<br class="fancyvrb"><a id="x34-165258r97"></a>97  <br class="fancyvrb"><a id="x34-165260r98"></a>98  Shell CURL_SH = {<br class="fancyvrb"><a id="x34-165262r99"></a>99      .dir = <span class="colorbox" id="colorbox3636"><span id="textcolor3637">"</span></span><span class="colorbox" id="colorbox3638"><span id="textcolor3639">/tmp</span></span><span class="colorbox" id="colorbox3640"><span id="textcolor3641">"</span></span>,<br class="fancyvrb"><a id="x34-165264r100"></a>100      .exe = <span class="colorbox" id="colorbox3642"><span id="textcolor3643">"</span></span><span class="colorbox" id="colorbox3644"><span id="textcolor3645">curl</span></span><span class="colorbox" id="colorbox3646"><span id="textcolor3647">"</span></span>,
<br class="fancyvrb"><a id="x34-165266r101"></a>101      .args = {<span class="colorbox" id="colorbox3648"><span id="textcolor3649">"</span></span><span class="colorbox" id="colorbox3650"><span id="textcolor3651">curl</span></span><span class="colorbox" id="colorbox3652"><span id="textcolor3653">"</span></span>, <span class="colorbox" id="colorbox3654"><span id="textcolor3655">"</span></span><span class="colorbox" id="colorbox3656"><span id="textcolor3657">-L</span></span><span class="colorbox" id="colorbox3658"><span id="textcolor3659">"</span></span>, <span class="colorbox" id="colorbox3660"><span id="textcolor3661">"</span></span><span class="colorbox" id="colorbox3662"><span id="textcolor3663">-o</span></span><span class="colorbox" id="colorbox3664"><span id="textcolor3665">"</span></span>, <span class="colorbox" id="colorbox3666"><span id="textcolor3667">"</span></span><span class="colorbox" id="colorbox3668"><span id="textcolor3669">TARGET</span></span><span class="colorbox" id="colorbox3670"><span id="textcolor3671">"</span></span>, <span class="colorbox" id="colorbox3672"><span id="textcolor3673">"</span></span><span class="colorbox" id="colorbox3674"><span id="textcolor3675">URL</span></span><span class="colorbox" id="colorbox3676"><span id="textcolor3677">"</span></span>, <span id="textcolor3678">NULL</span>}
<br class="fancyvrb"><a id="x34-165268r102"></a>102  };<br class="fancyvrb"><a id="x34-165270r103"></a>103  <br class="fancyvrb"><a id="x34-165272r104"></a>104  Shell CONFIGURE_SH = {<br class="fancyvrb"><a id="x34-165274r105"></a>105      .exe = <span class="colorbox" id="colorbox3679"><span id="textcolor3680">"</span></span><span class="colorbox" id="colorbox3681"><span id="textcolor3682">./configure</span></span><span class="colorbox" id="colorbox3683"><span id="textcolor3684">"</span></span>,
<br class="fancyvrb"><a id="x34-165276r106"></a>106      .dir = <span class="colorbox" id="colorbox3685"><span id="textcolor3686">"</span></span><span class="colorbox" id="colorbox3687"><span id="textcolor3688">/tmp/pkg-build</span></span><span class="colorbox" id="colorbox3689"><span id="textcolor3690">"</span></span>,<br class="fancyvrb"><a id="x34-165278r107"></a>107      .args = {<span class="colorbox" id="colorbox3691"><span id="textcolor3692">"</span></span><span class="colorbox" id="colorbox3693"><span id="textcolor3694">configure</span></span><span class="colorbox" id="colorbox3695"><span id="textcolor3696">"</span></span>, <span class="colorbox" id="colorbox3697"><span id="textcolor3698">"</span></span><span class="colorbox" id="colorbox3699"><span id="textcolor3700">OPTS</span></span><span class="colorbox" id="colorbox3701"><span id="textcolor3702">"</span></span>, <span id="textcolor3703">NULL</span>},
<br class="fancyvrb"><a id="x34-165280r108"></a>108  };<br class="fancyvrb"><a id="x34-165282r109"></a>109  <br class="fancyvrb"><a id="x34-165284r110"></a>110  Shell MAKE_SH = {<br class="fancyvrb"><a id="x34-165286r111"></a>111      .exe = <span class="colorbox" id="colorbox3704"><span id="textcolor3705">"</span></span><span class="colorbox" id="colorbox3706"><span id="textcolor3707">make</span></span><span class="colorbox" id="colorbox3708"><span id="textcolor3709">"</span></span>,<br class="fancyvrb"><a id="x34-165288r112"></a>112      .dir = <span class="colorbox" id="colorbox3710"><span id="textcolor3711">"</span></span><span class="colorbox" id="colorbox3712"><span id="textcolor3713">/tmp/pkg-build</span></span><span class="colorbox" id="colorbox3714"><span id="textcolor3715">"</span></span>,
<br class="fancyvrb"><a id="x34-165290r113"></a>113      .args = {<span class="colorbox" id="colorbox3716"><span id="textcolor3717">"</span></span><span class="colorbox" id="colorbox3718"><span id="textcolor3719">make</span></span><span class="colorbox" id="colorbox3720"><span id="textcolor3721">"</span></span>, <span class="colorbox" id="colorbox3722"><span id="textcolor3723">"</span></span><span class="colorbox" id="colorbox3724"><span id="textcolor3725">OPTS</span></span><span class="colorbox" id="colorbox3726"><span id="textcolor3727">"</span></span>, <span id="textcolor3728">NULL</span>}<br class="fancyvrb"><a id="x34-165292r114"></a>114  };<br class="fancyvrb"><a id="x34-165294r115"></a>115  <br class="fancyvrb"><a id="x34-165296r116"></a>116  Shell INSTALL_SH = {<br class="fancyvrb"><a id="x34-165298r117"></a>117      .exe = <span class="colorbox" id="colorbox3729"><span id="textcolor3730">"</span></span><span class="colorbox" id="colorbox3731"><span id="textcolor3732">sudo</span></span><span class="colorbox" id="colorbox3733"><span id="textcolor3734">"</span></span>,
<br class="fancyvrb"><a id="x34-165300r118"></a>118      .dir = <span class="colorbox" id="colorbox3735"><span id="textcolor3736">"</span></span><span class="colorbox" id="colorbox3737"><span id="textcolor3738">/tmp/pkg-build</span></span><span class="colorbox" id="colorbox3739"><span id="textcolor3740">"</span></span>,<br class="fancyvrb"><a id="x34-165302r119"></a>119      .args = {<span class="colorbox" id="colorbox3741"><span id="textcolor3742">"</span></span><span class="colorbox" id="colorbox3743"><span id="textcolor3744">sudo</span></span><span class="colorbox" id="colorbox3745"><span id="textcolor3746">"</span></span>, <span class="colorbox" id="colorbox3747"><span id="textcolor3748">"</span></span><span class="colorbox" id="colorbox3749"><span id="textcolor3750">make</span></span><span class="colorbox" id="colorbox3751"><span id="textcolor3752">"</span></span>, <span class="colorbox" id="colorbox3753"><span id="textcolor3754">"</span></span><span class="colorbox" id="colorbox3755"><span id="textcolor3756">TARGET</span></span><span class="colorbox" id="colorbox3757"><span id="textcolor3758">"</span></span>, <span id="textcolor3759">NULL</span>}<br class="fancyvrb"><a id="x34-165304r120"></a>120  };</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 591--><p class="indent">    从下往上倒着阅读 shell.c 里边的代码（这也是常见的 C 代码布局格式），你会看到我创建了实际用到的 Shell 变量，它们在 shell.h 中是以 extern 的形式声明的。它们就住在这里，但它们对于程序剩下的部分都是有效的。这样你就创建了一个住在.o 文件中，但是可以在任何位置使用的全局变量。
创造太多的全局变量不是一件好事情，不过在当前场合下还是比较合适的。
<!--l. 596--></p><p class="indent">    继续向上阅读我们就看到了 Shell_run 函数，这是一个“基础”函数，它会基于 Shell struct 中的内容执行一条指定的命令。这里使用了很多定义在 apr_thread_proc.h 中的函数，所以你需要去找出并学习每条函数的作用。比起直接调用 system 而言，这样似乎麻烦了许多，不过这样做的一个好处就是能让你更好地控制外部命令执行的一些细节。例如，在 Shell
struct 中我们有一个.dir 属性，它可以强制规定程序在某个指定的路径下运行。
<!--l. 602--></p><p class="indent">    最后，我写了 Shell_exec 这个函数，它是一个“可变参数”函数。这样的函数你已经见过了，不过请确认你明白了 stdarg.h 里的各个函数定义，并且知道怎样可以写出来这样的函数。在本节的挑战环节你将需要却分析这个函数。
    </p><h5 class="subsubsectionHead"><a id="x34-16600029.4.2"></a>挑战2: 分析Shell_exec</h5>
<!--l. 608--><p class="noindent">Challenge for these files (in addition to a full code review just like you did in
Challenge 1) is to fully analyze Shell_exec and break down exactly how it works.
You should be able to understand each line, how the two for-loops work, and
how arguments are being replaced.
<!--l. 613--></p><p class="indent">    Once you have it analyzed, add a field to struct Shell that gives the number
of variable args that must be replaced. Update all the commands to have the right
count of args, and then have an error check that confirms these args have been
replaced and error exit.
                                                                  

                                                                  
<!--l. 618--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">29.4.3    </span> <a id="x34-16700029.4.3"></a>The Command Functions</h4>
<!--l. 620--><p class="noindent">Now you get to make the actual commands that do the work. These commands
will use functions from APR, db.h and shell.h to do the real work of
downloading and building software you want it to build. This is the most
complex set of files, so do them carefully. As before, you start by making
the commands.h file, then implementing its functions in the commands.c
file.
                                                                  

                                                                  
<!--l. 627--></p><p class="indent">    <a id="x34-167001r74"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 74: </span><span class="content">                                                                                                  commands.h</span></div><!--tex4ht:label?: x34-167001r74 -->
<div class="fancyvrb" id="fancyvrb42"><a id="x34-167003r1"></a>1  <span id="textcolor3760">#</span><span id="textcolor3761">ifndef _commands_h</span><br class="fancyvrb"><a id="x34-167005r2"></a>2  <span id="textcolor3762">#</span><span id="textcolor3763">define _commands_h</span><br class="fancyvrb"><a id="x34-167007r3"></a>3  <br class="fancyvrb"><a id="x34-167009r4"></a>4  <span id="textcolor3764">#</span><span id="textcolor3765">include <apr_pools.h></apr_pools.h></span><br class="fancyvrb"><a id="x34-167011r5"></a>5  
<br class="fancyvrb"><a id="x34-167013r6"></a>6  <span id="textcolor3766">#</span><span id="textcolor3767">define DEPENDS_PATH "</span><span id="textcolor3768">/</span><span id="textcolor3769">tmp</span><span id="textcolor3770">/</span><span id="textcolor3771">DEPENDS"</span><br class="fancyvrb"><a id="x34-167015r7"></a>7  <span id="textcolor3772">#</span><span id="textcolor3773">define TAR_GZ_SRC "</span><span id="textcolor3774">/</span><span id="textcolor3775">tmp</span><span id="textcolor3776">/</span><span id="textcolor3777">pkg-src.tar.gz"</span>
<br class="fancyvrb"><a id="x34-167017r8"></a>8  <span id="textcolor3778">#</span><span id="textcolor3779">define TAR_BZ2_SRC "</span><span id="textcolor3780">/</span><span id="textcolor3781">tmp</span><span id="textcolor3782">/</span><span id="textcolor3783">pkg-src.tar.bz2"</span><br class="fancyvrb"><a id="x34-167019r9"></a>9  <span id="textcolor3784">#</span><span id="textcolor3785">define BUILD_DIR "</span><span id="textcolor3786">/</span><span id="textcolor3787">tmp</span><span id="textcolor3788">/</span><span id="textcolor3789">pkg-build"</span>
<br class="fancyvrb"><a id="x34-167021r10"></a>10  <span id="textcolor3790">#</span><span id="textcolor3791">define GIT_PAT "⋆.git"</span><br class="fancyvrb"><a id="x34-167023r11"></a>11  <span id="textcolor3792">#</span><span id="textcolor3793">define DEPEND_PAT "⋆DEPENDS"</span>
<br class="fancyvrb"><a id="x34-167025r12"></a>12  <span id="textcolor3794">#</span><span id="textcolor3795">define TAR_GZ_PAT "⋆.tar.gz"</span><br class="fancyvrb"><a id="x34-167027r13"></a>13  <span id="textcolor3796">#</span><span id="textcolor3797">define TAR_BZ2_PAT "⋆.tar.bz2"</span>
<br class="fancyvrb"><a id="x34-167029r14"></a>14  <span id="textcolor3798">#</span><span id="textcolor3799">define CONFIG_SCRIPT "</span><span id="textcolor3800">/</span><span id="textcolor3801">tmp</span><span id="textcolor3802">/</span><span id="textcolor3803">pkg-build</span><span id="textcolor3804">/</span><span id="textcolor3805">configure"</span><br class="fancyvrb"><a id="x34-167031r15"></a>15  <br class="fancyvrb"><a id="x34-167033r16"></a>16  <span id="textcolor3806">enum</span> CommandType {
<br class="fancyvrb"><a id="x34-167035r17"></a>17      COMMAND_NONE, COMMAND_INSTALL, COMMAND_LIST, COMMAND_FETCH,
<br class="fancyvrb"><a id="x34-167037r18"></a>18      COMMAND_INIT, COMMAND_BUILD<br class="fancyvrb"><a id="x34-167039r19"></a>19  };<br class="fancyvrb"><a id="x34-167041r20"></a>20  <br class="fancyvrb"><a id="x34-167043r21"></a>21  
<br class="fancyvrb"><a id="x34-167045r22"></a>22  <span id="textcolor3807">int</span> Command_fetch(apr_pool_t ⋆p, <span id="textcolor3808">const</span> <span id="textcolor3809">char</span> ⋆url, <span id="textcolor3810">int</span> fetch_only);<br class="fancyvrb"><a id="x34-167047r23"></a>23  
<br class="fancyvrb"><a id="x34-167049r24"></a>24  <span id="textcolor3811">int</span> Command_install(apr_pool_t ⋆p, <span id="textcolor3812">const</span> <span id="textcolor3813">char</span> ⋆url, <span id="textcolor3814">const</span> <span id="textcolor3815">char</span> ⋆configure_opts,
<br class="fancyvrb"><a id="x34-167051r25"></a>25          <span id="textcolor3816">const</span> <span id="textcolor3817">char</span> ⋆make_opts, <span id="textcolor3818">const</span> <span id="textcolor3819">char</span> ⋆install_opts);
<br class="fancyvrb"><a id="x34-167053r26"></a>26  <br class="fancyvrb"><a id="x34-167055r27"></a>27  <span id="textcolor3820">int</span> Command_depends(apr_pool_t ⋆p, <span id="textcolor3821">const</span> <span id="textcolor3822">char</span> ⋆path);<br class="fancyvrb"><a id="x34-167057r28"></a>28  
<br class="fancyvrb"><a id="x34-167059r29"></a>29  <span id="textcolor3823">int</span> Command_build(apr_pool_t ⋆p, <span id="textcolor3824">const</span> <span id="textcolor3825">char</span> ⋆url, <span id="textcolor3826">const</span> <span id="textcolor3827">char</span> ⋆configure_opts,
<br class="fancyvrb"><a id="x34-167061r30"></a>30          <span id="textcolor3828">const</span> <span id="textcolor3829">char</span> ⋆make_opts, <span id="textcolor3830">const</span> <span id="textcolor3831">char</span> ⋆install_opts);<br class="fancyvrb"><a id="x34-167063r31"></a>31  <br class="fancyvrb"><a id="x34-167065r32"></a>32  <span id="textcolor3832">#</span><span id="textcolor3833">endif</span></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 665--><p class="indent">    There’s not much in commands.h that you haven’t seen already. You should see
that there’s some defines for strings that are used everywhere. The real interesting
code is in commands.c.
                                                                  

                                                                  
<!--l. 669--></p><p class="indent">    <a id="x34-167066r75"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 75: </span><span class="content">                                                                                                  commands.c</span></div><!--tex4ht:label?: x34-167066r75 -->
<div class="fancyvrb" id="fancyvrb43"><a id="x34-167068r1"></a>1  <span id="textcolor3834">#</span><span id="textcolor3835">include <apr_uri.h></apr_uri.h></span><br class="fancyvrb"><a id="x34-167070r2"></a>2  <span id="textcolor3836">#</span><span id="textcolor3837">include <apr_fnmatch.h></apr_fnmatch.h></span><br class="fancyvrb"><a id="x34-167072r3"></a>3  <span id="textcolor3838">#</span><span id="textcolor3839">include <unistd.h></unistd.h></span><br class="fancyvrb"><a id="x34-167074r4"></a>4  
<br class="fancyvrb"><a id="x34-167076r5"></a>5  <span id="textcolor3840">#</span><span id="textcolor3841">include "commands.h"</span><br class="fancyvrb"><a id="x34-167078r6"></a>6  <span id="textcolor3842">#</span><span id="textcolor3843">include "dbg.h"</span><br class="fancyvrb"><a id="x34-167080r7"></a>7  <span id="textcolor3844">#</span><span id="textcolor3845">include "bstrlib.h"</span><br class="fancyvrb"><a id="x34-167082r8"></a>8  <span id="textcolor3846">#</span><span id="textcolor3847">include "db.h"</span>
<br class="fancyvrb"><a id="x34-167084r9"></a>9  <span id="textcolor3848">#</span><span id="textcolor3849">include "shell.h"</span><br class="fancyvrb"><a id="x34-167086r10"></a>10  <br class="fancyvrb"><a id="x34-167088r11"></a>11  <br class="fancyvrb"><a id="x34-167090r12"></a>12  <span id="textcolor3850">int</span> <span id="textcolor3851">Command_depends</span>(apr_pool_t ⋆p, <span id="textcolor3852">const</span> <span id="textcolor3853">char</span> ⋆path)
<br class="fancyvrb"><a id="x34-167092r13"></a>13  {<br class="fancyvrb"><a id="x34-167094r14"></a>14      <span id="textcolor3854">FILE</span> ⋆in = <span id="textcolor3855">NULL</span>;<br class="fancyvrb"><a id="x34-167096r15"></a>15      bstring line = <span id="textcolor3856">NULL</span>;<br class="fancyvrb"><a id="x34-167098r16"></a>16  <br class="fancyvrb"><a id="x34-167100r17"></a>17      in = fopen(path, <span class="colorbox" id="colorbox3857"><span id="textcolor3858">"</span></span><span class="colorbox" id="colorbox3859"><span id="textcolor3860">r</span></span><span class="colorbox" id="colorbox3861"><span id="textcolor3862">"</span></span>);
<br class="fancyvrb"><a id="x34-167102r18"></a>18      check(in != <span id="textcolor3863">NULL</span>, <span class="colorbox" id="colorbox3864"><span id="textcolor3865">"</span></span><span class="colorbox" id="colorbox3866"><span id="textcolor3867">Failed to open downloaded depends: %s</span></span><span class="colorbox" id="colorbox3868"><span id="textcolor3869">"</span></span>, path);
<br class="fancyvrb"><a id="x34-167104r19"></a>19  <br class="fancyvrb"><a id="x34-167106r20"></a>20      <span id="textcolor3870">for</span>(line = bgets((bNgetc)fgetc, in, <span class="colorbox" id="colorbox3871"><span id="textcolor3872">’\n’</span></span>); line != <span id="textcolor3873">NULL</span>;
<br class="fancyvrb"><a id="x34-167108r21"></a>21              line = bgets((bNgetc)fgetc, in, <span class="colorbox" id="colorbox3874"><span id="textcolor3875">’\n’</span></span>))<br class="fancyvrb"><a id="x34-167110r22"></a>22      {
<br class="fancyvrb"><a id="x34-167112r23"></a>23          btrimws(line);<br class="fancyvrb"><a id="x34-167114r24"></a>24          log_info(<span class="colorbox" id="colorbox3876"><span id="textcolor3877">"</span></span><span class="colorbox" id="colorbox3878"><span id="textcolor3879">Processing depends: %s</span></span><span class="colorbox" id="colorbox3880"><span id="textcolor3881">"</span></span>, bdata(line));
<br class="fancyvrb"><a id="x34-167116r25"></a>25          <span id="textcolor3882">int</span> rc = Command_install(p, bdata(line), <span id="textcolor3883">NULL</span>, <span id="textcolor3884">NULL</span>, <span id="textcolor3885">NULL</span>);
<br class="fancyvrb"><a id="x34-167118r26"></a>26          check(rc == <span id="textcolor3886">0</span>, <span class="colorbox" id="colorbox3887"><span id="textcolor3888">"</span></span><span class="colorbox" id="colorbox3889"><span id="textcolor3890">Failed to install: %s</span></span><span class="colorbox" id="colorbox3891"><span id="textcolor3892">"</span></span>, bdata(line));
<br class="fancyvrb"><a id="x34-167120r27"></a>27          bdestroy(line);<br class="fancyvrb"><a id="x34-167122r28"></a>28      }<br class="fancyvrb"><a id="x34-167124r29"></a>29  <br class="fancyvrb"><a id="x34-167126r30"></a>30      fclose(in);<br class="fancyvrb"><a id="x34-167128r31"></a>31      <span id="textcolor3893">return</span> <span id="textcolor3894">0</span>;<br class="fancyvrb"><a id="x34-167130r32"></a>32  <br class="fancyvrb"><a id="x34-167132r33"></a>33  <span id="textcolor3895">error:</span>
<br class="fancyvrb"><a id="x34-167134r34"></a>34      <span id="textcolor3896">if</span>(line) bdestroy(line);<br class="fancyvrb"><a id="x34-167136r35"></a>35      <span id="textcolor3897">if</span>(in) fclose(in);<br class="fancyvrb"><a id="x34-167138r36"></a>36      <span id="textcolor3898">return</span> -<span id="textcolor3899">1</span>;<br class="fancyvrb"><a id="x34-167140r37"></a>37  }
<br class="fancyvrb"><a id="x34-167142r38"></a>38  <br class="fancyvrb"><a id="x34-167144r39"></a>39  <span id="textcolor3900">int</span> <span id="textcolor3901">Command_fetch</span>(apr_pool_t ⋆p, <span id="textcolor3902">const</span> <span id="textcolor3903">char</span> ⋆url, <span id="textcolor3904">int</span> fetch_only)<br class="fancyvrb"><a id="x34-167146r40"></a>40  {
<br class="fancyvrb"><a id="x34-167148r41"></a>41      apr_uri_t info = {.port = <span id="textcolor3905">0</span>};<br class="fancyvrb"><a id="x34-167150r42"></a>42      <span id="textcolor3906">int</span> rc = <span id="textcolor3907">0</span>;<br class="fancyvrb"><a id="x34-167152r43"></a>43      <span id="textcolor3908">const</span> <span id="textcolor3909">char</span> ⋆depends_file = <span id="textcolor3910">NULL</span>;
<br class="fancyvrb"><a id="x34-167154r44"></a>44      apr_status_t rv = apr_uri_parse(p, url, &amp;info);<br class="fancyvrb"><a id="x34-167156r45"></a>45  
<br class="fancyvrb"><a id="x34-167158r46"></a>46      check(rv == APR_SUCCESS, <span class="colorbox" id="colorbox3911"><span id="textcolor3912">"</span></span><span class="colorbox" id="colorbox3913"><span id="textcolor3914">Failed to parse URL: %s</span></span><span class="colorbox" id="colorbox3915"><span id="textcolor3916">"</span></span>, url);<br class="fancyvrb"><a id="x34-167160r47"></a>47  
<br class="fancyvrb"><a id="x34-167162r48"></a>48      <span id="textcolor3917">if</span>(apr_fnmatch(GIT_PAT, info.path, <span id="textcolor3918">0</span>) == APR_SUCCESS) {
<br class="fancyvrb"><a id="x34-167164r49"></a>49          rc = Shell_exec(GIT_SH, <span class="colorbox" id="colorbox3919"><span id="textcolor3920">"</span></span><span class="colorbox" id="colorbox3921"><span id="textcolor3922">URL</span></span><span class="colorbox" id="colorbox3923"><span id="textcolor3924">"</span></span>, url, <span id="textcolor3925">NULL</span>);
<br class="fancyvrb"><a id="x34-167166r50"></a>50          check(rc == <span id="textcolor3926">0</span>, <span class="colorbox" id="colorbox3927"><span id="textcolor3928">"</span></span><span class="colorbox" id="colorbox3929"><span id="textcolor3930">git failed.</span></span><span class="colorbox" id="colorbox3931"><span id="textcolor3932">"</span></span>);
<br class="fancyvrb"><a id="x34-167168r51"></a>51      } <span id="textcolor3933">else</span> <span id="textcolor3934">if</span>(apr_fnmatch(DEPEND_PAT, info.path, <span id="textcolor3935">0</span>) == APR_SUCCESS) {
<br class="fancyvrb"><a id="x34-167170r52"></a>52          check(!fetch_only, <span class="colorbox" id="colorbox3936"><span id="textcolor3937">"</span></span><span class="colorbox" id="colorbox3938"><span id="textcolor3939">No point in fetching a DEPENDS file.</span></span><span class="colorbox" id="colorbox3940"><span id="textcolor3941">"</span></span>);<br class="fancyvrb"><a id="x34-167172r53"></a>53  
<br class="fancyvrb"><a id="x34-167174r54"></a>54          <span id="textcolor3942">if</span>(info.scheme) {<br class="fancyvrb"><a id="x34-167176r55"></a>55              depends_file = DEPENDS_PATH;
<br class="fancyvrb"><a id="x34-167178r56"></a>56              rc = Shell_exec(CURL_SH, <span class="colorbox" id="colorbox3943"><span id="textcolor3944">"</span></span><span class="colorbox" id="colorbox3945"><span id="textcolor3946">URL</span></span><span class="colorbox" id="colorbox3947"><span id="textcolor3948">"</span></span>, url, <span class="colorbox" id="colorbox3949"><span id="textcolor3950">"</span></span><span class="colorbox" id="colorbox3951"><span id="textcolor3952">TARGET</span></span><span class="colorbox" id="colorbox3953"><span id="textcolor3954">"</span></span>, depends_file, <span id="textcolor3955">NULL</span>);
<br class="fancyvrb"><a id="x34-167180r57"></a>57              check(rc == <span id="textcolor3956">0</span>, <span class="colorbox" id="colorbox3957"><span id="textcolor3958">"</span></span><span class="colorbox" id="colorbox3959"><span id="textcolor3960">Curl failed.</span></span><span class="colorbox" id="colorbox3961"><span id="textcolor3962">"</span></span>);<br class="fancyvrb"><a id="x34-167182r58"></a>58          } <span id="textcolor3963">else</span> {
<br class="fancyvrb"><a id="x34-167184r59"></a>59              depends_file = info.path;<br class="fancyvrb"><a id="x34-167186r60"></a>60          }
<br class="fancyvrb"><a id="x34-167188r61"></a>61  <br class="fancyvrb"><a id="x34-167190r62"></a>62          <span id="textcolor3964">// recursively process the devpkg list</span>
<br class="fancyvrb"><a id="x34-167192r63"></a>63          log_info(<span class="colorbox" id="colorbox3965"><span id="textcolor3966">"</span></span><span class="colorbox" id="colorbox3967"><span id="textcolor3968">Building according to DEPENDS: %s</span></span><span class="colorbox" id="colorbox3969"><span id="textcolor3970">"</span></span>, url);
<br class="fancyvrb"><a id="x34-167194r64"></a>64          rv = Command_depends(p, depends_file);
<br class="fancyvrb"><a id="x34-167196r65"></a>65          check(rv == <span id="textcolor3971">0</span>, <span class="colorbox" id="colorbox3972"><span id="textcolor3973">"</span></span><span class="colorbox" id="colorbox3974"><span id="textcolor3975">Failed to process the DEPENDS: %s</span></span><span class="colorbox" id="colorbox3976"><span id="textcolor3977">"</span></span>, url);<br class="fancyvrb"><a id="x34-167198r66"></a>66  
<br class="fancyvrb"><a id="x34-167200r67"></a>67          <span id="textcolor3978">// this indicates that nothing needs to be done</span><br class="fancyvrb"><a id="x34-167202r68"></a>68          <span id="textcolor3979">return</span> <span id="textcolor3980">0</span>;
<br class="fancyvrb"><a id="x34-167204r69"></a>69  <br class="fancyvrb"><a id="x34-167206r70"></a>70      } <span id="textcolor3981">else</span> <span id="textcolor3982">if</span>(apr_fnmatch(TAR_GZ_PAT, info.path, <span id="textcolor3983">0</span>) == APR_SUCCESS) {
<br class="fancyvrb"><a id="x34-167208r71"></a>71          <span id="textcolor3984">if</span>(info.scheme) {<br class="fancyvrb"><a id="x34-167210r72"></a>72              rc = Shell_exec(CURL_SH,
<br class="fancyvrb"><a id="x34-167212r73"></a>73                      <span class="colorbox" id="colorbox3985"><span id="textcolor3986">"</span></span><span class="colorbox" id="colorbox3987"><span id="textcolor3988">URL</span></span><span class="colorbox" id="colorbox3989"><span id="textcolor3990">"</span></span>, url,<br class="fancyvrb"><a id="x34-167214r74"></a>74                      <span class="colorbox" id="colorbox3991"><span id="textcolor3992">"</span></span><span class="colorbox" id="colorbox3993"><span id="textcolor3994">TARGET</span></span><span class="colorbox" id="colorbox3995"><span id="textcolor3996">"</span></span>, TAR_GZ_SRC, <span id="textcolor3997">NULL</span>);
<br class="fancyvrb"><a id="x34-167216r75"></a>75              check(rc == <span id="textcolor3998">0</span>, <span class="colorbox" id="colorbox3999"><span id="textcolor4000">"</span></span><span class="colorbox" id="colorbox4001"><span id="textcolor4002">Failed to curl source: %s</span></span><span class="colorbox" id="colorbox4003"><span id="textcolor4004">"</span></span>, url);
<br class="fancyvrb"><a id="x34-167218r76"></a>76          }<br class="fancyvrb"><a id="x34-167220r77"></a>77  <br class="fancyvrb"><a id="x34-167222r78"></a>78          rv = apr_dir_make_recursive(BUILD_DIR,
<br class="fancyvrb"><a id="x34-167224r79"></a>79                  APR_UREAD | APR_UWRITE | APR_UEXECUTE, p);
                                                                  

                                                                  
<br class="fancyvrb"><a id="x34-167226r80"></a>80          check(rv == APR_SUCCESS, <span class="colorbox" id="colorbox4005"><span id="textcolor4006">"</span></span><span class="colorbox" id="colorbox4007"><span id="textcolor4008">Failed to make directory %s</span></span><span class="colorbox" id="colorbox4009"><span id="textcolor4010">"</span></span>, BUILD_DIR);
<br class="fancyvrb"><a id="x34-167228r81"></a>81  <br class="fancyvrb"><a id="x34-167230r82"></a>82          rc = Shell_exec(TAR_SH, <span class="colorbox" id="colorbox4011"><span id="textcolor4012">"</span></span><span class="colorbox" id="colorbox4013"><span id="textcolor4014">FILE</span></span><span class="colorbox" id="colorbox4015"><span id="textcolor4016">"</span></span>, TAR_GZ_SRC, <span id="textcolor4017">NULL</span>);
<br class="fancyvrb"><a id="x34-167232r83"></a>83          check(rc == <span id="textcolor4018">0</span>, <span class="colorbox" id="colorbox4019"><span id="textcolor4020">"</span></span><span class="colorbox" id="colorbox4021"><span id="textcolor4022">Failed to untar %s</span></span><span class="colorbox" id="colorbox4023"><span id="textcolor4024">"</span></span>, TAR_GZ_SRC);
<br class="fancyvrb"><a id="x34-167234r84"></a>84      } <span id="textcolor4025">else</span> <span id="textcolor4026">if</span>(apr_fnmatch(TAR_BZ2_PAT, info.path, <span id="textcolor4027">0</span>) == APR_SUCCESS) {
<br class="fancyvrb"><a id="x34-167236r85"></a>85          <span id="textcolor4028">if</span>(info.scheme) {
<br class="fancyvrb"><a id="x34-167238r86"></a>86              rc = Shell_exec(CURL_SH, <span class="colorbox" id="colorbox4029"><span id="textcolor4030">"</span></span><span class="colorbox" id="colorbox4031"><span id="textcolor4032">URL</span></span><span class="colorbox" id="colorbox4033"><span id="textcolor4034">"</span></span>, url, <span class="colorbox" id="colorbox4035"><span id="textcolor4036">"</span></span><span class="colorbox" id="colorbox4037"><span id="textcolor4038">TARGET</span></span><span class="colorbox" id="colorbox4039"><span id="textcolor4040">"</span></span>, TAR_BZ2_SRC, <span id="textcolor4041">NULL</span>);
<br class="fancyvrb"><a id="x34-167240r87"></a>87              check(rc == <span id="textcolor4042">0</span>, <span class="colorbox" id="colorbox4043"><span id="textcolor4044">"</span></span><span class="colorbox" id="colorbox4045"><span id="textcolor4046">Curl failed.</span></span><span class="colorbox" id="colorbox4047"><span id="textcolor4048">"</span></span>);<br class="fancyvrb"><a id="x34-167242r88"></a>88          }<br class="fancyvrb"><a id="x34-167244r89"></a>89  
<br class="fancyvrb"><a id="x34-167246r90"></a>90          apr_status_t rc = apr_dir_make_recursive(BUILD_DIR,
<br class="fancyvrb"><a id="x34-167248r91"></a>91                  APR_UREAD | APR_UWRITE | APR_UEXECUTE, p);<br class="fancyvrb"><a id="x34-167250r92"></a>92  
<br class="fancyvrb"><a id="x34-167252r93"></a>93          check(rc == <span id="textcolor4049">0</span>, <span class="colorbox" id="colorbox4050"><span id="textcolor4051">"</span></span><span class="colorbox" id="colorbox4052"><span id="textcolor4053">Failed to make directory %s</span></span><span class="colorbox" id="colorbox4054"><span id="textcolor4055">"</span></span>, BUILD_DIR);
<br class="fancyvrb"><a id="x34-167254r94"></a>94          rc = Shell_exec(TAR_SH, <span class="colorbox" id="colorbox4056"><span id="textcolor4057">"</span></span><span class="colorbox" id="colorbox4058"><span id="textcolor4059">FILE</span></span><span class="colorbox" id="colorbox4060"><span id="textcolor4061">"</span></span>, TAR_BZ2_SRC, <span id="textcolor4062">NULL</span>);
<br class="fancyvrb"><a id="x34-167256r95"></a>95          check(rc == <span id="textcolor4063">0</span>, <span class="colorbox" id="colorbox4064"><span id="textcolor4065">"</span></span><span class="colorbox" id="colorbox4066"><span id="textcolor4067">Failed to untar %s</span></span><span class="colorbox" id="colorbox4068"><span id="textcolor4069">"</span></span>, TAR_BZ2_SRC);
<br class="fancyvrb"><a id="x34-167258r96"></a>96      } <span id="textcolor4070">else</span> {<br class="fancyvrb"><a id="x34-167260r97"></a>97          sentinel(<span class="colorbox" id="colorbox4071"><span id="textcolor4072">"</span></span><span class="colorbox" id="colorbox4073"><span id="textcolor4074">Don’t now how to handle %s</span></span><span class="colorbox" id="colorbox4075"><span id="textcolor4076">"</span></span>, url);
<br class="fancyvrb"><a id="x34-167262r98"></a>98      }<br class="fancyvrb"><a id="x34-167264r99"></a>99  <br class="fancyvrb"><a id="x34-167266r100"></a>100      <span id="textcolor4077">// indicates that an install needs to actually run</span>
<br class="fancyvrb"><a id="x34-167268r101"></a>101      <span id="textcolor4078">return</span> <span id="textcolor4079">1</span>;<br class="fancyvrb"><a id="x34-167270r102"></a>102  <span id="textcolor4080">error:</span><br class="fancyvrb"><a id="x34-167272r103"></a>103      <span id="textcolor4081">return</span> -<span id="textcolor4082">1</span>;<br class="fancyvrb"><a id="x34-167274r104"></a>104  }<br class="fancyvrb"><a id="x34-167276r105"></a>105  
<br class="fancyvrb"><a id="x34-167278r106"></a>106  <span id="textcolor4083">int</span> <span id="textcolor4084">Command_build</span>(apr_pool_t ⋆p, <span id="textcolor4085">const</span> <span id="textcolor4086">char</span> ⋆url, <span id="textcolor4087">const</span> <span id="textcolor4088">char</span> ⋆configure_opts,
<br class="fancyvrb"><a id="x34-167280r107"></a>107          <span id="textcolor4089">const</span> <span id="textcolor4090">char</span> ⋆make_opts, <span id="textcolor4091">const</span> <span id="textcolor4092">char</span> ⋆install_opts)<br class="fancyvrb"><a id="x34-167282r108"></a>108  {
<br class="fancyvrb"><a id="x34-167284r109"></a>109      <span id="textcolor4093">int</span> rc = <span id="textcolor4094">0</span>;<br class="fancyvrb"><a id="x34-167286r110"></a>110  <br class="fancyvrb"><a id="x34-167288r111"></a>111      check(access(BUILD_DIR, X_OK | R_OK | W_OK) == <span id="textcolor4095">0</span>,
<br class="fancyvrb"><a id="x34-167290r112"></a>112              <span class="colorbox" id="colorbox4096"><span id="textcolor4097">"</span></span><span class="colorbox" id="colorbox4098"><span id="textcolor4099">Build directory doesn’t exist: %s</span></span><span class="colorbox" id="colorbox4100"><span id="textcolor4101">"</span></span>, BUILD_DIR);<br class="fancyvrb"><a id="x34-167292r113"></a>113  
<br class="fancyvrb"><a id="x34-167294r114"></a>114      <span id="textcolor4102">// actually do an install</span><br class="fancyvrb"><a id="x34-167296r115"></a>115      <span id="textcolor4103">if</span>(access(CONFIG_SCRIPT, X_OK) == <span id="textcolor4104">0</span>) {
<br class="fancyvrb"><a id="x34-167298r116"></a>116          log_info(<span class="colorbox" id="colorbox4105"><span id="textcolor4106">"</span></span><span class="colorbox" id="colorbox4107"><span id="textcolor4108">Has a configure script, running it.</span></span><span class="colorbox" id="colorbox4109"><span id="textcolor4110">"</span></span>);
<br class="fancyvrb"><a id="x34-167300r117"></a>117          rc = Shell_exec(CONFIGURE_SH, <span class="colorbox" id="colorbox4111"><span id="textcolor4112">"</span></span><span class="colorbox" id="colorbox4113"><span id="textcolor4114">OPTS</span></span><span class="colorbox" id="colorbox4115"><span id="textcolor4116">"</span></span>, configure_opts, <span id="textcolor4117">NULL</span>);
<br class="fancyvrb"><a id="x34-167302r118"></a>118          check(rc == <span id="textcolor4118">0</span>, <span class="colorbox" id="colorbox4119"><span id="textcolor4120">"</span></span><span class="colorbox" id="colorbox4121"><span id="textcolor4122">Failed to configure.</span></span><span class="colorbox" id="colorbox4123"><span id="textcolor4124">"</span></span>);<br class="fancyvrb"><a id="x34-167304r119"></a>119      }<br class="fancyvrb"><a id="x34-167306r120"></a>120  
<br class="fancyvrb"><a id="x34-167308r121"></a>121      rc = Shell_exec(MAKE_SH, <span class="colorbox" id="colorbox4125"><span id="textcolor4126">"</span></span><span class="colorbox" id="colorbox4127"><span id="textcolor4128">OPTS</span></span><span class="colorbox" id="colorbox4129"><span id="textcolor4130">"</span></span>, make_opts, <span id="textcolor4131">NULL</span>);
<br class="fancyvrb"><a id="x34-167310r122"></a>122      check(rc == <span id="textcolor4132">0</span>, <span class="colorbox" id="colorbox4133"><span id="textcolor4134">"</span></span><span class="colorbox" id="colorbox4135"><span id="textcolor4136">Failed to build.</span></span><span class="colorbox" id="colorbox4137"><span id="textcolor4138">"</span></span>);<br class="fancyvrb"><a id="x34-167312r123"></a>123  <br class="fancyvrb"><a id="x34-167314r124"></a>124      rc = Shell_exec(INSTALL_SH,
<br class="fancyvrb"><a id="x34-167316r125"></a>125              <span class="colorbox" id="colorbox4139"><span id="textcolor4140">"</span></span><span class="colorbox" id="colorbox4141"><span id="textcolor4142">TARGET</span></span><span class="colorbox" id="colorbox4143"><span id="textcolor4144">"</span></span>, install_opts ? install_opts : <span class="colorbox" id="colorbox4145"><span id="textcolor4146">"</span></span><span class="colorbox" id="colorbox4147"><span id="textcolor4148">install</span></span><span class="colorbox" id="colorbox4149"><span id="textcolor4150">"</span></span>,<br class="fancyvrb"><a id="x34-167318r126"></a>126              <span id="textcolor4151">NULL</span>);
<br class="fancyvrb"><a id="x34-167320r127"></a>127      check(rc == <span id="textcolor4152">0</span>, <span class="colorbox" id="colorbox4153"><span id="textcolor4154">"</span></span><span class="colorbox" id="colorbox4155"><span id="textcolor4156">Failed to install.</span></span><span class="colorbox" id="colorbox4157"><span id="textcolor4158">"</span></span>);<br class="fancyvrb"><a id="x34-167322r128"></a>128  <br class="fancyvrb"><a id="x34-167324r129"></a>129      rc = Shell_exec(CLEANUP_SH, <span id="textcolor4159">NULL</span>);
<br class="fancyvrb"><a id="x34-167326r130"></a>130      check(rc == <span id="textcolor4160">0</span>, <span class="colorbox" id="colorbox4161"><span id="textcolor4162">"</span></span><span class="colorbox" id="colorbox4163"><span id="textcolor4164">Failed to cleanup after build.</span></span><span class="colorbox" id="colorbox4165"><span id="textcolor4166">"</span></span>);<br class="fancyvrb"><a id="x34-167328r131"></a>131  <br class="fancyvrb"><a id="x34-167330r132"></a>132      rc = DB_update(url);
<br class="fancyvrb"><a id="x34-167332r133"></a>133      check(rc == <span id="textcolor4167">0</span>, <span class="colorbox" id="colorbox4168"><span id="textcolor4169">"</span></span><span class="colorbox" id="colorbox4170"><span id="textcolor4171">Failed to add this package to the database.</span></span><span class="colorbox" id="colorbox4172"><span id="textcolor4173">"</span></span>);
<br class="fancyvrb"><a id="x34-167334r134"></a>134  <br class="fancyvrb"><a id="x34-167336r135"></a>135      <span id="textcolor4174">return</span> <span id="textcolor4175">0</span>;<br class="fancyvrb"><a id="x34-167338r136"></a>136  <br class="fancyvrb"><a id="x34-167340r137"></a>137  <span id="textcolor4176">error:</span><br class="fancyvrb"><a id="x34-167342r138"></a>138      <span id="textcolor4177">return</span> -<span id="textcolor4178">1</span>;<br class="fancyvrb"><a id="x34-167344r139"></a>139  }<br class="fancyvrb"><a id="x34-167346r140"></a>140  
<br class="fancyvrb"><a id="x34-167348r141"></a>141  <span id="textcolor4179">int</span> <span id="textcolor4180">Command_install</span>(apr_pool_t ⋆p, <span id="textcolor4181">const</span> <span id="textcolor4182">char</span> ⋆url, <span id="textcolor4183">const</span> <span id="textcolor4184">char</span> ⋆configure_opts,
<br class="fancyvrb"><a id="x34-167350r142"></a>142          <span id="textcolor4185">const</span> <span id="textcolor4186">char</span> ⋆make_opts, <span id="textcolor4187">const</span> <span id="textcolor4188">char</span> ⋆install_opts)<br class="fancyvrb"><a id="x34-167352r143"></a>143  {<br class="fancyvrb"><a id="x34-167354r144"></a>144      <span id="textcolor4189">int</span> rc = <span id="textcolor4190">0</span>;
<br class="fancyvrb"><a id="x34-167356r145"></a>145      check(Shell_exec(CLEANUP_SH, <span id="textcolor4191">NULL</span>) == <span id="textcolor4192">0</span>, <span class="colorbox" id="colorbox4193"><span id="textcolor4194">"</span></span><span class="colorbox" id="colorbox4195"><span id="textcolor4196">Failed to cleanup before building.</span></span><span class="colorbox" id="colorbox4197"><span id="textcolor4198">"</span></span>);<br class="fancyvrb"><a id="x34-167358r146"></a>146  
<br class="fancyvrb"><a id="x34-167360r147"></a>147      rc = DB_find(url);<br class="fancyvrb"><a id="x34-167362r148"></a>148      check(rc != -<span id="textcolor4199">1</span>, <span class="colorbox" id="colorbox4200"><span id="textcolor4201">"</span></span><span class="colorbox" id="colorbox4202"><span id="textcolor4203">Error checking the install database.</span></span><span class="colorbox" id="colorbox4204"><span id="textcolor4205">"</span></span>);
<br class="fancyvrb"><a id="x34-167364r149"></a>149  <br class="fancyvrb"><a id="x34-167366r150"></a>150      <span id="textcolor4206">if</span>(rc == <span id="textcolor4207">1</span>) {<br class="fancyvrb"><a id="x34-167368r151"></a>151          log_info(<span class="colorbox" id="colorbox4208"><span id="textcolor4209">"</span></span><span class="colorbox" id="colorbox4210"><span id="textcolor4211">Package %s already installed.</span></span><span class="colorbox" id="colorbox4212"><span id="textcolor4213">"</span></span>, url);
<br class="fancyvrb"><a id="x34-167370r152"></a>152          <span id="textcolor4214">return</span> <span id="textcolor4215">0</span>;<br class="fancyvrb"><a id="x34-167372r153"></a>153      }<br class="fancyvrb"><a id="x34-167374r154"></a>154  <br class="fancyvrb"><a id="x34-167376r155"></a>155      rc = Command_fetch(p, url, <span id="textcolor4216">0</span>);<br class="fancyvrb"><a id="x34-167378r156"></a>156  <br class="fancyvrb"><a id="x34-167380r157"></a>157      <span id="textcolor4217">if</span>(rc == <span id="textcolor4218">1</span>) {
<br class="fancyvrb"><a id="x34-167382r158"></a>158          rc = Command_build(p, url, configure_opts, make_opts, install_opts);
<br class="fancyvrb"><a id="x34-167384r159"></a>159          check(rc == <span id="textcolor4219">0</span>, <span class="colorbox" id="colorbox4220"><span id="textcolor4221">"</span></span><span class="colorbox" id="colorbox4222"><span id="textcolor4223">Failed to build: %s</span></span><span class="colorbox" id="colorbox4224"><span id="textcolor4225">"</span></span>, url);
                                                                  

                                                                  
<br class="fancyvrb"><a id="x34-167386r160"></a>160      } <span id="textcolor4226">else</span> <span id="textcolor4227">if</span>(rc == <span id="textcolor4228">0</span>) {<br class="fancyvrb"><a id="x34-167388r161"></a>161          <span id="textcolor4229">// no install needed</span>
<br class="fancyvrb"><a id="x34-167390r162"></a>162          log_info(<span class="colorbox" id="colorbox4230"><span id="textcolor4231">"</span></span><span class="colorbox" id="colorbox4232"><span id="textcolor4233">Depends successfully installed: %s</span></span><span class="colorbox" id="colorbox4234"><span id="textcolor4235">"</span></span>, url);<br class="fancyvrb"><a id="x34-167392r163"></a>163      } <span id="textcolor4236">else</span> {
<br class="fancyvrb"><a id="x34-167394r164"></a>164          <span id="textcolor4237">// had an error</span><br class="fancyvrb"><a id="x34-167396r165"></a>165          sentinel(<span class="colorbox" id="colorbox4238"><span id="textcolor4239">"</span></span><span class="colorbox" id="colorbox4240"><span id="textcolor4241">Install failed: %s</span></span><span class="colorbox" id="colorbox4242"><span id="textcolor4243">"</span></span>, url);
<br class="fancyvrb"><a id="x34-167398r166"></a>166      }<br class="fancyvrb"><a id="x34-167400r167"></a>167  <br class="fancyvrb"><a id="x34-167402r168"></a>168      Shell_exec(CLEANUP_SH, <span id="textcolor4244">NULL</span>);<br class="fancyvrb"><a id="x34-167404r169"></a>169      <span id="textcolor4245">return</span> <span id="textcolor4246">0</span>;<br class="fancyvrb"><a id="x34-167406r170"></a>170  <br class="fancyvrb"><a id="x34-167408r171"></a>171  <span id="textcolor4247">error:</span>
<br class="fancyvrb"><a id="x34-167410r172"></a>172      Shell_exec(CLEANUP_SH, <span id="textcolor4248">NULL</span>);<br class="fancyvrb"><a id="x34-167412r173"></a>173      <span id="textcolor4249">return</span> -<span id="textcolor4250">1</span>;<br class="fancyvrb"><a id="x34-167414r174"></a>174  }</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 849--><p class="indent">    After you have this entered in and compiling, you can analyze it. If you’ve don
the challenges until now, you should see how the shell.c functions are being
used to run shells and how the arguments are being replaced. If not then
go back and make sure you truly understand how Shell_exec actually
works.
    </p><h5 class="subsubsectionHead"><a id="x34-16800029.4.3"></a>Challenge 3: Critique My Design</h5>
<!--l. 857--><p class="noindent">As before, do a complete review of this code and make sure it’s exactly the same.
Then go through each function and make sure you know how it works and what it’s
doing. You also should trace how each function calls the other functions you’ve
written in this file and other files. Finally, confirm that you understand all the
functions you’re calling from APR here.
<!--l. 863--></p><p class="indent">    Once you have the file correct and analyzed, go back through and assume I’m
an idiot. Then, criticize the design I have to see how you can improve it if you can.
Don’t actually change the code, just create a little notes.txt file and write down
your thoughts and what you might change.
<!--l. 869--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">29.4.4    </span> <a id="x34-16900029.4.4"></a>The devpkg Main Function</h4>
<!--l. 871--><p class="noindent">The last and most important file, but probably the simplest, is devpkg.c where the
main function lives. There’s no .h file for this, since this one includes all the others.
Instead this just creates the executable devpkg when combined with the other .o
files from our Makefile. Enter in the code for this file, and make sure it’s
correct.
                                                                  

                                                                  
<!--l. 878--></p><p class="indent">    <a id="x34-169001r76"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 76: </span><span class="content">                                                                                                        devpkg.c</span></div><!--tex4ht:label?: x34-169001r76 -->
<div class="fancyvrb" id="fancyvrb44"><a id="x34-169003r1"></a>1  <span id="textcolor4251">#</span><span id="textcolor4252">include <stdio.h></stdio.h></span><br class="fancyvrb"><a id="x34-169005r2"></a>2  <span id="textcolor4253">#</span><span id="textcolor4254">include <apr_general.h></apr_general.h></span><br class="fancyvrb"><a id="x34-169007r3"></a>3  <span id="textcolor4255">#</span><span id="textcolor4256">include <apr_getopt.h></apr_getopt.h></span>
<br class="fancyvrb"><a id="x34-169009r4"></a>4  <span id="textcolor4257">#</span><span id="textcolor4258">include <apr_strings.h></apr_strings.h></span><br class="fancyvrb"><a id="x34-169011r5"></a>5  <span id="textcolor4259">#</span><span id="textcolor4260">include <apr_lib.h></apr_lib.h></span><br class="fancyvrb"><a id="x34-169013r6"></a>6  <span id="textcolor4261">#</span><span id="textcolor4262">include <apr_strings.h></apr_strings.h></span>
<br class="fancyvrb"><a id="x34-169015r7"></a>7  <br class="fancyvrb"><a id="x34-169017r8"></a>8  <span id="textcolor4263">#</span><span id="textcolor4264">include "dbg.h"</span><br class="fancyvrb"><a id="x34-169019r9"></a>9  <span id="textcolor4265">#</span><span id="textcolor4266">include "db.h"</span><br class="fancyvrb"><a id="x34-169021r10"></a>10  <span id="textcolor4267">#</span><span id="textcolor4268">include "commands.h"</span><br class="fancyvrb"><a id="x34-169023r11"></a>11  
<br class="fancyvrb"><a id="x34-169025r12"></a>12  <span id="textcolor4269">int</span> <span id="textcolor4270">main</span>(<span id="textcolor4271">int</span> argc, <span id="textcolor4272">const</span> <span id="textcolor4273">char</span> <span id="textcolor4274">const</span> ⋆argv[])<br class="fancyvrb"><a id="x34-169027r13"></a>13  {<br class="fancyvrb"><a id="x34-169029r14"></a>14      apr_pool_t ⋆p = <span id="textcolor4275">NULL</span>;
<br class="fancyvrb"><a id="x34-169031r15"></a>15      apr_pool_initialize();<br class="fancyvrb"><a id="x34-169033r16"></a>16      apr_pool_create(&amp;p, <span id="textcolor4276">NULL</span>);<br class="fancyvrb"><a id="x34-169035r17"></a>17  
<br class="fancyvrb"><a id="x34-169037r18"></a>18      apr_getopt_t ⋆opt;<br class="fancyvrb"><a id="x34-169039r19"></a>19      apr_status_t rv;<br class="fancyvrb"><a id="x34-169041r20"></a>20  <br class="fancyvrb"><a id="x34-169043r21"></a>21      <span id="textcolor4277">char</span> ch = <span class="colorbox" id="colorbox4278"><span id="textcolor4279">’\0’</span></span>;
<br class="fancyvrb"><a id="x34-169045r22"></a>22      <span id="textcolor4280">const</span> <span id="textcolor4281">char</span> ⋆optarg = <span id="textcolor4282">NULL</span>;<br class="fancyvrb"><a id="x34-169047r23"></a>23      <span id="textcolor4283">const</span> <span id="textcolor4284">char</span> ⋆config_opts = <span id="textcolor4285">NULL</span>;
<br class="fancyvrb"><a id="x34-169049r24"></a>24      <span id="textcolor4286">const</span> <span id="textcolor4287">char</span> ⋆install_opts = <span id="textcolor4288">NULL</span>;<br class="fancyvrb"><a id="x34-169051r25"></a>25      <span id="textcolor4289">const</span> <span id="textcolor4290">char</span> ⋆make_opts = <span id="textcolor4291">NULL</span>;
<br class="fancyvrb"><a id="x34-169053r26"></a>26      <span id="textcolor4292">const</span> <span id="textcolor4293">char</span> ⋆url = <span id="textcolor4294">NULL</span>;<br class="fancyvrb"><a id="x34-169055r27"></a>27      <span id="textcolor4295">enum</span> CommandType request = COMMAND_NONE;
<br class="fancyvrb"><a id="x34-169057r28"></a>28  <br class="fancyvrb"><a id="x34-169059r29"></a>29  <br class="fancyvrb"><a id="x34-169061r30"></a>30      rv = apr_getopt_init(&amp;opt, p, argc, argv);<br class="fancyvrb"><a id="x34-169063r31"></a>31  
<br class="fancyvrb"><a id="x34-169065r32"></a>32      <span id="textcolor4296">while</span>(apr_getopt(opt, <span class="colorbox" id="colorbox4297"><span id="textcolor4298">"</span></span><span class="colorbox" id="colorbox4299"><span id="textcolor4300">I:Lc:m:i:d:SF:B:</span></span><span class="colorbox" id="colorbox4301"><span id="textcolor4302">"</span></span>, &amp;ch, &amp;optarg) == APR_SUCCESS) {
<br class="fancyvrb"><a id="x34-169067r33"></a>33          <span id="textcolor4303">switch</span> (ch) {<br class="fancyvrb"><a id="x34-169069r34"></a>34              <span id="textcolor4304">case</span> <span class="colorbox" id="colorbox4305"><span id="textcolor4306">’I’</span></span>:
<br class="fancyvrb"><a id="x34-169071r35"></a>35                  request = COMMAND_INSTALL;<br class="fancyvrb"><a id="x34-169073r36"></a>36                  url = optarg;
<br class="fancyvrb"><a id="x34-169075r37"></a>37                  <span id="textcolor4307">break</span>;<br class="fancyvrb"><a id="x34-169077r38"></a>38  <br class="fancyvrb"><a id="x34-169079r39"></a>39              <span id="textcolor4308">case</span> <span class="colorbox" id="colorbox4309"><span id="textcolor4310">’L’</span></span>:
<br class="fancyvrb"><a id="x34-169081r40"></a>40                  request = COMMAND_LIST;<br class="fancyvrb"><a id="x34-169083r41"></a>41                  <span id="textcolor4311">break</span>;<br class="fancyvrb"><a id="x34-169085r42"></a>42  
<br class="fancyvrb"><a id="x34-169087r43"></a>43              <span id="textcolor4312">case</span> <span class="colorbox" id="colorbox4313"><span id="textcolor4314">’c’</span></span>:<br class="fancyvrb"><a id="x34-169089r44"></a>44                  config_opts = optarg;<br class="fancyvrb"><a id="x34-169091r45"></a>45                  <span id="textcolor4315">break</span>;
<br class="fancyvrb"><a id="x34-169093r46"></a>46  <br class="fancyvrb"><a id="x34-169095r47"></a>47              <span id="textcolor4316">case</span> <span class="colorbox" id="colorbox4317"><span id="textcolor4318">’m’</span></span>:<br class="fancyvrb"><a id="x34-169097r48"></a>48                  make_opts = optarg;<br class="fancyvrb"><a id="x34-169099r49"></a>49                  <span id="textcolor4319">break</span>;
<br class="fancyvrb"><a id="x34-169101r50"></a>50  <br class="fancyvrb"><a id="x34-169103r51"></a>51              <span id="textcolor4320">case</span> <span class="colorbox" id="colorbox4321"><span id="textcolor4322">’i’</span></span>:<br class="fancyvrb"><a id="x34-169105r52"></a>52                  install_opts = optarg;
<br class="fancyvrb"><a id="x34-169107r53"></a>53                  <span id="textcolor4323">break</span>;<br class="fancyvrb"><a id="x34-169109r54"></a>54  <br class="fancyvrb"><a id="x34-169111r55"></a>55              <span id="textcolor4324">case</span> <span class="colorbox" id="colorbox4325"><span id="textcolor4326">’S’</span></span>:
<br class="fancyvrb"><a id="x34-169113r56"></a>56                  request = COMMAND_INIT;<br class="fancyvrb"><a id="x34-169115r57"></a>57                  <span id="textcolor4327">break</span>;<br class="fancyvrb"><a id="x34-169117r58"></a>58  
<br class="fancyvrb"><a id="x34-169119r59"></a>59              <span id="textcolor4328">case</span> <span class="colorbox" id="colorbox4329"><span id="textcolor4330">’F’</span></span>:<br class="fancyvrb"><a id="x34-169121r60"></a>60                  request = COMMAND_FETCH;
<br class="fancyvrb"><a id="x34-169123r61"></a>61                  url = optarg;<br class="fancyvrb"><a id="x34-169125r62"></a>62                  <span id="textcolor4331">break</span>;<br class="fancyvrb"><a id="x34-169127r63"></a>63  <br class="fancyvrb"><a id="x34-169129r64"></a>64              <span id="textcolor4332">case</span> <span class="colorbox" id="colorbox4333"><span id="textcolor4334">’B’</span></span>:
<br class="fancyvrb"><a id="x34-169131r65"></a>65                  request = COMMAND_BUILD;<br class="fancyvrb"><a id="x34-169133r66"></a>66                  url = optarg;
<br class="fancyvrb"><a id="x34-169135r67"></a>67                  <span id="textcolor4335">break</span>;<br class="fancyvrb"><a id="x34-169137r68"></a>68          }<br class="fancyvrb"><a id="x34-169139r69"></a>69      }<br class="fancyvrb"><a id="x34-169141r70"></a>70  <br class="fancyvrb"><a id="x34-169143r71"></a>71      <span id="textcolor4336">switch</span>(request) {
<br class="fancyvrb"><a id="x34-169145r72"></a>72          <span id="textcolor4337">case</span> COMMAND_INSTALL:<br class="fancyvrb"><a id="x34-169147r73"></a>73              check(url, <span class="colorbox" id="colorbox4338"><span id="textcolor4339">"</span></span><span class="colorbox" id="colorbox4340"><span id="textcolor4341">You must at least give a URL.</span></span><span class="colorbox" id="colorbox4342"><span id="textcolor4343">"</span></span>);
<br class="fancyvrb"><a id="x34-169149r74"></a>74              Command_install(p, url, config_opts, make_opts, install_opts);
<br class="fancyvrb"><a id="x34-169151r75"></a>75              <span id="textcolor4344">break</span>;<br class="fancyvrb"><a id="x34-169153r76"></a>76  <br class="fancyvrb"><a id="x34-169155r77"></a>77          <span id="textcolor4345">case</span> COMMAND_LIST:<br class="fancyvrb"><a id="x34-169157r78"></a>78              DB_list();
<br class="fancyvrb"><a id="x34-169159r79"></a>79              <span id="textcolor4346">break</span>;<br class="fancyvrb"><a id="x34-169161r80"></a>80  <br class="fancyvrb"><a id="x34-169163r81"></a>81          <span id="textcolor4347">case</span> COMMAND_FETCH:
<br class="fancyvrb"><a id="x34-169165r82"></a>82              check(url != <span id="textcolor4348">NULL</span>, <span class="colorbox" id="colorbox4349"><span id="textcolor4350">"</span></span><span class="colorbox" id="colorbox4351"><span id="textcolor4352">You must give a URL.</span></span><span class="colorbox" id="colorbox4353"><span id="textcolor4354">"</span></span>);
<br class="fancyvrb"><a id="x34-169167r83"></a>83              Command_fetch(p, url, <span id="textcolor4355">1</span>);
<br class="fancyvrb"><a id="x34-169169r84"></a>84              log_info(<span class="colorbox" id="colorbox4356"><span id="textcolor4357">"</span></span><span class="colorbox" id="colorbox4358"><span id="textcolor4359">Downloaded to %s and in /tmp/</span></span><span class="colorbox" id="colorbox4360"><span id="textcolor4361">"</span></span>, BUILD_DIR);
<br class="fancyvrb"><a id="x34-169171r85"></a>85              <span id="textcolor4362">break</span>;<br class="fancyvrb"><a id="x34-169173r86"></a>86  <br class="fancyvrb"><a id="x34-169175r87"></a>87          <span id="textcolor4363">case</span> COMMAND_BUILD:
<br class="fancyvrb"><a id="x34-169177r88"></a>88              check(url, <span class="colorbox" id="colorbox4364"><span id="textcolor4365">"</span></span><span class="colorbox" id="colorbox4366"><span id="textcolor4367">You must at least give a URL.</span></span><span class="colorbox" id="colorbox4368"><span id="textcolor4369">"</span></span>);
<br class="fancyvrb"><a id="x34-169179r89"></a>89              Command_build(p, url, config_opts, make_opts, install_opts);
<br class="fancyvrb"><a id="x34-169181r90"></a>90              <span id="textcolor4370">break</span>;<br class="fancyvrb"><a id="x34-169183r91"></a>91  <br class="fancyvrb"><a id="x34-169185r92"></a>92          <span id="textcolor4371">case</span> COMMAND_INIT:<br class="fancyvrb"><a id="x34-169187r93"></a>93              rv = DB_init();
<br class="fancyvrb"><a id="x34-169189r94"></a>94              check(rv == <span id="textcolor4372">0</span>, <span class="colorbox" id="colorbox4373"><span id="textcolor4374">"</span></span><span class="colorbox" id="colorbox4375"><span id="textcolor4376">Failed to make the database.</span></span><span class="colorbox" id="colorbox4377"><span id="textcolor4378">"</span></span>);<br class="fancyvrb"><a id="x34-169191r95"></a>95              <span id="textcolor4379">break</span>;
                                                                  

                                                                  
<br class="fancyvrb"><a id="x34-169193r96"></a>96  <br class="fancyvrb"><a id="x34-169195r97"></a>97          <span id="textcolor4380">default:</span><br class="fancyvrb"><a id="x34-169197r98"></a>98              sentinel(<span class="colorbox" id="colorbox4381"><span id="textcolor4382">"</span></span><span class="colorbox" id="colorbox4383"><span id="textcolor4384">Invalid command given.</span></span><span class="colorbox" id="colorbox4385"><span id="textcolor4386">"</span></span>);
<br class="fancyvrb"><a id="x34-169199r99"></a>99      }<br class="fancyvrb"><a id="x34-169201r100"></a>100  <br class="fancyvrb"><a id="x34-169203r101"></a>101  <br class="fancyvrb"><a id="x34-169205r102"></a>102      <span id="textcolor4387">return</span> <span id="textcolor4388">0</span>;<br class="fancyvrb"><a id="x34-169207r103"></a>103  <br class="fancyvrb"><a id="x34-169209r104"></a>104  <span id="textcolor4389">error:</span><br class="fancyvrb"><a id="x34-169211r105"></a>105      <span id="textcolor4390">return</span> <span id="textcolor4391">1</span>;<br class="fancyvrb"><a id="x34-169213r106"></a>106  }</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><h5 class="subsubsectionHead"><a id="x34-17000029.4.4"></a>Challenge 4: The README And Test Files</h5>
<!--l. 992--><p class="noindent">The challenge for this file is to understand how the arguments are being processed,
what the arguments are, and then create the README file with instructions on how to
use it. As you write the README, also write a simple test.sh that runs
./devpkg to check that each command is actually working against real live
code. Use the <span class="obeylines-h"><span class="verb">set -e</span></span> at the top of your script so that it aborts on the first
error.
<!--l. 999--></p><p class="indent">    Finally, run the program under valgrind and make sure it’s all working before
moving on to the mid-term exam.
<!--l. 1002--></p><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">29.5    </span> <a id="x34-17100029.5"></a>The Mid-Term Exam</h3>
<!--l. 1004--><p class="noindent">Your final challenge is the mid-term exam and it involves three things:
<!--l. 1006--></p><p class="indent">
     </p><ol class="enumerate1"><li class="enumerate" id="x34-171002x1">Compare your code to my code available online and starting with 100%,
     remove 1% for each line you got wrong.
     </li>
     <li class="enumerate" id="x34-171004x2">Take   your   notes.txt   on   how   you   would   improve   the   code   and
     functionality of devpkg and implement your improvements.
     </li>
     <li class="enumerate" id="x34-171006x3">Write   an   alternative   version   of   devpkg using   your   other   favorite
     language or the one you think can do this the best. Compare the two,
     then improve your C version of devpkg based on what you’ve learned.</li></ol><!--l. 1017--><p class="indent">    To compare your code with mine, do the following:
                                                                  

                                                                  
    <!--l. 1019-->
</p><div class="lstlisting" id="listing-45"><span class="label"><a id="x34-171007r1"></a>1</span>cd ..  # get one directory above your current one <br><span class="label"><a id="x34-171008r2"></a>2</span>git clone git://gitorious.org/devpkg/devpkg.git devpkgzed <br><span class="label"><a id="x34-171009r3"></a>3</span>diff -r devpkg devpkgzed
    </div>
<!--l. 1025--><p class="indent">    This will clone my version of devpkg into a directory devpkgzed and then use
the tool diff to compare what you’ve done to what I did. The files you’re working
with in this book come directly from this project, so if you get different lines then
that’s an error.
<!--l. 1031--></p><p class="indent">    Keep in mind that there’s no real pass or fail on this exercise, just a way for you
to challenge yourself to be as exact and meticulous as possible.
                                                                  

                                                                  
                                                                  

                                                                  
    <!--l. 53--></p><div class="crosslinks"><p class="noindent">[<a href="learn-c-the-hard-waypa2.html">next</a>] [<a href="learn-c-the-hard-waych28.html">prev</a>] [<a href="learn-c-the-hard-waych28.html#taillearn-c-the-hard-waych28.html">prev-tail</a>] [<a href="learn-c-the-hard-waych29.html">front</a>] [<a href="learn-c-the-hard-waypa1.html#learn-c-the-hard-waych29.html">up</a>] </p></div>
<!--l. 53--><p class="indent">    <a id="taillearn-c-the-hard-waych29.html"></a>   
</p></body></html>