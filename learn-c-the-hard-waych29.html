<html><head><title>Exercise 28: Intermediate Makefiles</title><meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="generator"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="originator"></meta><!-- index=1,2,next,fn-in,charset=utf-8,NoFonts,html --><meta content="learn-c-the-hard-way.tex" name="src"></meta><meta content="2012-04-11 11:32:00" name="date"></meta><link href="learn-c-the-hard-way.css" rel="stylesheet" type="text/css"></link></head><body>
    <!--l. 1--><div class="crosslinks"><p class="noindent">[<a href="learn-c-the-hard-waych30.html">next</a>] [<a href="learn-c-the-hard-waych28.html">prev</a>] [<a href="learn-c-the-hard-waych28.html#taillearn-c-the-hard-waych28.html">prev-tail</a>] [<a href="#taillearn-c-the-hard-waych29.html">tail</a>] [<a href="learn-c-the-hard-waypa2.html#learn-c-the-hard-waych29.html">up</a>] </p></div>
    <h2 class="chapterHead"><span class="titlemark">Chapter 29</span><br><a id="x35-18200029"></a>Exercise 28: Intermediate Makefiles</h2>
<!--l. 3--><p class="noindent">In the next three Exercises you’ll create a skeleton project directory to use in building
your C programs later. This skeleton directory will be used in the rest of the book,
and in this exercise I’ll cover just the Makefile so you can understand
it.
<!--l. 8--></p><p class="indent">    The purpose of this structure is to make it easy to build medium sized programs
without having to resort to configure tools. If done right you can get very far with
just GNU make and some small shell scripts.
    </p><h3 class="sectionHead"><span class="titlemark">29.1    </span> <a id="x35-18300029.1"></a>The Basic Project Structure</h3>
<!--l. 14--><p class="noindent">The first thing to do is make a c-skeleton directory and then put a set of basic files
and directories in it that many projects have. Here’s my starter:
                                                                  

                                                                  
<!--l. 18--></p><p class="indent">    <a id="x35-183001r77"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 77: </span><span class="content">                                                                                            Initial C Project
Skeleton</span></div><!--tex4ht:label?: x35-183001r77 -->
<div class="fancyvrb" id="fancyvrb45"><a id="x35-183003r1"></a>1  <span id="textcolor4388">$</span> mkdir c-skeleton<br class="fancyvrb"><a id="x35-183005r2"></a>2  <span id="textcolor4389">$</span> <span id="textcolor4390">cd </span>c-skeleton/<br class="fancyvrb"><a id="x35-183007r3"></a>3  <span id="textcolor4391">$</span> touch LICENSE README.md Makefile
<br class="fancyvrb"><a id="x35-183009r4"></a>4  <span id="textcolor4392">$</span> mkdir bin src tests<br class="fancyvrb"><a id="x35-183011r5"></a>5  <span id="textcolor4393">$</span> cp dbg.h src/   <span id="textcolor4394"># this is from Ex20</span><br class="fancyvrb"><a id="x35-183013r6"></a>6  <span id="textcolor4395">$</span> ls -l
<br class="fancyvrb"><a id="x35-183015r7"></a>7  <span id="textcolor4396">total 8</span><br class="fancyvrb"><a id="x35-183017r8"></a>8  <span id="textcolor4397">-rw-r--r--  1 zedshaw  staff     0 Mar 31 16:38 LICENSE</span>
<br class="fancyvrb"><a id="x35-183019r9"></a>9  <span id="textcolor4398">-rw-r--r--  1 zedshaw  staff  1168 Apr  1 17:00 Makefile</span>
<br class="fancyvrb"><a id="x35-183021r10"></a>10  <span id="textcolor4399">-rw-r--r--  1 zedshaw  staff     0 Mar 31 16:38 README.md</span>
<br class="fancyvrb"><a id="x35-183023r11"></a>11  <span id="textcolor4400">drwxr-xr-x  2 zedshaw  staff    68 Mar 31 16:38 bin</span>
<br class="fancyvrb"><a id="x35-183025r12"></a>12  <span id="textcolor4401">drwxr-xr-x  2 zedshaw  staff    68 Apr  1 10:07 build</span>
<br class="fancyvrb"><a id="x35-183027r13"></a>13  <span id="textcolor4402">drwxr-xr-x  3 zedshaw  staff   102 Apr  3 16:28 src</span>
<br class="fancyvrb"><a id="x35-183029r14"></a>14  <span id="textcolor4403">drwxr-xr-x  2 zedshaw  staff    68 Mar 31 16:38 tests</span><br class="fancyvrb"><a id="x35-183031r15"></a>15  <span id="textcolor4404">$</span> ls -l src
<br class="fancyvrb"><a id="x35-183033r16"></a>16  <span id="textcolor4405">total 8</span><br class="fancyvrb"><a id="x35-183035r17"></a>17  <span id="textcolor4406">-rw-r--r--  1 zedshaw  staff  982 Apr  3 16:28 dbg.h</span><br class="fancyvrb"><a id="x35-183037r18"></a>18  <span id="textcolor4407">$</span></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 42--><p class="indent">    At the end you see me do an <span class="obeylines-h"><span class="verb">ls -l</span></span> so you can see the final results.
<!--l. 44--></p><p class="indent">    Here’s what each of these does:
     </p><dl class="description"><dt class="description">
LICENSE </dt><dd class="description">If you release the source of your projects you’ll want to include a
     license. If you don’t though, the code is copyright by you and nobody
     has rights to it by default.
     </dd><dt class="description">
README.md </dt><dd class="description">Basic instructions for using your project go here. It ends in .md
     so that it will be interpreted as markdown.
     </dd><dt class="description">
Makefile </dt><dd class="description">The main build file for the project.
     </dd><dt class="description">
bin/ </dt><dd class="description">Where  programs  that  users  can  run  go.  This  is  usually  empty  and  the
     Makefile will create it if it’s not there.
     </dd><dt class="description">
build/ </dt><dd class="description">Where  libraries  and  other  build  artifacts  go.  Also  empty  and  the
     Makefile will create it if it’s not there.
     </dd><dt class="description">
src/ </dt><dd class="description">Where the source code goes, usually .c and .h files.
     </dd><dt class="description">
tests/ </dt><dd class="description">Where automated tests go.
     </dd><dt class="description">
src/dbg.h </dt><dd class="description">I copied the dbg.h from Exercise 20 into src/ for later.</dd></dl><!--l. 60--><p class="indent">    I’ll now break down each of the compontents of this skeleton project so you can
understand how it works.
    </p><h3 class="sectionHead"><span class="titlemark">29.2    </span> <a id="x35-18400029.2"></a>Makefile</h3>
                                                                  

                                                                  
<!--l. 65--><p class="noindent">The first thing I’ll cover is the Makefile because from that you can understand how
everything else works. The Makefile in this exercise is much more detailed
than ones you’ve used so far, so I’m going to break it down after you type it
in:
                                                                  

                                                                  
<!--l. 70--></p><p class="indent">    <a id="x35-184001r78"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 78: </span><span class="content">                                                                                       c-skeleton/Makefile</span></div><!--tex4ht:label?: x35-184001r78 -->
<!--l. 71-->
<div class="lstlisting" id="listing-46"><span class="label"><a id="x35-184002r1"></a>1</span>CFLAGS=-g -O2 -Wall -Wextra -Isrc -rdynamic -DNDEBUG $(OPTFLAGS) <br><span class="label"><a id="x35-184003r2"></a>2</span>LIBS=-ldl $(OPTLIBS) <br><span class="label"><a id="x35-184004r3"></a>3</span>PREFIX?=/usr/local <br><span class="label"><a id="x35-184005r4"></a>4</span> <br><span class="label"><a id="x35-184006r5"></a>5</span>SOURCES=$(wildcard src/⋆⋆/⋆.c src/⋆.c) <br><span class="label"><a id="x35-184007r6"></a>6</span>OBJECTS=$(patsubst %.c,%.o,$(SOURCES)) <br><span class="label"><a id="x35-184008r7"></a>7</span> <br><span class="label"><a id="x35-184009r8"></a>8</span>TEST_SRC=$(wildcard tests/⋆_tests.c) <br><span class="label"><a id="x35-184010r9"></a>9</span>TESTS=$(patsubst %.c,%,$(TEST_SRC)) <br><span class="label"><a id="x35-184011r10"></a>10</span> <br><span class="label"><a id="x35-184012r11"></a>11</span>TARGET=build/libYOUR_LIBRARY.a <br><span class="label"><a id="x35-184013r12"></a>12</span>SO_TARGET=$(patsubst %.a,%.so,$(TARGET)) <br><span class="label"><a id="x35-184014r13"></a>13</span> <br><span class="label"><a id="x35-184015r14"></a>14</span># The Target Build <br><span class="label"><a id="x35-184016r15"></a>15</span>all: $(TARGET) $(SO_TARGET) tests <br><span class="label"><a id="x35-184017r16"></a>16</span> <br><span class="label"><a id="x35-184018r17"></a>17</span>dev: CFLAGS=-g -Wall -Isrc -Wall -Wextra $(OPTFLAGS) <br><span class="label"><a id="x35-184019r18"></a>18</span>dev: all <br><span class="label"><a id="x35-184020r19"></a>19</span> <br><span class="label"><a id="x35-184021r20"></a>20</span>$(TARGET): CFLAGS += -fPIC <br><span class="label"><a id="x35-184022r21"></a>21</span>$(TARGET): build $(OBJECTS) <br><span class="label"><a id="x35-184023r22"></a>22</span>        ar rcs $@ $(OBJECTS) <br><span class="label"><a id="x35-184024r23"></a>23</span>        ranlib $@ <br><span class="label"><a id="x35-184025r24"></a>24</span> <br><span class="label"><a id="x35-184026r25"></a>25</span>$(SO_TARGET): $(TARGET) $(OBJECTS) <br><span class="label"><a id="x35-184027r26"></a>26</span>        $(CC) -shared -o $@ $(OBJECTS) <br><span class="label"><a id="x35-184028r27"></a>27</span> <br><span class="label"><a id="x35-184029r28"></a>28</span>build: <br><span class="label"><a id="x35-184030r29"></a>29</span>        @mkdir -p build <br><span class="label"><a id="x35-184031r30"></a>30</span>        @mkdir -p bin <br><span class="label"><a id="x35-184032r31"></a>31</span> <br><span class="label"><a id="x35-184033r32"></a>32</span># The Unit Tests <br><span class="label"><a id="x35-184034r33"></a>33</span>.PHONY: tests <br><span class="label"><a id="x35-184035r34"></a>34</span>tests: CFLAGS += $(TARGET) <br><span class="label"><a id="x35-184036r35"></a>35</span>tests: $(TESTS) <br><span class="label"><a id="x35-184037r36"></a>36</span>        sh ./tests/runtests.sh <br><span class="label"><a id="x35-184038r37"></a>37</span> <br><span class="label"><a id="x35-184039r38"></a>38</span>valgrind: <br><span class="label"><a id="x35-184040r39"></a>39</span>        VALGRIND="valgrind --log-file=/tmp/valgrind-%p.log" $(MAKE) <br><span class="label"><a id="x35-184041r40"></a>40</span> <br><span class="label"><a id="x35-184042r41"></a>41</span># The Cleaner <br><span class="label"><a id="x35-184043r42"></a>42</span>clean: <br><span class="label"><a id="x35-184044r43"></a>43</span>        rm -rf build $(OBJECTS) $(TESTS) <br><span class="label"><a id="x35-184045r44"></a>44</span>        rm -f tests/tests.log <br><span class="label"><a id="x35-184046r45"></a>45</span>        find . -name "⋆.gc⋆" -exec rm {} \; <br><span class="label"><a id="x35-184047r46"></a>46</span>        rm -rf ‘find . -name "⋆.dSYM" -print‘ <br><span class="label"><a id="x35-184048r47"></a>47</span> <br><span class="label"><a id="x35-184049r48"></a>48</span># The Install <br><span class="label"><a id="x35-184050r49"></a>49</span>install: all <br><span class="label"><a id="x35-184051r50"></a>50</span>        install -d $(DESTDIR)/$(PREFIX)/lib/ <br><span class="label"><a id="x35-184052r51"></a>51</span>        install $(TARGET) $(DESTDIR)/$(PREFIX)/lib/ <br><span class="label"><a id="x35-184053r52"></a>52</span> <br><span class="label"><a id="x35-184054r53"></a>53</span># The Checker <br><span class="label"><a id="x35-184055r54"></a>54</span>BADFUNCS=’[^_.&gt;a-zA-Z0-9](str(n?cpy|n?cat|xfrm|n?dup|str|pbrk|tok|_)|stpn?cpy|a?sn?printf|byte_)’ <br><span class="label"><a id="x35-184056r55"></a>55</span>check: <br><span class="label"><a id="x35-184057r56"></a>56</span>        @echo Files with potentially dangerous functions. <br><span class="label"><a id="x35-184058r57"></a>57</span>        @egrep $(BADFUNCS) $(SOURCES) || true
</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 134--><p class="indent">    Remember that you need to indent the Makefile consistently with tab characters.
Your editor should know that and do the right thing, but if it doesn’t then get a
different text editor. No programmer should use an editor that fails at something so
simple.
    </p><h4 class="subsectionHead"><span class="titlemark">29.2.1    </span> <a id="x35-18500029.2.1"></a>The Header</h4>
<!--l. 141--><p class="noindent">This makefile is designed to build a library we’ll be working on later and to do so
reliably on almost any platform by using special features of GNU make. I’ll break
down each part in sections, starting with the header.
     </p><dl class="description"><dt class="description">
Makefile:1 </dt><dd class="description">These are the usual CFLAGS that you set in all of your projects, but
     with a few others that may be needed to build libraries. You may need to
     adjust these for different platforms. Notice the OPTFLAGS variable at the end
     which lets people augment the build options as needed.
     </dd><dt class="description">
Makefile:2 </dt><dd class="description">Options used when linking a library, and allows someone else to
     augment the linking options using the OPTLIBS variable.
     </dd><dt class="description">
Makefile:3 </dt><dd class="description">Setting an optional variable called PREFIX that will only have this
     value if the person running the Makefile didn’t already give a PREFIX
     setting. That’s what the <span class="obeylines-h"><span class="verb">?=</span></span> does.
     </dd><dt class="description">
Makefile:5 </dt><dd class="description">This  fancy  line  of  awesome  dynamically  creates  the  SOURCES
     variable  by  doing  a  wildcard search  for  all  ⋆.c files  in  the  src/
     directory. You have to give both src/⋆⋆/⋆.c and src/⋆.c so that GNU
     make will include the files in src and also the ones below it.
     </dd><dt class="description">
                                                                  

                                                                  
Makefile:6 </dt><dd class="description">Once  you  have  the  list  of  source  files,  you  can  then  use  the
     patsubst to take the SOURCES list of ⋆.c files and make a new list of
     all the object files. You do this by telling patsubst to change all %.c
     extensions to %.o and then those are assigned to OBJECTS.
     </dd><dt class="description">
Makefile:8 </dt><dd class="description">Using the wildcard again to find all the test source files for the
     unit tests. These are separate from the library’s source files.
     </dd><dt class="description">
Makefile:9 </dt><dd class="description">Then  using  the  same  patsubst trick  to  dynamically  get  all  the
     TEST targets. In this case I’m stripping away the .c extension so that a
     full program will be made with the same name. Previously I had replaced
     the .c with .o so an object file is created.
     </dd><dt class="description">
Makefile:11 </dt><dd class="description">Finally,                            we                            say                            the
     ultimate target is build/libYOUR_LIBRARY.a, which you will change
     to be whatever library you are actually trying to build.</dd></dl><!--l. 175--><p class="indent">    This completes the top of the Makefile, but I should explain what I
mean by ”lets people augment the build”. When you run make you can do
this:
                                                                  

                                                                  
<!--l. 178--></p><p class="indent">    <a id="x35-185001r79"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 79: </span><span class="content">                                                                                    A Changing A Make
Build</span></div><!--tex4ht:label?: x35-185001r79 -->
<div class="fancyvrb" id="fancyvrb46"><a id="x35-185003r1"></a>  # WARNING! Just a demonstration, won’t really work right now.
<br class="fancyvrb"><a id="x35-185005r2"></a>  # this installs the library into /tmp<br class="fancyvrb"><a id="x35-185007r3"></a>  $ make PREFIX=/tmp install
<br class="fancyvrb"><a id="x35-185009r4"></a>  # this tells it to add pthreads<br class="fancyvrb"><a id="x35-185011r5"></a>  $ make OPTFLAGS=-pthread</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 188--><p class="indent">    If you pass in options that match the same kind of variables you have in your
Makefile, then those will show up in your build. You can then use this to change
how the Makefile runs. The first one alters the PREFIX so that it installs into /tmp
instead. The second one sets OPTFLAGS so that the -pthread option is
present.
    </p><h4 class="subsectionHead"><span class="titlemark">29.2.2    </span> <a id="x35-18600029.2.2"></a>The Target Build</h4>
<!--l. 196--><p class="noindent">Continuing with the breakdown of the Makefile I have actually building the object
files and targets:
     </p><dl class="description"><dt class="description">
Makefile:14 </dt><dd class="description">Remember that the first target is what make will run by default
     when  no  target  is  given.  In  this  case  it’s  called  all: and  it  gives
     <span class="obeylines-h"><span class="verb">$(TARGET) tests</span></span> as  the  targets  to  build.  Look  up  at  the  TARGET
     variable and you see that’s the library, so all: will first build the library.
     The tests target is then further down in the Makefile and builds the
     unit tests.
     </dd><dt class="description">
Makefile:16 </dt><dd class="description">Another target for making ”developer builds” that introduces a
     technique for changing options for just one target. If I do a ”dev build”
     I want the CFLAGS to include options like -Wextra that are useful for
     finding bugs. If you place them on the target line as options like this, then
     give another line that says the original target (in this case all) then it
     will change the options you set. I use this for setting different flags on
     different platforms that need it.
     </dd><dt class="description">
Makefile:19 </dt><dd class="description">Builds  the  TARGET library,  whatever  that  is,  and  also  uses  the
     same trick from line 15 of giving a target with just options changes to
     alter them for this run. In this case I’m adding -fPIC just for the library
                                                                  

                                                                  
     build using the <span class="obeylines-h"><span class="verb">+=</span></span> syntax to add it on.
     </dd><dt class="description">
Makefile:20 </dt><dd class="description">Now the real target where I say first make the build directory,
     then compile all the OBJECTS.
     </dd><dt class="description">
Makefile:21 </dt><dd class="description">Runs  the  ar command  which  actually  makes  the  TARGET.  The
     syntax  <span class="obeylines-h"><span class="verb">$@ $(OBJECTS)</span></span> is  a  way  of  saying,  ”put  the  target  for  this
     Makefile  source  here  and  all  the  OBJECTS  after  that”.  In  this  case
     the  <span class="obeylines-h"><span class="verb">$@</span></span> maps  back  to  the  <span class="obeylines-h"><span class="verb">$(TARGET)</span></span> on  line  19,  which  maps  to
     build/libYOUR_LIBRARY.a. It seems like a lot to keep track of this
     indirection, and it can be, but once you get it working this means you just
     change TARGET at the top and build a whole new library.
     </dd><dt class="description">
Makefile:22 </dt><dd class="description">Finally, to make the library you run ranlib on the TARGET and
     it’s built.
     </dd><dt class="description">
Makefile:24-24 </dt><dd class="description">This just makes the build/ or bin/ directories if they don’t
     exist. This is then referenced from line 19 when it gives the build target
     to make sure the build/ directory is made.</dd></dl><!--l. 234--><p class="indent">    You now have all the stuff you need to build the software, so we’ll create a way
to build and run unit tests to do automated testing.
<!--l. 237--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">29.2.3    </span> <a id="x35-18700029.2.3"></a>The Unit Tests</h4>
<!--l. 239--><p class="noindent">C is different from other languages because it’s easier to create one tiny little
program for each thing you’re testing. Some testing frameworks try to emulate the
module concept other languages have and do dynamic loading, but this doesn’t
work well in C. It’s also unnecessary because you can just make a single program
that’s run for each test instead.
                                                                  

                                                                  
<!--l. 245--></p><p class="indent">    I’ll cover this part of the Makefile, and then later you’ll see the contents of the
tests/ directory that make it actually work.
     </p><dl class="description"><dt class="description">
Makefile:29 </dt><dd class="description">If you have a target that’s not ”real”, but there is a directory or file
     with that name, then you need to tag the target with .PHONY: so make
     will ignore the file and always run.
     </dd><dt class="description">
Makefile:30 </dt><dd class="description">I  use  the  same  trick  for  modifying  the  CFLAGS variable  to
     add   the   TARGET to   the   build   so   that   each   of   the   test   programs
     will   be   linked   with   the   TARGET library.   In   this   case   it   will   add
     build/libYOUR_LIBRARY.a to the linking.
     </dd><dt class="description">
Makefile:31 </dt><dd class="description">Then I have the actual tests: target which depends on all the
     programs listed in the TESTS variable we created in the header. This one
     line actually says, ”Make, use what you know about building programs
     and the current CFLAGS settings to build each program in TESTS.”
     </dd><dt class="description">
Makefile:32 </dt><dd class="description">Finally,  when  all  of  the  TESTS are  built,  there’s  a  simple  shell
     script I’ll create later that knows how to run them all and report their
     output. This line actually runs it so you can see the test results.
     </dd><dt class="description">
Makefile:34-35 </dt><dd class="description">In order to be able to dynamically rerun the tests with Valgrind
     there’s  a  valgrind: target  that  sets  the  right  variable  and  runs  itself
     again. This puts the valgrind logs into /tmp/valgrind-⋆.log so you
     can go look and see what might be going on. The tests/runtests.sh
     then knows to run the test programs under Valgrind when it sees this
     VALGRIND variable.</dd></dl><!--l. 273--><p class="indent">    For the unit testing to work you’ll need to create a little shell script that knows
how to run the programs. Go ahead and create this tests/runtests.sh
script:
                                                                  

                                                                  
                                                                  

                                                                  
<!--l. 277--></p><p class="indent">    <a id="x35-187001r80"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 80: </span><span class="content">                                                                                            tests/runtests.sh</span></div><!--tex4ht:label?: x35-187001r80 -->
<div class="fancyvrb" id="fancyvrb47"><a id="x35-187003r1"></a>1  <span id="textcolor4408">echo</span> <span class="colorbox" id="colorbox4409"><span id="textcolor4410">"Running unit tests:"</span></span><br class="fancyvrb"><a id="x35-187005r2"></a>2  <br class="fancyvrb"><a id="x35-187007r3"></a>3  <span id="textcolor4411">for </span>i in tests/⋆_tests<br class="fancyvrb"><a id="x35-187009r4"></a>4  <span id="textcolor4412">do</span>
<br class="fancyvrb"><a id="x35-187011r5"></a>5  <span id="textcolor4413">    </span><span id="textcolor4414">if </span><span id="textcolor4415">test</span> -f <span id="textcolor4416">$i</span><br class="fancyvrb"><a id="x35-187013r6"></a>6      <span id="textcolor4417">then</span><br class="fancyvrb"><a id="x35-187015r7"></a>7  <span id="textcolor4418">        </span><span id="textcolor4419">if</span> <span id="textcolor4420">$VALGRIND</span> ./<span id="textcolor4421">$i</span> 2&gt;&gt; tests/tests.log
<br class="fancyvrb"><a id="x35-187017r8"></a>8          <span id="textcolor4422">then</span><br class="fancyvrb"><a id="x35-187019r9"></a>9  <span id="textcolor4423">            </span><span id="textcolor4424">echo</span> <span id="textcolor4425">$i</span> PASS<br class="fancyvrb"><a id="x35-187021r10"></a>10          <span id="textcolor4426">else</span>
<br class="fancyvrb"><a id="x35-187023r11"></a>11  <span id="textcolor4427">            </span><span id="textcolor4428">echo</span> <span class="colorbox" id="colorbox4429"><span id="textcolor4430">"ERROR in test $i: here’s tests/tests.log"</span></span>
<br class="fancyvrb"><a id="x35-187025r12"></a>12              <span id="textcolor4431">echo</span> <span class="colorbox" id="colorbox4432"><span id="textcolor4433">"------"</span></span><br class="fancyvrb"><a id="x35-187027r13"></a>13              tail tests/tests.log
<br class="fancyvrb"><a id="x35-187029r14"></a>14              <span id="textcolor4434">exit </span>1<br class="fancyvrb"><a id="x35-187031r15"></a>15          <span id="textcolor4435">fi</span><br class="fancyvrb"><a id="x35-187033r16"></a>16  <span id="textcolor4436">    </span><span id="textcolor4437">fi</span><br class="fancyvrb"><a id="x35-187035r17"></a>17  <span id="textcolor4438">done</span><br class="fancyvrb"><a id="x35-187037r18"></a>18  <br class="fancyvrb"><a id="x35-187039r19"></a>19  <span id="textcolor4439">echo</span> <span class="colorbox" id="colorbox4440"><span id="textcolor4441">""</span></span></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 302--><p class="indent">    I’ll be using this later when I cover how unit tests work.
    </p><h4 class="subsectionHead"><span class="titlemark">29.2.4    </span> <a id="x35-18800029.2.4"></a>The Cleaner</h4>
<!--l. 306--><p class="noindent">I now have fully working unit tests, so next up is making things clean when I need to
reset everything.
     </p><dl class="description"><dt class="description">
Makefile:38 </dt><dd class="description">The clean: target starts things off whenever we need to clean
     up the project.
     </dd><dt class="description">
Makefile:39-42 </dt><dd class="description">This cleans out most of the junk that various compilers and
     tools leave behind. It also gets rid of the build/ directory and uses a
     trick at the end to cleanly erase the weird ⋆.dSYM directories Apple’s
     XCode leaves behind for debugging purposes.</dd></dl><!--l. 318--><p class="indent">    If you run into junk that you need to clean out, simply augment the list of things
being deleted in this target.
<!--l. 321--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">29.2.5    </span> <a id="x35-18900029.2.5"></a>The Install</h4>
<!--l. 323--><p class="noindent">After that I’ll need a way to install the project, and for a Makefile that’s building a
library I just need to put something in the common PREFIX directory, which is
usually /usr/local/lib.
     </p><dl class="description"><dt class="description">
Makefile:45 </dt><dd class="description">This makes install: depend on the all: target so that when
                                                                  

                                                                  
     you run <span class="obeylines-h"><span class="verb">make install</span></span> it will be sure to build everything.
     </dd><dt class="description">
Makefile:46 </dt><dd class="description">I then use the program install to create the target lib directory
     if it doesn’t exist. In this case I’m trying to make the install as flexible
     as  possible  by  using  two  variables  that  are  conventions  for  installers.
     DESTDIR is handed to make by installers that do their builds in secure or
     odd locations to build packages. PREFIX is used when people want the
     project to be installed in someplace other than /usr/local.
     </dd><dt class="description">
Makefile:47 </dt><dd class="description">After that I’m just using install to actually install the library
     where it needs to go.</dd></dl><!--l. 341--><p class="indent">    The purpose of the install program is to make sure things have the right
permissions set. When you run <span class="obeylines-h"><span class="verb">make install</span></span> you usually have to do it as the root
user, so the typical build process is <span class="obeylines-h"><span class="verb">make &amp;&amp; sudo make install</span></span>.
<!--l. 345--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">29.2.6    </span> <a id="x35-19000029.2.6"></a>The Checker</h4>
<!--l. 347--><p class="noindent">The very last part of this Makefile is a bonus that I include in my C projects to help
me dig out any attempts to use the ”bad” functions in C. Namely the string functions
and other ”unprotected buffer” functions.
     </p><dl class="description"><dt class="description">
Makefile:50 </dt><dd class="description">Sets a variable which is a big regex looking for bad functions like
     strcpy.
     </dd><dt class="description">
Makefile:51 </dt><dd class="description">The check: target so you can run a check whenever you need.
     </dd><dt class="description">
Makefile:52 </dt><dd class="description">Just a way to print a message, but doing @echo tells make to not
     print the command, just its output.
                                                                  

                                                                  
     </dd><dt class="description">
Makefile:53 </dt><dd class="description">Run the egrep command on the source files looking for any bad
     patterns. The <span class="obeylines-h"><span class="verb">|| true</span></span> at the end is a way to prevent make from thinking
     that egrep not finding things is a failure.</dd></dl><!--l. 364--><p class="indent">    When you run this it will have the odd effect that you’ll get an error when there
is nothing bad going on.
<!--l. 367--></p><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">29.3    </span> <a id="x35-19100029.3"></a>What You Should See</h3>
<!--l. 369--><p class="noindent">I have two more exercises to go before I’m done building the project skeleton
directory, but here’s me testing out the features of the Makefile.
                                                                  

                                                                  
<!--l. 372--></p><p class="indent">    <a id="x35-191001r81"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 81: </span><span class="content">                                                                                                Checking The
Makefile</span></div><!--tex4ht:label?: x35-191001r81 -->
<div class="fancyvrb" id="fancyvrb48"><a id="x35-191003r1"></a>1  <span id="textcolor4442">$</span> make clean<br class="fancyvrb"><a id="x35-191005r2"></a>2  <span id="textcolor4443">rm -rf build  </span><br class="fancyvrb"><a id="x35-191007r3"></a>3  <span id="textcolor4444">rm -f tests/tests.log </span>
<br class="fancyvrb"><a id="x35-191009r4"></a>4  <span id="textcolor4445">find . -name "⋆.gc⋆" -exec rm {} \;</span><br class="fancyvrb"><a id="x35-191011r5"></a>5  <span id="textcolor4446">rm -rf ‘find . -name "⋆.dSYM" -print‘</span><br class="fancyvrb"><a id="x35-191013r6"></a>6  <span id="textcolor4447">$</span> make check
<br class="fancyvrb"><a id="x35-191015r7"></a>7  <span id="textcolor4448">Files with potentially dangerous functions.</span><br class="fancyvrb"><a id="x35-191017r8"></a>8  <span id="textcolor4449">^Cmake: ⋆⋆⋆ [check] Interrupt: 2</span>
<br class="fancyvrb"><a id="x35-191019r9"></a>9  <br class="fancyvrb"><a id="x35-191021r10"></a>10  <span id="textcolor4450">$</span> make<br class="fancyvrb"><a id="x35-191023r11"></a>11  <span id="textcolor4451">ar rcs build/libYOUR_LIBRARY.a </span><br class="fancyvrb"><a id="x35-191025r12"></a>12  <span id="textcolor4452">ar: no archive members specified</span>
<br class="fancyvrb"><a id="x35-191027r13"></a>13  <span id="textcolor4453">usage:  ar -d [-TLsv] archive file ...</span><br class="fancyvrb"><a id="x35-191029r14"></a>14  <span id="textcolor4454">        ar -m [-TLsv] archive file ...</span>
<br class="fancyvrb"><a id="x35-191031r15"></a>15  <span id="textcolor4455">        ar -m [-abiTLsv] position archive file ...</span>
<br class="fancyvrb"><a id="x35-191033r16"></a>16  <span id="textcolor4456">        ar -p [-TLsv] archive [file ...]</span>
<br class="fancyvrb"><a id="x35-191035r17"></a>17  <span id="textcolor4457">        ar -q [-cTLsv] archive file ...</span><br class="fancyvrb"><a id="x35-191037r18"></a>18  <span id="textcolor4458">        ar -r [-cuTLsv] archive file ...</span>
<br class="fancyvrb"><a id="x35-191039r19"></a>19  <span id="textcolor4459">        ar -r [-abciuTLsv] position archive file ...</span>
<br class="fancyvrb"><a id="x35-191041r20"></a>20  <span id="textcolor4460">        ar -t [-TLsv] archive [file ...]</span><br class="fancyvrb"><a id="x35-191043r21"></a>21  <span id="textcolor4461">        ar -x [-ouTLsv] archive [file ...]</span>
<br class="fancyvrb"><a id="x35-191045r22"></a>22  <span id="textcolor4462">make: ⋆⋆⋆ [build/libYOUR_LIBRARY.a] Error 1</span><br class="fancyvrb"><a id="x35-191047r23"></a>23  <span id="textcolor4463">$</span> make valgrind
<br class="fancyvrb"><a id="x35-191049r24"></a>24  <span id="textcolor4464">VALGRIND="valgrind --log-file=/tmp/valgrind-%p.log" make</span>
<br class="fancyvrb"><a id="x35-191051r25"></a>25  <span id="textcolor4465">ar rcs build/libYOUR_LIBRARY.a </span><br class="fancyvrb"><a id="x35-191053r26"></a>26  <span id="textcolor4466">ar: no archive members specified</span>
<br class="fancyvrb"><a id="x35-191055r27"></a>27  <span id="textcolor4467">usage:  ar -d [-TLsv] archive file ...</span><br class="fancyvrb"><a id="x35-191057r28"></a>28  <span id="textcolor4468">        ar -m [-TLsv] archive file ...</span>
<br class="fancyvrb"><a id="x35-191059r29"></a>29  <span id="textcolor4469">        ar -m [-abiTLsv] position archive file ...</span>
<br class="fancyvrb"><a id="x35-191061r30"></a>30  <span id="textcolor4470">        ar -p [-TLsv] archive [file ...]</span>
<br class="fancyvrb"><a id="x35-191063r31"></a>31  <span id="textcolor4471">        ar -q [-cTLsv] archive file ...</span><br class="fancyvrb"><a id="x35-191065r32"></a>32  <span id="textcolor4472">        ar -r [-cuTLsv] archive file ...</span>
<br class="fancyvrb"><a id="x35-191067r33"></a>33  <span id="textcolor4473">        ar -r [-abciuTLsv] position archive file ...</span>
<br class="fancyvrb"><a id="x35-191069r34"></a>34  <span id="textcolor4474">        ar -t [-TLsv] archive [file ...]</span><br class="fancyvrb"><a id="x35-191071r35"></a>35  <span id="textcolor4475">        ar -x [-ouTLsv] archive [file ...]</span>
<br class="fancyvrb"><a id="x35-191073r36"></a>36  <span id="textcolor4476">make[1]: ⋆⋆⋆ [build/libYOUR_LIBRARY.a] Error 1</span><br class="fancyvrb"><a id="x35-191075r37"></a>37  <span id="textcolor4477">make: ⋆⋆⋆ [valgrind] Error 2</span><br class="fancyvrb"><a id="x35-191077r38"></a>38  <span id="textcolor4478">$</span></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 416--><p class="indent">    When I run the clean: target that works, but because I don’t have any source
files in the src/ directory none of the other commands really work. I’ll finish that up
in the next exercises.
    </p><h3 class="sectionHead"><span class="titlemark">29.4    </span> <a id="x35-19200029.4"></a>Extra Credit</h3>
<!--l. 422--><p class="noindent">
     </p><ol class="enumerate1"><li class="enumerate" id="x35-192002x1">Try to get the Makefile to actually work by putting a source and header
     file in src/ and making the library. You shouldn’t need a main function
     in the source file.
     </li>
     <li class="enumerate" id="x35-192004x2">Research   what   functions   the   check: target   is   looking   for   in   the
     BADFUNCS regular expression it’s using.
     </li>
     <li class="enumerate" id="x35-192006x3">If you don’t do automated unit testing, then go read about it so you’re
     prepared later.</li></ol><!--l. 1--><div class="crosslinks"><p class="noindent">[<a href="learn-c-the-hard-waych30.html">next</a>] [<a href="learn-c-the-hard-waych28.html">prev</a>] [<a href="learn-c-the-hard-waych28.html#taillearn-c-the-hard-waych28.html">prev-tail</a>] [<a href="learn-c-the-hard-waych29.html">front</a>] [<a href="learn-c-the-hard-waypa2.html#learn-c-the-hard-waych29.html">up</a>] </p></div>
<!--l. 1--><p class="indent">    <a id="taillearn-c-the-hard-waych29.html"></a>   
</p></body></html>