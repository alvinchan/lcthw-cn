<html><head><title>Exercise 17: Heap And Stack Memory Allocation</title><meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="generator"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="originator"></meta><!-- index=1,2,next,fn-in,charset=utf-8,NoFonts,html --><meta content="learn-c-the-hard-way.tex" name="src"></meta><meta content="2012-04-01 17:12:00" name="date"></meta><link href="learn-c-the-hard-way.css" rel="stylesheet" type="text/css"></link></head><body>
    <!--l. 1--><div class="crosslinks"><p class="noindent">[<a href="learn-c-the-hard-waych19.html">next</a>] [<a href="learn-c-the-hard-waych17.html">prev</a>] [<a href="learn-c-the-hard-waych17.html#taillearn-c-the-hard-waych17.html">prev-tail</a>] [<a href="#taillearn-c-the-hard-waych18.html">tail</a>] [<a href="learn-c-the-hard-waypa1.html#learn-c-the-hard-waych18.html">up</a>] </p></div>
    <h2 class="chapterHead"><span class="titlemark">Chapter 18</span><br><a id="x23-8700018"></a>Exercise 17: Heap And Stack Memory Allocation</h2>
<!--l. 3--><p class="noindent">In this exercise you’re going to make a big leap in difficulty and create an entire
small program to manage a database. This database isn’t very efficient and doesn’t
store very much, but it does demonstrate most of what you’ve learned so far. It also
introduces memory allocation more formally and gets you started working with
files. We use some file I/O functions, but I won’t be explaining them too well so you
can try to figure them out first.
<!--l. 11--></p><p class="indent">    As usual, type this whole program in and get it working, then we’ll
discuss:
                                                                  

                                                                  
<!--l. 13--></p><p class="indent">    <a id="x23-87001r43"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 43: </span><span class="content">                                                                                                            ex17.c</span></div><!--tex4ht:label?: x23-87001r43 -->
<div class="fancyvrb" id="fancyvrb20"><a id="x23-87003r1"></a>1  <span id="textcolor1136">#</span><span id="textcolor1137">include <stdio.h></stdio.h></span><br class="fancyvrb"><a id="x23-87005r2"></a>2  <span id="textcolor1138">#</span><span id="textcolor1139">include <assert.h></assert.h></span><br class="fancyvrb"><a id="x23-87007r3"></a>3  <span id="textcolor1140">#</span><span id="textcolor1141">include <stdlib.h></stdlib.h></span>
<br class="fancyvrb"><a id="x23-87009r4"></a>4  <span id="textcolor1142">#</span><span id="textcolor1143">include <errno.h></errno.h></span><br class="fancyvrb"><a id="x23-87011r5"></a>5  <span id="textcolor1144">#</span><span id="textcolor1145">include <string.h></string.h></span><br class="fancyvrb"><a id="x23-87013r6"></a>6  <br class="fancyvrb"><a id="x23-87015r7"></a>7  <span id="textcolor1146">#</span><span id="textcolor1147">define MAX_DATA 512</span>
<br class="fancyvrb"><a id="x23-87017r8"></a>8  <span id="textcolor1148">#</span><span id="textcolor1149">define MAX_ROWS 100</span><br class="fancyvrb"><a id="x23-87019r9"></a>9  <br class="fancyvrb"><a id="x23-87021r10"></a>10  <span id="textcolor1150">struct</span> Address {<br class="fancyvrb"><a id="x23-87023r11"></a>11      <span id="textcolor1151">int</span> id;<br class="fancyvrb"><a id="x23-87025r12"></a>12      <span id="textcolor1152">int</span> set;
<br class="fancyvrb"><a id="x23-87027r13"></a>13      <span id="textcolor1153">char</span> name[MAX_DATA];<br class="fancyvrb"><a id="x23-87029r14"></a>14      <span id="textcolor1154">char</span> email[MAX_DATA];<br class="fancyvrb"><a id="x23-87031r15"></a>15  };<br class="fancyvrb"><a id="x23-87033r16"></a>16  <br class="fancyvrb"><a id="x23-87035r17"></a>17  <span id="textcolor1155">struct</span> Database {
<br class="fancyvrb"><a id="x23-87037r18"></a>18      <span id="textcolor1156">struct</span> Address rows[MAX_ROWS];<br class="fancyvrb"><a id="x23-87039r19"></a>19  };<br class="fancyvrb"><a id="x23-87041r20"></a>20  <br class="fancyvrb"><a id="x23-87043r21"></a>21  <span id="textcolor1157">struct</span> Connection {<br class="fancyvrb"><a id="x23-87045r22"></a>22      <span id="textcolor1158">FILE</span> ⋆file;
<br class="fancyvrb"><a id="x23-87047r23"></a>23      <span id="textcolor1159">struct</span> Database ⋆db;<br class="fancyvrb"><a id="x23-87049r24"></a>24  };<br class="fancyvrb"><a id="x23-87051r25"></a>25  <br class="fancyvrb"><a id="x23-87053r26"></a>26  <span id="textcolor1160">void</span> <span id="textcolor1161">die</span>(<span id="textcolor1162">const</span> <span id="textcolor1163">char</span> ⋆message)<br class="fancyvrb"><a id="x23-87055r27"></a>27  {<br class="fancyvrb"><a id="x23-87057r28"></a>28      <span id="textcolor1164">if</span>(errno) {
<br class="fancyvrb"><a id="x23-87059r29"></a>29          perror(message);<br class="fancyvrb"><a id="x23-87061r30"></a>30      } <span id="textcolor1165">else</span> {<br class="fancyvrb"><a id="x23-87063r31"></a>31          printf(<span class="colorbox" id="colorbox1166"><span id="textcolor1167">"</span></span><span class="colorbox" id="colorbox1168"><span id="textcolor1169">ERROR: %s</span></span><span class="colorbox" id="colorbox1170"><span id="textcolor1171">\n</span></span><span class="colorbox" id="colorbox1172"><span id="textcolor1173">"</span></span>, message);
<br class="fancyvrb"><a id="x23-87065r32"></a>32      }<br class="fancyvrb"><a id="x23-87067r33"></a>33  <br class="fancyvrb"><a id="x23-87069r34"></a>34      exit(<span id="textcolor1174">1</span>);<br class="fancyvrb"><a id="x23-87071r35"></a>35  }<br class="fancyvrb"><a id="x23-87073r36"></a>36  <br class="fancyvrb"><a id="x23-87075r37"></a>37  <span id="textcolor1175">void</span> <span id="textcolor1176">Address_print</span>(<span id="textcolor1177">struct</span> Address ⋆addr)<br class="fancyvrb"><a id="x23-87077r38"></a>38  {
<br class="fancyvrb"><a id="x23-87079r39"></a>39      printf(<span class="colorbox" id="colorbox1178"><span id="textcolor1179">"</span></span><span class="colorbox" id="colorbox1180"><span id="textcolor1181">%d %s %s</span></span><span class="colorbox" id="colorbox1182"><span id="textcolor1183">\n</span></span><span class="colorbox" id="colorbox1184"><span id="textcolor1185">"</span></span>,<br class="fancyvrb"><a id="x23-87081r40"></a>40              addr-&gt;id, addr-&gt;name, addr-&gt;email);
<br class="fancyvrb"><a id="x23-87083r41"></a>41  }<br class="fancyvrb"><a id="x23-87085r42"></a>42  <br class="fancyvrb"><a id="x23-87087r43"></a>43  <span id="textcolor1186">void</span> <span id="textcolor1187">Database_load</span>(<span id="textcolor1188">struct</span> Connection ⋆conn)<br class="fancyvrb"><a id="x23-87089r44"></a>44  {
<br class="fancyvrb"><a id="x23-87091r45"></a>45      <span id="textcolor1189">int</span> rc = fread(conn-&gt;db, <span id="textcolor1190">sizeof</span>(<span id="textcolor1191">struct</span> Database), <span id="textcolor1192">1</span>, conn-&gt;file);
<br class="fancyvrb"><a id="x23-87093r46"></a>46      <span id="textcolor1193">if</span>(rc != <span id="textcolor1194">1</span>) die(<span class="colorbox" id="colorbox1195"><span id="textcolor1196">"</span></span><span class="colorbox" id="colorbox1197"><span id="textcolor1198">Failed to load database.</span></span><span class="colorbox" id="colorbox1199"><span id="textcolor1200">"</span></span>);<br class="fancyvrb"><a id="x23-87095r47"></a>47  }<br class="fancyvrb"><a id="x23-87097r48"></a>48  
<br class="fancyvrb"><a id="x23-87099r49"></a>49  <span id="textcolor1201">struct</span> Connection⋆ <span id="textcolor1202">Database_open</span>(<span id="textcolor1203">const</span> <span id="textcolor1204">char</span> ⋆filename, <span id="textcolor1205">char</span> mode)
<br class="fancyvrb"><a id="x23-87101r50"></a>50  {<br class="fancyvrb"><a id="x23-87103r51"></a>51      <span id="textcolor1206">struct</span> Connection ⋆conn = malloc(<span id="textcolor1207">sizeof</span>(<span id="textcolor1208">struct</span> Connection));
<br class="fancyvrb"><a id="x23-87105r52"></a>52      <span id="textcolor1209">if</span>(!conn) die(<span class="colorbox" id="colorbox1210"><span id="textcolor1211">"</span></span><span class="colorbox" id="colorbox1212"><span id="textcolor1213">Memory error</span></span><span class="colorbox" id="colorbox1214"><span id="textcolor1215">"</span></span>);<br class="fancyvrb"><a id="x23-87107r53"></a>53  <br class="fancyvrb"><a id="x23-87109r54"></a>54      conn-&gt;db = malloc(<span id="textcolor1216">sizeof</span>(<span id="textcolor1217">struct</span> Database));
<br class="fancyvrb"><a id="x23-87111r55"></a>55      <span id="textcolor1218">if</span>(!conn-&gt;db) die(<span class="colorbox" id="colorbox1219"><span id="textcolor1220">"</span></span><span class="colorbox" id="colorbox1221"><span id="textcolor1222">Memory error</span></span><span class="colorbox" id="colorbox1223"><span id="textcolor1224">"</span></span>);<br class="fancyvrb"><a id="x23-87113r56"></a>56  <br class="fancyvrb"><a id="x23-87115r57"></a>57      <span id="textcolor1225">if</span>(mode == <span class="colorbox" id="colorbox1226"><span id="textcolor1227">’c’</span></span>) {
<br class="fancyvrb"><a id="x23-87117r58"></a>58          conn-&gt;file = fopen(filename, <span class="colorbox" id="colorbox1228"><span id="textcolor1229">"</span></span><span class="colorbox" id="colorbox1230"><span id="textcolor1231">w</span></span><span class="colorbox" id="colorbox1232"><span id="textcolor1233">"</span></span>);<br class="fancyvrb"><a id="x23-87119r59"></a>59      } <span id="textcolor1234">else</span> {
<br class="fancyvrb"><a id="x23-87121r60"></a>60          conn-&gt;file = fopen(filename, <span class="colorbox" id="colorbox1235"><span id="textcolor1236">"</span></span><span class="colorbox" id="colorbox1237"><span id="textcolor1238">r+</span></span><span class="colorbox" id="colorbox1239"><span id="textcolor1240">"</span></span>);<br class="fancyvrb"><a id="x23-87123r61"></a>61  <br class="fancyvrb"><a id="x23-87125r62"></a>62          <span id="textcolor1241">if</span>(conn-&gt;file) {
<br class="fancyvrb"><a id="x23-87127r63"></a>63              Database_load(conn);<br class="fancyvrb"><a id="x23-87129r64"></a>64          }<br class="fancyvrb"><a id="x23-87131r65"></a>65      }<br class="fancyvrb"><a id="x23-87133r66"></a>66  
<br class="fancyvrb"><a id="x23-87135r67"></a>67      <span id="textcolor1242">if</span>(!conn-&gt;file) die(<span class="colorbox" id="colorbox1243"><span id="textcolor1244">"</span></span><span class="colorbox" id="colorbox1245"><span id="textcolor1246">Failed to open the file</span></span><span class="colorbox" id="colorbox1247"><span id="textcolor1248">"</span></span>);<br class="fancyvrb"><a id="x23-87137r68"></a>68  
<br class="fancyvrb"><a id="x23-87139r69"></a>69      <span id="textcolor1249">return</span> conn;<br class="fancyvrb"><a id="x23-87141r70"></a>70  }<br class="fancyvrb"><a id="x23-87143r71"></a>71  <br class="fancyvrb"><a id="x23-87145r72"></a>72  <span id="textcolor1250">void</span> <span id="textcolor1251">Database_close</span>(<span id="textcolor1252">struct</span> Connection ⋆conn)
<br class="fancyvrb"><a id="x23-87147r73"></a>73  {<br class="fancyvrb"><a id="x23-87149r74"></a>74      <span id="textcolor1253">if</span>(conn) {<br class="fancyvrb"><a id="x23-87151r75"></a>75          <span id="textcolor1254">if</span>(conn-&gt;file) fclose(conn-&gt;file);
<br class="fancyvrb"><a id="x23-87153r76"></a>76          <span id="textcolor1255">if</span>(conn-&gt;db) free(conn-&gt;db);<br class="fancyvrb"><a id="x23-87155r77"></a>77          free(conn);<br class="fancyvrb"><a id="x23-87157r78"></a>78      }<br class="fancyvrb"><a id="x23-87159r79"></a>79  }<br class="fancyvrb"><a id="x23-87161r80"></a>80  
<br class="fancyvrb"><a id="x23-87163r81"></a>81  <span id="textcolor1256">void</span> <span id="textcolor1257">Database_write</span>(<span id="textcolor1258">struct</span> Connection ⋆conn)<br class="fancyvrb"><a id="x23-87165r82"></a>82  {<br class="fancyvrb"><a id="x23-87167r83"></a>83      rewind(conn-&gt;file);
<br class="fancyvrb"><a id="x23-87169r84"></a>84  <br class="fancyvrb"><a id="x23-87171r85"></a>85      <span id="textcolor1259">int</span> rc = fwrite(conn-&gt;db, <span id="textcolor1260">sizeof</span>(<span id="textcolor1261">struct</span> Database), <span id="textcolor1262">1</span>, conn-&gt;file);
<br class="fancyvrb"><a id="x23-87173r86"></a>86      <span id="textcolor1263">if</span>(rc != <span id="textcolor1264">1</span>) die(<span class="colorbox" id="colorbox1265"><span id="textcolor1266">"</span></span><span class="colorbox" id="colorbox1267"><span id="textcolor1268">Failed to write database.</span></span><span class="colorbox" id="colorbox1269"><span id="textcolor1270">"</span></span>);<br class="fancyvrb"><a id="x23-87175r87"></a>87  
<br class="fancyvrb"><a id="x23-87177r88"></a>88      rc = fflush(conn-&gt;file);<br class="fancyvrb"><a id="x23-87179r89"></a>89      <span id="textcolor1271">if</span>(rc == -<span id="textcolor1272">1</span>) die(<span class="colorbox" id="colorbox1273"><span id="textcolor1274">"</span></span><span class="colorbox" id="colorbox1275"><span id="textcolor1276">Cannot flush database.</span></span><span class="colorbox" id="colorbox1277"><span id="textcolor1278">"</span></span>);
<br class="fancyvrb"><a id="x23-87181r90"></a>90  }<br class="fancyvrb"><a id="x23-87183r91"></a>91  <br class="fancyvrb"><a id="x23-87185r92"></a>92  <span id="textcolor1279">void</span> <span id="textcolor1280">Database_create</span>(<span id="textcolor1281">struct</span> Connection ⋆conn)<br class="fancyvrb"><a id="x23-87187r93"></a>93  {<br class="fancyvrb"><a id="x23-87189r94"></a>94      <span id="textcolor1282">int</span> i = <span id="textcolor1283">0</span>;<br class="fancyvrb"><a id="x23-87191r95"></a>95  
<br class="fancyvrb"><a id="x23-87193r96"></a>96      <span id="textcolor1284">for</span>(i = <span id="textcolor1285">0</span>; i <a id="x23-87195r97"></a>97          <span id="textcolor1286">// make a prototype to initialize it</span>
<br class="fancyvrb"><a id="x23-87197r98"></a>98          <span id="textcolor1287">struct</span> Address addr = {.id = i, .set = <span id="textcolor1288">0</span>};
<br class="fancyvrb"><a id="x23-87199r99"></a>99          <span id="textcolor1289">// then just assign it</span><br class="fancyvrb"><a id="x23-87201r100"></a>100          conn-&gt;db-&gt;rows[i] = addr;<br class="fancyvrb"><a id="x23-87203r101"></a>101      }<br class="fancyvrb"><a id="x23-87205r102"></a>102  }<br class="fancyvrb"><a id="x23-87207r103"></a>103  
<br class="fancyvrb"><a id="x23-87209r104"></a>104  <span id="textcolor1290">void</span> <span id="textcolor1291">Database_set</span>(<span id="textcolor1292">struct</span> Connection ⋆conn, <span id="textcolor1293">int</span> id, <span id="textcolor1294">const</span> <span id="textcolor1295">char</span> ⋆name, <span id="textcolor1296">const</span> <span id="textcolor1297">char</span> ⋆email)
<br class="fancyvrb"><a id="x23-87211r105"></a>105  {<br class="fancyvrb"><a id="x23-87213r106"></a>106      <span id="textcolor1298">struct</span> Address ⋆addr = &amp;conn-&gt;db-&gt;rows[id];
<br class="fancyvrb"><a id="x23-87215r107"></a>107      <span id="textcolor1299">if</span>(addr-&gt;set) die(<span class="colorbox" id="colorbox1300"><span id="textcolor1301">"</span></span><span class="colorbox" id="colorbox1302"><span id="textcolor1303">Already set, delete it first</span></span><span class="colorbox" id="colorbox1304"><span id="textcolor1305">"</span></span>);<br class="fancyvrb"><a id="x23-87217r108"></a>108  <br class="fancyvrb"><a id="x23-87219r109"></a>109      addr-&gt;set = <span id="textcolor1306">1</span>;
<br class="fancyvrb"><a id="x23-87221r110"></a>110      <span id="textcolor1307">// WARNING: bug, read the "How To Break It" and fix this</span>
<br class="fancyvrb"><a id="x23-87223r111"></a>111      <span id="textcolor1308">char</span> ⋆res = strncpy(addr-&gt;name, name, MAX_DATA);
                                                                  

                                                                  
<br class="fancyvrb"><a id="x23-87225r112"></a>112      <span id="textcolor1309">// demonstrate the strncpy bug</span><br class="fancyvrb"><a id="x23-87227r113"></a>113      <span id="textcolor1310">if</span>(!res) die(<span class="colorbox" id="colorbox1311"><span id="textcolor1312">"</span></span><span class="colorbox" id="colorbox1313"><span id="textcolor1314">Name copy failed</span></span><span class="colorbox" id="colorbox1315"><span id="textcolor1316">"</span></span>);
<br class="fancyvrb"><a id="x23-87229r114"></a>114  <br class="fancyvrb"><a id="x23-87231r115"></a>115      res = strncpy(addr-&gt;email, email, MAX_DATA);
<br class="fancyvrb"><a id="x23-87233r116"></a>116      <span id="textcolor1317">if</span>(!res) die(<span class="colorbox" id="colorbox1318"><span id="textcolor1319">"</span></span><span class="colorbox" id="colorbox1320"><span id="textcolor1321">Email copy failed</span></span><span class="colorbox" id="colorbox1322"><span id="textcolor1323">"</span></span>);<br class="fancyvrb"><a id="x23-87235r117"></a>117  }<br class="fancyvrb"><a id="x23-87237r118"></a>118  
<br class="fancyvrb"><a id="x23-87239r119"></a>119  <span id="textcolor1324">void</span> <span id="textcolor1325">Database_get</span>(<span id="textcolor1326">struct</span> Connection ⋆conn, <span id="textcolor1327">int</span> id)<br class="fancyvrb"><a id="x23-87241r120"></a>120  {
<br class="fancyvrb"><a id="x23-87243r121"></a>121      <span id="textcolor1328">struct</span> Address ⋆addr = &amp;conn-&gt;db-&gt;rows[id];<br class="fancyvrb"><a id="x23-87245r122"></a>122  <br class="fancyvrb"><a id="x23-87247r123"></a>123      <span id="textcolor1329">if</span>(addr-&gt;set) {
<br class="fancyvrb"><a id="x23-87249r124"></a>124          Address_print(addr);<br class="fancyvrb"><a id="x23-87251r125"></a>125      } <span id="textcolor1330">else</span> {<br class="fancyvrb"><a id="x23-87253r126"></a>126          die(<span class="colorbox" id="colorbox1331"><span id="textcolor1332">"</span></span><span class="colorbox" id="colorbox1333"><span id="textcolor1334">ID is not set</span></span><span class="colorbox" id="colorbox1335"><span id="textcolor1336">"</span></span>);
<br class="fancyvrb"><a id="x23-87255r127"></a>127      }<br class="fancyvrb"><a id="x23-87257r128"></a>128  }<br class="fancyvrb"><a id="x23-87259r129"></a>129  <br class="fancyvrb"><a id="x23-87261r130"></a>130  <span id="textcolor1337">void</span> <span id="textcolor1338">Database_delete</span>(<span id="textcolor1339">struct</span> Connection ⋆conn, <span id="textcolor1340">int</span> id)<br class="fancyvrb"><a id="x23-87263r131"></a>131  {
<br class="fancyvrb"><a id="x23-87265r132"></a>132      <span id="textcolor1341">struct</span> Address addr = {.id = id, .set = <span id="textcolor1342">0</span>};<br class="fancyvrb"><a id="x23-87267r133"></a>133      conn-&gt;db-&gt;rows[id] = addr;
<br class="fancyvrb"><a id="x23-87269r134"></a>134  }<br class="fancyvrb"><a id="x23-87271r135"></a>135  <br class="fancyvrb"><a id="x23-87273r136"></a>136  <span id="textcolor1343">void</span> <span id="textcolor1344">Database_list</span>(<span id="textcolor1345">struct</span> Connection ⋆conn)<br class="fancyvrb"><a id="x23-87275r137"></a>137  {<br class="fancyvrb"><a id="x23-87277r138"></a>138      <span id="textcolor1346">int</span> i = <span id="textcolor1347">0</span>;
<br class="fancyvrb"><a id="x23-87279r139"></a>139      <span id="textcolor1348">struct</span> Database ⋆db = conn-&gt;db;<br class="fancyvrb"><a id="x23-87281r140"></a>140  <br class="fancyvrb"><a id="x23-87283r141"></a>141      <span id="textcolor1349">for</span>(i = <span id="textcolor1350">0</span>; i <a id="x23-87285r142"></a>142          <span id="textcolor1351">struct</span> Address ⋆cur = &amp;db-&gt;rows[i];<br class="fancyvrb"><a id="x23-87287r143"></a>143  
<br class="fancyvrb"><a id="x23-87289r144"></a>144          <span id="textcolor1352">if</span>(cur-&gt;set) {<br class="fancyvrb"><a id="x23-87291r145"></a>145              Address_print(cur);
<br class="fancyvrb"><a id="x23-87293r146"></a>146          }<br class="fancyvrb"><a id="x23-87295r147"></a>147      }<br class="fancyvrb"><a id="x23-87297r148"></a>148  }<br class="fancyvrb"><a id="x23-87299r149"></a>149  <br class="fancyvrb"><a id="x23-87301r150"></a>150  <span id="textcolor1353">int</span> <span id="textcolor1354">main</span>(<span id="textcolor1355">int</span> argc, <span id="textcolor1356">char</span> ⋆argv[])<br class="fancyvrb"><a id="x23-87303r151"></a>151  {
<br class="fancyvrb"><a id="x23-87305r152"></a>152      <span id="textcolor1357">if</span>(argc 3) die(<span class="colorbox" id="colorbox1359"><span id="textcolor1360">"</span></span><span class="colorbox" id="colorbox1361"><span id="textcolor1362">USAGE: ex17 <dbfile> <action> [action params]</action></dbfile></span></span><span class="colorbox" id="colorbox1363"><span id="textcolor1364">"</span></span>);
<br class="fancyvrb"><a id="x23-87307r153"></a>153  <br class="fancyvrb"><a id="x23-87309r154"></a>154      <span id="textcolor1365">char</span> ⋆filename = argv[<span id="textcolor1366">1</span>];<br class="fancyvrb"><a id="x23-87311r155"></a>155      <span id="textcolor1367">char</span> action = argv[<span id="textcolor1368">2</span>][<span id="textcolor1369">0</span>];
<br class="fancyvrb"><a id="x23-87313r156"></a>156      <span id="textcolor1370">struct</span> Connection ⋆conn = Database_open(filename, action);
<br class="fancyvrb"><a id="x23-87315r157"></a>157      <span id="textcolor1371">int</span> id = <span id="textcolor1372">0</span>;<br class="fancyvrb"><a id="x23-87317r158"></a>158  <br class="fancyvrb"><a id="x23-87319r159"></a>159      <span id="textcolor1373">if</span>(argc &gt; <span id="textcolor1374">3</span>) id = atoi(argv[<span id="textcolor1375">3</span>]);
<br class="fancyvrb"><a id="x23-87321r160"></a>160      <span id="textcolor1376">if</span>(id &gt;= MAX_ROWS) die(<span class="colorbox" id="colorbox1377"><span id="textcolor1378">"</span></span><span class="colorbox" id="colorbox1379"><span id="textcolor1380">There’s not that many records.</span></span><span class="colorbox" id="colorbox1381"><span id="textcolor1382">"</span></span>);<br class="fancyvrb"><a id="x23-87323r161"></a>161  
<br class="fancyvrb"><a id="x23-87325r162"></a>162      <span id="textcolor1383">switch</span>(action) {<br class="fancyvrb"><a id="x23-87327r163"></a>163          <span id="textcolor1384">case</span> <span class="colorbox" id="colorbox1385"><span id="textcolor1386">’c’</span></span>:<br class="fancyvrb"><a id="x23-87329r164"></a>164              Database_create(conn);
<br class="fancyvrb"><a id="x23-87331r165"></a>165              Database_write(conn);<br class="fancyvrb"><a id="x23-87333r166"></a>166              <span id="textcolor1387">break</span>;<br class="fancyvrb"><a id="x23-87335r167"></a>167  
<br class="fancyvrb"><a id="x23-87337r168"></a>168          <span id="textcolor1388">case</span> <span class="colorbox" id="colorbox1389"><span id="textcolor1390">’g’</span></span>:<br class="fancyvrb"><a id="x23-87339r169"></a>169              <span id="textcolor1391">if</span>(argc != <span id="textcolor1392">4</span>) die(<span class="colorbox" id="colorbox1393"><span id="textcolor1394">"</span></span><span class="colorbox" id="colorbox1395"><span id="textcolor1396">Need an id to get</span></span><span class="colorbox" id="colorbox1397"><span id="textcolor1398">"</span></span>);<br class="fancyvrb"><a id="x23-87341r170"></a>170  
<br class="fancyvrb"><a id="x23-87343r171"></a>171              Database_get(conn, id);<br class="fancyvrb"><a id="x23-87345r172"></a>172              <span id="textcolor1399">break</span>;<br class="fancyvrb"><a id="x23-87347r173"></a>173  <br class="fancyvrb"><a id="x23-87349r174"></a>174          <span id="textcolor1400">case</span> <span class="colorbox" id="colorbox1401"><span id="textcolor1402">’s’</span></span>:
<br class="fancyvrb"><a id="x23-87351r175"></a>175              <span id="textcolor1403">if</span>(argc != <span id="textcolor1404">6</span>) die(<span class="colorbox" id="colorbox1405"><span id="textcolor1406">"</span></span><span class="colorbox" id="colorbox1407"><span id="textcolor1408">Need id, name, email to set</span></span><span class="colorbox" id="colorbox1409"><span id="textcolor1410">"</span></span>);
<br class="fancyvrb"><a id="x23-87353r176"></a>176  <br class="fancyvrb"><a id="x23-87355r177"></a>177              Database_set(conn, id, argv[<span id="textcolor1411">4</span>], argv[<span id="textcolor1412">5</span>]);
<br class="fancyvrb"><a id="x23-87357r178"></a>178              Database_write(conn);<br class="fancyvrb"><a id="x23-87359r179"></a>179              <span id="textcolor1413">break</span>;<br class="fancyvrb"><a id="x23-87361r180"></a>180  
<br class="fancyvrb"><a id="x23-87363r181"></a>181          <span id="textcolor1414">case</span> <span class="colorbox" id="colorbox1415"><span id="textcolor1416">’d’</span></span>:<br class="fancyvrb"><a id="x23-87365r182"></a>182              <span id="textcolor1417">if</span>(argc != <span id="textcolor1418">4</span>) die(<span class="colorbox" id="colorbox1419"><span id="textcolor1420">"</span></span><span class="colorbox" id="colorbox1421"><span id="textcolor1422">Need id to delete</span></span><span class="colorbox" id="colorbox1423"><span id="textcolor1424">"</span></span>);
<br class="fancyvrb"><a id="x23-87367r183"></a>183  <br class="fancyvrb"><a id="x23-87369r184"></a>184              Database_delete(conn, id);
<br class="fancyvrb"><a id="x23-87371r185"></a>185              Database_write(conn);<br class="fancyvrb"><a id="x23-87373r186"></a>186              <span id="textcolor1425">break</span>;<br class="fancyvrb"><a id="x23-87375r187"></a>187  <br class="fancyvrb"><a id="x23-87377r188"></a>188          <span id="textcolor1426">case</span> <span class="colorbox" id="colorbox1427"><span id="textcolor1428">’l’</span></span>:
<br class="fancyvrb"><a id="x23-87379r189"></a>189              Database_list(conn);<br class="fancyvrb"><a id="x23-87381r190"></a>190              <span id="textcolor1429">break</span>;<br class="fancyvrb"><a id="x23-87383r191"></a>191          <span id="textcolor1430">default:</span>
<br class="fancyvrb"><a id="x23-87385r192"></a>192              die(<span class="colorbox" id="colorbox1431"><span id="textcolor1432">"</span></span><span class="colorbox" id="colorbox1433"><span id="textcolor1434">Invalid action, only: c=create, g=get, s=set, d=del, l=list</span></span><span class="colorbox" id="colorbox1435"><span id="textcolor1436">"</span></span>);
<br class="fancyvrb"><a id="x23-87387r193"></a>193      }<br class="fancyvrb"><a id="x23-87389r194"></a>194  <br class="fancyvrb"><a id="x23-87391r195"></a>195      Database_close(conn);<br class="fancyvrb"><a id="x23-87393r196"></a>196  <br class="fancyvrb"><a id="x23-87395r197"></a>197      <span id="textcolor1437">return</span> <span id="textcolor1438">0</span>;<br class="fancyvrb"><a id="x23-87397r198"></a>198  }</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 217--><p class="indent">    In this program I am using a set of structures to create a simple database for an
address book. In it I’m using some things you’ve never seen, so you should go
through it line-by-line, explain what each line does, and look up any functions you
do not recognize. There are few key things I’m doing that you should pay attention
to as well:
     </p><dl class="description"><dt class="description">
#define for constants </dt><dd class="description">I  use  another  part  of  the  ”C  Pre-Processor”  to  create
     constant settings of MAX_DATA and MAX_ROWS. I’ll cover more of what
     the CPP does, but this is a way to create a constant that will work reliably.
     There’s other ways but they don’t apply in certain situations.
     </dd><dt class="description">
Fixed Sized Structs </dt><dd class="description">The Address struct then uses these constants to create a
     piece of data that is fixed in size making it less efficient, but easier to store
     and read. The Database struct is then also fixed size because it is a fixed
     length array of Address structs. That lets you write the whole thing to
     disk in one move later on.
     </dd><dt class="description">
die function to abort with an error </dt><dd class="description">In a small program like this you can make
     a single function that kills the program with an error if there’s anything
     wrong. I call this die, and it’s used after any failed function calls or bad
     inputs to exit with an error using exit.
     </dd><dt class="description">
errno and perror() for error reporting </dt><dd class="description">When you have an error return from a
     function, it will usually set an ”external” variable called errno to say
     exactly  what  error  happened.  These  are  just  numbers,  so  you  can  use
     perror to ”print the error message”.
     </dd><dt class="description">
FILE functions </dt><dd class="description">I’m using all new functions like fopen, fread, fclose, and
     rewind to  work  with  files.  Each  of  these  functions  works  on  a  FILE
     struct  that’s  just  like  your  structs,  but  it’s  defined  by  the  C  standard
     library.
                                                                  

                                                                  
     </dd><dt class="description">
nested struct pointers </dt><dd class="description">There’s   use   of   nested   structures   and   getting   the
     address of array elements that you should study. Specifically code like
     <span class="obeylines-h"><span class="verb">&amp;conn-&gt;db-&gt;rows[i]</span></span> which reads ”get the i element of rows, which
     is in db, which is in conn, then get the address of (&amp;) it”.
     </dd><dt class="description">
copying struct prototypes </dt><dd class="description">best shown in Database_delete, you can see I’m
     using a temporary local Address, initializing its id and set fields, and
     then simply copying it into the rows array by assigning it to the element
     I want. This trick makes sure that all fields but set and id are initialized
     to 0s and is actually easier to write. Incidentally, you shouldn’t be using
     memcpy to do these kinds of struct copying operations. Modern C allows
     you to simply assign one struct to another and it’ll handle the copying
     for you.
     </dd><dt class="description">
processing complex arguments </dt><dd class="description">I’m   doing   some   more   complex   argument
     parsing, but this isn’t really the best way to do it. We’ll get into better
     option parsing later in the book.
     </dd><dt class="description">
converting strings to ints </dt><dd class="description">I use the atoi function to take the string for the id
     on the command line and convert it to the int id variable. Read up on
     this function and similar ones.
     </dd><dt class="description">
allocating large data on the ”heap” </dt><dd class="description">The  whole  point  of  this  program  is  that
     I’m using malloc to ask the OS for a large amount of memory to work
     with when I create the Database. I cover this in more detail below.
     </dd><dt class="description">
NULL is 0 so boolean works </dt><dd class="description">In many of the checks I’m testing that a pointer
     is not NULL by simply doing <span class="obeylines-h"><span class="verb">if(!ptr) die("fail!")</span></span> this is valid
     because NULL is the same as 0 so it will evaluate to false. You could be
     explicit and say <span class="obeylines-h"><span class="verb">if(ptr == NULL) die("fail!")</span></span> as well.</dd></dl><h3 class="sectionHead"><span class="titlemark">18.1    </span> <a id="x23-8800018.1"></a>What You Should See</h3>
<!--l. 277--><p class="noindent">You should spend as much time as you can testing that it works, and running it
with Valgrind to confirm you’ve got all the memory usage right. Here’s a
session of me testing it normally and then using Valgrind to check the
operations:
                                                                  

                                                                  
<!--l. 282--></p><p class="indent">    <a id="x23-88001r44"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 44: </span><span class="content">                                                                                                               ex17
output</span></div><!--tex4ht:label?: x23-88001r44 -->
<!--l. 283-->
<div class="lstlisting" id="listing-28"><span class="label"><a id="x23-88002r1"></a>1</span>$ make ex17 <br><span class="label"><a id="x23-88003r2"></a>2</span>cc -Wall -g    ex17.c   -o ex17 <br><span class="label"><a id="x23-88004r3"></a>3</span>$ ./ex17 db.dat c <br><span class="label"><a id="x23-88005r4"></a>4</span>$ ./ex17 db.dat s 1 zed zed@zedshaw.com <br><span class="label"><a id="x23-88006r5"></a>5</span>$ ./ex17 db.dat s 2 frank frank@zedshaw.com <br><span class="label"><a id="x23-88007r6"></a>6</span>$ ./ex17 db.dat s 3 joe joe@zedshaw.com <br><span class="label"><a id="x23-88008r7"></a>7</span>$ <br><span class="label"><a id="x23-88009r8"></a>8</span>$ ./ex17 db.dat l <br><span class="label"><a id="x23-88010r9"></a>9</span>1 zed zed@zedshaw.com <br><span class="label"><a id="x23-88011r10"></a>10</span>2 frank frank@zedshaw.com <br><span class="label"><a id="x23-88012r11"></a>11</span>3 joe joe@zedshaw.com <br><span class="label"><a id="x23-88013r12"></a>12</span>$ ./ex17 db.dat d 3 <br><span class="label"><a id="x23-88014r13"></a>13</span>$ ./ex17 db.dat l <br><span class="label"><a id="x23-88015r14"></a>14</span>1 zed zed@zedshaw.com <br><span class="label"><a id="x23-88016r15"></a>15</span>2 frank frank@zedshaw.com <br><span class="label"><a id="x23-88017r16"></a>16</span>$ ./ex17 db.dat g 2 <br><span class="label"><a id="x23-88018r17"></a>17</span>2 frank frank@zedshaw.com <br><span class="label"><a id="x23-88019r18"></a>18</span>$ <br><span class="label"><a id="x23-88020r19"></a>19</span>$ valgrind --leak-check=yes ./ex17 db.dat g 2 <br><span class="label"><a id="x23-88021r20"></a>20</span># cut valgrind output... <br><span class="label"><a id="x23-88022r21"></a>21</span>$
</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 309--><p class="indent">    The actual output of Valgrind is taken out since you should be able to detect
it.
                                                                  

                                                                  
<!--l. 312--></p><p class="indent">    <a id="x23-88025r5"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Note 5: </span><span class="content">                                                                                                    OSX Valgrind
”Leaks”</span></div><!--tex4ht:label?: x23-88025r5 -->
     <div class="quote">
     <!--l. 313--><p class="indent">   Valgrind will report that you’re leaking small blocks of memory,
     but  sometimes  it’s  just  over-reporting  from  OSX’s  internal  APIs.
     If you see it showing leaks that aren’t inside your code then just
     ignore them. </p></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><h3 class="sectionHead"><span class="titlemark">18.2    </span> <a id="x23-8900018.2"></a>Heap vs. Stack Allocation</h3>
<!--l. 320--><p class="noindent">You kids these days have it great. You play with your Ruby or Python and just
make objects and variables without any care for where they live. You don’t
care if it’s on the ”stack”, and the heap? Fuggedaboutit. You don’t even
know, and you know what, chances are your language of choice doesn’t even
put the variables on stack at all. It’s all heap, and you don’t even know if it
is.
<!--l. 327--></p><p class="indent">    C is different because it’s using the real CPU’s actual machinery to do
its work, and that involves a chunk of ram called the stack and another
called the heap. What’s the difference? It all depends on where you get the
storage.
<!--l. 332--></p><p class="indent">    The heap is easier to explain as it’s just all the remaining memory in your
computer, and you access it with the function malloc to get more. Each time you
call malloc, the OS uses internal functions to register that piece of memory to you,
and then returns a pointer to it. When you’re done with it, you use free to return it
to the OS so that it can be used by other programs. Failing to do this will cause your
program to ”leak” memory, but Valgrind will help you track these leaks
down.
<!--l. 341--></p><p class="indent">    The stack is a special region of memory that stores temporary variables each
function creates as locals to that function. How it works is each argument to a
function is ”pushed” onto the stack, and then used inside the function. It is really a
stack data structure, so the last thing in is the first thing out. This also happens with
all local variables like char action and int id in main. The advantage of using a
stack for this is simply that, when the function exits, the C compiler ”pops” these
variables off the stack to clean up. This is simple and prevents memory leaks if the
variable is on the stack.
<!--l. 351--></p><p class="indent">    The easiest way to keep this straight is with this mantra: If you didn’t
get it from malloc or a function that got it from malloc, then it’s on the
                                                                  

                                                                  
stack.
<!--l. 355--></p><p class="indent">    There’s three primary problems with stacks and heaps to watch for:
<!--l. 357--></p><p class="indent">
     </p><ol class="enumerate1"><li class="enumerate" id="x23-89002x1">If you get a block of memory from malloc, and have that pointer on the
     stack, then when the function exits, the pointer will get popped off and
     lost.
     </li>
     <li class="enumerate" id="x23-89004x2">If you put too much data on the stack (like large structs and arrays) then
     you can cause a ”stack overflow” and the program will abort. In this case,
     use the heap with malloc.
     </li>
     <li class="enumerate" id="x23-89006x3">If  you  take  a  pointer  to  something  on  the  stack,  and  then  pass  that
     or  return  it  from  your  function,  then  the  function  receiving  it  will
     ”segmentation fault” (segfault) because the actual data will get popped
     off and disappear. You’ll be pointing at dead space.</li></ol><!--l. 370--><p class="indent">    This is why in the program I’ve created a Database_open that allocates
memory or dies, and then a Database_close that frees everything. If you
create a ”create” function, that makes the whole thing or nothing, and then a
”destroy” function that cleans up everything safely, then it’s easier to keep it all
straight.
<!--l. 376--></p><p class="indent">    Finally, when a program exits the OS will clean up all the resources for you, but
sometimes not immediately. A common idiom (and one I use in this exercise) is to
just abort and let the OS clean up on error.
<!--l. 380--></p><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">18.3    </span> <a id="x23-9000018.3"></a>How To Break It</h3>
<!--l. 382--><p class="noindent">This program has a lot of places you can break it, so try some of these but also come
up with your own:
                                                                  

                                                                  
<!--l. 385--></p><p class="indent">
     </p><ol class="enumerate1"><li class="enumerate" id="x23-90002x1">The classic way is to remove some of the safety checks such that you can
     pass in arbitrary data. For example, if you remove the check on line 159
     that prevents you from passing in any record number.
     </li>
     <li class="enumerate" id="x23-90004x2">You can also try corrupting the data file. Open it in any editor and change
     random bytes then close it.
     </li>
     <li class="enumerate" id="x23-90006x3">You could also find ways to pass bad arguments to the program when it’s
     run, such as getting the file and action backwards will make it create a
     file named after the action, then do an action based on the first character.
     </li>
     <li class="enumerate" id="x23-90008x4">There  is  a  bug  in  this  program  because  of  strncpy being  poorly
     designed.  Go  read  about  strncpy then  try  to  find  out  what  happens
     when the name or address you give is greater than 512 bytes. Fix this by
     simply forcing the last character to <span class="obeylines-h"><span class="verb">’\0’</span></span> so that it’s always set no matter
     what (which is what strncpy should do).
     </li>
     <li class="enumerate" id="x23-90010x5">In the extra credit I have you augment the program to create arbitrary
     size databases. Try to see what the biggest database is before you cause
     the program to die for lack of memory from malloc.</li></ol><!--l. 405--><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">18.4    </span> <a id="x23-9100018.4"></a>Extra Credit</h3>
<!--l. 407--><p class="noindent">
     </p><ol class="enumerate1"><li class="enumerate" id="x23-91002x1">The  die function  needs  to  be  augmented  to  let  you  pass  the  conn
     variable so it can close it and clean up.
                                                                  

                                                                  
     </li>
     <li class="enumerate" id="x23-91004x2">Change  the  code  to  accept  parameters  for  MAX_DATA and  MAX_ROWS,
     store them in the Database struct, and write that to the file, thus creating
     a database that can be arbitrarily sized.
     </li>
     <li class="enumerate" id="x23-91006x3">Add more operations you can do on the database, like find.
     </li>
     <li class="enumerate" id="x23-91008x4">Read about how C does it’s struct packing, and then try to see why your
     file is the size it is. See if you can calculate a new size after adding more
     fields.
     </li>
     <li class="enumerate" id="x23-91010x5">Add some more fields to the Address and make them searchable.
     </li>
     <li class="enumerate" id="x23-91012x6">Write  a  shell  script  that  will  do  your  testing  automatically  for  you  by
     running commands in the right order. Hint: Use <span class="obeylines-h"><span class="verb">set -e</span></span> at the top of a
     bash to make it abort the whole script if any command has an error.
     </li>
     <li class="enumerate" id="x23-91014x7">Try  reworking  the  program  to  use  a  single  global  for  the  database
     connection. How does this new version of the program compare to the
     other one?
     </li>
     <li class="enumerate" id="x23-91016x8">Go  research  ”stack  data  structure”  and  write  one  in  your  favorite
     language, then try to do it in C.</li></ol><!--l. 1--><div class="crosslinks"><p class="noindent">[<a href="learn-c-the-hard-waych19.html">next</a>] [<a href="learn-c-the-hard-waych17.html">prev</a>] [<a href="learn-c-the-hard-waych17.html#taillearn-c-the-hard-waych17.html">prev-tail</a>] [<a href="learn-c-the-hard-waych18.html">front</a>] [<a href="learn-c-the-hard-waypa1.html#learn-c-the-hard-waych18.html">up</a>] </p></div>
<!--l. 1--><p class="indent">    <a id="taillearn-c-the-hard-waych18.html"></a>   
</p></body></html>