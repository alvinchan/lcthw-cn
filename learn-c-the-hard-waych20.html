<html><head><title>习题19: 一个简单的对象系统</title><meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="generator"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="originator"></meta><!-- index=1,2,next,fn-in,charset=utf-8,NoFonts,html --><meta content="learn-c-the-hard-way.tex" name="src"></meta><meta content="2012-04-11 11:32:00" name="date"></meta><link href="learn-c-the-hard-way.css" rel="stylesheet" type="text/css"></link></head><body>
    <!--l. 1--><div class="crosslinks"><p class="noindent">[<a href="learn-c-the-hard-waych21.html">next</a>] [<a href="learn-c-the-hard-waych19.html">prev</a>] [<a href="learn-c-the-hard-waych19.html#taillearn-c-the-hard-waych19.html">prev-tail</a>] [<a href="#taillearn-c-the-hard-waych20.html">tail</a>] [<a href="learn-c-the-hard-waypa1.html#learn-c-the-hard-waych20.html">up</a>] </p></div>
    <h2 class="chapterHead"><span class="titlemark">Chapter 20</span><br><a id="x25-9600020"></a>习题19: 一个简单的对象系统</h2>
<!--l. 3--><p class="noindent">I learned C before I learned Object Oriented Programming, so it helped me to build
an OOP system in C to understand the basics of what OOP meant. You are probably
the kind of person who learned an OOP language before you learned C, so
this kind of bridge might help you as well. In this exercise, you will build
a simple object system, but also learn more about the C Pre-Processor or
CPP.
<!--l. 10--></p><p class="indent">    This exercise will build a simple game where you kill a Minotaur in a small little
castle. Nothing fancy, just four rooms and a bad guy. This project will also be a
multi-file project, and look more like a real C software project than your previous
ones. This is why I’m introducing the CPP here because you need it to start using
multiple files in your own software.
    </p><h3 class="sectionHead"><span class="titlemark">20.1    </span> <a id="x25-9700020.1"></a>How The CPP Works</h3>
<!--l. 18--><p class="noindent">The C Pre-Processor is a template processing system. It’s a highly targeted one
that helps make C easier to work with, but it does this by having a syntax
aware templating mechanism. Traditionally people just used the CPP to store
constants and make ”macros” to simplify repetitive coding. In modern C
you’ll actually use the CPP as a code generator to create templated pieces of
code.
<!--l. 25--></p><p class="indent">    How the CPP works is you give it one file, usually a .c
file, and it processes various bits of text starting with the <span class="obeylines-h"><span class="verb">#</span></span>
(octothorpe<span class="footnote-mark"><a href="#fn1x21" id="fn1x21-bk"><sup class="textsuperscript">1</sup></a></span><a id="x25-97001f1"></a>)
character. When it encounters one of these it performs a specific replacement on the
text of the input file. It’s main advantage though is it can include other files, and then
augment its list of macros based on that file’s contents.
<!--l. 32--></p><p class="indent">    A quick way to see what the CPP does is take the last exercise and run
this:
                                                                  

                                                                  
<!--l. 35--></p><p class="indent">
    </p><div class="fancyvrb" id="fancyvrb23"><a id="x25-97003r1"></a>  cpp ex18.c | less</div>
<!--l. 39--><p class="indent">    It will be a huge amount of output, but scroll through it and you’ll see the
contents of the other files you included with <span class="obeylines-h"><span class="verb">#include</span></span>. Scroll down to the original
code and you can see how the cpp is altering the source based on various <span class="obeylines-h"><span class="verb">#define</span></span>
macros in the header files.
<!--l. 44--></p><p class="indent">    The C compiler is so tightly integrated with cpp that it just runs this for you and
understands how it works intimately. In modern C, the cpp system is so
integral to C’s function that you might as well just consider it to be part of the
language.
<!--l. 49--></p><p class="indent">    In the remaining sections, we’ll be using more of the CPP syntax and explaining
it as we go.
<!--l. 53--></p><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">20.2    </span> <a id="x25-9800020.2"></a>The Prototype Object System</h3>
<!--l. 55--><p class="noindent">The OOP system we’ll create is a simple ”prototype” style object system more like
JavaScript. Instead of classes, you start with prototypes that have fields set, and then
use those as the basis of creating other object instances. This ”classless” design is
much easier to implement and work with than a traditional class based
one.
<!--l. 61--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">20.2.1    </span> <a id="x25-9900020.2.1"></a>The Object Header File</h4>
<!--l. 63--><p class="noindent">I want to put the data types and function declarations into a separate header file
named object.h. This is standard C practice and it lets you ship binary libraries
but still let the programmer compile against it. In this file I have several advanced
CPP techniques I’m going to quickly describe and then have you see in action
                                                                  

                                                                  
later:
                                                                  

                                                                  
<!--l. 69--></p><p class="indent">    <a id="x25-99001r49"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 49: </span><span class="content">                                                                                                          object.h</span></div><!--tex4ht:label?: x25-99001r49 -->
<div class="fancyvrb" id="fancyvrb24"><a id="x25-99003r1"></a>1  <span id="textcolor1591">#</span><span id="textcolor1592">ifndef _object_h</span><br class="fancyvrb"><a id="x25-99005r2"></a>2  <span id="textcolor1593">#</span><span id="textcolor1594">define _object_h</span><br class="fancyvrb"><a id="x25-99007r3"></a>3  <br class="fancyvrb"><a id="x25-99009r4"></a>4  <span id="textcolor1595">typedef</span> <span id="textcolor1596">enum</span> {<br class="fancyvrb"><a id="x25-99011r5"></a>5      NORTH, SOUTH, EAST, WEST
<br class="fancyvrb"><a id="x25-99013r6"></a>6  } Direction;<br class="fancyvrb"><a id="x25-99015r7"></a>7  <br class="fancyvrb"><a id="x25-99017r8"></a>8  <span id="textcolor1597">typedef</span> <span id="textcolor1598">struct</span> {<br class="fancyvrb"><a id="x25-99019r9"></a>9      <span id="textcolor1599">char</span> ⋆description;
<br class="fancyvrb"><a id="x25-99021r10"></a>10      <span id="textcolor1600">int</span> (⋆init)(<span id="textcolor1601">void</span> ⋆self);<br class="fancyvrb"><a id="x25-99023r11"></a>11      <span id="textcolor1602">void</span> (⋆describe)(<span id="textcolor1603">void</span> ⋆self);
<br class="fancyvrb"><a id="x25-99025r12"></a>12      <span id="textcolor1604">void</span> (⋆destroy)(<span id="textcolor1605">void</span> ⋆self);<br class="fancyvrb"><a id="x25-99027r13"></a>13      <span id="textcolor1606">void</span> ⋆(⋆move)(<span id="textcolor1607">void</span> ⋆self, Direction direction);
<br class="fancyvrb"><a id="x25-99029r14"></a>14      <span id="textcolor1608">int</span> (⋆attack)(<span id="textcolor1609">void</span> ⋆self, <span id="textcolor1610">int</span> damage);<br class="fancyvrb"><a id="x25-99031r15"></a>15  } Object;<br class="fancyvrb"><a id="x25-99033r16"></a>16  <br class="fancyvrb"><a id="x25-99035r17"></a>17  <span id="textcolor1611">int</span> Object_init(<span id="textcolor1612">void</span> ⋆self);
<br class="fancyvrb"><a id="x25-99037r18"></a>18  <span id="textcolor1613">void</span> Object_destroy(<span id="textcolor1614">void</span> ⋆self);<br class="fancyvrb"><a id="x25-99039r19"></a>19  <span id="textcolor1615">void</span> Object_describe(<span id="textcolor1616">void</span> ⋆self);
<br class="fancyvrb"><a id="x25-99041r20"></a>20  <span id="textcolor1617">void</span> ⋆Object_move(<span id="textcolor1618">void</span> ⋆self, Direction direction);
<br class="fancyvrb"><a id="x25-99043r21"></a>21  <span id="textcolor1619">int</span> Object_attack(<span id="textcolor1620">void</span> ⋆self, <span id="textcolor1621">int</span> damage);
<br class="fancyvrb"><a id="x25-99045r22"></a>22  <span id="textcolor1622">void</span> ⋆Object_new(<span id="textcolor1623">size_t</span> size, Object proto, <span id="textcolor1624">char</span> ⋆description);<br class="fancyvrb"><a id="x25-99047r23"></a>23  
<br class="fancyvrb"><a id="x25-99049r24"></a>24  <span id="textcolor1625">#</span><span id="textcolor1626">define NEW(T, N) Object_new(sizeof(T), T##Proto, N)</span><br class="fancyvrb"><a id="x25-99051r25"></a>25  <span id="textcolor1627">#</span><span id="textcolor1628">define _(N) proto.N</span><br class="fancyvrb"><a id="x25-99053r26"></a>26  <br class="fancyvrb"><a id="x25-99055r27"></a>27  <span id="textcolor1629">#</span><span id="textcolor1630">endif</span></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 102--><p class="indent">    Taking a look at this file, you can see we have a few new pieces of syntax you
haven’t encountered before:
     </p><dl class="description"><dt class="description">
#ifndef </dt><dd class="description">You’ve  seen  a  <span class="obeylines-h"><span class="verb">#define</span></span> for  making  simple  constants,  but  the  CPP
     can also do logic and remove sections of code. This <span class="obeylines-h"><span class="verb">#ifndef</span></span> is ”if not
     defined”  and  checks  if  there’s  already  a  <span class="obeylines-h"><span class="verb">#define _object_h</span></span> and  if
     there is it skips all of this code. I do this so that we can include this file
     any time we want and not worry about it defining things multiple times.
     </dd><dt class="description">
#define </dt><dd class="description">With  the  above  <span class="obeylines-h"><span class="verb">#ifndef</span></span> shielding  this  file  from  we  then  add  the
     _object_h define so that any attempts to include it later cause the above
     to skip.
     </dd><dt class="description">
#define NEW(T,N) </dt><dd class="description">This makes a macro, and it works like a template function
     that spits out the code on the right, whenever you write use the macro
     on the left. This one is simply making a short version of the normal way
     we’ll call Object_new and avoids potential errors with calling it wrong.
     The way the macro works is the T and N parameters to NEW are ”injected”
     into the line of code on the right. The syntax <span class="obeylines-h"><span class="verb">T##Proto</span></span> says to ”concat
     Proto at the end of T”, so if you had <span class="obeylines-h"><span class="verb">NEW(Room, "Hello.")</span></span> then it’d
     make RoomProto there.
     </dd><dt class="description">
#define _(N) </dt><dd class="description">This   macro   is   a   bit   of   ”syntactic   sugar”   for   the   object
     system  and  basically  helps  you  write  <span class="obeylines-h"><span class="verb">obj-&gt;proto.blah</span></span> as  simply
     <span class="obeylines-h"><span class="verb">obj-&gt;_(blah)</span></span>. It’s not necessary, but it’s a fun little trick that I’ll use
     later.</dd></dl><h4 class="subsectionHead"><span class="titlemark">20.2.2    </span> <a id="x25-10000020.2.2"></a>The Object Source File</h4>
<!--l. 132--><p class="noindent">The object.h file is declaring functions and data types that are defined (created) in
                                                                  

                                                                  
the object.c, so that’s next:
                                                                  

                                                                  
<!--l. 135--></p><p class="indent">    <a id="x25-100001r50"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 50: </span><span class="content">                                                                                                          object.c</span></div><!--tex4ht:label?: x25-100001r50 -->
<div class="fancyvrb" id="fancyvrb25"><a id="x25-100003r1"></a>1  <span id="textcolor1631">#</span><span id="textcolor1632">include <stdio.h></stdio.h></span><br class="fancyvrb"><a id="x25-100005r2"></a>2  <span id="textcolor1633">#</span><span id="textcolor1634">include <string.h></string.h></span><br class="fancyvrb"><a id="x25-100007r3"></a>3  <span id="textcolor1635">#</span><span id="textcolor1636">include <stdlib.h></stdlib.h></span><br class="fancyvrb"><a id="x25-100009r4"></a>4  <span id="textcolor1637">#</span><span id="textcolor1638">include "object.h"</span>
<br class="fancyvrb"><a id="x25-100011r5"></a>5  <span id="textcolor1639">#</span><span id="textcolor1640">include <assert.h></assert.h></span><br class="fancyvrb"><a id="x25-100013r6"></a>6  <br class="fancyvrb"><a id="x25-100015r7"></a>7  <span id="textcolor1641">void</span> <span id="textcolor1642">Object_destroy</span>(<span id="textcolor1643">void</span> ⋆self)<br class="fancyvrb"><a id="x25-100017r8"></a>8  {<br class="fancyvrb"><a id="x25-100019r9"></a>9      Object ⋆obj = self;
<br class="fancyvrb"><a id="x25-100021r10"></a>10  <br class="fancyvrb"><a id="x25-100023r11"></a>11      <span id="textcolor1644">if</span>(obj) {<br class="fancyvrb"><a id="x25-100025r12"></a>12          <span id="textcolor1645">if</span>(obj-&gt;description) free(obj-&gt;description);
<br class="fancyvrb"><a id="x25-100027r13"></a>13          free(obj);<br class="fancyvrb"><a id="x25-100029r14"></a>14      }<br class="fancyvrb"><a id="x25-100031r15"></a>15  }<br class="fancyvrb"><a id="x25-100033r16"></a>16  <br class="fancyvrb"><a id="x25-100035r17"></a>17  <span id="textcolor1646">void</span> <span id="textcolor1647">Object_describe</span>(<span id="textcolor1648">void</span> ⋆self)<br class="fancyvrb"><a id="x25-100037r18"></a>18  {
<br class="fancyvrb"><a id="x25-100039r19"></a>19      Object ⋆obj = self;<br class="fancyvrb"><a id="x25-100041r20"></a>20      printf(<span class="colorbox" id="colorbox1649"><span id="textcolor1650">"</span></span><span class="colorbox" id="colorbox1651"><span id="textcolor1652">%s.</span></span><span class="colorbox" id="colorbox1653"><span id="textcolor1654">\n</span></span><span class="colorbox" id="colorbox1655"><span id="textcolor1656">"</span></span>, obj-&gt;description);<br class="fancyvrb"><a id="x25-100043r21"></a>21  }<br class="fancyvrb"><a id="x25-100045r22"></a>22  
<br class="fancyvrb"><a id="x25-100047r23"></a>23  <span id="textcolor1657">int</span> <span id="textcolor1658">Object_init</span>(<span id="textcolor1659">void</span> ⋆self)<br class="fancyvrb"><a id="x25-100049r24"></a>24  {<br class="fancyvrb"><a id="x25-100051r25"></a>25      <span id="textcolor1660">// do nothing really</span><br class="fancyvrb"><a id="x25-100053r26"></a>26      <span id="textcolor1661">return</span> <span id="textcolor1662">1</span>;
<br class="fancyvrb"><a id="x25-100055r27"></a>27  }<br class="fancyvrb"><a id="x25-100057r28"></a>28  <br class="fancyvrb"><a id="x25-100059r29"></a>29  <span id="textcolor1663">void</span> ⋆<span id="textcolor1664">Object_move</span>(<span id="textcolor1665">void</span> ⋆self, Direction direction)<br class="fancyvrb"><a id="x25-100061r30"></a>30  {
<br class="fancyvrb"><a id="x25-100063r31"></a>31      printf(<span class="colorbox" id="colorbox1666"><span id="textcolor1667">"</span></span><span class="colorbox" id="colorbox1668"><span id="textcolor1669">You can’t go that direction.</span></span><span class="colorbox" id="colorbox1670"><span id="textcolor1671">\n</span></span><span class="colorbox" id="colorbox1672"><span id="textcolor1673">"</span></span>);<br class="fancyvrb"><a id="x25-100065r32"></a>32      <span id="textcolor1674">return</span> <span id="textcolor1675">NULL</span>;<br class="fancyvrb"><a id="x25-100067r33"></a>33  }<br class="fancyvrb"><a id="x25-100069r34"></a>34  
<br class="fancyvrb"><a id="x25-100071r35"></a>35  <span id="textcolor1676">int</span> <span id="textcolor1677">Object_attack</span>(<span id="textcolor1678">void</span> ⋆self, <span id="textcolor1679">int</span> damage)<br class="fancyvrb"><a id="x25-100073r36"></a>36  {<br class="fancyvrb"><a id="x25-100075r37"></a>37      printf(<span class="colorbox" id="colorbox1680"><span id="textcolor1681">"</span></span><span class="colorbox" id="colorbox1682"><span id="textcolor1683">You can’t attack that.</span></span><span class="colorbox" id="colorbox1684"><span id="textcolor1685">\n</span></span><span class="colorbox" id="colorbox1686"><span id="textcolor1687">"</span></span>);
<br class="fancyvrb"><a id="x25-100077r38"></a>38      <span id="textcolor1688">return</span> <span id="textcolor1689">0</span>;<br class="fancyvrb"><a id="x25-100079r39"></a>39  }<br class="fancyvrb"><a id="x25-100081r40"></a>40  <br class="fancyvrb"><a id="x25-100083r41"></a>41  <span id="textcolor1690">void</span> ⋆<span id="textcolor1691">Object_new</span>(<span id="textcolor1692">size_t</span> size, Object proto, <span id="textcolor1693">char</span> ⋆description)
<br class="fancyvrb"><a id="x25-100085r42"></a>42  {<br class="fancyvrb"><a id="x25-100087r43"></a>43      <span id="textcolor1694">// setup the default functions in case they aren’t set</span>
<br class="fancyvrb"><a id="x25-100089r44"></a>44      <span id="textcolor1695">if</span>(!proto.init) proto.init = Object_init;
<br class="fancyvrb"><a id="x25-100091r45"></a>45      <span id="textcolor1696">if</span>(!proto.describe) proto.describe = Object_describe;
<br class="fancyvrb"><a id="x25-100093r46"></a>46      <span id="textcolor1697">if</span>(!proto.destroy) proto.destroy = Object_destroy;
<br class="fancyvrb"><a id="x25-100095r47"></a>47      <span id="textcolor1698">if</span>(!proto.attack) proto.attack = Object_attack;
<br class="fancyvrb"><a id="x25-100097r48"></a>48      <span id="textcolor1699">if</span>(!proto.move) proto.move = Object_move;<br class="fancyvrb"><a id="x25-100099r49"></a>49  
<br class="fancyvrb"><a id="x25-100101r50"></a>50      <span id="textcolor1700">// this seems weird, but we can make a struct of one size,</span>
<br class="fancyvrb"><a id="x25-100103r51"></a>51      <span id="textcolor1701">// then point a different pointer at it to "cast" it</span>
<br class="fancyvrb"><a id="x25-100105r52"></a>52      Object ⋆el = calloc(<span id="textcolor1702">1</span>, size);<br class="fancyvrb"><a id="x25-100107r53"></a>53      ⋆el = proto;<br class="fancyvrb"><a id="x25-100109r54"></a>54  
<br class="fancyvrb"><a id="x25-100111r55"></a>55      <span id="textcolor1703">// copy the description over</span><br class="fancyvrb"><a id="x25-100113r56"></a>56      el-&gt;description = strdup(description);
<br class="fancyvrb"><a id="x25-100115r57"></a>57  <br class="fancyvrb"><a id="x25-100117r58"></a>58      <span id="textcolor1704">// initialize it with whatever init we were given</span>
<br class="fancyvrb"><a id="x25-100119r59"></a>59      <span id="textcolor1705">if</span>(!el-&gt;init(el)) {<br class="fancyvrb"><a id="x25-100121r60"></a>60          <span id="textcolor1706">// looks like it didn’t initialize properly</span>
<br class="fancyvrb"><a id="x25-100123r61"></a>61          el-&gt;destroy(el);<br class="fancyvrb"><a id="x25-100125r62"></a>62          <span id="textcolor1707">return</span> <span id="textcolor1708">NULL</span>;<br class="fancyvrb"><a id="x25-100127r63"></a>63      } <span id="textcolor1709">else</span> {
<br class="fancyvrb"><a id="x25-100129r64"></a>64          <span id="textcolor1710">// all done, we made an object of any type</span><br class="fancyvrb"><a id="x25-100131r65"></a>65          <span id="textcolor1711">return</span> el;<br class="fancyvrb"><a id="x25-100133r66"></a>66      }<br class="fancyvrb"><a id="x25-100135r67"></a>67  }</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 208--><p class="indent">    There’s really nothing new in this file, except one tiny little trick. The function
Object_new uses an aspect of how structs work by putting the base prototype at
the beginning of the struct. When you look at the ex19.h header later, you’ll see
how I make the first field in the struct an Object. Since C puts the fields in a struct
in order, and since a pointer just points at a chunk of memory, I can ”cast” a pointer
to anything I want. In this case, even though I’m taking a potentially larger
block of memory from calloc, I’m using a Object pointer to work with
it.
<!--l. 218--></p><p class="indent">    I explain this a bit better when we write the ex19.h file since it’s easier to
understand when you see it being used.
<!--l. 221--></p><p class="indent">    That creates your base object system, but you’ll need a way to compile it and
link it into your ex19.c file to create a complete program. The object.c file on its
own doesn’t have a main so it isn’t enough to make a full program. Here’s a
Makefile that will do this based on the one you’ve been using:
                                                                  

                                                                  
<!--l. 227--></p><p class="indent">    <a id="x25-100136r51"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 51: </span><span class="content">                                                                                                                The
Makefile</span></div><!--tex4ht:label?: x25-100136r51 -->
<!--l. 228-->
<div class="lstlisting" id="listing-32"><span class="label"><a id="x25-100137r1"></a>1</span>CFLAGS=-Wall -g <br><span class="label"><a id="x25-100138r2"></a>2</span> <br><span class="label"><a id="x25-100139r3"></a>3</span>all: ex19 <br><span class="label"><a id="x25-100140r4"></a>4</span> <br><span class="label"><a id="x25-100141r5"></a>5</span>ex19: object.o <br><span class="label"><a id="x25-100142r6"></a>6</span> <br><span class="label"><a id="x25-100143r7"></a>7</span>clean: <br><span class="label"><a id="x25-100144r8"></a>8</span>        rm -f ex19
</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 242--><p class="indent">    This Makefile is doing nothing more than saying that ex19 depends on
object.o. Remember how make knows how to build different kinds of files by
their extensions? Doing this tells make the following:
     </p><ol class="enumerate1"><li class="enumerate" id="x25-100149x1">When I say run make the default all should just build ex19.
     </li>
     <li class="enumerate" id="x25-100151x2">When you build ex19, you need to also build object.o and include it
     in the build.
     </li>
     <li class="enumerate" id="x25-100153x3">make can’t  see  anything  in  the  file  for  object.o,  but  it  does  see  an
     object.c file, and it knows how to turn a .c into a .o, so it does that.
     </li>
     <li class="enumerate" id="x25-100155x4">Once it has object.o built it then runs the correct compile command to
     build ex19 from ex19.c and object.o.</li></ol><h3 class="sectionHead"><span class="titlemark">20.3    </span> <a id="x25-10100020.3"></a>The Game Implementation</h3>
<!--l. 262--><p class="noindent">Once you have those files you just need to implement the actual game using the
object system, and first step is putting all the data types and function declarations in
a ex19.h file:
                                                                  

                                                                  
<!--l. 266--></p><p class="indent">    <a id="x25-101001r52"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 52: </span><span class="content">                                                                                                            ex19.h</span></div><!--tex4ht:label?: x25-101001r52 -->
<div class="fancyvrb" id="fancyvrb26"><a id="x25-101003r1"></a>1  <span id="textcolor1712">#</span><span id="textcolor1713">ifndef _ex19_h</span><br class="fancyvrb"><a id="x25-101005r2"></a>2  <span id="textcolor1714">#</span><span id="textcolor1715">define _ex19_h</span><br class="fancyvrb"><a id="x25-101007r3"></a>3  <br class="fancyvrb"><a id="x25-101009r4"></a>4  <span id="textcolor1716">#</span><span id="textcolor1717">include "object.h"</span><br class="fancyvrb"><a id="x25-101011r5"></a>5  <br class="fancyvrb"><a id="x25-101013r6"></a>6  <span id="textcolor1718">struct</span> Monster {
<br class="fancyvrb"><a id="x25-101015r7"></a>7      Object proto;<br class="fancyvrb"><a id="x25-101017r8"></a>8      <span id="textcolor1719">int</span> hit_points;<br class="fancyvrb"><a id="x25-101019r9"></a>9  };<br class="fancyvrb"><a id="x25-101021r10"></a>10  <br class="fancyvrb"><a id="x25-101023r11"></a>11  <span id="textcolor1720">typedef</span> <span id="textcolor1721">struct</span> Monster Monster;
<br class="fancyvrb"><a id="x25-101025r12"></a>12  <br class="fancyvrb"><a id="x25-101027r13"></a>13  <span id="textcolor1722">int</span> Monster_attack(<span id="textcolor1723">void</span> ⋆self, <span id="textcolor1724">int</span> damage);<br class="fancyvrb"><a id="x25-101029r14"></a>14  <span id="textcolor1725">int</span> Monster_init(<span id="textcolor1726">void</span> ⋆self);<br class="fancyvrb"><a id="x25-101031r15"></a>15  
<br class="fancyvrb"><a id="x25-101033r16"></a>16  <span id="textcolor1727">struct</span> Room {<br class="fancyvrb"><a id="x25-101035r17"></a>17      Object proto;<br class="fancyvrb"><a id="x25-101037r18"></a>18  <br class="fancyvrb"><a id="x25-101039r19"></a>19      Monster ⋆bad_guy;<br class="fancyvrb"><a id="x25-101041r20"></a>20  <br class="fancyvrb"><a id="x25-101043r21"></a>21      <span id="textcolor1728">struct</span> Room ⋆north;
<br class="fancyvrb"><a id="x25-101045r22"></a>22      <span id="textcolor1729">struct</span> Room ⋆south;<br class="fancyvrb"><a id="x25-101047r23"></a>23      <span id="textcolor1730">struct</span> Room ⋆east;<br class="fancyvrb"><a id="x25-101049r24"></a>24      <span id="textcolor1731">struct</span> Room ⋆west;<br class="fancyvrb"><a id="x25-101051r25"></a>25  };<br class="fancyvrb"><a id="x25-101053r26"></a>26  
<br class="fancyvrb"><a id="x25-101055r27"></a>27  <span id="textcolor1732">typedef</span> <span id="textcolor1733">struct</span> Room Room;<br class="fancyvrb"><a id="x25-101057r28"></a>28  <br class="fancyvrb"><a id="x25-101059r29"></a>29  <span id="textcolor1734">void</span> ⋆Room_move(<span id="textcolor1735">void</span> ⋆self, Direction direction);
<br class="fancyvrb"><a id="x25-101061r30"></a>30  <span id="textcolor1736">int</span> Room_attack(<span id="textcolor1737">void</span> ⋆self, <span id="textcolor1738">int</span> damage);<br class="fancyvrb"><a id="x25-101063r31"></a>31  <span id="textcolor1739">int</span> Room_init(<span id="textcolor1740">void</span> ⋆self);<br class="fancyvrb"><a id="x25-101065r32"></a>32  <br class="fancyvrb"><a id="x25-101067r33"></a>33  
<br class="fancyvrb"><a id="x25-101069r34"></a>34  <span id="textcolor1741">struct</span> Map {<br class="fancyvrb"><a id="x25-101071r35"></a>35      Object proto;<br class="fancyvrb"><a id="x25-101073r36"></a>36      Room ⋆start;<br class="fancyvrb"><a id="x25-101075r37"></a>37      Room ⋆location;<br class="fancyvrb"><a id="x25-101077r38"></a>38  };
<br class="fancyvrb"><a id="x25-101079r39"></a>39  <br class="fancyvrb"><a id="x25-101081r40"></a>40  <span id="textcolor1742">typedef</span> <span id="textcolor1743">struct</span> Map Map;<br class="fancyvrb"><a id="x25-101083r41"></a>41  <br class="fancyvrb"><a id="x25-101085r42"></a>42  <span id="textcolor1744">void</span> ⋆Map_move(<span id="textcolor1745">void</span> ⋆self, Direction direction);
<br class="fancyvrb"><a id="x25-101087r43"></a>43  <span id="textcolor1746">int</span> Map_attack(<span id="textcolor1747">void</span> ⋆self, <span id="textcolor1748">int</span> damage);<br class="fancyvrb"><a id="x25-101089r44"></a>44  <span id="textcolor1749">int</span> Map_init(<span id="textcolor1750">void</span> ⋆self);<br class="fancyvrb"><a id="x25-101091r45"></a>45  <br class="fancyvrb"><a id="x25-101093r46"></a>46  <span id="textcolor1751">#</span><span id="textcolor1752">endif</span></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 318--><p class="indent">    That sets up three new Objects you’ll be using: Monster, Room, and
Map.
<!--l. 321--></p><p class="indent">    Taking a look at object.c:52 you can see where I use a pointer
<span class="obeylines-h"><span class="verb">Object ⋆el = calloc(1, size)</span></span>. Go back and look at the NEW macro in
object.h and you can see that it is getting the sizeof another struct, say Room,
and I allocate that much. However, because I’ve pointed a Object pointer at this
block of memory, and because I put an Object proto field at the from of Room, I’m
able to treat a Room like it’s an Object.
<!--l. 329--></p><p class="indent">    The way to break this down is like so:
     </p><ol class="enumerate1"><li class="enumerate" id="x25-101095x1">I call <span class="obeylines-h"><span class="verb">NEW(Room, "Hello.")</span></span> which the CPP expands as a macro into
     <span class="obeylines-h"><span class="verb">Object_new(sizeof(Room), RoomProto, "Hello.")</span></span>.
     </li>
     <li class="enumerate" id="x25-101097x2">This runs, and inside Object_new I allocate a piece of memory that’s
     Room in size, but point a Object ⋆el pointer at it.
     </li>
     <li class="enumerate" id="x25-101099x3">Since  C  puts  the  Room.proto field  first,  that  means  the  el pointer  is
     really  only  pointing  at  enough  of  the  block  of  memory  to  see  a  full
     Object struct. It has no idea that it’s even called proto.
     </li>
     <li class="enumerate" id="x25-101101x4">It then uses this Object ⋆el pointer to set the contents of the piece of
     memory correctly with <span class="obeylines-h"><span class="verb">⋆el = proto;</span></span>. Remember that you can copy
     structs, and that ⋆el means ”the value of whatever el points at”, so this
     means ”assign the proto struct to whatever el points at”.
     </li>
     <li class="enumerate" id="x25-101103x5">Now that this mystery struct is filled in with the right data from proto,
     the function can then call init or destroy on the Object, but the cool
     part is whoever called this function can change these out for whatever
     ones they want.</li></ol><!--l. 351--><p class="indent">    And with that, we have a way to get this one function to construct new types,
                                                                  

                                                                  
and give them new functions to change their behavior. This may seem like ”hackery”
but it’s stock C and totally valid. In fact there’s quite a few standard system
functions that work this same way, and we’ll be using some of them for converting
addresses in network code.
<!--l. 357--></p><p class="indent">    With the function definitions and data structures written out I can now actually
implement the game with four rooms and a minotaur to beat up:
                                                                  

                                                                  
<!--l. 360--></p><p class="indent">    <a id="x25-101104r53"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 53: </span><span class="content">                                                                                                            ex19.c</span></div><!--tex4ht:label?: x25-101104r53 -->
<div class="fancyvrb" id="fancyvrb27"><a id="x25-101106r1"></a>1  <span id="textcolor1753">#</span><span id="textcolor1754">include <stdio.h></stdio.h></span><br class="fancyvrb"><a id="x25-101108r2"></a>2  <span id="textcolor1755">#</span><span id="textcolor1756">include <errno.h></errno.h></span><br class="fancyvrb"><a id="x25-101110r3"></a>3  <span id="textcolor1757">#</span><span id="textcolor1758">include <stdlib.h></stdlib.h></span>
<br class="fancyvrb"><a id="x25-101112r4"></a>4  <span id="textcolor1759">#</span><span id="textcolor1760">include <string.h></string.h></span><br class="fancyvrb"><a id="x25-101114r5"></a>5  <span id="textcolor1761">#</span><span id="textcolor1762">include <time.h></time.h></span><br class="fancyvrb"><a id="x25-101116r6"></a>6  <span id="textcolor1763">#</span><span id="textcolor1764">include "ex19.h"</span><br class="fancyvrb"><a id="x25-101118r7"></a>7  <br class="fancyvrb"><a id="x25-101120r8"></a>8  
<br class="fancyvrb"><a id="x25-101122r9"></a>9  <span id="textcolor1765">int</span> <span id="textcolor1766">Monster_attack</span>(<span id="textcolor1767">void</span> ⋆self, <span id="textcolor1768">int</span> damage)<br class="fancyvrb"><a id="x25-101124r10"></a>10  {<br class="fancyvrb"><a id="x25-101126r11"></a>11      Monster ⋆monster = self;
<br class="fancyvrb"><a id="x25-101128r12"></a>12  <br class="fancyvrb"><a id="x25-101130r13"></a>13      printf(<span class="colorbox" id="colorbox1769"><span id="textcolor1770">"</span></span><span class="colorbox" id="colorbox1771"><span id="textcolor1772">You attack %s!</span></span><span class="colorbox" id="colorbox1773"><span id="textcolor1774">\n</span></span><span class="colorbox" id="colorbox1775"><span id="textcolor1776">"</span></span>, monster-&gt;_(description));<br class="fancyvrb"><a id="x25-101132r14"></a>14  
<br class="fancyvrb"><a id="x25-101134r15"></a>15      monster-&gt;hit_points -= damage;<br class="fancyvrb"><a id="x25-101136r16"></a>16  <br class="fancyvrb"><a id="x25-101138r17"></a>17      <span id="textcolor1777">if</span>(monster-&gt;hit_points &gt; <span id="textcolor1778">0</span>) {
<br class="fancyvrb"><a id="x25-101140r18"></a>18          printf(<span class="colorbox" id="colorbox1779"><span id="textcolor1780">"</span></span><span class="colorbox" id="colorbox1781"><span id="textcolor1782">It is still alive.</span></span><span class="colorbox" id="colorbox1783"><span id="textcolor1784">\n</span></span><span class="colorbox" id="colorbox1785"><span id="textcolor1786">"</span></span>);<br class="fancyvrb"><a id="x25-101142r19"></a>19          <span id="textcolor1787">return</span> <span id="textcolor1788">0</span>;<br class="fancyvrb"><a id="x25-101144r20"></a>20      } <span id="textcolor1789">else</span> {
<br class="fancyvrb"><a id="x25-101146r21"></a>21          printf(<span class="colorbox" id="colorbox1790"><span id="textcolor1791">"</span></span><span class="colorbox" id="colorbox1792"><span id="textcolor1793">It is dead!</span></span><span class="colorbox" id="colorbox1794"><span id="textcolor1795">\n</span></span><span class="colorbox" id="colorbox1796"><span id="textcolor1797">"</span></span>);<br class="fancyvrb"><a id="x25-101148r22"></a>22          <span id="textcolor1798">return</span> <span id="textcolor1799">1</span>;<br class="fancyvrb"><a id="x25-101150r23"></a>23      }<br class="fancyvrb"><a id="x25-101152r24"></a>24  }<br class="fancyvrb"><a id="x25-101154r25"></a>25  
<br class="fancyvrb"><a id="x25-101156r26"></a>26  <span id="textcolor1800">int</span> <span id="textcolor1801">Monster_init</span>(<span id="textcolor1802">void</span> ⋆self)<br class="fancyvrb"><a id="x25-101158r27"></a>27  {<br class="fancyvrb"><a id="x25-101160r28"></a>28      Monster ⋆monster = self;
<br class="fancyvrb"><a id="x25-101162r29"></a>29      monster-&gt;hit_points = <span id="textcolor1803">10</span>;<br class="fancyvrb"><a id="x25-101164r30"></a>30      <span id="textcolor1804">return</span> <span id="textcolor1805">1</span>;<br class="fancyvrb"><a id="x25-101166r31"></a>31  }<br class="fancyvrb"><a id="x25-101168r32"></a>32  <br class="fancyvrb"><a id="x25-101170r33"></a>33  Object MonsterProto = {
<br class="fancyvrb"><a id="x25-101172r34"></a>34      .init = Monster_init,<br class="fancyvrb"><a id="x25-101174r35"></a>35      .attack = Monster_attack<br class="fancyvrb"><a id="x25-101176r36"></a>36  };<br class="fancyvrb"><a id="x25-101178r37"></a>37  <br class="fancyvrb"><a id="x25-101180r38"></a>38  
<br class="fancyvrb"><a id="x25-101182r39"></a>39  <span id="textcolor1806">void</span> ⋆<span id="textcolor1807">Room_move</span>(<span id="textcolor1808">void</span> ⋆self, Direction direction)<br class="fancyvrb"><a id="x25-101184r40"></a>40  {<br class="fancyvrb"><a id="x25-101186r41"></a>41      Room ⋆room = self;
<br class="fancyvrb"><a id="x25-101188r42"></a>42      Room ⋆next = <span id="textcolor1809">NULL</span>;<br class="fancyvrb"><a id="x25-101190r43"></a>43  <br class="fancyvrb"><a id="x25-101192r44"></a>44      <span id="textcolor1810">if</span>(direction == NORTH &amp;&amp; room-&gt;north) {
<br class="fancyvrb"><a id="x25-101194r45"></a>45          printf(<span class="colorbox" id="colorbox1811"><span id="textcolor1812">"</span></span><span class="colorbox" id="colorbox1813"><span id="textcolor1814">You go north, into:</span></span><span class="colorbox" id="colorbox1815"><span id="textcolor1816">\n</span></span><span class="colorbox" id="colorbox1817"><span id="textcolor1818">"</span></span>);<br class="fancyvrb"><a id="x25-101196r46"></a>46          next = room-&gt;north;
<br class="fancyvrb"><a id="x25-101198r47"></a>47      } <span id="textcolor1819">else</span> <span id="textcolor1820">if</span>(direction == SOUTH &amp;&amp; room-&gt;south) {
<br class="fancyvrb"><a id="x25-101200r48"></a>48          printf(<span class="colorbox" id="colorbox1821"><span id="textcolor1822">"</span></span><span class="colorbox" id="colorbox1823"><span id="textcolor1824">You go south, into:</span></span><span class="colorbox" id="colorbox1825"><span id="textcolor1826">\n</span></span><span class="colorbox" id="colorbox1827"><span id="textcolor1828">"</span></span>);<br class="fancyvrb"><a id="x25-101202r49"></a>49          next = room-&gt;south;
<br class="fancyvrb"><a id="x25-101204r50"></a>50      } <span id="textcolor1829">else</span> <span id="textcolor1830">if</span>(direction == EAST &amp;&amp; room-&gt;east) {
<br class="fancyvrb"><a id="x25-101206r51"></a>51          printf(<span class="colorbox" id="colorbox1831"><span id="textcolor1832">"</span></span><span class="colorbox" id="colorbox1833"><span id="textcolor1834">You go east, into:</span></span><span class="colorbox" id="colorbox1835"><span id="textcolor1836">\n</span></span><span class="colorbox" id="colorbox1837"><span id="textcolor1838">"</span></span>);<br class="fancyvrb"><a id="x25-101208r52"></a>52          next = room-&gt;east;
<br class="fancyvrb"><a id="x25-101210r53"></a>53      } <span id="textcolor1839">else</span> <span id="textcolor1840">if</span>(direction == WEST &amp;&amp; room-&gt;west) {
<br class="fancyvrb"><a id="x25-101212r54"></a>54          printf(<span class="colorbox" id="colorbox1841"><span id="textcolor1842">"</span></span><span class="colorbox" id="colorbox1843"><span id="textcolor1844">You go west, into:</span></span><span class="colorbox" id="colorbox1845"><span id="textcolor1846">\n</span></span><span class="colorbox" id="colorbox1847"><span id="textcolor1848">"</span></span>);<br class="fancyvrb"><a id="x25-101214r55"></a>55          next = room-&gt;west;<br class="fancyvrb"><a id="x25-101216r56"></a>56      } <span id="textcolor1849">else</span> {
<br class="fancyvrb"><a id="x25-101218r57"></a>57          printf(<span class="colorbox" id="colorbox1850"><span id="textcolor1851">"</span></span><span class="colorbox" id="colorbox1852"><span id="textcolor1853">You can’t go that direction.</span></span><span class="colorbox" id="colorbox1854"><span id="textcolor1855">"</span></span>);<br class="fancyvrb"><a id="x25-101220r58"></a>58          next = <span id="textcolor1856">NULL</span>;<br class="fancyvrb"><a id="x25-101222r59"></a>59      }
<br class="fancyvrb"><a id="x25-101224r60"></a>60  <br class="fancyvrb"><a id="x25-101226r61"></a>61      <span id="textcolor1857">if</span>(next) {<br class="fancyvrb"><a id="x25-101228r62"></a>62          next-&gt;_(describe)(next);<br class="fancyvrb"><a id="x25-101230r63"></a>63      }<br class="fancyvrb"><a id="x25-101232r64"></a>64  <br class="fancyvrb"><a id="x25-101234r65"></a>65      <span id="textcolor1858">return</span> next;
<br class="fancyvrb"><a id="x25-101236r66"></a>66  }<br class="fancyvrb"><a id="x25-101238r67"></a>67  <br class="fancyvrb"><a id="x25-101240r68"></a>68  <br class="fancyvrb"><a id="x25-101242r69"></a>69  <span id="textcolor1859">int</span> <span id="textcolor1860">Room_attack</span>(<span id="textcolor1861">void</span> ⋆self, <span id="textcolor1862">int</span> damage)<br class="fancyvrb"><a id="x25-101244r70"></a>70  {<br class="fancyvrb"><a id="x25-101246r71"></a>71      Room ⋆room = self;
<br class="fancyvrb"><a id="x25-101248r72"></a>72      Monster ⋆monster = room-&gt;bad_guy;<br class="fancyvrb"><a id="x25-101250r73"></a>73  <br class="fancyvrb"><a id="x25-101252r74"></a>74      <span id="textcolor1863">if</span>(monster) {
<br class="fancyvrb"><a id="x25-101254r75"></a>75          monster-&gt;_(attack)(monster, damage);<br class="fancyvrb"><a id="x25-101256r76"></a>76          <span id="textcolor1864">return</span> <span id="textcolor1865">1</span>;
<br class="fancyvrb"><a id="x25-101258r77"></a>77      } <span id="textcolor1866">else</span> {<br class="fancyvrb"><a id="x25-101260r78"></a>78          printf(<span class="colorbox" id="colorbox1867"><span id="textcolor1868">"</span></span><span class="colorbox" id="colorbox1869"><span id="textcolor1870">You flail in the air at nothing. Idiot.</span></span><span class="colorbox" id="colorbox1871"><span id="textcolor1872">\n</span></span><span class="colorbox" id="colorbox1873"><span id="textcolor1874">"</span></span>);
<br class="fancyvrb"><a id="x25-101262r79"></a>79          <span id="textcolor1875">return</span> <span id="textcolor1876">0</span>;<br class="fancyvrb"><a id="x25-101264r80"></a>80      }<br class="fancyvrb"><a id="x25-101266r81"></a>81  }<br class="fancyvrb"><a id="x25-101268r82"></a>82  <br class="fancyvrb"><a id="x25-101270r83"></a>83  <br class="fancyvrb"><a id="x25-101272r84"></a>84  Object RoomProto = {<br class="fancyvrb"><a id="x25-101274r85"></a>85      .move = Room_move,
<br class="fancyvrb"><a id="x25-101276r86"></a>86      .attack = Room_attack<br class="fancyvrb"><a id="x25-101278r87"></a>87  };<br class="fancyvrb"><a id="x25-101280r88"></a>88  <br class="fancyvrb"><a id="x25-101282r89"></a>89  <br class="fancyvrb"><a id="x25-101284r90"></a>90  <span id="textcolor1877">void</span> ⋆<span id="textcolor1878">Map_move</span>(<span id="textcolor1879">void</span> ⋆self, Direction direction)
<br class="fancyvrb"><a id="x25-101286r91"></a>91  {<br class="fancyvrb"><a id="x25-101288r92"></a>92      Map ⋆map = self;<br class="fancyvrb"><a id="x25-101290r93"></a>93      Room ⋆location = map-&gt;location;
<br class="fancyvrb"><a id="x25-101292r94"></a>94      Room ⋆next = <span id="textcolor1880">NULL</span>;<br class="fancyvrb"><a id="x25-101294r95"></a>95  <br class="fancyvrb"><a id="x25-101296r96"></a>96      next = location-&gt;_(move)(location, direction);
<br class="fancyvrb"><a id="x25-101298r97"></a>97  <br class="fancyvrb"><a id="x25-101300r98"></a>98      <span id="textcolor1881">if</span>(next) {<br class="fancyvrb"><a id="x25-101302r99"></a>99          map-&gt;location = next;<br class="fancyvrb"><a id="x25-101304r100"></a>100      }<br class="fancyvrb"><a id="x25-101306r101"></a>101  
<br class="fancyvrb"><a id="x25-101308r102"></a>102      <span id="textcolor1882">return</span> next;<br class="fancyvrb"><a id="x25-101310r103"></a>103  }<br class="fancyvrb"><a id="x25-101312r104"></a>104  <br class="fancyvrb"><a id="x25-101314r105"></a>105  <span id="textcolor1883">int</span> <span id="textcolor1884">Map_attack</span>(<span id="textcolor1885">void</span> ⋆self, <span id="textcolor1886">int</span> damage)<br class="fancyvrb"><a id="x25-101316r106"></a>106  {
<br class="fancyvrb"><a id="x25-101318r107"></a>107      Map⋆ map = self;<br class="fancyvrb"><a id="x25-101320r108"></a>108      Room ⋆location = map-&gt;location;<br class="fancyvrb"><a id="x25-101322r109"></a>109  
<br class="fancyvrb"><a id="x25-101324r110"></a>110      <span id="textcolor1887">return</span> location-&gt;_(attack)(location, damage);<br class="fancyvrb"><a id="x25-101326r111"></a>111  }<br class="fancyvrb"><a id="x25-101328r112"></a>112  <br class="fancyvrb"><a id="x25-101330r113"></a>113  <br class="fancyvrb"><a id="x25-101332r114"></a>114  <span id="textcolor1888">int</span> <span id="textcolor1889">Map_init</span>(<span id="textcolor1890">void</span> ⋆self)
<br class="fancyvrb"><a id="x25-101334r115"></a>115  {<br class="fancyvrb"><a id="x25-101336r116"></a>116      Map ⋆map = self;<br class="fancyvrb"><a id="x25-101338r117"></a>117  <br class="fancyvrb"><a id="x25-101340r118"></a>118      <span id="textcolor1891">// make some rooms for a small map</span>
<br class="fancyvrb"><a id="x25-101342r119"></a>119      Room ⋆hall = NEW(Room, <span class="colorbox" id="colorbox1892"><span id="textcolor1893">"</span></span><span class="colorbox" id="colorbox1894"><span id="textcolor1895">The great Hall</span></span><span class="colorbox" id="colorbox1896"><span id="textcolor1897">"</span></span>);
<br class="fancyvrb"><a id="x25-101344r120"></a>120      Room ⋆throne = NEW(Room, <span class="colorbox" id="colorbox1898"><span id="textcolor1899">"</span></span><span class="colorbox" id="colorbox1900"><span id="textcolor1901">The throne room</span></span><span class="colorbox" id="colorbox1902"><span id="textcolor1903">"</span></span>);
                                                                  

                                                                  
<br class="fancyvrb"><a id="x25-101346r121"></a>121      Room ⋆arena = NEW(Room, <span class="colorbox" id="colorbox1904"><span id="textcolor1905">"</span></span><span class="colorbox" id="colorbox1906"><span id="textcolor1907">The arena, with the minotaur</span></span><span class="colorbox" id="colorbox1908"><span id="textcolor1909">"</span></span>);
<br class="fancyvrb"><a id="x25-101348r122"></a>122      Room ⋆kitchen = NEW(Room, <span class="colorbox" id="colorbox1910"><span id="textcolor1911">"</span></span><span class="colorbox" id="colorbox1912"><span id="textcolor1913">Kitchen, you have the knife now</span></span><span class="colorbox" id="colorbox1914"><span id="textcolor1915">"</span></span>);
<br class="fancyvrb"><a id="x25-101350r123"></a>123  <br class="fancyvrb"><a id="x25-101352r124"></a>124      <span id="textcolor1916">// put the bad guy in the arena</span>
<br class="fancyvrb"><a id="x25-101354r125"></a>125      arena-&gt;bad_guy = NEW(Monster, <span class="colorbox" id="colorbox1917"><span id="textcolor1918">"</span></span><span class="colorbox" id="colorbox1919"><span id="textcolor1920">The evil minotaur</span></span><span class="colorbox" id="colorbox1921"><span id="textcolor1922">"</span></span>);<br class="fancyvrb"><a id="x25-101356r126"></a>126  
<br class="fancyvrb"><a id="x25-101358r127"></a>127      <span id="textcolor1923">// setup the map rooms</span><br class="fancyvrb"><a id="x25-101360r128"></a>128      hall-&gt;north = throne;<br class="fancyvrb"><a id="x25-101362r129"></a>129  
<br class="fancyvrb"><a id="x25-101364r130"></a>130      throne-&gt;west = arena;<br class="fancyvrb"><a id="x25-101366r131"></a>131      throne-&gt;east = kitchen;<br class="fancyvrb"><a id="x25-101368r132"></a>132      throne-&gt;south = hall;
<br class="fancyvrb"><a id="x25-101370r133"></a>133  <br class="fancyvrb"><a id="x25-101372r134"></a>134      arena-&gt;east = throne;<br class="fancyvrb"><a id="x25-101374r135"></a>135      kitchen-&gt;west = throne;<br class="fancyvrb"><a id="x25-101376r136"></a>136  
<br class="fancyvrb"><a id="x25-101378r137"></a>137      <span id="textcolor1924">// start the map and the character off in the hall</span><br class="fancyvrb"><a id="x25-101380r138"></a>138      map-&gt;start = hall;
<br class="fancyvrb"><a id="x25-101382r139"></a>139      map-&gt;location = hall;<br class="fancyvrb"><a id="x25-101384r140"></a>140  <br class="fancyvrb"><a id="x25-101386r141"></a>141      <span id="textcolor1925">return</span> <span id="textcolor1926">1</span>;<br class="fancyvrb"><a id="x25-101388r142"></a>142  }<br class="fancyvrb"><a id="x25-101390r143"></a>143  <br class="fancyvrb"><a id="x25-101392r144"></a>144  Object MapProto = {
<br class="fancyvrb"><a id="x25-101394r145"></a>145      .init = Map_init,<br class="fancyvrb"><a id="x25-101396r146"></a>146      .move = Map_move,<br class="fancyvrb"><a id="x25-101398r147"></a>147      .attack = Map_attack<br class="fancyvrb"><a id="x25-101400r148"></a>148  };<br class="fancyvrb"><a id="x25-101402r149"></a>149  
<br class="fancyvrb"><a id="x25-101404r150"></a>150  <span id="textcolor1927">int</span> <span id="textcolor1928">process_input</span>(Map ⋆game)<br class="fancyvrb"><a id="x25-101406r151"></a>151  {<br class="fancyvrb"><a id="x25-101408r152"></a>152      printf(<span class="colorbox" id="colorbox1929"><span id="textcolor1930">"</span></span><span class="colorbox" id="colorbox1931"><span id="textcolor1932">\n</span></span><span class="colorbox" id="colorbox1933"><span id="textcolor1934">&gt; </span></span><span class="colorbox" id="colorbox1935"><span id="textcolor1936">"</span></span>);<br class="fancyvrb"><a id="x25-101410r153"></a>153  <br class="fancyvrb"><a id="x25-101412r154"></a>154      <span id="textcolor1937">char</span> ch = getchar();
<br class="fancyvrb"><a id="x25-101414r155"></a>155      getchar(); <span id="textcolor1938">// eat ENTER</span><br class="fancyvrb"><a id="x25-101416r156"></a>156  <br class="fancyvrb"><a id="x25-101418r157"></a>157      <span id="textcolor1939">int</span> damage = rand() % <span id="textcolor1940">4</span>;<br class="fancyvrb"><a id="x25-101420r158"></a>158  <br class="fancyvrb"><a id="x25-101422r159"></a>159      <span id="textcolor1941">switch</span>(ch) {
<br class="fancyvrb"><a id="x25-101424r160"></a>160          <span id="textcolor1942">case</span> -<span id="textcolor1943">1</span>:<br class="fancyvrb"><a id="x25-101426r161"></a>161              printf(<span class="colorbox" id="colorbox1944"><span id="textcolor1945">"</span></span><span class="colorbox" id="colorbox1946"><span id="textcolor1947">Giving up? You suck.</span></span><span class="colorbox" id="colorbox1948"><span id="textcolor1949">\n</span></span><span class="colorbox" id="colorbox1950"><span id="textcolor1951">"</span></span>);
<br class="fancyvrb"><a id="x25-101428r162"></a>162              <span id="textcolor1952">return</span> <span id="textcolor1953">0</span>;<br class="fancyvrb"><a id="x25-101430r163"></a>163              <span id="textcolor1954">break</span>;<br class="fancyvrb"><a id="x25-101432r164"></a>164  <br class="fancyvrb"><a id="x25-101434r165"></a>165          <span id="textcolor1955">case</span> <span class="colorbox" id="colorbox1956"><span id="textcolor1957">’n’</span></span>:
<br class="fancyvrb"><a id="x25-101436r166"></a>166              game-&gt;_(move)(game, NORTH);<br class="fancyvrb"><a id="x25-101438r167"></a>167              <span id="textcolor1958">break</span>;<br class="fancyvrb"><a id="x25-101440r168"></a>168  
<br class="fancyvrb"><a id="x25-101442r169"></a>169          <span id="textcolor1959">case</span> <span class="colorbox" id="colorbox1960"><span id="textcolor1961">’s’</span></span>:<br class="fancyvrb"><a id="x25-101444r170"></a>170              game-&gt;_(move)(game, SOUTH);<br class="fancyvrb"><a id="x25-101446r171"></a>171              <span id="textcolor1962">break</span>;
<br class="fancyvrb"><a id="x25-101448r172"></a>172  <br class="fancyvrb"><a id="x25-101450r173"></a>173          <span id="textcolor1963">case</span> <span class="colorbox" id="colorbox1964"><span id="textcolor1965">’e’</span></span>:<br class="fancyvrb"><a id="x25-101452r174"></a>174              game-&gt;_(move)(game, EAST);<br class="fancyvrb"><a id="x25-101454r175"></a>175              <span id="textcolor1966">break</span>;
<br class="fancyvrb"><a id="x25-101456r176"></a>176  <br class="fancyvrb"><a id="x25-101458r177"></a>177          <span id="textcolor1967">case</span> <span class="colorbox" id="colorbox1968"><span id="textcolor1969">’w’</span></span>:<br class="fancyvrb"><a id="x25-101460r178"></a>178              game-&gt;_(move)(game, WEST);<br class="fancyvrb"><a id="x25-101462r179"></a>179              <span id="textcolor1970">break</span>;
<br class="fancyvrb"><a id="x25-101464r180"></a>180  <br class="fancyvrb"><a id="x25-101466r181"></a>181          <span id="textcolor1971">case</span> <span class="colorbox" id="colorbox1972"><span id="textcolor1973">’a’</span></span>:<br class="fancyvrb"><a id="x25-101468r182"></a>182  <br class="fancyvrb"><a id="x25-101470r183"></a>183              game-&gt;_(attack)(game, damage);
<br class="fancyvrb"><a id="x25-101472r184"></a>184              <span id="textcolor1974">break</span>;<br class="fancyvrb"><a id="x25-101474r185"></a>185          <span id="textcolor1975">case</span> <span class="colorbox" id="colorbox1976"><span id="textcolor1977">’l’</span></span>:<br class="fancyvrb"><a id="x25-101476r186"></a>186              printf(<span class="colorbox" id="colorbox1978"><span id="textcolor1979">"</span></span><span class="colorbox" id="colorbox1980"><span id="textcolor1981">You can go:</span></span><span class="colorbox" id="colorbox1982"><span id="textcolor1983">\n</span></span><span class="colorbox" id="colorbox1984"><span id="textcolor1985">"</span></span>);
<br class="fancyvrb"><a id="x25-101478r187"></a>187              <span id="textcolor1986">if</span>(game-&gt;location-&gt;north) printf(<span class="colorbox" id="colorbox1987"><span id="textcolor1988">"</span></span><span class="colorbox" id="colorbox1989"><span id="textcolor1990">NORTH</span></span><span class="colorbox" id="colorbox1991"><span id="textcolor1992">\n</span></span><span class="colorbox" id="colorbox1993"><span id="textcolor1994">"</span></span>);
<br class="fancyvrb"><a id="x25-101480r188"></a>188              <span id="textcolor1995">if</span>(game-&gt;location-&gt;south) printf(<span class="colorbox" id="colorbox1996"><span id="textcolor1997">"</span></span><span class="colorbox" id="colorbox1998"><span id="textcolor1999">SOUTH</span></span><span class="colorbox" id="colorbox2000"><span id="textcolor2001">\n</span></span><span class="colorbox" id="colorbox2002"><span id="textcolor2003">"</span></span>);
<br class="fancyvrb"><a id="x25-101482r189"></a>189              <span id="textcolor2004">if</span>(game-&gt;location-&gt;east) printf(<span class="colorbox" id="colorbox2005"><span id="textcolor2006">"</span></span><span class="colorbox" id="colorbox2007"><span id="textcolor2008">EAST</span></span><span class="colorbox" id="colorbox2009"><span id="textcolor2010">\n</span></span><span class="colorbox" id="colorbox2011"><span id="textcolor2012">"</span></span>);
<br class="fancyvrb"><a id="x25-101484r190"></a>190              <span id="textcolor2013">if</span>(game-&gt;location-&gt;west) printf(<span class="colorbox" id="colorbox2014"><span id="textcolor2015">"</span></span><span class="colorbox" id="colorbox2016"><span id="textcolor2017">WEST</span></span><span class="colorbox" id="colorbox2018"><span id="textcolor2019">\n</span></span><span class="colorbox" id="colorbox2020"><span id="textcolor2021">"</span></span>);<br class="fancyvrb"><a id="x25-101486r191"></a>191              <span id="textcolor2022">break</span>;<br class="fancyvrb"><a id="x25-101488r192"></a>192  
<br class="fancyvrb"><a id="x25-101490r193"></a>193          <span id="textcolor2023">default:</span><br class="fancyvrb"><a id="x25-101492r194"></a>194              printf(<span class="colorbox" id="colorbox2024"><span id="textcolor2025">"</span></span><span class="colorbox" id="colorbox2026"><span id="textcolor2027">What?: %d</span></span><span class="colorbox" id="colorbox2028"><span id="textcolor2029">\n</span></span><span class="colorbox" id="colorbox2030"><span id="textcolor2031">"</span></span>, ch);<br class="fancyvrb"><a id="x25-101494r195"></a>195      }<br class="fancyvrb"><a id="x25-101496r196"></a>196  <br class="fancyvrb"><a id="x25-101498r197"></a>197      <span id="textcolor2032">return</span> <span id="textcolor2033">1</span>;<br class="fancyvrb"><a id="x25-101500r198"></a>198  }
<br class="fancyvrb"><a id="x25-101502r199"></a>199  <br class="fancyvrb"><a id="x25-101504r200"></a>200  <span id="textcolor2034">int</span> <span id="textcolor2035">main</span>(<span id="textcolor2036">int</span> argc, <span id="textcolor2037">char</span> ⋆argv[])<br class="fancyvrb"><a id="x25-101506r201"></a>201  {<br class="fancyvrb"><a id="x25-101508r202"></a>202      <span id="textcolor2038">// simple way to setup the randomness</span>
<br class="fancyvrb"><a id="x25-101510r203"></a>203      srand(time(<span id="textcolor2039">NULL</span>));<br class="fancyvrb"><a id="x25-101512r204"></a>204  <br class="fancyvrb"><a id="x25-101514r205"></a>205      <span id="textcolor2040">// make our map to work with</span>
<br class="fancyvrb"><a id="x25-101516r206"></a>206      Map ⋆game = NEW(Map, <span class="colorbox" id="colorbox2041"><span id="textcolor2042">"</span></span><span class="colorbox" id="colorbox2043"><span id="textcolor2044">The Hall of the Minotaur.</span></span><span class="colorbox" id="colorbox2045"><span id="textcolor2046">"</span></span>);<br class="fancyvrb"><a id="x25-101518r207"></a>207  
<br class="fancyvrb"><a id="x25-101520r208"></a>208      printf(<span class="colorbox" id="colorbox2047"><span id="textcolor2048">"</span></span><span class="colorbox" id="colorbox2049"><span id="textcolor2050">You enter the </span></span><span class="colorbox" id="colorbox2051"><span id="textcolor2052">"</span></span>);<br class="fancyvrb"><a id="x25-101522r209"></a>209      game-&gt;location-&gt;_(describe)(game-&gt;location);
<br class="fancyvrb"><a id="x25-101524r210"></a>210  <br class="fancyvrb"><a id="x25-101526r211"></a>211      <span id="textcolor2053">while</span>(process_input(game)) {<br class="fancyvrb"><a id="x25-101528r212"></a>212      }<br class="fancyvrb"><a id="x25-101530r213"></a>213  <br class="fancyvrb"><a id="x25-101532r214"></a>214      <span id="textcolor2054">return</span> <span id="textcolor2055">0</span>;<br class="fancyvrb"><a id="x25-101534r215"></a>215  }</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 581--><p class="indent">    Honestly there isn’t much in this that you haven’t seen, and only you might
need to understand how I’m using the macros I made from the headers files. Here’s
the important key things to study and understand:
     </p><ol class="enumerate1"><li class="enumerate" id="x25-101536x1">Implementing a prototype involves creating its version of the functions,
     and   then   creating   a   single   struct   ending   in   ”Proto”.   Look   at
     MonsterProto, RoomProto and MapProto.
     </li>
     <li class="enumerate" id="x25-101538x2">Because of how Object_new is implemented, if you don’t set a function
     in your prototype, then it will get the default implementation created in
     object.c.
     </li>
     <li class="enumerate" id="x25-101540x3">In Map_init I create the little world, but more importantly I use the NEW
     macro from object.h to build all of the objects. To get this concept in
     your head, try replacing the NEW usage with direct Object_new calls to
     see how it’s being translated.
     </li>
     <li class="enumerate" id="x25-101542x4">Working   with   these   objects   involves   calling   functions   on   them,
     and   the   _(N) macro   does   this   for   me.   If   you   look   at   the   code
     <span class="obeylines-h"><span class="verb">monster-&gt;_(attack)(monster, damage)</span></span> you  see  that  I’m  using
     the                                                  macro,                                                  which
     gets  replaced  with  <span class="obeylines-h"><span class="verb">monster-&gt;proto.attack(monster, damage)</span></span>.
     Study  this  transformation  again  by  rewriting  these  calls  back  to  their
     original. Also, if you get stuck then run cpp manually to see what it’s
     going to do.
     </li>
     <li class="enumerate" id="x25-101544x5">I’m  using  two  new  functions  srand and  rand,  which  setup  a  simple
     random number generator good enough for the game. I also use time to
     initialize the random number generator. Research those.
     </li>
     <li class="enumerate" id="x25-101546x6">I use a new function getchar that gets a single character from the stdin.
                                                                  

                                                                  
     Research it.</li></ol><h3 class="sectionHead"><span class="titlemark">20.4    </span> <a id="x25-10200020.4"></a>What You Should See</h3>
<!--l. 614--><p class="noindent">Here’s me playing my own game:
                                                                  

                                                                  
<!--l. 616--></p><p class="indent">    <a id="x25-102001r54"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
 <div class="caption"><span class="id">Source 54: </span><span class="content">                                                                                                               ex19
output</span></div><!--tex4ht:label?: x25-102001r54 -->
<!--l. 617-->
<div class="lstlisting" id="listing-33"><span class="label"><a id="x25-102002r1"></a>1</span>$ make ex19 <br><span class="label"><a id="x25-102003r2"></a>2</span>cc -Wall -g   -c -o object.o object.c <br><span class="label"><a id="x25-102004r3"></a>3</span>cc -Wall -g    ex19.c object.o   -o ex19 <br><span class="label"><a id="x25-102005r4"></a>4</span>$ ./ex19 <br><span class="label"><a id="x25-102006r5"></a>5</span>You enter the The great Hall. <br><span class="label"><a id="x25-102007r6"></a>6</span> <br><span class="label"><a id="x25-102008r7"></a>7</span>&gt; l <br><span class="label"><a id="x25-102009r8"></a>8</span>You can go: <br><span class="label"><a id="x25-102010r9"></a>9</span>NORTH <br><span class="label"><a id="x25-102011r10"></a>10</span> <br><span class="label"><a id="x25-102012r11"></a>11</span>&gt; n <br><span class="label"><a id="x25-102013r12"></a>12</span>You go north, into: <br><span class="label"><a id="x25-102014r13"></a>13</span>The throne room. <br><span class="label"><a id="x25-102015r14"></a>14</span> <br><span class="label"><a id="x25-102016r15"></a>15</span>&gt; l <br><span class="label"><a id="x25-102017r16"></a>16</span>You can go: <br><span class="label"><a id="x25-102018r17"></a>17</span>SOUTH <br><span class="label"><a id="x25-102019r18"></a>18</span>EAST <br><span class="label"><a id="x25-102020r19"></a>19</span>WEST <br><span class="label"><a id="x25-102021r20"></a>20</span> <br><span class="label"><a id="x25-102022r21"></a>21</span>&gt; e <br><span class="label"><a id="x25-102023r22"></a>22</span>You go east, into: <br><span class="label"><a id="x25-102024r23"></a>23</span>Kitchen, you have the knife now. <br><span class="label"><a id="x25-102025r24"></a>24</span> <br><span class="label"><a id="x25-102026r25"></a>25</span>&gt; w <br><span class="label"><a id="x25-102027r26"></a>26</span>You go west, into: <br><span class="label"><a id="x25-102028r27"></a>27</span>The throne room. <br><span class="label"><a id="x25-102029r28"></a>28</span> <br><span class="label"><a id="x25-102030r29"></a>29</span>&gt; s <br><span class="label"><a id="x25-102031r30"></a>30</span>You go south, into: <br><span class="label"><a id="x25-102032r31"></a>31</span>The great Hall. <br><span class="label"><a id="x25-102033r32"></a>32</span> <br><span class="label"><a id="x25-102034r33"></a>33</span>&gt; n <br><span class="label"><a id="x25-102035r34"></a>34</span>You go north, into: <br><span class="label"><a id="x25-102036r35"></a>35</span>The throne room. <br><span class="label"><a id="x25-102037r36"></a>36</span> <br><span class="label"><a id="x25-102038r37"></a>37</span>&gt; w <br><span class="label"><a id="x25-102039r38"></a>38</span>You go west, into: <br><span class="label"><a id="x25-102040r39"></a>39</span>The arena, with the minotaur. <br><span class="label"><a id="x25-102041r40"></a>40</span> <br><span class="label"><a id="x25-102042r41"></a>41</span>&gt; a <br><span class="label"><a id="x25-102043r42"></a>42</span>You attack The evil minotaur! <br><span class="label"><a id="x25-102044r43"></a>43</span>It is still alive. <br><span class="label"><a id="x25-102045r44"></a>44</span> <br><span class="label"><a id="x25-102046r45"></a>45</span>&gt; a <br><span class="label"><a id="x25-102047r46"></a>46</span>You attack The evil minotaur! <br><span class="label"><a id="x25-102048r47"></a>47</span>It is dead! <br><span class="label"><a id="x25-102049r48"></a>48</span> <br><span class="label"><a id="x25-102050r49"></a>49</span>&gt; ^D <br><span class="label"><a id="x25-102051r50"></a>50</span>Giving up? You suck. <br><span class="label"><a id="x25-102052r51"></a>51</span>$
</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><h3 class="sectionHead"><span class="titlemark">20.5    </span> <a id="x25-10300020.5"></a>Auditing The Game</h3>
<!--l. 676--><p class="noindent">As an exercise for you I have left out all of the assert checks I normally
put into a piece of software. You’ve seen me use assert to make sure a
program is running correctly, but now I want you to go back and do the
following:
<!--l. 681--></p><p class="indent">
     </p><ol class="enumerate1"><li class="enumerate" id="x25-103002x1">Look at each function you’ve defined, one file at a time.
     </li>
     <li class="enumerate" id="x25-103004x2">At  the  top  of  each  function,  add  asserts that  make  sure  the  input
     parameters  are  correct.  For  example,  in  Object_new you  want  a
     <span class="obeylines-h"><span class="verb">assert(description != NULL)</span></span>.
     </li>
     <li class="enumerate" id="x25-103006x3">Go through each line of the function, and find any functions being called.
     Read the documentation (man page) for that function, and confirm what
     it returns for an error. Add another assert to check that the error didn’t
     happen.  For  example,  in  Object_new you  need  one  after  the  call  to
     calloc that does <span class="obeylines-h"><span class="verb">assert(el != NULL)</span></span>.
     </li>
     <li class="enumerate" id="x25-103008x4">If a function is expected to return a value, either make sure it returns an
     error value (like NULL), or have an assert to make sure that the returned
     variable isn’t invalid. For example, in Object_new, you need to have
     <span class="obeylines-h"><span class="verb">assert(el != NULL)</span></span> again before the last return since that part can
     never be NULL.
     </li>
     <li class="enumerate" id="x25-103010x5">For  every  if-statement you  write,  make  sure  there’s  an  else  clause
     unless that if is an error check that causes an exit.
                                                                  

                                                                  
     </li>
     <li class="enumerate" id="x25-103012x6">For  every  switch-statement you  write,  make  sure  that  there’s  a
     default case that handles anything you didn’t anticipate.</li></ol><!--l. 702--><p class="indent">    Take your time going through every line of the function and find any errors you
make. Remember that the point of this exercise is to stop being a ”coder” and switch
your brain into being a ”hacker”. Try to see how you could break it, then write code
to prevent it or abort early if you can.
<!--l. 707--></p><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">20.6    </span> <a id="x25-10400020.6"></a>Extra Credit</h3>
<!--l. 709--><p class="noindent">
     </p><ol class="enumerate1"><li class="enumerate" id="x25-104002x1">Update  the  Makefile so  that  when  you  do  make clean it  will  also
     remove the object.o file.
     </li>
     <li class="enumerate" id="x25-104004x2">Write a test script that works the game in different ways and augment
     the Makefile so you can run make test and it’ll thrash the game with
     your script.
     </li>
     <li class="enumerate" id="x25-104006x3">Add more rooms and monsters to the game.
     </li>
     <li class="enumerate" id="x25-104008x4">Put the game mechanics into a third file, compile it to .o, and then use
     that to write another little game. If you’re doing it right you should only
     have a new Map and a main function in the new game.</li></ol><div class="footnotes"><!--l. 26--><p class="indent">   <span class="footnote-mark"><a href="#fn1x21-bk" id="fn1x21"><sup class="textsuperscript">1</sup></a></span>A.K.A. pound, hash, mesh, number symbol, pick whatever makes you happy        </p></div> <!--l. 1--><div class="crosslinks"><p class="noindent">[<a href="learn-c-the-hard-waych21.html">next</a>]
[<a href="learn-c-the-hard-waych19.html">prev</a>] [<a href="learn-c-the-hard-waych19.html#taillearn-c-the-hard-waych19.html">prev-tail</a>] [<a href="learn-c-the-hard-waych20.html">front</a>] [<a href="learn-c-the-hard-waypa1.html#learn-c-the-hard-waych20.html">up</a>] </p></div>
<!--l. 1--><p class="indent">    <a id="taillearn-c-the-hard-waych20.html"></a>   
</p></body></html>