<html><head><title>习题18: 指向函数的指针</title><meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="generator"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="originator"></meta><!-- index=1,2,next,fn-in,charset=utf-8,NoFonts,html --><meta content="learn-c-the-hard-way.tex" name="src"></meta><meta content="2012-04-11 10:56:00" name="date"></meta><link href="learn-c-the-hard-way.css" rel="stylesheet" type="text/css"></link></head><body>
    <!--l. 1--><div class="crosslinks"><p class="noindent">[<a>prev</a>] [<a href="#taillearn-c-the-hard-way">prev-tail</a>] [<a href="#tail">tail</a>] [<a href="# ">up</a>] </p></div>
    <h2 class="chapterHead"><span class="titlemark">Chapter 19</span><br><a id="x24-9200019"></a>习题18: 指向函数的指针</h2>
<!--l. 3--><p class="noindent">C 中的函数（译注：函数名即为指针名）实际上只是指向程序中的代码的指针。就像你创建的指向结构体（structs），字符串（strings），和数组（arrays）的指针一样，你也能用指针指向函数。这么做的主要用途就是向其他函数传递”回调函数”（callbacks），或者传递给模拟的类与对象。这个练习中，我们会用到一些回调（callback）函数，在下一个中我们会做一个简单的对象系统。
<!--l. 9--></p><p class="indent">    函数指针的格式看起来像这样:
<!--l. 11--></p><p class="indent">    <span class="obeylines-h"><span class="verb">int (⋆POINTER_NAME)(int a, int b)</span></span>
<!--l. 13--></p><p class="indent">    这些是帮助你想起如何写出函数指针的方法:
     </p><ol class="enumerate1"><li class="enumerate" id="x24-92002x1">写一个普通的函数声明: <span class="obeylines-h"><span class="verb">int callme(int a, int b)</span></span>
     </li>
     <li class="enumerate" id="x24-92004x2">用指针的语法格式包围函数名： <span class="obeylines-h"><span class="verb">int (⋆callme)(int a, int b)</span></span>
     </li>
     <li class="enumerate" id="x24-92006x3">把名字改为指针名： <span class="obeylines-h"><span class="verb">int (⋆compare_cb)(int a, int b)</span></span></li></ol><!--l. 21--><p class="indent">    记住这个的关键就是，当你用这种方法做完后，指针的变量名叫做 compare_cb 然后你就像使用函数一样使用它。这和指向数组的指针可以像被指向的数组那样使用相似。指向函数的指针可以向被指向的函数那样使用，只是名字不用而已。
                                                                  

                                                                  
<!--l. 26--></p><p class="indent">    </p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<a id="x24-92007r45"></a>
<div class="caption"><span class="id">Source 45: </span><span class="content">                                                使用行函数指针（Raw Function Pointer）
</span></div><!--tex4ht:label?: x24-92007r45 -->
<!--l. 27-->
<div class="lstlisting" id="listing-29"><span class="label"><a id="x24-92008r1"></a>1</span>    int (⋆tester)(int a, int b) = sorted_order; <br><span class="label"><a id="x24-92009r2"></a>2</span>    printf("TEST: %d is same as %d\n", tester(2, 3), sorted_order(2, 3));
</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 33--><p class="indent">    即使函数指针返回一个指向别的什么东西的指针这也会正常工作:
     </p><ol class="enumerate1"><li class="enumerate" id="x24-92011x1">写下了: <span class="obeylines-h"><span class="verb">char ⋆make_coolness(int awesome_levels)</span></span>
     </li>
     <li class="enumerate" id="x24-92013x2">包裹它: <span class="obeylines-h"><span class="verb">char ⋆(⋆make_coolness)(int awesome_levels)</span></span>
     </li>
     <li class="enumerate" id="x24-92015x3">重命名: <span class="obeylines-h"><span class="verb">char ⋆(⋆coolness_cb)(int awesome_levels)</span></span></li></ol><!--l. 41--><p class="indent">    接下来需要解决的在使用函数指针时的问题是很难把它们作为形参传给函数，就像你想把一个回调函数传给另一个函数的时候那样。解决方法就是使用 typedef－C 语言中为其它复杂类型重新命名的关键字。唯一需要做的就是把 typedef 放到声明函数指针语法的前面，之后你就可以像使用一种类型一样的使用函数指针名。我用下面的练习代码演示一下:
                                                                  

                                                                  
<!--l. 47--></p><p class="indent">    </p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<a id="x24-92016r46"></a>
 <div class="caption"><span class="id">Source 46: </span><span class="content">                                                                                                            ex18.c</span></div><!--tex4ht:label?: x24-92016r46 -->
<div class="fancyvrb" id="fancyvrb21"><a id="x24-92018r1"></a>1  <span id="textcolor1437">#</span><span id="textcolor1438">include <stdio.h></stdio.h></span><br class="fancyvrb"><a id="x24-92020r2"></a>2  <span id="textcolor1439">#</span><span id="textcolor1440">include <stdlib.h></stdlib.h></span><br class="fancyvrb"><a id="x24-92022r3"></a>3  <span id="textcolor1441">#</span><span id="textcolor1442">include <assert.h></assert.h></span>
<br class="fancyvrb"><a id="x24-92024r4"></a>4  <span id="textcolor1443">#</span><span id="textcolor1444">include <errno.h></errno.h></span><br class="fancyvrb"><a id="x24-92026r5"></a>5  <span id="textcolor1445">#</span><span id="textcolor1446">include <string.h></string.h></span><br class="fancyvrb"><a id="x24-92028r6"></a>6  <br class="fancyvrb"><a id="x24-92030r7"></a>7  <span id="textcolor1447">/⋆⋆ Our old friend die from ex17. ⋆/</span>
<br class="fancyvrb"><a id="x24-92032r8"></a>8  <span id="textcolor1448">void</span> <span id="textcolor1449">die</span>(<span id="textcolor1450">const</span> <span id="textcolor1451">char</span> ⋆message)<br class="fancyvrb"><a id="x24-92034r9"></a>9  {<br class="fancyvrb"><a id="x24-92036r10"></a>10      <span id="textcolor1452">if</span>(errno) {<br class="fancyvrb"><a id="x24-92038r11"></a>11          perror(message);
<br class="fancyvrb"><a id="x24-92040r12"></a>12      } <span id="textcolor1453">else</span> {<br class="fancyvrb"><a id="x24-92042r13"></a>13          printf(<span class="colorbox" id="colorbox1454"><span id="textcolor1455">"</span></span><span class="colorbox" id="colorbox1456"><span id="textcolor1457">ERROR: %s</span></span><span class="colorbox" id="colorbox1458"><span id="textcolor1459">\n</span></span><span class="colorbox" id="colorbox1460"><span id="textcolor1461">"</span></span>, message);<br class="fancyvrb"><a id="x24-92044r14"></a>14      }<br class="fancyvrb"><a id="x24-92046r15"></a>15  
<br class="fancyvrb"><a id="x24-92048r16"></a>16      exit(<span id="textcolor1462">1</span>);<br class="fancyvrb"><a id="x24-92050r17"></a>17  }<br class="fancyvrb"><a id="x24-92052r18"></a>18  <br class="fancyvrb"><a id="x24-92054r19"></a>19  <span id="textcolor1463">// a typedef creates a fake type, in this</span>
<br class="fancyvrb"><a id="x24-92056r20"></a>20  <span id="textcolor1464">// case for a function pointer</span><br class="fancyvrb"><a id="x24-92058r21"></a>21  <span id="textcolor1465">typedef</span> <span id="textcolor1466">int</span> (⋆compare_cb)(<span id="textcolor1467">int</span> a, <span id="textcolor1468">int</span> b);<br class="fancyvrb"><a id="x24-92060r22"></a>22  <br class="fancyvrb"><a id="x24-92062r23"></a>23  <span id="textcolor1469">/⋆⋆</span>
<br class="fancyvrb"><a id="x24-92064r24"></a>24  <span id="textcolor1470"> ⋆ A classic bubble sort function that uses the </span><br class="fancyvrb"><a id="x24-92066r25"></a>25  <span id="textcolor1471"> ⋆ compare_cb to do the sorting. </span>
<br class="fancyvrb"><a id="x24-92068r26"></a>26  <span id="textcolor1472"> ⋆/</span><br class="fancyvrb"><a id="x24-92070r27"></a>27  <span id="textcolor1473">int</span> ⋆<span id="textcolor1474">bubble_sort</span>(<span id="textcolor1475">int</span> ⋆numbers, <span id="textcolor1476">int</span> count, compare_cb cmp)<br class="fancyvrb"><a id="x24-92072r28"></a>28  {<br class="fancyvrb"><a id="x24-92074r29"></a>29      <span id="textcolor1477">int</span> temp = <span id="textcolor1478">0</span>;
<br class="fancyvrb"><a id="x24-92076r30"></a>30      <span id="textcolor1479">int</span> i = <span id="textcolor1480">0</span>;<br class="fancyvrb"><a id="x24-92078r31"></a>31      <span id="textcolor1481">int</span> j = <span id="textcolor1482">0</span>;<br class="fancyvrb"><a id="x24-92080r32"></a>32      <span id="textcolor1483">int</span> ⋆target = malloc(count ⋆ <span id="textcolor1484">sizeof</span>(<span id="textcolor1485">int</span>));
<br class="fancyvrb"><a id="x24-92082r33"></a>33  <br class="fancyvrb"><a id="x24-92084r34"></a>34      <span id="textcolor1486">if</span>(!target) die(<span class="colorbox" id="colorbox1487"><span id="textcolor1488">"</span></span><span class="colorbox" id="colorbox1489"><span id="textcolor1490">Memory error.</span></span><span class="colorbox" id="colorbox1491"><span id="textcolor1492">"</span></span>);<br class="fancyvrb"><a id="x24-92086r35"></a>35  
<br class="fancyvrb"><a id="x24-92088r36"></a>36      memcpy(target, numbers, count ⋆ <span id="textcolor1493">sizeof</span>(<span id="textcolor1494">int</span>));<br class="fancyvrb"><a id="x24-92090r37"></a>37  
<br class="fancyvrb"><a id="x24-92092r38"></a>38      <span id="textcolor1495">for</span>(i = <span id="textcolor1496">0</span>; i <a id="x24-92094r39"></a>39          <span id="textcolor1497">for</span>(j = <span id="textcolor1498">0</span>; j 1; j++) {
<br class="fancyvrb"><a id="x24-92096r40"></a>40              <span id="textcolor1500">if</span>(cmp(target[j], target[j+<span id="textcolor1501">1</span>]) &gt; <span id="textcolor1502">0</span>) {
<br class="fancyvrb"><a id="x24-92098r41"></a>41                  temp = target[j+<span id="textcolor1503">1</span>];<br class="fancyvrb"><a id="x24-92100r42"></a>42                  target[j+<span id="textcolor1504">1</span>] = target[j];
<br class="fancyvrb"><a id="x24-92102r43"></a>43                  target[j] = temp;<br class="fancyvrb"><a id="x24-92104r44"></a>44              }<br class="fancyvrb"><a id="x24-92106r45"></a>45          }<br class="fancyvrb"><a id="x24-92108r46"></a>46      }
<br class="fancyvrb"><a id="x24-92110r47"></a>47  <br class="fancyvrb"><a id="x24-92112r48"></a>48      <span id="textcolor1505">return</span> target;<br class="fancyvrb"><a id="x24-92114r49"></a>49  }<br class="fancyvrb"><a id="x24-92116r50"></a>50  <br class="fancyvrb"><a id="x24-92118r51"></a>51  <span id="textcolor1506">int</span> <span id="textcolor1507">sorted_order</span>(<span id="textcolor1508">int</span> a, <span id="textcolor1509">int</span> b)<br class="fancyvrb"><a id="x24-92120r52"></a>52  {
<br class="fancyvrb"><a id="x24-92122r53"></a>53      <span id="textcolor1510">return</span> a - b;<br class="fancyvrb"><a id="x24-92124r54"></a>54  }<br class="fancyvrb"><a id="x24-92126r55"></a>55  <br class="fancyvrb"><a id="x24-92128r56"></a>56  <span id="textcolor1511">int</span> <span id="textcolor1512">reverse_order</span>(<span id="textcolor1513">int</span> a, <span id="textcolor1514">int</span> b)<br class="fancyvrb"><a id="x24-92130r57"></a>57  {<br class="fancyvrb"><a id="x24-92132r58"></a>58      <span id="textcolor1515">return</span> b - a;
<br class="fancyvrb"><a id="x24-92134r59"></a>59  }<br class="fancyvrb"><a id="x24-92136r60"></a>60  <br class="fancyvrb"><a id="x24-92138r61"></a>61  <span id="textcolor1516">int</span> <span id="textcolor1517">strange_order</span>(<span id="textcolor1518">int</span> a, <span id="textcolor1519">int</span> b)<br class="fancyvrb"><a id="x24-92140r62"></a>62  {<br class="fancyvrb"><a id="x24-92142r63"></a>63      <span id="textcolor1520">if</span>(a == <span id="textcolor1521">0</span> || b == <span id="textcolor1522">0</span>) {
<br class="fancyvrb"><a id="x24-92144r64"></a>64          <span id="textcolor1523">return</span> <span id="textcolor1524">0</span>;<br class="fancyvrb"><a id="x24-92146r65"></a>65      } <span id="textcolor1525">else</span> {<br class="fancyvrb"><a id="x24-92148r66"></a>66          <span id="textcolor1526">return</span> a % b;<br class="fancyvrb"><a id="x24-92150r67"></a>67      }<br class="fancyvrb"><a id="x24-92152r68"></a>68  }<br class="fancyvrb"><a id="x24-92154r69"></a>69  
<br class="fancyvrb"><a id="x24-92156r70"></a>70  <span id="textcolor1527">/⋆⋆ </span><br class="fancyvrb"><a id="x24-92158r71"></a>71  <span id="textcolor1528"> ⋆ Used to test that we are sorting things correctly</span>
<br class="fancyvrb"><a id="x24-92160r72"></a>72  <span id="textcolor1529"> ⋆ by doing the sort and printing it out.</span><br class="fancyvrb"><a id="x24-92162r73"></a>73  <span id="textcolor1530"> ⋆/</span>
<br class="fancyvrb"><a id="x24-92164r74"></a>74  <span id="textcolor1531">void</span> <span id="textcolor1532">test_sorting</span>(<span id="textcolor1533">int</span> ⋆numbers, <span id="textcolor1534">int</span> count, compare_cb cmp)<br class="fancyvrb"><a id="x24-92166r75"></a>75  {
<br class="fancyvrb"><a id="x24-92168r76"></a>76      <span id="textcolor1535">int</span> i = <span id="textcolor1536">0</span>;<br class="fancyvrb"><a id="x24-92170r77"></a>77      <span id="textcolor1537">int</span> ⋆sorted = bubble_sort(numbers, count, cmp);
<br class="fancyvrb"><a id="x24-92172r78"></a>78  <br class="fancyvrb"><a id="x24-92174r79"></a>79      <span id="textcolor1538">if</span>(!sorted) die(<span class="colorbox" id="colorbox1539"><span id="textcolor1540">"</span></span><span class="colorbox" id="colorbox1541"><span id="textcolor1542">Failed to sort as requested.</span></span><span class="colorbox" id="colorbox1543"><span id="textcolor1544">"</span></span>);<br class="fancyvrb"><a id="x24-92176r80"></a>80  
<br class="fancyvrb"><a id="x24-92178r81"></a>81      <span id="textcolor1545">for</span>(i = <span id="textcolor1546">0</span>; i <a id="x24-92180r82"></a>82          printf(<span class="colorbox" id="colorbox1547"><span id="textcolor1548">"</span></span><span class="colorbox" id="colorbox1549"><span id="textcolor1550">%d </span></span><span class="colorbox" id="colorbox1551"><span id="textcolor1552">"</span></span>, sorted[i]);<br class="fancyvrb"><a id="x24-92182r83"></a>83      }
<br class="fancyvrb"><a id="x24-92184r84"></a>84      printf(<span class="colorbox" id="colorbox1553"><span id="textcolor1554">"</span></span><span class="colorbox" id="colorbox1555"><span id="textcolor1556">\n</span></span><span class="colorbox" id="colorbox1557"><span id="textcolor1558">"</span></span>);<br class="fancyvrb"><a id="x24-92186r85"></a>85  <br class="fancyvrb"><a id="x24-92188r86"></a>86      free(sorted);<br class="fancyvrb"><a id="x24-92190r87"></a>87  }<br class="fancyvrb"><a id="x24-92192r88"></a>88  <br class="fancyvrb"><a id="x24-92194r89"></a>89  <br class="fancyvrb"><a id="x24-92196r90"></a>90  <span id="textcolor1559">int</span> <span id="textcolor1560">main</span>(<span id="textcolor1561">int</span> argc, <span id="textcolor1562">char</span> ⋆argv[])
<br class="fancyvrb"><a id="x24-92198r91"></a>91  {<br class="fancyvrb"><a id="x24-92200r92"></a>92      <span id="textcolor1563">if</span>(argc 2) die(<span class="colorbox" id="colorbox1565"><span id="textcolor1566">"</span></span><span class="colorbox" id="colorbox1567"><span id="textcolor1568">USAGE: ex18 4 3 1 5 6</span></span><span class="colorbox" id="colorbox1569"><span id="textcolor1570">"</span></span>);<br class="fancyvrb"><a id="x24-92202r93"></a>93  
<br class="fancyvrb"><a id="x24-92204r94"></a>94      <span id="textcolor1571">int</span> count = argc - <span id="textcolor1572">1</span>;<br class="fancyvrb"><a id="x24-92206r95"></a>95      <span id="textcolor1573">int</span> i = <span id="textcolor1574">0</span>;<br class="fancyvrb"><a id="x24-92208r96"></a>96      <span id="textcolor1575">char</span> ⋆⋆inputs = argv + <span id="textcolor1576">1</span>;<br class="fancyvrb"><a id="x24-92210r97"></a>97  
<br class="fancyvrb"><a id="x24-92212r98"></a>98      <span id="textcolor1577">int</span> ⋆numbers = malloc(count ⋆ <span id="textcolor1578">sizeof</span>(<span id="textcolor1579">int</span>));<br class="fancyvrb"><a id="x24-92214r99"></a>99      <span id="textcolor1580">if</span>(!numbers) die(<span class="colorbox" id="colorbox1581"><span id="textcolor1582">"</span></span><span class="colorbox" id="colorbox1583"><span id="textcolor1584">Memory error.</span></span><span class="colorbox" id="colorbox1585"><span id="textcolor1586">"</span></span>);
<br class="fancyvrb"><a id="x24-92216r100"></a>100  <br class="fancyvrb"><a id="x24-92218r101"></a>101      <span id="textcolor1587">for</span>(i = <span id="textcolor1588">0</span>; i <a id="x24-92220r102"></a>102          numbers[i] = atoi(inputs[i]);
<br class="fancyvrb"><a id="x24-92222r103"></a>103      }<br class="fancyvrb"><a id="x24-92224r104"></a>104  <br class="fancyvrb"><a id="x24-92226r105"></a>105      test_sorting(numbers, count, sorted_order);
<br class="fancyvrb"><a id="x24-92228r106"></a>106      test_sorting(numbers, count, reverse_order);
<br class="fancyvrb"><a id="x24-92230r107"></a>107      test_sorting(numbers, count, strange_order);<br class="fancyvrb"><a id="x24-92232r108"></a>108  <br class="fancyvrb"><a id="x24-92234r109"></a>109      free(numbers);
<br class="fancyvrb"><a id="x24-92236r110"></a>110  <br class="fancyvrb"><a id="x24-92238r111"></a>111      <span id="textcolor1589">return</span> <span id="textcolor1590">0</span>;<br class="fancyvrb"><a id="x24-92240r112"></a>112  }</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 165--><p class="indent">    在这个程序中，你创建了一个可以通过比较回调函数（comparison callback）
排序整型数组的动态排序算法。这是修改后的程序，你可以清晰的理解它:
     </p><dl class="description"><dt class="description">
ex18.c:1-6 </dt><dd class="description">所有我们调用的函数都需要 include 包含。
     </dd><dt class="description">
ex18.c:7-17 </dt><dd class="description">这是我们前一个练习中的 die 函数，我们会用它来做错误检查。
     </dd><dt class="description">
ex18.c:21 </dt><dd class="description">在这里使用了 typedef，稍后我们会像在 bubble_sort
     和 test_sorting 中使用 int 或 char 一样把 compare_cb 当做类型使用。
     </dd><dt class="description">
ex18.c:27-49 </dt><dd class="description">一种冒泡排序（bubble sort）的实现，这是一种排序整型数效率很差的方法。这个函数包含:
         <dl class="description"><dt class="description">
     ex18.c:27 </dt><dd class="description">这个我为最后一个参数 cmp 使用 typedef 类型 compare_cb。
         这是一个为了排序而返回的两个整型的比较结果的函数。
         </dd><dt class="description">
     ex18.c:29-34 </dt><dd class="description">先是在栈上创建变量的一般方法，接着是在堆上使用 malloc 创建整型数组的方法。确保你知道 <span class="obeylines-h"><span class="verb">count ⋆ sizeof(int)</span></span>做的什么事。
         </dd><dt class="description">
     ex18.c:38 </dt><dd class="description">冒泡排序的外层循环。
         </dd><dt class="description">
     ex18.c:39 </dt><dd class="description">冒泡排序的内层循环。
         </dd><dt class="description">
     ex18.c:40 </dt><dd class="description">现在我像调用一般函数一样的调用 cmp 这个回调函数，但是用我们定义好的一些名字代替，只是指向它的指针。这就让调用器（caller）传递近任何它们想要的东西，只要满足 compare_cb
                                                                  

                                                                  
         typedef 的“特征”（signature）。
         </dd><dt class="description">
     ex18.c:41-43 </dt><dd class="description">冒泡排序的实际需要做的交换操作。
         </dd><dt class="description">
     ex18.c:48 </dt><dd class="description">最后返回新创建并排序的结果数组 target。</dd></dl></dd><dt class="description">
ex18.c:51-68 </dt><dd class="description">compare_cb 的三种不同的函数类型，我们需要和我们创建的 typedef
     定义一样的定义。如果你得到了这个错误，C 编译其就会向你抱怨说这些类型不匹配。
     </dd><dt class="description">
ex18.c:74-87 </dt><dd class="description">这是 bubble_sort 函数的测试用例。现在你也可以看看我演示如何把传入的 compare_cb 参数传递给 bubble_sort。
     </dd><dt class="description">
ex18.c:90-103 </dt><dd class="description">一个简单的 main 函数，通过你从命令行传入的整型数建立数组，然后调用 test_sorting 函数。
     </dd><dt class="description">
ex18.c:105-107 </dt><dd class="description">最后，你看到了 typedef 定义的函数指针 compare_cb 是如何使用的。我只是简单的调用了 test_sorting 但是把 sorted_order，
     reverse_order，和 strange_order 作为函数名来使用。C 编译器接着找到这些函数的地址，然后把它作为一个指针供 test_sorting 去使用。如果你看看 test_sorting 你会看到它把这些依次传递给 bubble_sort 但事实上它根本就不知道它们是做什么的，只有满足 compare_cb 原型（prototype）的才能工作。
     </dd><dt class="description">
ex18.c:109 </dt><dd class="description">最后我们要做的就是释放我们构造的数值数组。</dd></dl><h3 class="sectionHead"><span class="titlemark">19.1    </span> <a id="x24-9300019.1"></a>你应该看到的结果</h3>
<!--l. 192--><p class="noindent">运行这个程序很简单，那就尝试不同数值的组合，甚至是非数值的组合并产看结果。
                                                                  

                                                                  
                                                                  

                                                                  
<!--l. 194--></p><p class="indent">    </p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<a id="x24-93001r47"></a>
<div class="caption"><span class="id">Source 47: </span><span class="content">                                                                                                               ex18
output</span></div><!--tex4ht:label?: x24-93001r47 -->
<!--l. 195-->
<div class="lstlisting" id="listing-30"><span class="label"><a id="x24-93002r1"></a>1</span>$ make ex18 <br><span class="label"><a id="x24-93003r2"></a>2</span>cc -Wall -g    ex18.c   -o ex18 <br><span class="label"><a id="x24-93004r3"></a>3</span>$ ./ex18 4 1 7 3 2 0 8 <br><span class="label"><a id="x24-93005r4"></a>4</span>0 1 2 3 4 7 8 <br><span class="label"><a id="x24-93006r5"></a>5</span>8 7 4 3 2 1 0 <br><span class="label"><a id="x24-93007r6"></a>6</span>3 4 2 7 1 0 8 <br><span class="label"><a id="x24-93008r7"></a>7</span>$
</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><h3 class="sectionHead"><span class="titlemark">19.2    </span> <a id="x24-9400019.2"></a>让程序出错</h3>
<!--l. 210--><p class="noindent">我将让你做一些奇怪的事情去破坏它。这些函数指针和别的指针一样，所以它们指向的是内存块（blocks of memory）。C 可以把一种指针类型转换成另一种所以你可以用不同的方法处理数据。这通常不是必要的，但还是让你看看如何修改（hack）你的电脑，我希望你在 test_sorting 函数结尾加上这些:
                                                                  

                                                                  
<!--l. 215--></p><p class="indent">    </p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<a id="x24-94001r48"></a>
 <div class="caption"><span class="id">Source 48: </span><span class="content">                                                                                          Function Pointer
Evil</span></div><!--tex4ht:label?: x24-94001r48 -->
<!--l. 216-->
<div class="lstlisting" id="listing-31"><span class="label"><a id="x24-94002r1"></a>1</span>    unsigned char ⋆data = (unsigned char ⋆)cmp; <br><span class="label"><a id="x24-94003r2"></a>2</span> <br><span class="label"><a id="x24-94004r3"></a>3</span>    for(i = 0; i <span class="label"><a id="x24-94005r4"></a>4</span>        printf("%0x:", data[i]); <br><span class="label"><a id="x24-94006r5"></a>5</span>    } <br><span class="label"><a id="x24-94007r6"></a>6</span>    printf("\n");
</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 226--><p class="indent">    这个循环像先把你的函数转换成字符串然后在排序，接着输出它们的内容。这个循环不会中断（break）你的程序，除非你正在使用的 CPU 或操作系统因为你的操作而产生问题。当它输出这个排序后的数组，你会看到一个十六进制数的字符串:
    </p><div class="fancyvrb" id="fancyvrb22"><a id="x24-94009r1"></a>  55:48:89:e5:89:7d:fc:89:75:f8:8b:55:fc:8b:45:f8:29:d0:c9:c3:55:48:89:e5:89:</div>
<!--l. 234--><p class="indent">    那应该是这个函数自身的汇编字节码，你会看到它们开头都相同，但结尾不同。
还可能是这个循环没取得完整的函数或者是取的太多了，取了一部分别的函数的代码。不多分析一下你永远都不会知道。
    </p><h3 class="sectionHead"><span class="titlemark">19.3    </span> <a id="x24-9500019.3"></a>加分习题</h3>
<!--l. 240--><p class="noindent">
     </p><ol class="enumerate1"><li class="enumerate" id="x24-95002x1">找一个十六进制编辑器打开 ex18，然后找到包含这个十六进制位串的函数，看看你是否可以在这个程序中找到这个函数。
     </li>
     <li class="enumerate" id="x24-95004x2">在你的十六进制编辑器中随便找点别的东西，修改它们。回到你的程序看看发生了什么。修改你找到的字符串是相当容易的。
     </li>
     <li class="enumerate" id="x24-95006x3">给 compare_cb 传入错误的参数，然后看看 C 编译器提示什么信息。
     </li>
     <li class="enumerate" id="x24-95008x4">传入 NULL 看看你的程序出了什么问题。然后运行 Valgrind 看看报告了什么。
     </li>
     <li class="enumerate" id="x24-95010x5">写另外一个排序算法，修改 test_sorting 调用这两个函数并比较排序结果。</li></ol><!--l. 1--><div class="crosslinks"><p class="noindent">[<a>prev</a>] [<a href="#taillearn-c-the-hard-way">prev-tail</a>] [<a>front</a>] [<a href="# ">up</a>] </p></div>
<!--l. 1--><p class="indent">    <a id="tail"></a>   
</p></body></html>