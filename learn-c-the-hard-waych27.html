<html><head><title>习题26: 第一个真正的程序</title><meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="generator"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="originator"></meta><!-- index=1,2,next,fn-in,charset=utf-8,NoFonts,html --><meta content="learn-c-the-hard-way.tex" name="src"></meta><meta content="2012-04-11 11:32:00" name="date"></meta><link href="learn-c-the-hard-way.css" rel="stylesheet" type="text/css"></link></head><body>
    <!--l. 1--><div class="crosslinks"><p class="noindent">[<a href="learn-c-the-hard-waypa2.html">next</a>] [<a href="learn-c-the-hard-waych26.html">prev</a>] [<a href="learn-c-the-hard-waych26.html#taillearn-c-the-hard-waych26.html">prev-tail</a>] [<a href="#taillearn-c-the-hard-waych27.html">tail</a>] [<a href="learn-c-the-hard-waypa1.html#learn-c-the-hard-waych27.html">up</a>] </p></div>
    <h2 class="chapterHead"><span class="titlemark">Chapter 27</span><br><a id="x32-14800027"></a>习题26: 第一个真正的程序</h2>
<!--l. 3--><p class="noindent">到这里正好是本书的一半，你也该参加一次期中考试了。这次考核我要求你把我专为本书写的一个叫 devpkg 的程序重写一遍，然后你要用一些关键方法改进代码，最重要的方法就是为它写一些单元测试。
                                                                  

                                                                  
<!--l. 7--></p><p class="indent">    <a id="x32-148001r7"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Note 7: </span><span class="content">                                                                                     WARNING: Beta Draft
Content</span></div><!--tex4ht:label?: x32-148001r7 -->
     <div class="quote">
     <!--l. 8--><p class="indent">   I  wrote  this  exercise  before  writing  some  of  the  exercises  you
     might need to complete this. If you are attempting this one now,
     please  keep  in  mind  that  the  software  may  have  bugs,  that  you
     might have problems because of my mistakes, and that you might
     not  know  everything  you  need  to  finish  it.  If  so,  tell  me  at
     help@learncodethehardway.org  and  then  wait  until  I  finish  the
     other exercises. </p></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><h3 class="sectionHead"><span class="titlemark">27.1    </span> <a id="x32-14900027.1"></a>什么是devpkg?</h3>
<!--l. 18--><p class="noindent">Devpkg 是一个简单的 C 程序，它的功能是用来安装别的软件。这个软件是我专为这本书写的，目的是教你学习真正的软件项目是怎样构架的，以及学习怎样重复使用别人写的 library。它使用了一个称作 <a href="http://apr.apache.org/">The Apache Portable
Runtime (APR)</a> 可移植性library，它里边有很多好用适用于很多平台（包
括Windows）的C 函数。除此之外，它所做的就是从网上或者本地抓到代码，然后执
行一下我们每个人都会的 <span class="obeylines-h"><span class="verb">./configure ; make ; make install</span></span> 而已。
<!--l. 25--></p><p class="indent">    本节习题中你的任务是从源代码 build devpkg，完成我给你的每一个挑战，然后通过阅读源代码来理解 devpkg 的功能和原理。
<!--l. 28--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">27.1.1    </span> <a id="x32-15000027.1.1"></a>我们要实现的功能</h4>
<!--l. 30--><p class="noindent">我们要做一个工具，它有三条命令:
<!--l. 32--></p><p class="indent">
     </p><ol class="enumerate1"><li class="enumerate" id="x32-150001x27.1.1">执行软件的全新安装。
     </li>
     <li class="enumerate" id="x32-150002x27.1.1">通过 URL 安装软件。
     </li>
     <li class="enumerate" id="x32-150003x27.1.1">列出所有安装了的软件。
     </li>
     <li class="enumerate" id="x32-150004x27.1.1">下载源代码以供手动 build。
     </li>
                                                                  

                                                                  
     <li class="enumerate" id="x32-150005x27.1.1">下载源代码，build 并且安装软件，即使在软件已被安装的情况下也会再装一遍。</li></ol><!--l. 40--><p class="indent">    我们要求 devpkg 能够识别绝大部分的 URL，识别出这个 URL 对应的是哪个项目，然后下载并且安装软件，最后记录下来它下载了哪个软件。我们还要求 devpkg
能够处理一份简单的需求列表(dependency list)，这样它就能同时将当前要安装的软件依赖的软件也安装起来。
<!--l. 44--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">27.1.2    </span> <a id="x32-15100027.1.2"></a>软件设计</h4>
<!--l. 46--><p class="noindent">我们将通过非常简单的设计来达到我们的目的：
     </p><dl class="description"><dt class="description">
使用外部命令 </dt><dd class="description">你的大部分工作将通过外部命令诸如 curl、git、tar 来完成。
     这样可以减少实现 devpkg 所需的代码量。
     </dd><dt class="description">
简单的文件数据库 </dt><dd class="description">要做复杂也不难，不过起始阶段你只要建立一个单个文件的简单数据库/usr/local/.devpkg/db，用来记录所安装的软件即可。
     </dd><dt class="description">
只适用/usr/local </dt><dd class="description">这里你也可以做得更高级，不过初始阶段我们就假设所有的东西都装到/usr/local 好了，这也是大部分 Unix 下软件的标准安装路径。
     </dd><dt class="description">
configure, make, make install </dt><dd class="description">我们假设绝大部分软件可以通过执行 configure; make; make install 来安装，而 configure 可能不是必须的一步。如果你要安装的软件不支持这些基本的安装方式，那你可以通过一个选项来修改安装命令，不过更多的东西 devpkg 就不去理会了。
     </dd><dt class="description">
用户可以是root </dt><dd class="description">我们将假设用户可以通过 sudo 命令得到 root 权限，不过在执行完安装命令以后他们将回到普通用户级别。</dd></dl><!--l. 63--><p class="indent">    这样我们可以让程序的初始体积比较小，而功能也都能实现，这样我们就能顺利进行后面的学习，而以后你也能够进一步修改它。
<!--l. 66--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">27.1.3    </span> <a id="x32-15200027.1.3"></a>Apache Portable Runtime</h4>
<!--l. 68--><p class="noindent">接下来你要做的是利用 <a href="http://apr.apache.org/">Apache Portable Runtime (APR)</a> 里一成套的可移植函数库以
完成本项目。APR 不是必须项，就算不用它你也可以完成本程序，只不过你需要写更
多的代码罢了。我要求你使用APR 的原因是让你习惯于链接并使用别的库文件。最后
要说的一点是，APR 在Windows 下也能工作，所以你学的APL 技能可以用在很多别
的平台上面。
<!--l. 73--></p><p class="indent">    你需要下载 apr-1.4.5 和 apr-util-1.3 这两个函数库，同时阅读一下 <a href="http://apr.apache.org/">APR 主
站</a>提供的文档。
<!--l. 76--></p><p class="indent">    下面是一个用来安装的 shell 脚本，你需要将这个脚本手动誊写一遍，然后运行它，直到它能毫不出错地安装 APR 为止。
                                                                  

                                                                  
<!--l. 79--></p><p class="indent">    <a id="x32-152001r67"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 67: </span><span class="content">                                                                                                 APR 安装脚本</span></div><!--tex4ht:label?: x32-152001r67 -->
<div class="fancyvrb" id="fancyvrb36"><a id="x32-152003r1"></a>1  <span id="textcolor3156">set</span> -e<br class="fancyvrb"><a id="x32-152005r2"></a>2  <br class="fancyvrb"><a id="x32-152007r3"></a>3  <span id="textcolor3157"># go somewhere safe</span><br class="fancyvrb"><a id="x32-152009r4"></a>4  <span id="textcolor3158">cd</span> /tmp<br class="fancyvrb"><a id="x32-152011r5"></a>5  <br class="fancyvrb"><a id="x32-152013r6"></a>6  <span id="textcolor3159"># get the source to base APR 1.4.5</span>
<br class="fancyvrb"><a id="x32-152015r7"></a>7  curl -L -O http://download.nextag.com/apache//apr/apr-1.4.5.tar.gz
<br class="fancyvrb"><a id="x32-152017r8"></a>8  <br class="fancyvrb"><a id="x32-152019r9"></a>9  <span id="textcolor3160"># extract it and go into the source</span><br class="fancyvrb"><a id="x32-152021r10"></a>10  tar -xzvf apr-1.4.5.tar.gz
<br class="fancyvrb"><a id="x32-152023r11"></a>11  <span id="textcolor3161">cd </span>apr-1.4.5<br class="fancyvrb"><a id="x32-152025r12"></a>12  <br class="fancyvrb"><a id="x32-152027r13"></a>13  <span id="textcolor3162"># configure, make, make install</span><br class="fancyvrb"><a id="x32-152029r14"></a>14  ./configure
<br class="fancyvrb"><a id="x32-152031r15"></a>15  make<br class="fancyvrb"><a id="x32-152033r16"></a>16  sudo make install<br class="fancyvrb"><a id="x32-152035r17"></a>17  <br class="fancyvrb"><a id="x32-152037r18"></a>18  <span id="textcolor3163"># reset and cleanup</span><br class="fancyvrb"><a id="x32-152039r19"></a>19  <span id="textcolor3164">cd</span> /tmp
<br class="fancyvrb"><a id="x32-152041r20"></a>20  rm -rf apr-1.4.5 apr-1.4.5.tar.gz<br class="fancyvrb"><a id="x32-152043r21"></a>21  <br class="fancyvrb"><a id="x32-152045r22"></a>22  <span id="textcolor3165"># do the same with apr-util</span>
<br class="fancyvrb"><a id="x32-152047r23"></a>23  curl -L -O http://download.nextag.com/apache//apr/apr-util-1.3.12.tar.gz
<br class="fancyvrb"><a id="x32-152049r24"></a>24  <br class="fancyvrb"><a id="x32-152051r25"></a>25  <span id="textcolor3166"># extract</span><br class="fancyvrb"><a id="x32-152053r26"></a>26  tar -xzvf apr-util-1.3.12.tar.gz<br class="fancyvrb"><a id="x32-152055r27"></a>27  <span id="textcolor3167">cd </span>apr-util-1.3.12<br class="fancyvrb"><a id="x32-152057r28"></a>28  
<br class="fancyvrb"><a id="x32-152059r29"></a>29  <span id="textcolor3168"># configure, make, make install</span><br class="fancyvrb"><a id="x32-152061r30"></a>30  ./configure --with-apr=/usr/local/apr
<br class="fancyvrb"><a id="x32-152063r31"></a>31  <span id="textcolor3169"># you need that extra parameter to configure because</span>
<br class="fancyvrb"><a id="x32-152065r32"></a>32  <span id="textcolor3170"># apr-util can’t really find it because...who knows.</span><br class="fancyvrb"><a id="x32-152067r33"></a>33  <br class="fancyvrb"><a id="x32-152069r34"></a>34  make
<br class="fancyvrb"><a id="x32-152071r35"></a>35  sudo make install<br class="fancyvrb"><a id="x32-152073r36"></a>36  <br class="fancyvrb"><a id="x32-152075r37"></a>37  <span id="textcolor3171">#cleanup</span><br class="fancyvrb"><a id="x32-152077r38"></a>38  <span id="textcolor3172">cd</span> /tmp<br class="fancyvrb"><a id="x32-152079r39"></a>39  rm -rf apr-util-1.3.12⋆ apr-1.4.5⋆</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 124--><p class="indent">    我要求你写这个脚本是因为 devpkg 实现的功能和这个脚本一样，只不过参数更多，功能也更完善而已。其实你可以用 shell 完全实现本项目，而且这样做代码量更少，不过在一本 C 语言的书里教你 shell 程序还是有些不合适吧？
<!--l. 128--></p><p class="indent">    运行这个脚本，如果有错就修改过来，直到它能正常工作为止。这样你就装好了实现剩余项目所需的函数库。
    </p><h3 class="sectionHead"><span class="titlemark">27.2    </span> <a id="x32-15300027.2"></a>项目结构</h3>
<!--l. 132--><p class="noindent">你需要通过建立一些文件来开始一个新项目。以下是我通常建立新项目的方法：
                                                                  

                                                                  
<!--l. 134--></p><p class="indent">    <a id="x32-153001r68"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 68: </span><span class="content">                                                                                                  项目骨架目录</span></div><!--tex4ht:label?: x32-153001r68 -->
<div class="fancyvrb" id="fancyvrb37"><a id="x32-153003r1"></a>1  mkdir devpkg<br class="fancyvrb"><a id="x32-153005r2"></a>2  <span id="textcolor3173">cd </span>devpkg<br class="fancyvrb"><a id="x32-153007r3"></a>3  touch README Makefile</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><h4 class="subsectionHead"><span class="titlemark">27.2.1    </span> <a id="x32-15400027.2.1"></a>其他需求</h4>
<!--l. 145--><p class="noindent">你应该已经装了 APR 和 APR-util，所以现在你还需要几个文件作为基本 dependency：
<!--l. 147--></p><p class="indent">
     </p><ol class="enumerate1"><li class="enumerate" id="x32-154002x1">习题 20 中的 dbg.h
     </li>
     <li class="enumerate" id="x32-154004x2">bstrlib.h 和 bstrlib.c，它们来自 <a href="http://bstring.sourceforge.net/">http://bstring.sourceforge.net/</a>。
     下载并解压.zip 文件，把这两个文件复制出来即可。
     </li>
     <li class="enumerate" id="x32-154006x3">键入命令 <span class="obeylines-h"><span class="verb">make bstrlib.o</span></span>，如果执行失败，请阅读下面的“解决 bstring 的问题”。</li></ol><!--l. 154--><p class="indent">    <a id="x32-154007r8"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Note 8: </span><span class="content">                                                                                               解决 bstring 的问题</span></div><!--tex4ht:label?: x32-154007r8 -->
     <div class="quote">
     <!--l. 155--><p class="indent"> 有些平台上面 bstring.c 会出现如下的错误：
      <!--l. 157-->
</p><div class="lstlisting" id="listing-43"><span class="label"><a id="x32-154008r1"></a>1</span>bstrlib.c:2762: error: expected declaration specifiers or ’...’ before numeric constant
      </div>
     <!--l. 161--><p class="indent"> 这是因为 bstrlib.c 的作者用了一个有问题的 define 语句，这个语句有时不能正常工作。只要把这个 <span class="obeylines-h"><span class="verb">#ifdef</span></span> 删掉并且重新编译即可。
     </p></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 165--><p class="indent">    上述步骤完成以后，你应该准备了以下文件：Makefile、README、dbg.h、
bstrlib.h、bstrlib.c。现在你可以继续了。
    </p><h3 class="sectionHead"><span class="titlemark">27.3    </span> <a id="x32-15500027.3"></a>Makefile</h3>
<!--l. 170--><p class="noindent">Makefile 是一个很好的开始着手点，这样你可以计划好要 build 的内容，以及你需要建立的代码文件。
                                                                  

                                                                  
<!--l. 173--></p><p class="indent">    <a id="x32-155001r69"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 69: </span><span class="content">                                                                                                        Makefile</span></div><!--tex4ht:label?: x32-155001r69 -->
<!--l. 174-->
<div class="lstlisting" id="listing-44"><span class="label"><a id="x32-155002r1"></a>1</span>PREFIX?=/usr/local <br><span class="label"><a id="x32-155003r2"></a>2</span>CFLAGS=-g -Wall -I${PREFIX}/apr/include/apr-1  -I${PREFIX}/apr/include/apr-util-1 <br><span class="label"><a id="x32-155004r3"></a>3</span>LDFLAGS=-lapr-1 -pthread -laprutil-1 <br><span class="label"><a id="x32-155005r4"></a>4</span> <br><span class="label"><a id="x32-155006r5"></a>5</span>all: devpkg <br><span class="label"><a id="x32-155007r6"></a>6</span> <br><span class="label"><a id="x32-155008r7"></a>7</span>devpkg: bstrlib.o db.o shell.o commands.o <br><span class="label"><a id="x32-155009r8"></a>8</span> <br><span class="label"><a id="x32-155010r9"></a>9</span>install: all <br><span class="label"><a id="x32-155011r10"></a>10</span>        install -d $(DESTDIR)/$(PREFIX)/bin/ <br><span class="label"><a id="x32-155012r11"></a>11</span>        install devpkg $(DESTDIR)/$(PREFIX)/bin/ <br><span class="label"><a id="x32-155013r12"></a>12</span> <br><span class="label"><a id="x32-155014r13"></a>13</span>clean: <br><span class="label"><a id="x32-155015r14"></a>14</span>        rm -f ⋆.o <br><span class="label"><a id="x32-155016r15"></a>15</span>        rm -f devpkg <br><span class="label"><a id="x32-155017r16"></a>16</span>        rm -rf ⋆.dSYM
</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 196--><p class="indent">    除了这个奇怪的 <span class="obeylines-h"><span class="verb">?=</span></span>语法以外，这里基本没有你没见过的东西。这个表达式的意思是“如果 PREFIX 的值还没被设定，那么就将 PREFIX 设为该值”。
    </p><h3 class="sectionHead"><span class="titlemark">27.4    </span> <a id="x32-15600027.4"></a>代码文件</h3>
<!--l. 201--><p class="noindent">从 Makefile 里我们可以看出 devpkg 需要以下四个 dependency：
     </p><dl class="description"><dt class="description">
bstrlib.o </dt><dd class="description">，编译自你下载的 bstlib.c 和 bstlib.h。
     </dd><dt class="description">
db.o </dt><dd class="description">，编译自 db.c 和 db.h 头文件。它包含我们即将需要的“数据库”功能。
     </dd><dt class="description">
shell.o </dt><dd class="description">，编译自 shell.c 和 shell.h，它里边包含一些方便运行外部命令
    （例如 curl）的辅助函数。
     </dd><dt class="description">
commands.o </dt><dd class="description">，编译自 command.c 和 command.h，它包含了实现 devpkg 命令行功能所须的各种函数。
     </dd><dt class="description">
devpkg </dt><dd class="description">我们并没有特别提及它，不过其实它是这部分 Makefile 的 build target
    （就在最左边）。它是由 devpkg.c 编译而来，该文件包含了整个程序的 main 函数。</dd></dl><!--l. 214--><p class="indent">    你现在的任务是创建上面提到的每个文件，键入必须的代码并确保正确。
                                                                  

                                                                  
<!--l. 216--></p><p class="indent">    <a id="x32-156001r9"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Note 9: </span><span class="content">                                                                                       别被这场魔法秀忽悠了</span></div><!--tex4ht:label?: x32-156001r9 -->
     <div class="quote">
     <!--l. 217--><p class="indent"> 读到这里也许你会想：“神啊，Zed 怎么能这么牛，这么多东西随便搞搞就弄出来了？！我这辈子都做不到。”其实我并不是用我强悍的编程技术妙笔生花般地地写出这个 devpkg 结构的，我做的是下面这些事情：
    </p><ol class="enumerate1"><li class="enumerate" id="x32-156003x1">我写了一个短小的 README 用来梳理思路，从而决定了我要为 devpkg 实现什么样的功能。
    </li>
    <li class="enumerate" id="x32-156005x2">我创建了一个简单的 Bash 脚本（跟你刚写的那个类似），用以找出所有要实现的细节。
    </li>
    <li class="enumerate" id="x32-156007x3">我创建了一个.c 文件，并且花了几天时间去实现它的功能。
    </li>
    <li class="enumerate" id="x32-156009x4">待到功能基本实现，bug 基本没有了的时候，我接着就把一整个大文件分割成了这四个文件。
    </li>
    <li class="enumerate" id="x32-156011x5">分割完以后，我把里边的函数和数据结构该重命名的重命名，
    该完善的完善，从而让它们的逻辑更完整，而且更“美观”。
    </li>
    <li class="enumerate" id="x32-156013x6">最后，等我让这个重新构架过的程序成功运行起来之后，我又加了一些诸如 -F 和 -B 这样的命令行选项。</li></ol><!--l. 233--><p class="indent"> 你读到的是我想要教你的顺序，不过其实这也不是我固定使用的顺序。有时我对主题了解比较明确，所以会花比较长的时间做更多计划，有时我会直接把想法写成代码看它是否能工作。有时我会写出一个项目再把它丢掉，然后重新设计并写出一个更好的来。一切都取决于我的个人经验带来的感觉，或者是编程的灵感。
                                                                  

                                                                  
     <!--l. 237--></p><p class="indent"> 如果你碰到一个“高手”说一个编程问题只有一种方法解决，那他是在骗你。要吗他们其实用了多种方法，要么他们其实不是高手。
     </p></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><h4 class="subsectionHead"><span class="titlemark">27.4.1    </span> <a id="x32-15700027.4.1"></a>数据库函数</h4>
<!--l. 243--><p class="noindent">我们有必要把安装过的软件的 URL 用某种方式记录下来，并且能够随时列出这些 URL，并通过这些记检查并跳过那些安装过的软件。我采用的是一个单个文件的数据库，并通过 bstrlib.h 这个头文件来实现它的功能。
<!--l. 247--></p><p class="indent">    首先创建 db.h 以供你实现必要的功能：
                                                                  

                                                                  
<!--l. 249--></p><p class="indent">    <a id="x32-157001r70"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 70: </span><span class="content">                                                                                                               db.h</span></div><!--tex4ht:label?: x32-157001r70 -->
<div class="fancyvrb" id="fancyvrb38"><a id="x32-157003r1"></a>1  <span id="textcolor3174">#</span><span id="textcolor3175">ifndef _db_h</span><br class="fancyvrb"><a id="x32-157005r2"></a>2  <span id="textcolor3176">#</span><span id="textcolor3177">define _db_h</span><br class="fancyvrb"><a id="x32-157007r3"></a>3  <br class="fancyvrb"><a id="x32-157009r4"></a>4  <span id="textcolor3178">#</span><span id="textcolor3179">define DB_FILE "</span><span id="textcolor3180">/</span><span id="textcolor3181">usr</span><span id="textcolor3182">/</span><span id="textcolor3183">local</span><span id="textcolor3184">/</span><span id="textcolor3185">.devpkg</span><span id="textcolor3186">/</span><span id="textcolor3187">db"</span>
<br class="fancyvrb"><a id="x32-157011r5"></a>5  <span id="textcolor3188">#</span><span id="textcolor3189">define DB_DIR "</span><span id="textcolor3190">/</span><span id="textcolor3191">usr</span><span id="textcolor3192">/</span><span id="textcolor3193">local</span><span id="textcolor3194">/</span><span id="textcolor3195">.devpkg"</span><br class="fancyvrb"><a id="x32-157013r6"></a>6  <br class="fancyvrb"><a id="x32-157015r7"></a>7  <br class="fancyvrb"><a id="x32-157017r8"></a>8  <span id="textcolor3196">int</span> DB_init();<br class="fancyvrb"><a id="x32-157019r9"></a>9  <span id="textcolor3197">int</span> DB_list();
<br class="fancyvrb"><a id="x32-157021r10"></a>10  <span id="textcolor3198">int</span> DB_update(<span id="textcolor3199">const</span> <span id="textcolor3200">char</span> ⋆url);<br class="fancyvrb"><a id="x32-157023r11"></a>11  <span id="textcolor3201">int</span> DB_find(<span id="textcolor3202">const</span> <span id="textcolor3203">char</span> ⋆url);<br class="fancyvrb"><a id="x32-157025r12"></a>12  <br class="fancyvrb"><a id="x32-157027r13"></a>13  <span id="textcolor3204">#</span><span id="textcolor3205">endif</span></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 268--><p class="indent">    然后在 db.c 中实现这些函数，在你 build 它的时候，使用 make 来实现干净的编译，就跟你以前学过的一样。
                                                                  

                                                                  
<!--l. 271--></p><p class="indent">    <a id="x32-157028r71"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 71: </span><span class="content">                                                                                                                db.c</span></div><!--tex4ht:label?: x32-157028r71 -->
<div class="fancyvrb" id="fancyvrb39"><a id="x32-157030r1"></a>1  <span id="textcolor3206">#</span><span id="textcolor3207">include <unistd.h></unistd.h></span><br class="fancyvrb"><a id="x32-157032r2"></a>2  <span id="textcolor3208">#</span><span id="textcolor3209">include <apr_errno.h></apr_errno.h></span><br class="fancyvrb"><a id="x32-157034r3"></a>3  <span id="textcolor3210">#</span><span id="textcolor3211">include <apr_file_io.h></apr_file_io.h></span>
<br class="fancyvrb"><a id="x32-157036r4"></a>4  <br class="fancyvrb"><a id="x32-157038r5"></a>5  <span id="textcolor3212">#</span><span id="textcolor3213">include "db.h"</span><br class="fancyvrb"><a id="x32-157040r6"></a>6  <span id="textcolor3214">#</span><span id="textcolor3215">include "bstrlib.h"</span><br class="fancyvrb"><a id="x32-157042r7"></a>7  <span id="textcolor3216">#</span><span id="textcolor3217">include "dbg.h"</span><br class="fancyvrb"><a id="x32-157044r8"></a>8  
<br class="fancyvrb"><a id="x32-157046r9"></a>9  <span id="textcolor3218">static</span> <span id="textcolor3219">FILE</span> ⋆<span id="textcolor3220">DB_open</span>(<span id="textcolor3221">const</span> <span id="textcolor3222">char</span> ⋆path, <span id="textcolor3223">const</span> <span id="textcolor3224">char</span> ⋆mode)<br class="fancyvrb"><a id="x32-157048r10"></a>10  {
<br class="fancyvrb"><a id="x32-157050r11"></a>11      <span id="textcolor3225">return</span> fopen(path, mode);<br class="fancyvrb"><a id="x32-157052r12"></a>12  }<br class="fancyvrb"><a id="x32-157054r13"></a>13  <br class="fancyvrb"><a id="x32-157056r14"></a>14  <br class="fancyvrb"><a id="x32-157058r15"></a>15  <span id="textcolor3226">static</span> <span id="textcolor3227">void</span> <span id="textcolor3228">DB_close</span>(<span id="textcolor3229">FILE</span> ⋆db)<br class="fancyvrb"><a id="x32-157060r16"></a>16  {
<br class="fancyvrb"><a id="x32-157062r17"></a>17      fclose(db);<br class="fancyvrb"><a id="x32-157064r18"></a>18  }<br class="fancyvrb"><a id="x32-157066r19"></a>19  <br class="fancyvrb"><a id="x32-157068r20"></a>20  <br class="fancyvrb"><a id="x32-157070r21"></a>21  <span id="textcolor3230">static</span> bstring <span id="textcolor3231">DB_load</span>()<br class="fancyvrb"><a id="x32-157072r22"></a>22  {<br class="fancyvrb"><a id="x32-157074r23"></a>23      <span id="textcolor3232">FILE</span> ⋆db = <span id="textcolor3233">NULL</span>;
<br class="fancyvrb"><a id="x32-157076r24"></a>24      bstring data = <span id="textcolor3234">NULL</span>;<br class="fancyvrb"><a id="x32-157078r25"></a>25  <br class="fancyvrb"><a id="x32-157080r26"></a>26      db = DB_open(DB_FILE, <span class="colorbox" id="colorbox3235"><span id="textcolor3236">"</span></span><span class="colorbox" id="colorbox3237"><span id="textcolor3238">r</span></span><span class="colorbox" id="colorbox3239"><span id="textcolor3240">"</span></span>);
<br class="fancyvrb"><a id="x32-157082r27"></a>27      check(db, <span class="colorbox" id="colorbox3241"><span id="textcolor3242">"</span></span><span class="colorbox" id="colorbox3243"><span id="textcolor3244">Failed to open database: %s</span></span><span class="colorbox" id="colorbox3245"><span id="textcolor3246">"</span></span>, DB_FILE);
<br class="fancyvrb"><a id="x32-157084r28"></a>28  <br class="fancyvrb"><a id="x32-157086r29"></a>29      data = bread((bNread)fread, db);
<br class="fancyvrb"><a id="x32-157088r30"></a>30      check(data, <span class="colorbox" id="colorbox3247"><span id="textcolor3248">"</span></span><span class="colorbox" id="colorbox3249"><span id="textcolor3250">Failed to read from db file: %s</span></span><span class="colorbox" id="colorbox3251"><span id="textcolor3252">"</span></span>, DB_FILE);<br class="fancyvrb"><a id="x32-157090r31"></a>31  <br class="fancyvrb"><a id="x32-157092r32"></a>32      DB_close(db);
<br class="fancyvrb"><a id="x32-157094r33"></a>33      <span id="textcolor3253">return</span> data;<br class="fancyvrb"><a id="x32-157096r34"></a>34  <br class="fancyvrb"><a id="x32-157098r35"></a>35  <span id="textcolor3254">error:</span><br class="fancyvrb"><a id="x32-157100r36"></a>36      <span id="textcolor3255">if</span>(db) DB_close(db);<br class="fancyvrb"><a id="x32-157102r37"></a>37      <span id="textcolor3256">if</span>(data) bdestroy(data);
<br class="fancyvrb"><a id="x32-157104r38"></a>38      <span id="textcolor3257">return</span> <span id="textcolor3258">NULL</span>;<br class="fancyvrb"><a id="x32-157106r39"></a>39  }<br class="fancyvrb"><a id="x32-157108r40"></a>40  <br class="fancyvrb"><a id="x32-157110r41"></a>41  <br class="fancyvrb"><a id="x32-157112r42"></a>42  <span id="textcolor3259">int</span> <span id="textcolor3260">DB_update</span>(<span id="textcolor3261">const</span> <span id="textcolor3262">char</span> ⋆url)<br class="fancyvrb"><a id="x32-157114r43"></a>43  {<br class="fancyvrb"><a id="x32-157116r44"></a>44      <span id="textcolor3263">if</span>(DB_find(url)) {
<br class="fancyvrb"><a id="x32-157118r45"></a>45          log_info(<span class="colorbox" id="colorbox3264"><span id="textcolor3265">"</span></span><span class="colorbox" id="colorbox3266"><span id="textcolor3267">Already recorded as installed: %s</span></span><span class="colorbox" id="colorbox3268"><span id="textcolor3269">"</span></span>, url);
<br class="fancyvrb"><a id="x32-157120r46"></a>46      }<br class="fancyvrb"><a id="x32-157122r47"></a>47  <br class="fancyvrb"><a id="x32-157124r48"></a>48      <span id="textcolor3270">FILE</span> ⋆db = DB_open(DB_FILE, <span class="colorbox" id="colorbox3271"><span id="textcolor3272">"</span></span><span class="colorbox" id="colorbox3273"><span id="textcolor3274">a+</span></span><span class="colorbox" id="colorbox3275"><span id="textcolor3276">"</span></span>);
<br class="fancyvrb"><a id="x32-157126r49"></a>49      check(db, <span class="colorbox" id="colorbox3277"><span id="textcolor3278">"</span></span><span class="colorbox" id="colorbox3279"><span id="textcolor3280">Failed to open DB file: %s</span></span><span class="colorbox" id="colorbox3281"><span id="textcolor3282">"</span></span>, DB_FILE);<br class="fancyvrb"><a id="x32-157128r50"></a>50  
<br class="fancyvrb"><a id="x32-157130r51"></a>51      bstring line = bfromcstr(url);<br class="fancyvrb"><a id="x32-157132r52"></a>52      bconchar(line, <span class="colorbox" id="colorbox3283"><span id="textcolor3284">’\n’</span></span>);
<br class="fancyvrb"><a id="x32-157134r53"></a>53      <span id="textcolor3285">int</span> rc = fwrite(line-&gt;data, blength(line), <span id="textcolor3286">1</span>, db);
<br class="fancyvrb"><a id="x32-157136r54"></a>54      check(rc == <span id="textcolor3287">1</span>, <span class="colorbox" id="colorbox3288"><span id="textcolor3289">"</span></span><span class="colorbox" id="colorbox3290"><span id="textcolor3291">Failed to append to the db.</span></span><span class="colorbox" id="colorbox3292"><span id="textcolor3293">"</span></span>);<br class="fancyvrb"><a id="x32-157138r55"></a>55  <br class="fancyvrb"><a id="x32-157140r56"></a>56      <span id="textcolor3294">return</span> <span id="textcolor3295">0</span>;<br class="fancyvrb"><a id="x32-157142r57"></a>57  <span id="textcolor3296">error:</span>
<br class="fancyvrb"><a id="x32-157144r58"></a>58      <span id="textcolor3297">if</span>(db) DB_close(db);<br class="fancyvrb"><a id="x32-157146r59"></a>59      <span id="textcolor3298">return</span> -<span id="textcolor3299">1</span>;<br class="fancyvrb"><a id="x32-157148r60"></a>60  }<br class="fancyvrb"><a id="x32-157150r61"></a>61  <br class="fancyvrb"><a id="x32-157152r62"></a>62  <br class="fancyvrb"><a id="x32-157154r63"></a>63  <span id="textcolor3300">int</span> <span id="textcolor3301">DB_find</span>(<span id="textcolor3302">const</span> <span id="textcolor3303">char</span> ⋆url)<br class="fancyvrb"><a id="x32-157156r64"></a>64  {
<br class="fancyvrb"><a id="x32-157158r65"></a>65      bstring data = <span id="textcolor3304">NULL</span>;<br class="fancyvrb"><a id="x32-157160r66"></a>66      bstring line = bfromcstr(url);<br class="fancyvrb"><a id="x32-157162r67"></a>67      <span id="textcolor3305">int</span> res = -<span id="textcolor3306">1</span>;
<br class="fancyvrb"><a id="x32-157164r68"></a>68  <br class="fancyvrb"><a id="x32-157166r69"></a>69      data = DB_load(DB_FILE);<br class="fancyvrb"><a id="x32-157168r70"></a>70      check(data, <span class="colorbox" id="colorbox3307"><span id="textcolor3308">"</span></span><span class="colorbox" id="colorbox3309"><span id="textcolor3310">Failed to load: %s</span></span><span class="colorbox" id="colorbox3311"><span id="textcolor3312">"</span></span>, DB_FILE);
<br class="fancyvrb"><a id="x32-157170r71"></a>71  <br class="fancyvrb"><a id="x32-157172r72"></a>72      <span id="textcolor3313">if</span>(binstr(data, <span id="textcolor3314">0</span>, line) == BSTR_ERR) {<br class="fancyvrb"><a id="x32-157174r73"></a>73          res = <span id="textcolor3315">0</span>;
<br class="fancyvrb"><a id="x32-157176r74"></a>74      } <span id="textcolor3316">else</span> {<br class="fancyvrb"><a id="x32-157178r75"></a>75          res = <span id="textcolor3317">1</span>;<br class="fancyvrb"><a id="x32-157180r76"></a>76      }<br class="fancyvrb"><a id="x32-157182r77"></a>77  <br class="fancyvrb"><a id="x32-157184r78"></a>78  <span id="textcolor3318">error:</span> <span id="textcolor3319">// fallthrough</span>
<br class="fancyvrb"><a id="x32-157186r79"></a>79      <span id="textcolor3320">if</span>(data) bdestroy(data);<br class="fancyvrb"><a id="x32-157188r80"></a>80      <span id="textcolor3321">if</span>(line) bdestroy(line);<br class="fancyvrb"><a id="x32-157190r81"></a>81  <br class="fancyvrb"><a id="x32-157192r82"></a>82      <span id="textcolor3322">return</span> res;
<br class="fancyvrb"><a id="x32-157194r83"></a>83  }<br class="fancyvrb"><a id="x32-157196r84"></a>84  <br class="fancyvrb"><a id="x32-157198r85"></a>85  <br class="fancyvrb"><a id="x32-157200r86"></a>86  <span id="textcolor3323">int</span> <span id="textcolor3324">DB_init</span>()<br class="fancyvrb"><a id="x32-157202r87"></a>87  {<br class="fancyvrb"><a id="x32-157204r88"></a>88      apr_pool_t ⋆p = <span id="textcolor3325">NULL</span>;<br class="fancyvrb"><a id="x32-157206r89"></a>89      apr_pool_initialize();
<br class="fancyvrb"><a id="x32-157208r90"></a>90      apr_pool_create(&amp;p, <span id="textcolor3326">NULL</span>);<br class="fancyvrb"><a id="x32-157210r91"></a>91  <br class="fancyvrb"><a id="x32-157212r92"></a>92      <span id="textcolor3327">if</span>(access(DB_DIR, W_OK | X_OK) == -<span id="textcolor3328">1</span>) {
<br class="fancyvrb"><a id="x32-157214r93"></a>93          apr_status_t rc = apr_dir_make_recursive(DB_DIR,
<br class="fancyvrb"><a id="x32-157216r94"></a>94                  APR_UREAD | APR_UWRITE | APR_UEXECUTE |
<br class="fancyvrb"><a id="x32-157218r95"></a>95                  APR_GREAD | APR_GWRITE | APR_GEXECUTE, p);
<br class="fancyvrb"><a id="x32-157220r96"></a>96          check(rc == APR_SUCCESS, <span class="colorbox" id="colorbox3329"><span id="textcolor3330">"</span></span><span class="colorbox" id="colorbox3331"><span id="textcolor3332">Failed to make database dir: %s</span></span><span class="colorbox" id="colorbox3333"><span id="textcolor3334">"</span></span>, DB_DIR);<br class="fancyvrb"><a id="x32-157222r97"></a>97      }
<br class="fancyvrb"><a id="x32-157224r98"></a>98  <br class="fancyvrb"><a id="x32-157226r99"></a>99      <span id="textcolor3335">if</span>(access(DB_FILE, W_OK) == -<span id="textcolor3336">1</span>) {<br class="fancyvrb"><a id="x32-157228r100"></a>100          <span id="textcolor3337">FILE</span> ⋆db = DB_open(DB_FILE, <span class="colorbox" id="colorbox3338"><span id="textcolor3339">"</span></span><span class="colorbox" id="colorbox3340"><span id="textcolor3341">w</span></span><span class="colorbox" id="colorbox3342"><span id="textcolor3343">"</span></span>);
<br class="fancyvrb"><a id="x32-157230r101"></a>101          check(db, <span class="colorbox" id="colorbox3344"><span id="textcolor3345">"</span></span><span class="colorbox" id="colorbox3346"><span id="textcolor3347">Cannot open database: %s</span></span><span class="colorbox" id="colorbox3348"><span id="textcolor3349">"</span></span>, DB_FILE);<br class="fancyvrb"><a id="x32-157232r102"></a>102          DB_close(db);
<br class="fancyvrb"><a id="x32-157234r103"></a>103      }<br class="fancyvrb"><a id="x32-157236r104"></a>104  <br class="fancyvrb"><a id="x32-157238r105"></a>105      apr_pool_destroy(p);<br class="fancyvrb"><a id="x32-157240r106"></a>106      <span id="textcolor3350">return</span> <span id="textcolor3351">0</span>;<br class="fancyvrb"><a id="x32-157242r107"></a>107  <br class="fancyvrb"><a id="x32-157244r108"></a>108  <span id="textcolor3352">error:</span><br class="fancyvrb"><a id="x32-157246r109"></a>109      apr_pool_destroy(p);
<br class="fancyvrb"><a id="x32-157248r110"></a>110      <span id="textcolor3353">return</span> -<span id="textcolor3354">1</span>;<br class="fancyvrb"><a id="x32-157250r111"></a>111  }<br class="fancyvrb"><a id="x32-157252r112"></a>112  <br class="fancyvrb"><a id="x32-157254r113"></a>113  <br class="fancyvrb"><a id="x32-157256r114"></a>114  <span id="textcolor3355">int</span> <span id="textcolor3356">DB_list</span>()<br class="fancyvrb"><a id="x32-157258r115"></a>115  {<br class="fancyvrb"><a id="x32-157260r116"></a>116      bstring data = DB_load(DB_FILE);
<br class="fancyvrb"><a id="x32-157262r117"></a>117      check(data, <span class="colorbox" id="colorbox3357"><span id="textcolor3358">"</span></span><span class="colorbox" id="colorbox3359"><span id="textcolor3360">Failed to read load: %s</span></span><span class="colorbox" id="colorbox3361"><span id="textcolor3362">"</span></span>, DB_FILE);<br class="fancyvrb"><a id="x32-157264r118"></a>118  <br class="fancyvrb"><a id="x32-157266r119"></a>119      printf(<span class="colorbox" id="colorbox3363"><span id="textcolor3364">"</span></span><span class="colorbox" id="colorbox3365"><span id="textcolor3366">%s</span></span><span class="colorbox" id="colorbox3367"><span id="textcolor3368">"</span></span>, bdata(data));
<br class="fancyvrb"><a id="x32-157268r120"></a>120      bdestroy(data);<br class="fancyvrb"><a id="x32-157270r121"></a>121      <span id="textcolor3369">return</span> <span id="textcolor3370">0</span>;<br class="fancyvrb"><a id="x32-157272r122"></a>122  <br class="fancyvrb"><a id="x32-157274r123"></a>123  <span id="textcolor3371">error:</span><br class="fancyvrb"><a id="x32-157276r124"></a>124      <span id="textcolor3372">return</span> -<span id="textcolor3373">1</span>;<br class="fancyvrb"><a id="x32-157278r125"></a>125  }</div>
                                                                  

                                                                  
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><h5 class="subsubsectionHead"><a id="x32-15800027.4.1"></a>挑战1: 代码审查</h5>
<!--l. 404--><p class="noindent">继续下一步之前，仔细阅读每一行代码，确认你输入的内容和书里的完全相同。练习倒着一行一行读回去，你还要检查每一处函数调用，确认你使用了 check 来检查返回值。最后，如果你有不认识或者不了解的函数，你需要到 APR 网站的文档中，或者在 bstrlib.h 和 bstrlib.c 这两个代码文件中寻找答案。
<!--l. 410--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">27.4.2    </span> <a id="x32-15900027.4.2"></a>Shell 函数</h4>
<!--l. 412--><p class="noindent">devpkg 设计最关键的一个设计决策就是使用外部工具来实现大部分功能，例如 curl、tar、git 等程序。我们其实也能找到需要的函数库，在不借用外部工具的情况下实现这个项目，不过如果我们需要的只是这些程序的基本功能，那么使用函数库是没必要的，再说在 Unix 下多运行几条命令也不是啥丢人的事情。
<!--l. 417--></p><p class="indent">    为了达到目的，我将使用 apr_thread_proc.h 里的函数来运行外部程序，不过我还想创建一个简单的“模板”系统。我将使用 struct Shell 来存储运行程序必须的所有信息，不过我会在参数列表中留出“空位”，实际用到的参数将被填入到这些空位中。
<!--l. 421--></p><p class="indent">    从下面的 shell.h 文件中你可以看到我们需要使用的结构和命令。我用了 extern 来表示别的.c 文件可以访问到我在 shell.c 中定义的变量。
                                                                  

                                                                  
<!--l. 424--></p><p class="indent">    <a id="x32-159001r72"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 72: </span><span class="content">                                                                                                            shell.h</span></div><!--tex4ht:label?: x32-159001r72 -->
<div class="fancyvrb" id="fancyvrb40"><a id="x32-159003r1"></a>1  <span id="textcolor3374">#</span><span id="textcolor3375">ifndef _shell_h</span><br class="fancyvrb"><a id="x32-159005r2"></a>2  <span id="textcolor3376">#</span><span id="textcolor3377">define _shell_h</span><br class="fancyvrb"><a id="x32-159007r3"></a>3  <br class="fancyvrb"><a id="x32-159009r4"></a>4  <span id="textcolor3378">#</span><span id="textcolor3379">define MAX_COMMAND_ARGS 100</span>
<br class="fancyvrb"><a id="x32-159011r5"></a>5  <br class="fancyvrb"><a id="x32-159013r6"></a>6  <span id="textcolor3380">#</span><span id="textcolor3381">include <apr_thread_proc.h></apr_thread_proc.h></span><br class="fancyvrb"><a id="x32-159015r7"></a>7  <br class="fancyvrb"><a id="x32-159017r8"></a>8  <span id="textcolor3382">typedef</span> <span id="textcolor3383">struct</span> Shell {
<br class="fancyvrb"><a id="x32-159019r9"></a>9      <span id="textcolor3384">const</span> <span id="textcolor3385">char</span> ⋆dir;<br class="fancyvrb"><a id="x32-159021r10"></a>10      <span id="textcolor3386">const</span> <span id="textcolor3387">char</span> ⋆exe;<br class="fancyvrb"><a id="x32-159023r11"></a>11  <br class="fancyvrb"><a id="x32-159025r12"></a>12      apr_procattr_t ⋆attr;
<br class="fancyvrb"><a id="x32-159027r13"></a>13      apr_proc_t proc;<br class="fancyvrb"><a id="x32-159029r14"></a>14      apr_exit_why_e exit_why;<br class="fancyvrb"><a id="x32-159031r15"></a>15      <span id="textcolor3388">int</span> exit_code;
<br class="fancyvrb"><a id="x32-159033r16"></a>16  <br class="fancyvrb"><a id="x32-159035r17"></a>17      <span id="textcolor3389">const</span> <span id="textcolor3390">char</span> ⋆args[MAX_COMMAND_ARGS];<br class="fancyvrb"><a id="x32-159037r18"></a>18  } Shell;<br class="fancyvrb"><a id="x32-159039r19"></a>19  
<br class="fancyvrb"><a id="x32-159041r20"></a>20  <span id="textcolor3391">int</span> Shell_run(apr_pool_t ⋆p, Shell ⋆cmd);<br class="fancyvrb"><a id="x32-159043r21"></a>21  <span id="textcolor3392">int</span> Shell_exec(Shell cmd, ...);
<br class="fancyvrb"><a id="x32-159045r22"></a>22  <br class="fancyvrb"><a id="x32-159047r23"></a>23  <span id="textcolor3393">extern</span> Shell CLEANUP_SH;<br class="fancyvrb"><a id="x32-159049r24"></a>24  <span id="textcolor3394">extern</span> Shell GIT_SH;<br class="fancyvrb"><a id="x32-159051r25"></a>25  <span id="textcolor3395">extern</span> Shell TAR_SH;
<br class="fancyvrb"><a id="x32-159053r26"></a>26  <span id="textcolor3396">extern</span> Shell CURL_SH;<br class="fancyvrb"><a id="x32-159055r27"></a>27  <span id="textcolor3397">extern</span> Shell CONFIGURE_SH;<br class="fancyvrb"><a id="x32-159057r28"></a>28  <span id="textcolor3398">extern</span> Shell MAKE_SH;
<br class="fancyvrb"><a id="x32-159059r29"></a>29  <span id="textcolor3399">extern</span> Shell INSTALL_SH;<br class="fancyvrb"><a id="x32-159061r30"></a>30  <br class="fancyvrb"><a id="x32-159063r31"></a>31  <span id="textcolor3400">#</span><span id="textcolor3401">endif</span></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 461--><p class="indent">    确认你一字不差地创建了 shell.h，而且获得了一样名称和数量的 extern
Shell 变量。这些变量将被 Shell_run 函数和 Shell_exec 函数用以执行外部命令。我定义了这两个函数，然后在 shell.c 中创建了真正用到的变量。
                                                                  

                                                                  
<!--l. 465--></p><p class="indent">    <a id="x32-159064r73"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 73: </span><span class="content">                                                                                                            shell.c</span></div><!--tex4ht:label?: x32-159064r73 -->
<div class="fancyvrb" id="fancyvrb41"><a id="x32-159066r1"></a>1  <span id="textcolor3402">#</span><span id="textcolor3403">include "shell.h"</span><br class="fancyvrb"><a id="x32-159068r2"></a>2  <span id="textcolor3404">#</span><span id="textcolor3405">include "dbg.h"</span><br class="fancyvrb"><a id="x32-159070r3"></a>3  <span id="textcolor3406">#</span><span id="textcolor3407">include <stdarg.h></stdarg.h></span><br class="fancyvrb"><a id="x32-159072r4"></a>4  
<br class="fancyvrb"><a id="x32-159074r5"></a>5  <span id="textcolor3408">int</span> <span id="textcolor3409">Shell_exec</span>(Shell template, ...)<br class="fancyvrb"><a id="x32-159076r6"></a>6  {<br class="fancyvrb"><a id="x32-159078r7"></a>7      apr_pool_t ⋆p = <span id="textcolor3410">NULL</span>;<br class="fancyvrb"><a id="x32-159080r8"></a>8      <span id="textcolor3411">int</span> rc = -<span id="textcolor3412">1</span>;
<br class="fancyvrb"><a id="x32-159082r9"></a>9      apr_status_t rv = APR_SUCCESS;<br class="fancyvrb"><a id="x32-159084r10"></a>10      <span id="textcolor3413">va_list</span> argp;<br class="fancyvrb"><a id="x32-159086r11"></a>11      <span id="textcolor3414">const</span> <span id="textcolor3415">char</span> ⋆key = <span id="textcolor3416">NULL</span>;
<br class="fancyvrb"><a id="x32-159088r12"></a>12      <span id="textcolor3417">const</span> <span id="textcolor3418">char</span> ⋆arg = <span id="textcolor3419">NULL</span>;<br class="fancyvrb"><a id="x32-159090r13"></a>13      <span id="textcolor3420">int</span> i = <span id="textcolor3421">0</span>;<br class="fancyvrb"><a id="x32-159092r14"></a>14  <br class="fancyvrb"><a id="x32-159094r15"></a>15      rv = apr_pool_create(&amp;p, <span id="textcolor3422">NULL</span>);
<br class="fancyvrb"><a id="x32-159096r16"></a>16      check(rv == APR_SUCCESS, <span class="colorbox" id="colorbox3423"><span id="textcolor3424">"</span></span><span class="colorbox" id="colorbox3425"><span id="textcolor3426">Failed to create pool.</span></span><span class="colorbox" id="colorbox3427"><span id="textcolor3428">"</span></span>);<br class="fancyvrb"><a id="x32-159098r17"></a>17  
<br class="fancyvrb"><a id="x32-159100r18"></a>18      va_start(argp, template);<br class="fancyvrb"><a id="x32-159102r19"></a>19  <br class="fancyvrb"><a id="x32-159104r20"></a>20      <span id="textcolor3429">for</span>(key = va_arg(argp, <span id="textcolor3430">const</span> <span id="textcolor3431">char</span> ⋆);
<br class="fancyvrb"><a id="x32-159106r21"></a>21          key != <span id="textcolor3432">NULL</span>;<br class="fancyvrb"><a id="x32-159108r22"></a>22          key = va_arg(argp, <span id="textcolor3433">const</span> <span id="textcolor3434">char</span> ⋆))
<br class="fancyvrb"><a id="x32-159110r23"></a>23      {<br class="fancyvrb"><a id="x32-159112r24"></a>24          arg = va_arg(argp, <span id="textcolor3435">const</span> <span id="textcolor3436">char</span> ⋆);<br class="fancyvrb"><a id="x32-159114r25"></a>25  
<br class="fancyvrb"><a id="x32-159116r26"></a>26          <span id="textcolor3437">for</span>(i = <span id="textcolor3438">0</span>; template.args[i] != <span id="textcolor3439">NULL</span>; i++) {
<br class="fancyvrb"><a id="x32-159118r27"></a>27              <span id="textcolor3440">if</span>(strcmp(template.args[i], key) == <span id="textcolor3441">0</span>) {
<br class="fancyvrb"><a id="x32-159120r28"></a>28                  template.args[i] = arg;<br class="fancyvrb"><a id="x32-159122r29"></a>29                  <span id="textcolor3442">break</span>; <span id="textcolor3443">// found it</span>
<br class="fancyvrb"><a id="x32-159124r30"></a>30              }<br class="fancyvrb"><a id="x32-159126r31"></a>31          }<br class="fancyvrb"><a id="x32-159128r32"></a>32      }<br class="fancyvrb"><a id="x32-159130r33"></a>33  <br class="fancyvrb"><a id="x32-159132r34"></a>34      rc = Shell_run(p, &amp;template);
<br class="fancyvrb"><a id="x32-159134r35"></a>35      apr_pool_destroy(p);<br class="fancyvrb"><a id="x32-159136r36"></a>36      va_end(argp);<br class="fancyvrb"><a id="x32-159138r37"></a>37      <span id="textcolor3444">return</span> rc;
<br class="fancyvrb"><a id="x32-159140r38"></a>38  <span id="textcolor3445">error:</span><br class="fancyvrb"><a id="x32-159142r39"></a>39      <span id="textcolor3446">if</span>(p) {<br class="fancyvrb"><a id="x32-159144r40"></a>40          apr_pool_destroy(p);<br class="fancyvrb"><a id="x32-159146r41"></a>41      }
<br class="fancyvrb"><a id="x32-159148r42"></a>42      <span id="textcolor3447">return</span> rc;<br class="fancyvrb"><a id="x32-159150r43"></a>43  }<br class="fancyvrb"><a id="x32-159152r44"></a>44  <br class="fancyvrb"><a id="x32-159154r45"></a>45  <span id="textcolor3448">int</span> <span id="textcolor3449">Shell_run</span>(apr_pool_t ⋆p, Shell ⋆cmd)
<br class="fancyvrb"><a id="x32-159156r46"></a>46  {<br class="fancyvrb"><a id="x32-159158r47"></a>47      apr_procattr_t ⋆attr;<br class="fancyvrb"><a id="x32-159160r48"></a>48      apr_status_t rv;
<br class="fancyvrb"><a id="x32-159162r49"></a>49      apr_proc_t newproc;<br class="fancyvrb"><a id="x32-159164r50"></a>50  <br class="fancyvrb"><a id="x32-159166r51"></a>51      rv = apr_procattr_create(&amp;attr, p);
<br class="fancyvrb"><a id="x32-159168r52"></a>52      check(rv == APR_SUCCESS, <span class="colorbox" id="colorbox3450"><span id="textcolor3451">"</span></span><span class="colorbox" id="colorbox3452"><span id="textcolor3453">Failed to create proc attr.</span></span><span class="colorbox" id="colorbox3454"><span id="textcolor3455">"</span></span>);<br class="fancyvrb"><a id="x32-159170r53"></a>53  
<br class="fancyvrb"><a id="x32-159172r54"></a>54      rv = apr_procattr_io_set(attr, APR_NO_PIPE, APR_NO_PIPE,<br class="fancyvrb"><a id="x32-159174r55"></a>55              APR_NO_PIPE);
<br class="fancyvrb"><a id="x32-159176r56"></a>56      check(rv == APR_SUCCESS, <span class="colorbox" id="colorbox3456"><span id="textcolor3457">"</span></span><span class="colorbox" id="colorbox3458"><span id="textcolor3459">Failed to set IO of command.</span></span><span class="colorbox" id="colorbox3460"><span id="textcolor3461">"</span></span>);
<br class="fancyvrb"><a id="x32-159178r57"></a>57  <br class="fancyvrb"><a id="x32-159180r58"></a>58      rv = apr_procattr_dir_set(attr, cmd-&gt;dir);
<br class="fancyvrb"><a id="x32-159182r59"></a>59      check(rv == APR_SUCCESS, <span class="colorbox" id="colorbox3462"><span id="textcolor3463">"</span></span><span class="colorbox" id="colorbox3464"><span id="textcolor3465">Failed to set root to %s</span></span><span class="colorbox" id="colorbox3466"><span id="textcolor3467">"</span></span>, cmd-&gt;dir);
<br class="fancyvrb"><a id="x32-159184r60"></a>60  <br class="fancyvrb"><a id="x32-159186r61"></a>61      rv = apr_procattr_cmdtype_set(attr, APR_PROGRAM_PATH);
<br class="fancyvrb"><a id="x32-159188r62"></a>62      check(rv == APR_SUCCESS, <span class="colorbox" id="colorbox3468"><span id="textcolor3469">"</span></span><span class="colorbox" id="colorbox3470"><span id="textcolor3471">Failed to set cmd type.</span></span><span class="colorbox" id="colorbox3472"><span id="textcolor3473">"</span></span>);<br class="fancyvrb"><a id="x32-159190r63"></a>63  
<br class="fancyvrb"><a id="x32-159192r64"></a>64      rv = apr_proc_create(&amp;newproc, cmd-&gt;exe, cmd-&gt;args, <span id="textcolor3474">NULL</span>, attr, p);
<br class="fancyvrb"><a id="x32-159194r65"></a>65      check(rv == APR_SUCCESS, <span class="colorbox" id="colorbox3475"><span id="textcolor3476">"</span></span><span class="colorbox" id="colorbox3477"><span id="textcolor3478">Failed to run command.</span></span><span class="colorbox" id="colorbox3479"><span id="textcolor3480">"</span></span>);<br class="fancyvrb"><a id="x32-159196r66"></a>66  
<br class="fancyvrb"><a id="x32-159198r67"></a>67      rv = apr_proc_wait(&amp;newproc, &amp;cmd-&gt;exit_code, &amp;cmd-&gt;exit_why, APR_WAIT);
<br class="fancyvrb"><a id="x32-159200r68"></a>68      check(rv == APR_CHILD_DONE, <span class="colorbox" id="colorbox3481"><span id="textcolor3482">"</span></span><span class="colorbox" id="colorbox3483"><span id="textcolor3484">Failed to wait.</span></span><span class="colorbox" id="colorbox3485"><span id="textcolor3486">"</span></span>);<br class="fancyvrb"><a id="x32-159202r69"></a>69  
<br class="fancyvrb"><a id="x32-159204r70"></a>70      check(cmd-&gt;exit_code == <span id="textcolor3487">0</span>, <span class="colorbox" id="colorbox3488"><span id="textcolor3489">"</span></span><span class="colorbox" id="colorbox3490"><span id="textcolor3491">%s exited badly.</span></span><span class="colorbox" id="colorbox3492"><span id="textcolor3493">"</span></span>, cmd-&gt;exe);
<br class="fancyvrb"><a id="x32-159206r71"></a>71      check(cmd-&gt;exit_why == APR_PROC_EXIT, <span class="colorbox" id="colorbox3494"><span id="textcolor3495">"</span></span><span class="colorbox" id="colorbox3496"><span id="textcolor3497">%s was killed or crashed</span></span><span class="colorbox" id="colorbox3498"><span id="textcolor3499">"</span></span>, cmd-&gt;exe);
<br class="fancyvrb"><a id="x32-159208r72"></a>72  <br class="fancyvrb"><a id="x32-159210r73"></a>73      <span id="textcolor3500">return</span> <span id="textcolor3501">0</span>;<br class="fancyvrb"><a id="x32-159212r74"></a>74  <br class="fancyvrb"><a id="x32-159214r75"></a>75  <span id="textcolor3502">error:</span><br class="fancyvrb"><a id="x32-159216r76"></a>76      <span id="textcolor3503">return</span> -<span id="textcolor3504">1</span>;<br class="fancyvrb"><a id="x32-159218r77"></a>77  }<br class="fancyvrb"><a id="x32-159220r78"></a>78  
<br class="fancyvrb"><a id="x32-159222r79"></a>79  Shell CLEANUP_SH = {<br class="fancyvrb"><a id="x32-159224r80"></a>80      .exe = <span class="colorbox" id="colorbox3505"><span id="textcolor3506">"</span></span><span class="colorbox" id="colorbox3507"><span id="textcolor3508">rm</span></span><span class="colorbox" id="colorbox3509"><span id="textcolor3510">"</span></span>,<br class="fancyvrb"><a id="x32-159226r81"></a>81      .dir = <span class="colorbox" id="colorbox3511"><span id="textcolor3512">"</span></span><span class="colorbox" id="colorbox3513"><span id="textcolor3514">/tmp</span></span><span class="colorbox" id="colorbox3515"><span id="textcolor3516">"</span></span>,
<br class="fancyvrb"><a id="x32-159228r82"></a>82      .args = {<span class="colorbox" id="colorbox3517"><span id="textcolor3518">"</span></span><span class="colorbox" id="colorbox3519"><span id="textcolor3520">rm</span></span><span class="colorbox" id="colorbox3521"><span id="textcolor3522">"</span></span>, <span class="colorbox" id="colorbox3523"><span id="textcolor3524">"</span></span><span class="colorbox" id="colorbox3525"><span id="textcolor3526">-rf</span></span><span class="colorbox" id="colorbox3527"><span id="textcolor3528">"</span></span>, <span class="colorbox" id="colorbox3529"><span id="textcolor3530">"</span></span><span class="colorbox" id="colorbox3531"><span id="textcolor3532">/tmp/pkg-build</span></span><span class="colorbox" id="colorbox3533"><span id="textcolor3534">"</span></span>, <span class="colorbox" id="colorbox3535"><span id="textcolor3536">"</span></span><span class="colorbox" id="colorbox3537"><span id="textcolor3538">/tmp/pkg-src.tar.gz</span></span><span class="colorbox" id="colorbox3539"><span id="textcolor3540">"</span></span>,
<br class="fancyvrb"><a id="x32-159230r83"></a>83          <span class="colorbox" id="colorbox3541"><span id="textcolor3542">"</span></span><span class="colorbox" id="colorbox3543"><span id="textcolor3544">/tmp/pkg-src.tar.bz2</span></span><span class="colorbox" id="colorbox3545"><span id="textcolor3546">"</span></span>, <span class="colorbox" id="colorbox3547"><span id="textcolor3548">"</span></span><span class="colorbox" id="colorbox3549"><span id="textcolor3550">/tmp/DEPENDS</span></span><span class="colorbox" id="colorbox3551"><span id="textcolor3552">"</span></span>, <span id="textcolor3553">NULL</span>}<br class="fancyvrb"><a id="x32-159232r84"></a>84  };
<br class="fancyvrb"><a id="x32-159234r85"></a>85  <br class="fancyvrb"><a id="x32-159236r86"></a>86  Shell GIT_SH = {<br class="fancyvrb"><a id="x32-159238r87"></a>87      .dir = <span class="colorbox" id="colorbox3554"><span id="textcolor3555">"</span></span><span class="colorbox" id="colorbox3556"><span id="textcolor3557">/tmp</span></span><span class="colorbox" id="colorbox3558"><span id="textcolor3559">"</span></span>,<br class="fancyvrb"><a id="x32-159240r88"></a>88      .exe = <span class="colorbox" id="colorbox3560"><span id="textcolor3561">"</span></span><span class="colorbox" id="colorbox3562"><span id="textcolor3563">git</span></span><span class="colorbox" id="colorbox3564"><span id="textcolor3565">"</span></span>,
<br class="fancyvrb"><a id="x32-159242r89"></a>89      .args = {<span class="colorbox" id="colorbox3566"><span id="textcolor3567">"</span></span><span class="colorbox" id="colorbox3568"><span id="textcolor3569">git</span></span><span class="colorbox" id="colorbox3570"><span id="textcolor3571">"</span></span>, <span class="colorbox" id="colorbox3572"><span id="textcolor3573">"</span></span><span class="colorbox" id="colorbox3574"><span id="textcolor3575">clone</span></span><span class="colorbox" id="colorbox3576"><span id="textcolor3577">"</span></span>, <span class="colorbox" id="colorbox3578"><span id="textcolor3579">"</span></span><span class="colorbox" id="colorbox3580"><span id="textcolor3581">URL</span></span><span class="colorbox" id="colorbox3582"><span id="textcolor3583">"</span></span>, <span class="colorbox" id="colorbox3584"><span id="textcolor3585">"</span></span><span class="colorbox" id="colorbox3586"><span id="textcolor3587">pkg-build</span></span><span class="colorbox" id="colorbox3588"><span id="textcolor3589">"</span></span>, <span id="textcolor3590">NULL</span>}<br class="fancyvrb"><a id="x32-159244r90"></a>90  };<br class="fancyvrb"><a id="x32-159246r91"></a>91  
                                                                  

                                                                  
<br class="fancyvrb"><a id="x32-159248r92"></a>92  Shell TAR_SH = {<br class="fancyvrb"><a id="x32-159250r93"></a>93      .dir = <span class="colorbox" id="colorbox3591"><span id="textcolor3592">"</span></span><span class="colorbox" id="colorbox3593"><span id="textcolor3594">/tmp/pkg-build</span></span><span class="colorbox" id="colorbox3595"><span id="textcolor3596">"</span></span>,<br class="fancyvrb"><a id="x32-159252r94"></a>94      .exe = <span class="colorbox" id="colorbox3597"><span id="textcolor3598">"</span></span><span class="colorbox" id="colorbox3599"><span id="textcolor3600">tar</span></span><span class="colorbox" id="colorbox3601"><span id="textcolor3602">"</span></span>,
<br class="fancyvrb"><a id="x32-159254r95"></a>95      .args = {<span class="colorbox" id="colorbox3603"><span id="textcolor3604">"</span></span><span class="colorbox" id="colorbox3605"><span id="textcolor3606">tar</span></span><span class="colorbox" id="colorbox3607"><span id="textcolor3608">"</span></span>, <span class="colorbox" id="colorbox3609"><span id="textcolor3610">"</span></span><span class="colorbox" id="colorbox3611"><span id="textcolor3612">-xzf</span></span><span class="colorbox" id="colorbox3613"><span id="textcolor3614">"</span></span>, <span class="colorbox" id="colorbox3615"><span id="textcolor3616">"</span></span><span class="colorbox" id="colorbox3617"><span id="textcolor3618">FILE</span></span><span class="colorbox" id="colorbox3619"><span id="textcolor3620">"</span></span>, <span class="colorbox" id="colorbox3621"><span id="textcolor3622">"</span></span><span class="colorbox" id="colorbox3623"><span id="textcolor3624">--strip-components</span></span><span class="colorbox" id="colorbox3625"><span id="textcolor3626">"</span></span>, <span class="colorbox" id="colorbox3627"><span id="textcolor3628">"</span></span><span class="colorbox" id="colorbox3629"><span id="textcolor3630">1</span></span><span class="colorbox" id="colorbox3631"><span id="textcolor3632">"</span></span>, <span id="textcolor3633">NULL</span>}
<br class="fancyvrb"><a id="x32-159256r96"></a>96  };<br class="fancyvrb"><a id="x32-159258r97"></a>97  <br class="fancyvrb"><a id="x32-159260r98"></a>98  Shell CURL_SH = {<br class="fancyvrb"><a id="x32-159262r99"></a>99      .dir = <span class="colorbox" id="colorbox3634"><span id="textcolor3635">"</span></span><span class="colorbox" id="colorbox3636"><span id="textcolor3637">/tmp</span></span><span class="colorbox" id="colorbox3638"><span id="textcolor3639">"</span></span>,<br class="fancyvrb"><a id="x32-159264r100"></a>100      .exe = <span class="colorbox" id="colorbox3640"><span id="textcolor3641">"</span></span><span class="colorbox" id="colorbox3642"><span id="textcolor3643">curl</span></span><span class="colorbox" id="colorbox3644"><span id="textcolor3645">"</span></span>,
<br class="fancyvrb"><a id="x32-159266r101"></a>101      .args = {<span class="colorbox" id="colorbox3646"><span id="textcolor3647">"</span></span><span class="colorbox" id="colorbox3648"><span id="textcolor3649">curl</span></span><span class="colorbox" id="colorbox3650"><span id="textcolor3651">"</span></span>, <span class="colorbox" id="colorbox3652"><span id="textcolor3653">"</span></span><span class="colorbox" id="colorbox3654"><span id="textcolor3655">-L</span></span><span class="colorbox" id="colorbox3656"><span id="textcolor3657">"</span></span>, <span class="colorbox" id="colorbox3658"><span id="textcolor3659">"</span></span><span class="colorbox" id="colorbox3660"><span id="textcolor3661">-o</span></span><span class="colorbox" id="colorbox3662"><span id="textcolor3663">"</span></span>, <span class="colorbox" id="colorbox3664"><span id="textcolor3665">"</span></span><span class="colorbox" id="colorbox3666"><span id="textcolor3667">TARGET</span></span><span class="colorbox" id="colorbox3668"><span id="textcolor3669">"</span></span>, <span class="colorbox" id="colorbox3670"><span id="textcolor3671">"</span></span><span class="colorbox" id="colorbox3672"><span id="textcolor3673">URL</span></span><span class="colorbox" id="colorbox3674"><span id="textcolor3675">"</span></span>, <span id="textcolor3676">NULL</span>}
<br class="fancyvrb"><a id="x32-159268r102"></a>102  };<br class="fancyvrb"><a id="x32-159270r103"></a>103  <br class="fancyvrb"><a id="x32-159272r104"></a>104  Shell CONFIGURE_SH = {<br class="fancyvrb"><a id="x32-159274r105"></a>105      .exe = <span class="colorbox" id="colorbox3677"><span id="textcolor3678">"</span></span><span class="colorbox" id="colorbox3679"><span id="textcolor3680">./configure</span></span><span class="colorbox" id="colorbox3681"><span id="textcolor3682">"</span></span>,
<br class="fancyvrb"><a id="x32-159276r106"></a>106      .dir = <span class="colorbox" id="colorbox3683"><span id="textcolor3684">"</span></span><span class="colorbox" id="colorbox3685"><span id="textcolor3686">/tmp/pkg-build</span></span><span class="colorbox" id="colorbox3687"><span id="textcolor3688">"</span></span>,<br class="fancyvrb"><a id="x32-159278r107"></a>107      .args = {<span class="colorbox" id="colorbox3689"><span id="textcolor3690">"</span></span><span class="colorbox" id="colorbox3691"><span id="textcolor3692">configure</span></span><span class="colorbox" id="colorbox3693"><span id="textcolor3694">"</span></span>, <span class="colorbox" id="colorbox3695"><span id="textcolor3696">"</span></span><span class="colorbox" id="colorbox3697"><span id="textcolor3698">OPTS</span></span><span class="colorbox" id="colorbox3699"><span id="textcolor3700">"</span></span>, <span id="textcolor3701">NULL</span>},
<br class="fancyvrb"><a id="x32-159280r108"></a>108  };<br class="fancyvrb"><a id="x32-159282r109"></a>109  <br class="fancyvrb"><a id="x32-159284r110"></a>110  Shell MAKE_SH = {<br class="fancyvrb"><a id="x32-159286r111"></a>111      .exe = <span class="colorbox" id="colorbox3702"><span id="textcolor3703">"</span></span><span class="colorbox" id="colorbox3704"><span id="textcolor3705">make</span></span><span class="colorbox" id="colorbox3706"><span id="textcolor3707">"</span></span>,<br class="fancyvrb"><a id="x32-159288r112"></a>112      .dir = <span class="colorbox" id="colorbox3708"><span id="textcolor3709">"</span></span><span class="colorbox" id="colorbox3710"><span id="textcolor3711">/tmp/pkg-build</span></span><span class="colorbox" id="colorbox3712"><span id="textcolor3713">"</span></span>,
<br class="fancyvrb"><a id="x32-159290r113"></a>113      .args = {<span class="colorbox" id="colorbox3714"><span id="textcolor3715">"</span></span><span class="colorbox" id="colorbox3716"><span id="textcolor3717">make</span></span><span class="colorbox" id="colorbox3718"><span id="textcolor3719">"</span></span>, <span class="colorbox" id="colorbox3720"><span id="textcolor3721">"</span></span><span class="colorbox" id="colorbox3722"><span id="textcolor3723">OPTS</span></span><span class="colorbox" id="colorbox3724"><span id="textcolor3725">"</span></span>, <span id="textcolor3726">NULL</span>}<br class="fancyvrb"><a id="x32-159292r114"></a>114  };<br class="fancyvrb"><a id="x32-159294r115"></a>115  <br class="fancyvrb"><a id="x32-159296r116"></a>116  Shell INSTALL_SH = {<br class="fancyvrb"><a id="x32-159298r117"></a>117      .exe = <span class="colorbox" id="colorbox3727"><span id="textcolor3728">"</span></span><span class="colorbox" id="colorbox3729"><span id="textcolor3730">sudo</span></span><span class="colorbox" id="colorbox3731"><span id="textcolor3732">"</span></span>,
<br class="fancyvrb"><a id="x32-159300r118"></a>118      .dir = <span class="colorbox" id="colorbox3733"><span id="textcolor3734">"</span></span><span class="colorbox" id="colorbox3735"><span id="textcolor3736">/tmp/pkg-build</span></span><span class="colorbox" id="colorbox3737"><span id="textcolor3738">"</span></span>,<br class="fancyvrb"><a id="x32-159302r119"></a>119      .args = {<span class="colorbox" id="colorbox3739"><span id="textcolor3740">"</span></span><span class="colorbox" id="colorbox3741"><span id="textcolor3742">sudo</span></span><span class="colorbox" id="colorbox3743"><span id="textcolor3744">"</span></span>, <span class="colorbox" id="colorbox3745"><span id="textcolor3746">"</span></span><span class="colorbox" id="colorbox3747"><span id="textcolor3748">make</span></span><span class="colorbox" id="colorbox3749"><span id="textcolor3750">"</span></span>, <span class="colorbox" id="colorbox3751"><span id="textcolor3752">"</span></span><span class="colorbox" id="colorbox3753"><span id="textcolor3754">TARGET</span></span><span class="colorbox" id="colorbox3755"><span id="textcolor3756">"</span></span>, <span id="textcolor3757">NULL</span>}<br class="fancyvrb"><a id="x32-159304r120"></a>120  };</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 591--><p class="indent">    从下往上倒着阅读 shell.c 里边的代码（这也是常见的 C 代码布局格式），你会看到我创建了实际用到的 Shell 变量，它们在 shell.h 中是以 extern 的形式声明的。它们就住在这里，但它们对于程序剩下的部分都是有效的。这样你就创建了一个住在.o 文件中，但是可以在任何位置使用的全局变量。
创造太多的全局变量不是一件好事情，不过在当前场合下还是比较合适的。
<!--l. 596--></p><p class="indent">    继续向上阅读我们就看到了 Shell_run 函数，这是一个“基础”函数，它会基于 Shell struct 中的内容执行一条指定的命令。这里使用了很多定义在 apr_thread_proc.h 中的函数，所以你需要去找出并学习每条函数的作用。比起直接调用 system 而言，这样似乎麻烦了许多，不过这样做的一个好处就是能让你更好地控制外部命令执行的一些细节。例如，在 Shell
struct 中我们有一个.dir 属性，它可以强制规定程序在某个指定的路径下运行。
<!--l. 602--></p><p class="indent">    最后，我写了 Shell_exec 这个函数，它是一个“可变参数”函数。这样的函数你已经见过了，不过请确认你明白了 stdarg.h 里的各个函数定义，并且知道怎样可以写出来这样的函数。在本节的挑战环节你将需要却分析这个函数。
    </p><h5 class="subsubsectionHead"><a id="x32-16000027.4.2"></a>挑战2: 分析Shell_exec</h5>
<!--l. 608--><p class="noindent">在这里除了和挑战 1 里一样的完整代码审查以外，你还要完整地分析 Shell_exec 函数，详细了解它的工作原理。你需要弄懂每一行，包括两个 for-loop 的原理，以及参数是怎样被替换的。
<!--l. 612--></p><p class="indent">    分析完以后，在 struct Shell 中添加一栏用以表示需要替换的 args 变量的个数。更新所有的命令，修正它们的参数个数，然后添加错误检查功能，以确认参数被正确替换。
<!--l. 615--></p><p class="noindent">
                                                                  

                                                                  
    </p><h4 class="subsectionHead"><span class="titlemark">27.4.3    </span> <a id="x32-16100027.4.3"></a>命令函数</h4>
<!--l. 617--><p class="noindent">现在你要做的是让命令切实生效。这些命令将用到 APR、db.h、shell.h 中的函数来实现诸如下载以及 build 此类真正的功能。这些文件中的内容及其复杂，所以做这部分时要很小心。和之前一样，你要先完成 commands.h 文件，然后在 commands.c
中实现前面定义的函数。
                                                                  

                                                                  
<!--l. 622--></p><p class="indent">    <a id="x32-161001r74"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 74: </span><span class="content">                                                                                                  commands.h</span></div><!--tex4ht:label?: x32-161001r74 -->
<div class="fancyvrb" id="fancyvrb42"><a id="x32-161003r1"></a>1  <span id="textcolor3758">#</span><span id="textcolor3759">ifndef _commands_h</span><br class="fancyvrb"><a id="x32-161005r2"></a>2  <span id="textcolor3760">#</span><span id="textcolor3761">define _commands_h</span><br class="fancyvrb"><a id="x32-161007r3"></a>3  <br class="fancyvrb"><a id="x32-161009r4"></a>4  <span id="textcolor3762">#</span><span id="textcolor3763">include <apr_pools.h></apr_pools.h></span><br class="fancyvrb"><a id="x32-161011r5"></a>5  
<br class="fancyvrb"><a id="x32-161013r6"></a>6  <span id="textcolor3764">#</span><span id="textcolor3765">define DEPENDS_PATH "</span><span id="textcolor3766">/</span><span id="textcolor3767">tmp</span><span id="textcolor3768">/</span><span id="textcolor3769">DEPENDS"</span><br class="fancyvrb"><a id="x32-161015r7"></a>7  <span id="textcolor3770">#</span><span id="textcolor3771">define TAR_GZ_SRC "</span><span id="textcolor3772">/</span><span id="textcolor3773">tmp</span><span id="textcolor3774">/</span><span id="textcolor3775">pkg-src.tar.gz"</span>
<br class="fancyvrb"><a id="x32-161017r8"></a>8  <span id="textcolor3776">#</span><span id="textcolor3777">define TAR_BZ2_SRC "</span><span id="textcolor3778">/</span><span id="textcolor3779">tmp</span><span id="textcolor3780">/</span><span id="textcolor3781">pkg-src.tar.bz2"</span><br class="fancyvrb"><a id="x32-161019r9"></a>9  <span id="textcolor3782">#</span><span id="textcolor3783">define BUILD_DIR "</span><span id="textcolor3784">/</span><span id="textcolor3785">tmp</span><span id="textcolor3786">/</span><span id="textcolor3787">pkg-build"</span>
<br class="fancyvrb"><a id="x32-161021r10"></a>10  <span id="textcolor3788">#</span><span id="textcolor3789">define GIT_PAT "⋆.git"</span><br class="fancyvrb"><a id="x32-161023r11"></a>11  <span id="textcolor3790">#</span><span id="textcolor3791">define DEPEND_PAT "⋆DEPENDS"</span>
<br class="fancyvrb"><a id="x32-161025r12"></a>12  <span id="textcolor3792">#</span><span id="textcolor3793">define TAR_GZ_PAT "⋆.tar.gz"</span><br class="fancyvrb"><a id="x32-161027r13"></a>13  <span id="textcolor3794">#</span><span id="textcolor3795">define TAR_BZ2_PAT "⋆.tar.bz2"</span>
<br class="fancyvrb"><a id="x32-161029r14"></a>14  <span id="textcolor3796">#</span><span id="textcolor3797">define CONFIG_SCRIPT "</span><span id="textcolor3798">/</span><span id="textcolor3799">tmp</span><span id="textcolor3800">/</span><span id="textcolor3801">pkg-build</span><span id="textcolor3802">/</span><span id="textcolor3803">configure"</span><br class="fancyvrb"><a id="x32-161031r15"></a>15  <br class="fancyvrb"><a id="x32-161033r16"></a>16  <span id="textcolor3804">enum</span> CommandType {
<br class="fancyvrb"><a id="x32-161035r17"></a>17      COMMAND_NONE, COMMAND_INSTALL, COMMAND_LIST, COMMAND_FETCH,
<br class="fancyvrb"><a id="x32-161037r18"></a>18      COMMAND_INIT, COMMAND_BUILD<br class="fancyvrb"><a id="x32-161039r19"></a>19  };<br class="fancyvrb"><a id="x32-161041r20"></a>20  <br class="fancyvrb"><a id="x32-161043r21"></a>21  
<br class="fancyvrb"><a id="x32-161045r22"></a>22  <span id="textcolor3805">int</span> Command_fetch(apr_pool_t ⋆p, <span id="textcolor3806">const</span> <span id="textcolor3807">char</span> ⋆url, <span id="textcolor3808">int</span> fetch_only);<br class="fancyvrb"><a id="x32-161047r23"></a>23  
<br class="fancyvrb"><a id="x32-161049r24"></a>24  <span id="textcolor3809">int</span> Command_install(apr_pool_t ⋆p, <span id="textcolor3810">const</span> <span id="textcolor3811">char</span> ⋆url, <span id="textcolor3812">const</span> <span id="textcolor3813">char</span> ⋆configure_opts,
<br class="fancyvrb"><a id="x32-161051r25"></a>25          <span id="textcolor3814">const</span> <span id="textcolor3815">char</span> ⋆make_opts, <span id="textcolor3816">const</span> <span id="textcolor3817">char</span> ⋆install_opts);
<br class="fancyvrb"><a id="x32-161053r26"></a>26  <br class="fancyvrb"><a id="x32-161055r27"></a>27  <span id="textcolor3818">int</span> Command_depends(apr_pool_t ⋆p, <span id="textcolor3819">const</span> <span id="textcolor3820">char</span> ⋆path);<br class="fancyvrb"><a id="x32-161057r28"></a>28  
<br class="fancyvrb"><a id="x32-161059r29"></a>29  <span id="textcolor3821">int</span> Command_build(apr_pool_t ⋆p, <span id="textcolor3822">const</span> <span id="textcolor3823">char</span> ⋆url, <span id="textcolor3824">const</span> <span id="textcolor3825">char</span> ⋆configure_opts,
<br class="fancyvrb"><a id="x32-161061r30"></a>30          <span id="textcolor3826">const</span> <span id="textcolor3827">char</span> ⋆make_opts, <span id="textcolor3828">const</span> <span id="textcolor3829">char</span> ⋆install_opts);<br class="fancyvrb"><a id="x32-161063r31"></a>31  <br class="fancyvrb"><a id="x32-161065r32"></a>32  <span id="textcolor3830">#</span><span id="textcolor3831">endif</span></div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 660--><p class="indent">    commands.h 里边没有什么新东西。你可以看到里边定义了一些各处都会用到的字符串，真正有意思的是接下来的 commands.c。
                                                                  

                                                                  
<!--l. 663--></p><p class="indent">    <a id="x32-161066r75"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 75: </span><span class="content">                                                                                                  commands.c</span></div><!--tex4ht:label?: x32-161066r75 -->
<div class="fancyvrb" id="fancyvrb43"><a id="x32-161068r1"></a>1  <span id="textcolor3832">#</span><span id="textcolor3833">include <apr_uri.h></apr_uri.h></span><br class="fancyvrb"><a id="x32-161070r2"></a>2  <span id="textcolor3834">#</span><span id="textcolor3835">include <apr_fnmatch.h></apr_fnmatch.h></span><br class="fancyvrb"><a id="x32-161072r3"></a>3  <span id="textcolor3836">#</span><span id="textcolor3837">include <unistd.h></unistd.h></span><br class="fancyvrb"><a id="x32-161074r4"></a>4  
<br class="fancyvrb"><a id="x32-161076r5"></a>5  <span id="textcolor3838">#</span><span id="textcolor3839">include "commands.h"</span><br class="fancyvrb"><a id="x32-161078r6"></a>6  <span id="textcolor3840">#</span><span id="textcolor3841">include "dbg.h"</span><br class="fancyvrb"><a id="x32-161080r7"></a>7  <span id="textcolor3842">#</span><span id="textcolor3843">include "bstrlib.h"</span><br class="fancyvrb"><a id="x32-161082r8"></a>8  <span id="textcolor3844">#</span><span id="textcolor3845">include "db.h"</span>
<br class="fancyvrb"><a id="x32-161084r9"></a>9  <span id="textcolor3846">#</span><span id="textcolor3847">include "shell.h"</span><br class="fancyvrb"><a id="x32-161086r10"></a>10  <br class="fancyvrb"><a id="x32-161088r11"></a>11  <br class="fancyvrb"><a id="x32-161090r12"></a>12  <span id="textcolor3848">int</span> <span id="textcolor3849">Command_depends</span>(apr_pool_t ⋆p, <span id="textcolor3850">const</span> <span id="textcolor3851">char</span> ⋆path)
<br class="fancyvrb"><a id="x32-161092r13"></a>13  {<br class="fancyvrb"><a id="x32-161094r14"></a>14      <span id="textcolor3852">FILE</span> ⋆in = <span id="textcolor3853">NULL</span>;<br class="fancyvrb"><a id="x32-161096r15"></a>15      bstring line = <span id="textcolor3854">NULL</span>;<br class="fancyvrb"><a id="x32-161098r16"></a>16  <br class="fancyvrb"><a id="x32-161100r17"></a>17      in = fopen(path, <span class="colorbox" id="colorbox3855"><span id="textcolor3856">"</span></span><span class="colorbox" id="colorbox3857"><span id="textcolor3858">r</span></span><span class="colorbox" id="colorbox3859"><span id="textcolor3860">"</span></span>);
<br class="fancyvrb"><a id="x32-161102r18"></a>18      check(in != <span id="textcolor3861">NULL</span>, <span class="colorbox" id="colorbox3862"><span id="textcolor3863">"</span></span><span class="colorbox" id="colorbox3864"><span id="textcolor3865">Failed to open downloaded depends: %s</span></span><span class="colorbox" id="colorbox3866"><span id="textcolor3867">"</span></span>, path);
<br class="fancyvrb"><a id="x32-161104r19"></a>19  <br class="fancyvrb"><a id="x32-161106r20"></a>20      <span id="textcolor3868">for</span>(line = bgets((bNgetc)fgetc, in, <span class="colorbox" id="colorbox3869"><span id="textcolor3870">’\n’</span></span>); line != <span id="textcolor3871">NULL</span>;
<br class="fancyvrb"><a id="x32-161108r21"></a>21              line = bgets((bNgetc)fgetc, in, <span class="colorbox" id="colorbox3872"><span id="textcolor3873">’\n’</span></span>))<br class="fancyvrb"><a id="x32-161110r22"></a>22      {
<br class="fancyvrb"><a id="x32-161112r23"></a>23          btrimws(line);<br class="fancyvrb"><a id="x32-161114r24"></a>24          log_info(<span class="colorbox" id="colorbox3874"><span id="textcolor3875">"</span></span><span class="colorbox" id="colorbox3876"><span id="textcolor3877">Processing depends: %s</span></span><span class="colorbox" id="colorbox3878"><span id="textcolor3879">"</span></span>, bdata(line));
<br class="fancyvrb"><a id="x32-161116r25"></a>25          <span id="textcolor3880">int</span> rc = Command_install(p, bdata(line), <span id="textcolor3881">NULL</span>, <span id="textcolor3882">NULL</span>, <span id="textcolor3883">NULL</span>);
<br class="fancyvrb"><a id="x32-161118r26"></a>26          check(rc == <span id="textcolor3884">0</span>, <span class="colorbox" id="colorbox3885"><span id="textcolor3886">"</span></span><span class="colorbox" id="colorbox3887"><span id="textcolor3888">Failed to install: %s</span></span><span class="colorbox" id="colorbox3889"><span id="textcolor3890">"</span></span>, bdata(line));
<br class="fancyvrb"><a id="x32-161120r27"></a>27          bdestroy(line);<br class="fancyvrb"><a id="x32-161122r28"></a>28      }<br class="fancyvrb"><a id="x32-161124r29"></a>29  <br class="fancyvrb"><a id="x32-161126r30"></a>30      fclose(in);<br class="fancyvrb"><a id="x32-161128r31"></a>31      <span id="textcolor3891">return</span> <span id="textcolor3892">0</span>;<br class="fancyvrb"><a id="x32-161130r32"></a>32  <br class="fancyvrb"><a id="x32-161132r33"></a>33  <span id="textcolor3893">error:</span>
<br class="fancyvrb"><a id="x32-161134r34"></a>34      <span id="textcolor3894">if</span>(line) bdestroy(line);<br class="fancyvrb"><a id="x32-161136r35"></a>35      <span id="textcolor3895">if</span>(in) fclose(in);<br class="fancyvrb"><a id="x32-161138r36"></a>36      <span id="textcolor3896">return</span> -<span id="textcolor3897">1</span>;<br class="fancyvrb"><a id="x32-161140r37"></a>37  }
<br class="fancyvrb"><a id="x32-161142r38"></a>38  <br class="fancyvrb"><a id="x32-161144r39"></a>39  <span id="textcolor3898">int</span> <span id="textcolor3899">Command_fetch</span>(apr_pool_t ⋆p, <span id="textcolor3900">const</span> <span id="textcolor3901">char</span> ⋆url, <span id="textcolor3902">int</span> fetch_only)<br class="fancyvrb"><a id="x32-161146r40"></a>40  {
<br class="fancyvrb"><a id="x32-161148r41"></a>41      apr_uri_t info = {.port = <span id="textcolor3903">0</span>};<br class="fancyvrb"><a id="x32-161150r42"></a>42      <span id="textcolor3904">int</span> rc = <span id="textcolor3905">0</span>;<br class="fancyvrb"><a id="x32-161152r43"></a>43      <span id="textcolor3906">const</span> <span id="textcolor3907">char</span> ⋆depends_file = <span id="textcolor3908">NULL</span>;
<br class="fancyvrb"><a id="x32-161154r44"></a>44      apr_status_t rv = apr_uri_parse(p, url, &amp;info);<br class="fancyvrb"><a id="x32-161156r45"></a>45  
<br class="fancyvrb"><a id="x32-161158r46"></a>46      check(rv == APR_SUCCESS, <span class="colorbox" id="colorbox3909"><span id="textcolor3910">"</span></span><span class="colorbox" id="colorbox3911"><span id="textcolor3912">Failed to parse URL: %s</span></span><span class="colorbox" id="colorbox3913"><span id="textcolor3914">"</span></span>, url);<br class="fancyvrb"><a id="x32-161160r47"></a>47  
<br class="fancyvrb"><a id="x32-161162r48"></a>48      <span id="textcolor3915">if</span>(apr_fnmatch(GIT_PAT, info.path, <span id="textcolor3916">0</span>) == APR_SUCCESS) {
<br class="fancyvrb"><a id="x32-161164r49"></a>49          rc = Shell_exec(GIT_SH, <span class="colorbox" id="colorbox3917"><span id="textcolor3918">"</span></span><span class="colorbox" id="colorbox3919"><span id="textcolor3920">URL</span></span><span class="colorbox" id="colorbox3921"><span id="textcolor3922">"</span></span>, url, <span id="textcolor3923">NULL</span>);
<br class="fancyvrb"><a id="x32-161166r50"></a>50          check(rc == <span id="textcolor3924">0</span>, <span class="colorbox" id="colorbox3925"><span id="textcolor3926">"</span></span><span class="colorbox" id="colorbox3927"><span id="textcolor3928">git failed.</span></span><span class="colorbox" id="colorbox3929"><span id="textcolor3930">"</span></span>);
<br class="fancyvrb"><a id="x32-161168r51"></a>51      } <span id="textcolor3931">else</span> <span id="textcolor3932">if</span>(apr_fnmatch(DEPEND_PAT, info.path, <span id="textcolor3933">0</span>) == APR_SUCCESS) {
<br class="fancyvrb"><a id="x32-161170r52"></a>52          check(!fetch_only, <span class="colorbox" id="colorbox3934"><span id="textcolor3935">"</span></span><span class="colorbox" id="colorbox3936"><span id="textcolor3937">No point in fetching a DEPENDS file.</span></span><span class="colorbox" id="colorbox3938"><span id="textcolor3939">"</span></span>);<br class="fancyvrb"><a id="x32-161172r53"></a>53  
<br class="fancyvrb"><a id="x32-161174r54"></a>54          <span id="textcolor3940">if</span>(info.scheme) {<br class="fancyvrb"><a id="x32-161176r55"></a>55              depends_file = DEPENDS_PATH;
<br class="fancyvrb"><a id="x32-161178r56"></a>56              rc = Shell_exec(CURL_SH, <span class="colorbox" id="colorbox3941"><span id="textcolor3942">"</span></span><span class="colorbox" id="colorbox3943"><span id="textcolor3944">URL</span></span><span class="colorbox" id="colorbox3945"><span id="textcolor3946">"</span></span>, url, <span class="colorbox" id="colorbox3947"><span id="textcolor3948">"</span></span><span class="colorbox" id="colorbox3949"><span id="textcolor3950">TARGET</span></span><span class="colorbox" id="colorbox3951"><span id="textcolor3952">"</span></span>, depends_file, <span id="textcolor3953">NULL</span>);
<br class="fancyvrb"><a id="x32-161180r57"></a>57              check(rc == <span id="textcolor3954">0</span>, <span class="colorbox" id="colorbox3955"><span id="textcolor3956">"</span></span><span class="colorbox" id="colorbox3957"><span id="textcolor3958">Curl failed.</span></span><span class="colorbox" id="colorbox3959"><span id="textcolor3960">"</span></span>);<br class="fancyvrb"><a id="x32-161182r58"></a>58          } <span id="textcolor3961">else</span> {
<br class="fancyvrb"><a id="x32-161184r59"></a>59              depends_file = info.path;<br class="fancyvrb"><a id="x32-161186r60"></a>60          }
<br class="fancyvrb"><a id="x32-161188r61"></a>61  <br class="fancyvrb"><a id="x32-161190r62"></a>62          <span id="textcolor3962">// recursively process the devpkg list</span>
<br class="fancyvrb"><a id="x32-161192r63"></a>63          log_info(<span class="colorbox" id="colorbox3963"><span id="textcolor3964">"</span></span><span class="colorbox" id="colorbox3965"><span id="textcolor3966">Building according to DEPENDS: %s</span></span><span class="colorbox" id="colorbox3967"><span id="textcolor3968">"</span></span>, url);
<br class="fancyvrb"><a id="x32-161194r64"></a>64          rv = Command_depends(p, depends_file);
<br class="fancyvrb"><a id="x32-161196r65"></a>65          check(rv == <span id="textcolor3969">0</span>, <span class="colorbox" id="colorbox3970"><span id="textcolor3971">"</span></span><span class="colorbox" id="colorbox3972"><span id="textcolor3973">Failed to process the DEPENDS: %s</span></span><span class="colorbox" id="colorbox3974"><span id="textcolor3975">"</span></span>, url);<br class="fancyvrb"><a id="x32-161198r66"></a>66  
<br class="fancyvrb"><a id="x32-161200r67"></a>67          <span id="textcolor3976">// this indicates that nothing needs to be done</span><br class="fancyvrb"><a id="x32-161202r68"></a>68          <span id="textcolor3977">return</span> <span id="textcolor3978">0</span>;
<br class="fancyvrb"><a id="x32-161204r69"></a>69  <br class="fancyvrb"><a id="x32-161206r70"></a>70      } <span id="textcolor3979">else</span> <span id="textcolor3980">if</span>(apr_fnmatch(TAR_GZ_PAT, info.path, <span id="textcolor3981">0</span>) == APR_SUCCESS) {
<br class="fancyvrb"><a id="x32-161208r71"></a>71          <span id="textcolor3982">if</span>(info.scheme) {<br class="fancyvrb"><a id="x32-161210r72"></a>72              rc = Shell_exec(CURL_SH,
<br class="fancyvrb"><a id="x32-161212r73"></a>73                      <span class="colorbox" id="colorbox3983"><span id="textcolor3984">"</span></span><span class="colorbox" id="colorbox3985"><span id="textcolor3986">URL</span></span><span class="colorbox" id="colorbox3987"><span id="textcolor3988">"</span></span>, url,<br class="fancyvrb"><a id="x32-161214r74"></a>74                      <span class="colorbox" id="colorbox3989"><span id="textcolor3990">"</span></span><span class="colorbox" id="colorbox3991"><span id="textcolor3992">TARGET</span></span><span class="colorbox" id="colorbox3993"><span id="textcolor3994">"</span></span>, TAR_GZ_SRC, <span id="textcolor3995">NULL</span>);
<br class="fancyvrb"><a id="x32-161216r75"></a>75              check(rc == <span id="textcolor3996">0</span>, <span class="colorbox" id="colorbox3997"><span id="textcolor3998">"</span></span><span class="colorbox" id="colorbox3999"><span id="textcolor4000">Failed to curl source: %s</span></span><span class="colorbox" id="colorbox4001"><span id="textcolor4002">"</span></span>, url);
<br class="fancyvrb"><a id="x32-161218r76"></a>76          }<br class="fancyvrb"><a id="x32-161220r77"></a>77  <br class="fancyvrb"><a id="x32-161222r78"></a>78          rv = apr_dir_make_recursive(BUILD_DIR,
<br class="fancyvrb"><a id="x32-161224r79"></a>79                  APR_UREAD | APR_UWRITE | APR_UEXECUTE, p);
                                                                  

                                                                  
<br class="fancyvrb"><a id="x32-161226r80"></a>80          check(rv == APR_SUCCESS, <span class="colorbox" id="colorbox4003"><span id="textcolor4004">"</span></span><span class="colorbox" id="colorbox4005"><span id="textcolor4006">Failed to make directory %s</span></span><span class="colorbox" id="colorbox4007"><span id="textcolor4008">"</span></span>, BUILD_DIR);
<br class="fancyvrb"><a id="x32-161228r81"></a>81  <br class="fancyvrb"><a id="x32-161230r82"></a>82          rc = Shell_exec(TAR_SH, <span class="colorbox" id="colorbox4009"><span id="textcolor4010">"</span></span><span class="colorbox" id="colorbox4011"><span id="textcolor4012">FILE</span></span><span class="colorbox" id="colorbox4013"><span id="textcolor4014">"</span></span>, TAR_GZ_SRC, <span id="textcolor4015">NULL</span>);
<br class="fancyvrb"><a id="x32-161232r83"></a>83          check(rc == <span id="textcolor4016">0</span>, <span class="colorbox" id="colorbox4017"><span id="textcolor4018">"</span></span><span class="colorbox" id="colorbox4019"><span id="textcolor4020">Failed to untar %s</span></span><span class="colorbox" id="colorbox4021"><span id="textcolor4022">"</span></span>, TAR_GZ_SRC);
<br class="fancyvrb"><a id="x32-161234r84"></a>84      } <span id="textcolor4023">else</span> <span id="textcolor4024">if</span>(apr_fnmatch(TAR_BZ2_PAT, info.path, <span id="textcolor4025">0</span>) == APR_SUCCESS) {
<br class="fancyvrb"><a id="x32-161236r85"></a>85          <span id="textcolor4026">if</span>(info.scheme) {
<br class="fancyvrb"><a id="x32-161238r86"></a>86              rc = Shell_exec(CURL_SH, <span class="colorbox" id="colorbox4027"><span id="textcolor4028">"</span></span><span class="colorbox" id="colorbox4029"><span id="textcolor4030">URL</span></span><span class="colorbox" id="colorbox4031"><span id="textcolor4032">"</span></span>, url, <span class="colorbox" id="colorbox4033"><span id="textcolor4034">"</span></span><span class="colorbox" id="colorbox4035"><span id="textcolor4036">TARGET</span></span><span class="colorbox" id="colorbox4037"><span id="textcolor4038">"</span></span>, TAR_BZ2_SRC, <span id="textcolor4039">NULL</span>);
<br class="fancyvrb"><a id="x32-161240r87"></a>87              check(rc == <span id="textcolor4040">0</span>, <span class="colorbox" id="colorbox4041"><span id="textcolor4042">"</span></span><span class="colorbox" id="colorbox4043"><span id="textcolor4044">Curl failed.</span></span><span class="colorbox" id="colorbox4045"><span id="textcolor4046">"</span></span>);<br class="fancyvrb"><a id="x32-161242r88"></a>88          }<br class="fancyvrb"><a id="x32-161244r89"></a>89  
<br class="fancyvrb"><a id="x32-161246r90"></a>90          apr_status_t rc = apr_dir_make_recursive(BUILD_DIR,
<br class="fancyvrb"><a id="x32-161248r91"></a>91                  APR_UREAD | APR_UWRITE | APR_UEXECUTE, p);<br class="fancyvrb"><a id="x32-161250r92"></a>92  
<br class="fancyvrb"><a id="x32-161252r93"></a>93          check(rc == <span id="textcolor4047">0</span>, <span class="colorbox" id="colorbox4048"><span id="textcolor4049">"</span></span><span class="colorbox" id="colorbox4050"><span id="textcolor4051">Failed to make directory %s</span></span><span class="colorbox" id="colorbox4052"><span id="textcolor4053">"</span></span>, BUILD_DIR);
<br class="fancyvrb"><a id="x32-161254r94"></a>94          rc = Shell_exec(TAR_SH, <span class="colorbox" id="colorbox4054"><span id="textcolor4055">"</span></span><span class="colorbox" id="colorbox4056"><span id="textcolor4057">FILE</span></span><span class="colorbox" id="colorbox4058"><span id="textcolor4059">"</span></span>, TAR_BZ2_SRC, <span id="textcolor4060">NULL</span>);
<br class="fancyvrb"><a id="x32-161256r95"></a>95          check(rc == <span id="textcolor4061">0</span>, <span class="colorbox" id="colorbox4062"><span id="textcolor4063">"</span></span><span class="colorbox" id="colorbox4064"><span id="textcolor4065">Failed to untar %s</span></span><span class="colorbox" id="colorbox4066"><span id="textcolor4067">"</span></span>, TAR_BZ2_SRC);
<br class="fancyvrb"><a id="x32-161258r96"></a>96      } <span id="textcolor4068">else</span> {<br class="fancyvrb"><a id="x32-161260r97"></a>97          sentinel(<span class="colorbox" id="colorbox4069"><span id="textcolor4070">"</span></span><span class="colorbox" id="colorbox4071"><span id="textcolor4072">Don’t now how to handle %s</span></span><span class="colorbox" id="colorbox4073"><span id="textcolor4074">"</span></span>, url);
<br class="fancyvrb"><a id="x32-161262r98"></a>98      }<br class="fancyvrb"><a id="x32-161264r99"></a>99  <br class="fancyvrb"><a id="x32-161266r100"></a>100      <span id="textcolor4075">// indicates that an install needs to actually run</span>
<br class="fancyvrb"><a id="x32-161268r101"></a>101      <span id="textcolor4076">return</span> <span id="textcolor4077">1</span>;<br class="fancyvrb"><a id="x32-161270r102"></a>102  <span id="textcolor4078">error:</span><br class="fancyvrb"><a id="x32-161272r103"></a>103      <span id="textcolor4079">return</span> -<span id="textcolor4080">1</span>;<br class="fancyvrb"><a id="x32-161274r104"></a>104  }<br class="fancyvrb"><a id="x32-161276r105"></a>105  
<br class="fancyvrb"><a id="x32-161278r106"></a>106  <span id="textcolor4081">int</span> <span id="textcolor4082">Command_build</span>(apr_pool_t ⋆p, <span id="textcolor4083">const</span> <span id="textcolor4084">char</span> ⋆url, <span id="textcolor4085">const</span> <span id="textcolor4086">char</span> ⋆configure_opts,
<br class="fancyvrb"><a id="x32-161280r107"></a>107          <span id="textcolor4087">const</span> <span id="textcolor4088">char</span> ⋆make_opts, <span id="textcolor4089">const</span> <span id="textcolor4090">char</span> ⋆install_opts)<br class="fancyvrb"><a id="x32-161282r108"></a>108  {
<br class="fancyvrb"><a id="x32-161284r109"></a>109      <span id="textcolor4091">int</span> rc = <span id="textcolor4092">0</span>;<br class="fancyvrb"><a id="x32-161286r110"></a>110  <br class="fancyvrb"><a id="x32-161288r111"></a>111      check(access(BUILD_DIR, X_OK | R_OK | W_OK) == <span id="textcolor4093">0</span>,
<br class="fancyvrb"><a id="x32-161290r112"></a>112              <span class="colorbox" id="colorbox4094"><span id="textcolor4095">"</span></span><span class="colorbox" id="colorbox4096"><span id="textcolor4097">Build directory doesn’t exist: %s</span></span><span class="colorbox" id="colorbox4098"><span id="textcolor4099">"</span></span>, BUILD_DIR);<br class="fancyvrb"><a id="x32-161292r113"></a>113  
<br class="fancyvrb"><a id="x32-161294r114"></a>114      <span id="textcolor4100">// actually do an install</span><br class="fancyvrb"><a id="x32-161296r115"></a>115      <span id="textcolor4101">if</span>(access(CONFIG_SCRIPT, X_OK) == <span id="textcolor4102">0</span>) {
<br class="fancyvrb"><a id="x32-161298r116"></a>116          log_info(<span class="colorbox" id="colorbox4103"><span id="textcolor4104">"</span></span><span class="colorbox" id="colorbox4105"><span id="textcolor4106">Has a configure script, running it.</span></span><span class="colorbox" id="colorbox4107"><span id="textcolor4108">"</span></span>);
<br class="fancyvrb"><a id="x32-161300r117"></a>117          rc = Shell_exec(CONFIGURE_SH, <span class="colorbox" id="colorbox4109"><span id="textcolor4110">"</span></span><span class="colorbox" id="colorbox4111"><span id="textcolor4112">OPTS</span></span><span class="colorbox" id="colorbox4113"><span id="textcolor4114">"</span></span>, configure_opts, <span id="textcolor4115">NULL</span>);
<br class="fancyvrb"><a id="x32-161302r118"></a>118          check(rc == <span id="textcolor4116">0</span>, <span class="colorbox" id="colorbox4117"><span id="textcolor4118">"</span></span><span class="colorbox" id="colorbox4119"><span id="textcolor4120">Failed to configure.</span></span><span class="colorbox" id="colorbox4121"><span id="textcolor4122">"</span></span>);<br class="fancyvrb"><a id="x32-161304r119"></a>119      }<br class="fancyvrb"><a id="x32-161306r120"></a>120  
<br class="fancyvrb"><a id="x32-161308r121"></a>121      rc = Shell_exec(MAKE_SH, <span class="colorbox" id="colorbox4123"><span id="textcolor4124">"</span></span><span class="colorbox" id="colorbox4125"><span id="textcolor4126">OPTS</span></span><span class="colorbox" id="colorbox4127"><span id="textcolor4128">"</span></span>, make_opts, <span id="textcolor4129">NULL</span>);
<br class="fancyvrb"><a id="x32-161310r122"></a>122      check(rc == <span id="textcolor4130">0</span>, <span class="colorbox" id="colorbox4131"><span id="textcolor4132">"</span></span><span class="colorbox" id="colorbox4133"><span id="textcolor4134">Failed to build.</span></span><span class="colorbox" id="colorbox4135"><span id="textcolor4136">"</span></span>);<br class="fancyvrb"><a id="x32-161312r123"></a>123  <br class="fancyvrb"><a id="x32-161314r124"></a>124      rc = Shell_exec(INSTALL_SH,
<br class="fancyvrb"><a id="x32-161316r125"></a>125              <span class="colorbox" id="colorbox4137"><span id="textcolor4138">"</span></span><span class="colorbox" id="colorbox4139"><span id="textcolor4140">TARGET</span></span><span class="colorbox" id="colorbox4141"><span id="textcolor4142">"</span></span>, install_opts ? install_opts : <span class="colorbox" id="colorbox4143"><span id="textcolor4144">"</span></span><span class="colorbox" id="colorbox4145"><span id="textcolor4146">install</span></span><span class="colorbox" id="colorbox4147"><span id="textcolor4148">"</span></span>,<br class="fancyvrb"><a id="x32-161318r126"></a>126              <span id="textcolor4149">NULL</span>);
<br class="fancyvrb"><a id="x32-161320r127"></a>127      check(rc == <span id="textcolor4150">0</span>, <span class="colorbox" id="colorbox4151"><span id="textcolor4152">"</span></span><span class="colorbox" id="colorbox4153"><span id="textcolor4154">Failed to install.</span></span><span class="colorbox" id="colorbox4155"><span id="textcolor4156">"</span></span>);<br class="fancyvrb"><a id="x32-161322r128"></a>128  <br class="fancyvrb"><a id="x32-161324r129"></a>129      rc = Shell_exec(CLEANUP_SH, <span id="textcolor4157">NULL</span>);
<br class="fancyvrb"><a id="x32-161326r130"></a>130      check(rc == <span id="textcolor4158">0</span>, <span class="colorbox" id="colorbox4159"><span id="textcolor4160">"</span></span><span class="colorbox" id="colorbox4161"><span id="textcolor4162">Failed to cleanup after build.</span></span><span class="colorbox" id="colorbox4163"><span id="textcolor4164">"</span></span>);<br class="fancyvrb"><a id="x32-161328r131"></a>131  <br class="fancyvrb"><a id="x32-161330r132"></a>132      rc = DB_update(url);
<br class="fancyvrb"><a id="x32-161332r133"></a>133      check(rc == <span id="textcolor4165">0</span>, <span class="colorbox" id="colorbox4166"><span id="textcolor4167">"</span></span><span class="colorbox" id="colorbox4168"><span id="textcolor4169">Failed to add this package to the database.</span></span><span class="colorbox" id="colorbox4170"><span id="textcolor4171">"</span></span>);
<br class="fancyvrb"><a id="x32-161334r134"></a>134  <br class="fancyvrb"><a id="x32-161336r135"></a>135      <span id="textcolor4172">return</span> <span id="textcolor4173">0</span>;<br class="fancyvrb"><a id="x32-161338r136"></a>136  <br class="fancyvrb"><a id="x32-161340r137"></a>137  <span id="textcolor4174">error:</span><br class="fancyvrb"><a id="x32-161342r138"></a>138      <span id="textcolor4175">return</span> -<span id="textcolor4176">1</span>;<br class="fancyvrb"><a id="x32-161344r139"></a>139  }<br class="fancyvrb"><a id="x32-161346r140"></a>140  
<br class="fancyvrb"><a id="x32-161348r141"></a>141  <span id="textcolor4177">int</span> <span id="textcolor4178">Command_install</span>(apr_pool_t ⋆p, <span id="textcolor4179">const</span> <span id="textcolor4180">char</span> ⋆url, <span id="textcolor4181">const</span> <span id="textcolor4182">char</span> ⋆configure_opts,
<br class="fancyvrb"><a id="x32-161350r142"></a>142          <span id="textcolor4183">const</span> <span id="textcolor4184">char</span> ⋆make_opts, <span id="textcolor4185">const</span> <span id="textcolor4186">char</span> ⋆install_opts)<br class="fancyvrb"><a id="x32-161352r143"></a>143  {<br class="fancyvrb"><a id="x32-161354r144"></a>144      <span id="textcolor4187">int</span> rc = <span id="textcolor4188">0</span>;
<br class="fancyvrb"><a id="x32-161356r145"></a>145      check(Shell_exec(CLEANUP_SH, <span id="textcolor4189">NULL</span>) == <span id="textcolor4190">0</span>, <span class="colorbox" id="colorbox4191"><span id="textcolor4192">"</span></span><span class="colorbox" id="colorbox4193"><span id="textcolor4194">Failed to cleanup before building.</span></span><span class="colorbox" id="colorbox4195"><span id="textcolor4196">"</span></span>);<br class="fancyvrb"><a id="x32-161358r146"></a>146  
<br class="fancyvrb"><a id="x32-161360r147"></a>147      rc = DB_find(url);<br class="fancyvrb"><a id="x32-161362r148"></a>148      check(rc != -<span id="textcolor4197">1</span>, <span class="colorbox" id="colorbox4198"><span id="textcolor4199">"</span></span><span class="colorbox" id="colorbox4200"><span id="textcolor4201">Error checking the install database.</span></span><span class="colorbox" id="colorbox4202"><span id="textcolor4203">"</span></span>);
<br class="fancyvrb"><a id="x32-161364r149"></a>149  <br class="fancyvrb"><a id="x32-161366r150"></a>150      <span id="textcolor4204">if</span>(rc == <span id="textcolor4205">1</span>) {<br class="fancyvrb"><a id="x32-161368r151"></a>151          log_info(<span class="colorbox" id="colorbox4206"><span id="textcolor4207">"</span></span><span class="colorbox" id="colorbox4208"><span id="textcolor4209">Package %s already installed.</span></span><span class="colorbox" id="colorbox4210"><span id="textcolor4211">"</span></span>, url);
<br class="fancyvrb"><a id="x32-161370r152"></a>152          <span id="textcolor4212">return</span> <span id="textcolor4213">0</span>;<br class="fancyvrb"><a id="x32-161372r153"></a>153      }<br class="fancyvrb"><a id="x32-161374r154"></a>154  <br class="fancyvrb"><a id="x32-161376r155"></a>155      rc = Command_fetch(p, url, <span id="textcolor4214">0</span>);<br class="fancyvrb"><a id="x32-161378r156"></a>156  <br class="fancyvrb"><a id="x32-161380r157"></a>157      <span id="textcolor4215">if</span>(rc == <span id="textcolor4216">1</span>) {
<br class="fancyvrb"><a id="x32-161382r158"></a>158          rc = Command_build(p, url, configure_opts, make_opts, install_opts);
<br class="fancyvrb"><a id="x32-161384r159"></a>159          check(rc == <span id="textcolor4217">0</span>, <span class="colorbox" id="colorbox4218"><span id="textcolor4219">"</span></span><span class="colorbox" id="colorbox4220"><span id="textcolor4221">Failed to build: %s</span></span><span class="colorbox" id="colorbox4222"><span id="textcolor4223">"</span></span>, url);
                                                                  

                                                                  
<br class="fancyvrb"><a id="x32-161386r160"></a>160      } <span id="textcolor4224">else</span> <span id="textcolor4225">if</span>(rc == <span id="textcolor4226">0</span>) {<br class="fancyvrb"><a id="x32-161388r161"></a>161          <span id="textcolor4227">// no install needed</span>
<br class="fancyvrb"><a id="x32-161390r162"></a>162          log_info(<span class="colorbox" id="colorbox4228"><span id="textcolor4229">"</span></span><span class="colorbox" id="colorbox4230"><span id="textcolor4231">Depends successfully installed: %s</span></span><span class="colorbox" id="colorbox4232"><span id="textcolor4233">"</span></span>, url);<br class="fancyvrb"><a id="x32-161392r163"></a>163      } <span id="textcolor4234">else</span> {
<br class="fancyvrb"><a id="x32-161394r164"></a>164          <span id="textcolor4235">// had an error</span><br class="fancyvrb"><a id="x32-161396r165"></a>165          sentinel(<span class="colorbox" id="colorbox4236"><span id="textcolor4237">"</span></span><span class="colorbox" id="colorbox4238"><span id="textcolor4239">Install failed: %s</span></span><span class="colorbox" id="colorbox4240"><span id="textcolor4241">"</span></span>, url);
<br class="fancyvrb"><a id="x32-161398r166"></a>166      }<br class="fancyvrb"><a id="x32-161400r167"></a>167  <br class="fancyvrb"><a id="x32-161402r168"></a>168      Shell_exec(CLEANUP_SH, <span id="textcolor4242">NULL</span>);<br class="fancyvrb"><a id="x32-161404r169"></a>169      <span id="textcolor4243">return</span> <span id="textcolor4244">0</span>;<br class="fancyvrb"><a id="x32-161406r170"></a>170  <br class="fancyvrb"><a id="x32-161408r171"></a>171  <span id="textcolor4245">error:</span>
<br class="fancyvrb"><a id="x32-161410r172"></a>172      Shell_exec(CLEANUP_SH, <span id="textcolor4246">NULL</span>);<br class="fancyvrb"><a id="x32-161412r173"></a>173      <span id="textcolor4247">return</span> -<span id="textcolor4248">1</span>;<br class="fancyvrb"><a id="x32-161414r174"></a>174  }</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 843--><p class="indent">    输入完成并编译成功以后，你就可以对它进行分析了。如果你完成了前面的挑战，
那你应该看出 shell.c 中的函数是如何被用以运行 shell，以及参数是如何被替换的。
如果你看不明白，那你需要回到前面，知道真正弄懂 Shell_exec 的工作原理为止。
    </p><h5 class="subsubsectionHead"><a id="x32-16200027.4.3"></a>挑战3: 评判我的设计</h5>
<!--l. 850--><p class="noindent">和之前一样，做一次完整的代码审核，确认你写的和书里的完全一致。然后详细阅读每一个函数，弄明白它们的功能。试着去追踪每一个函数是怎样去调用你写在当前文件或者其它代码文件中的函数的。最后，确认你弄懂了你从 APR 调用的所有的函数。
<!--l. 854--></p><p class="indent">    确认文件内容正确，而且分析完成以后，回头重新审查一遍。这一次你就把我当成一个白痴，你可以批评我的设计方案，并且提出能够改善的地方。不要真去修改代码，创建一个 notes.txt 并写下你觉得可以改进的东西即可。
<!--l. 859--></p><p class="noindent">
    </p><h4 class="subsectionHead"><span class="titlemark">27.4.4    </span> <a id="x32-16300027.4.4"></a>devpkg的主函数</h4>
<!--l. 861--><p class="noindent">最后也是最重要的代码文件是 devpkg.c，不过这可能也是最简单的代码文件了。它就是 main 函数所在的地方。这里我们不需要.h 文件，因为它已经包含了所有的头文件。当它和 Makefile 中包含的.o 文件搭配编译的时候，我们就会编译出可执行文件 devpkg。输入该文件的代码并确认没有写错。
                                                                  

                                                                  
<!--l. 867--></p><p class="indent">    <a id="x32-163001r76"></a></p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<div class="caption"><span class="id">Source 76: </span><span class="content">                                                                                                        devpkg.c</span></div><!--tex4ht:label?: x32-163001r76 -->
<div class="fancyvrb" id="fancyvrb44"><a id="x32-163003r1"></a>1  <span id="textcolor4249">#</span><span id="textcolor4250">include <stdio.h></stdio.h></span><br class="fancyvrb"><a id="x32-163005r2"></a>2  <span id="textcolor4251">#</span><span id="textcolor4252">include <apr_general.h></apr_general.h></span><br class="fancyvrb"><a id="x32-163007r3"></a>3  <span id="textcolor4253">#</span><span id="textcolor4254">include <apr_getopt.h></apr_getopt.h></span>
<br class="fancyvrb"><a id="x32-163009r4"></a>4  <span id="textcolor4255">#</span><span id="textcolor4256">include <apr_strings.h></apr_strings.h></span><br class="fancyvrb"><a id="x32-163011r5"></a>5  <span id="textcolor4257">#</span><span id="textcolor4258">include <apr_lib.h></apr_lib.h></span><br class="fancyvrb"><a id="x32-163013r6"></a>6  <br class="fancyvrb"><a id="x32-163015r7"></a>7  <span id="textcolor4259">#</span><span id="textcolor4260">include "dbg.h"</span><br class="fancyvrb"><a id="x32-163017r8"></a>8  <span id="textcolor4261">#</span><span id="textcolor4262">include "db.h"</span>
<br class="fancyvrb"><a id="x32-163019r9"></a>9  <span id="textcolor4263">#</span><span id="textcolor4264">include "commands.h"</span><br class="fancyvrb"><a id="x32-163021r10"></a>10  <br class="fancyvrb"><a id="x32-163023r11"></a>11  <span id="textcolor4265">int</span> <span id="textcolor4266">main</span>(<span id="textcolor4267">int</span> argc, <span id="textcolor4268">const</span> <span id="textcolor4269">char</span> <span id="textcolor4270">const</span> ⋆argv[])<br class="fancyvrb"><a id="x32-163025r12"></a>12  {
<br class="fancyvrb"><a id="x32-163027r13"></a>13      apr_pool_t ⋆p = <span id="textcolor4271">NULL</span>;<br class="fancyvrb"><a id="x32-163029r14"></a>14      apr_pool_initialize();<br class="fancyvrb"><a id="x32-163031r15"></a>15      apr_pool_create(&amp;p, <span id="textcolor4272">NULL</span>);
<br class="fancyvrb"><a id="x32-163033r16"></a>16  <br class="fancyvrb"><a id="x32-163035r17"></a>17      apr_getopt_t ⋆opt;<br class="fancyvrb"><a id="x32-163037r18"></a>18      apr_status_t rv;<br class="fancyvrb"><a id="x32-163039r19"></a>19  <br class="fancyvrb"><a id="x32-163041r20"></a>20      <span id="textcolor4273">char</span> ch = <span class="colorbox" id="colorbox4274"><span id="textcolor4275">’\0’</span></span>;
<br class="fancyvrb"><a id="x32-163043r21"></a>21      <span id="textcolor4276">const</span> <span id="textcolor4277">char</span> ⋆optarg = <span id="textcolor4278">NULL</span>;<br class="fancyvrb"><a id="x32-163045r22"></a>22      <span id="textcolor4279">const</span> <span id="textcolor4280">char</span> ⋆config_opts = <span id="textcolor4281">NULL</span>;
<br class="fancyvrb"><a id="x32-163047r23"></a>23      <span id="textcolor4282">const</span> <span id="textcolor4283">char</span> ⋆install_opts = <span id="textcolor4284">NULL</span>;<br class="fancyvrb"><a id="x32-163049r24"></a>24      <span id="textcolor4285">const</span> <span id="textcolor4286">char</span> ⋆make_opts = <span id="textcolor4287">NULL</span>;
<br class="fancyvrb"><a id="x32-163051r25"></a>25      <span id="textcolor4288">const</span> <span id="textcolor4289">char</span> ⋆url = <span id="textcolor4290">NULL</span>;<br class="fancyvrb"><a id="x32-163053r26"></a>26      <span id="textcolor4291">enum</span> CommandType request = COMMAND_NONE;
<br class="fancyvrb"><a id="x32-163055r27"></a>27  <br class="fancyvrb"><a id="x32-163057r28"></a>28  <br class="fancyvrb"><a id="x32-163059r29"></a>29      rv = apr_getopt_init(&amp;opt, p, argc, argv);<br class="fancyvrb"><a id="x32-163061r30"></a>30  
<br class="fancyvrb"><a id="x32-163063r31"></a>31      <span id="textcolor4292">while</span>(apr_getopt(opt, <span class="colorbox" id="colorbox4293"><span id="textcolor4294">"</span></span><span class="colorbox" id="colorbox4295"><span id="textcolor4296">I:Lc:m:i:d:SF:B:</span></span><span class="colorbox" id="colorbox4297"><span id="textcolor4298">"</span></span>, &amp;ch, &amp;optarg) == APR_SUCCESS) {
<br class="fancyvrb"><a id="x32-163065r32"></a>32          <span id="textcolor4299">switch</span> (ch) {<br class="fancyvrb"><a id="x32-163067r33"></a>33              <span id="textcolor4300">case</span> <span class="colorbox" id="colorbox4301"><span id="textcolor4302">’I’</span></span>:
<br class="fancyvrb"><a id="x32-163069r34"></a>34                  request = COMMAND_INSTALL;<br class="fancyvrb"><a id="x32-163071r35"></a>35                  url = optarg;
<br class="fancyvrb"><a id="x32-163073r36"></a>36                  <span id="textcolor4303">break</span>;<br class="fancyvrb"><a id="x32-163075r37"></a>37  <br class="fancyvrb"><a id="x32-163077r38"></a>38              <span id="textcolor4304">case</span> <span class="colorbox" id="colorbox4305"><span id="textcolor4306">’L’</span></span>:
<br class="fancyvrb"><a id="x32-163079r39"></a>39                  request = COMMAND_LIST;<br class="fancyvrb"><a id="x32-163081r40"></a>40                  <span id="textcolor4307">break</span>;<br class="fancyvrb"><a id="x32-163083r41"></a>41  
<br class="fancyvrb"><a id="x32-163085r42"></a>42              <span id="textcolor4308">case</span> <span class="colorbox" id="colorbox4309"><span id="textcolor4310">’c’</span></span>:<br class="fancyvrb"><a id="x32-163087r43"></a>43                  config_opts = optarg;<br class="fancyvrb"><a id="x32-163089r44"></a>44                  <span id="textcolor4311">break</span>;
<br class="fancyvrb"><a id="x32-163091r45"></a>45  <br class="fancyvrb"><a id="x32-163093r46"></a>46              <span id="textcolor4312">case</span> <span class="colorbox" id="colorbox4313"><span id="textcolor4314">’m’</span></span>:<br class="fancyvrb"><a id="x32-163095r47"></a>47                  make_opts = optarg;<br class="fancyvrb"><a id="x32-163097r48"></a>48                  <span id="textcolor4315">break</span>;
<br class="fancyvrb"><a id="x32-163099r49"></a>49  <br class="fancyvrb"><a id="x32-163101r50"></a>50              <span id="textcolor4316">case</span> <span class="colorbox" id="colorbox4317"><span id="textcolor4318">’i’</span></span>:<br class="fancyvrb"><a id="x32-163103r51"></a>51                  install_opts = optarg;
<br class="fancyvrb"><a id="x32-163105r52"></a>52                  <span id="textcolor4319">break</span>;<br class="fancyvrb"><a id="x32-163107r53"></a>53  <br class="fancyvrb"><a id="x32-163109r54"></a>54              <span id="textcolor4320">case</span> <span class="colorbox" id="colorbox4321"><span id="textcolor4322">’S’</span></span>:
<br class="fancyvrb"><a id="x32-163111r55"></a>55                  request = COMMAND_INIT;<br class="fancyvrb"><a id="x32-163113r56"></a>56                  <span id="textcolor4323">break</span>;<br class="fancyvrb"><a id="x32-163115r57"></a>57  
<br class="fancyvrb"><a id="x32-163117r58"></a>58              <span id="textcolor4324">case</span> <span class="colorbox" id="colorbox4325"><span id="textcolor4326">’F’</span></span>:<br class="fancyvrb"><a id="x32-163119r59"></a>59                  request = COMMAND_FETCH;
<br class="fancyvrb"><a id="x32-163121r60"></a>60                  url = optarg;<br class="fancyvrb"><a id="x32-163123r61"></a>61                  <span id="textcolor4327">break</span>;<br class="fancyvrb"><a id="x32-163125r62"></a>62  <br class="fancyvrb"><a id="x32-163127r63"></a>63              <span id="textcolor4328">case</span> <span class="colorbox" id="colorbox4329"><span id="textcolor4330">’B’</span></span>:
<br class="fancyvrb"><a id="x32-163129r64"></a>64                  request = COMMAND_BUILD;<br class="fancyvrb"><a id="x32-163131r65"></a>65                  url = optarg;
<br class="fancyvrb"><a id="x32-163133r66"></a>66                  <span id="textcolor4331">break</span>;<br class="fancyvrb"><a id="x32-163135r67"></a>67          }<br class="fancyvrb"><a id="x32-163137r68"></a>68      }<br class="fancyvrb"><a id="x32-163139r69"></a>69  <br class="fancyvrb"><a id="x32-163141r70"></a>70      <span id="textcolor4332">switch</span>(request) {
<br class="fancyvrb"><a id="x32-163143r71"></a>71          <span id="textcolor4333">case</span> COMMAND_INSTALL:<br class="fancyvrb"><a id="x32-163145r72"></a>72              check(url, <span class="colorbox" id="colorbox4334"><span id="textcolor4335">"</span></span><span class="colorbox" id="colorbox4336"><span id="textcolor4337">You must at least give a URL.</span></span><span class="colorbox" id="colorbox4338"><span id="textcolor4339">"</span></span>);
<br class="fancyvrb"><a id="x32-163147r73"></a>73              Command_install(p, url, config_opts, make_opts, install_opts);
<br class="fancyvrb"><a id="x32-163149r74"></a>74              <span id="textcolor4340">break</span>;<br class="fancyvrb"><a id="x32-163151r75"></a>75  <br class="fancyvrb"><a id="x32-163153r76"></a>76          <span id="textcolor4341">case</span> COMMAND_LIST:<br class="fancyvrb"><a id="x32-163155r77"></a>77              DB_list();
<br class="fancyvrb"><a id="x32-163157r78"></a>78              <span id="textcolor4342">break</span>;<br class="fancyvrb"><a id="x32-163159r79"></a>79  <br class="fancyvrb"><a id="x32-163161r80"></a>80          <span id="textcolor4343">case</span> COMMAND_FETCH:
<br class="fancyvrb"><a id="x32-163163r81"></a>81              check(url != <span id="textcolor4344">NULL</span>, <span class="colorbox" id="colorbox4345"><span id="textcolor4346">"</span></span><span class="colorbox" id="colorbox4347"><span id="textcolor4348">You must give a URL.</span></span><span class="colorbox" id="colorbox4349"><span id="textcolor4350">"</span></span>);
<br class="fancyvrb"><a id="x32-163165r82"></a>82              Command_fetch(p, url, <span id="textcolor4351">1</span>);
<br class="fancyvrb"><a id="x32-163167r83"></a>83              log_info(<span class="colorbox" id="colorbox4352"><span id="textcolor4353">"</span></span><span class="colorbox" id="colorbox4354"><span id="textcolor4355">Downloaded to %s and in /tmp/</span></span><span class="colorbox" id="colorbox4356"><span id="textcolor4357">"</span></span>, BUILD_DIR);
<br class="fancyvrb"><a id="x32-163169r84"></a>84              <span id="textcolor4358">break</span>;<br class="fancyvrb"><a id="x32-163171r85"></a>85  <br class="fancyvrb"><a id="x32-163173r86"></a>86          <span id="textcolor4359">case</span> COMMAND_BUILD:
<br class="fancyvrb"><a id="x32-163175r87"></a>87              check(url, <span class="colorbox" id="colorbox4360"><span id="textcolor4361">"</span></span><span class="colorbox" id="colorbox4362"><span id="textcolor4363">You must at least give a URL.</span></span><span class="colorbox" id="colorbox4364"><span id="textcolor4365">"</span></span>);
<br class="fancyvrb"><a id="x32-163177r88"></a>88              Command_build(p, url, config_opts, make_opts, install_opts);
<br class="fancyvrb"><a id="x32-163179r89"></a>89              <span id="textcolor4366">break</span>;<br class="fancyvrb"><a id="x32-163181r90"></a>90  <br class="fancyvrb"><a id="x32-163183r91"></a>91          <span id="textcolor4367">case</span> COMMAND_INIT:<br class="fancyvrb"><a id="x32-163185r92"></a>92              rv = DB_init();
<br class="fancyvrb"><a id="x32-163187r93"></a>93              check(rv == <span id="textcolor4368">0</span>, <span class="colorbox" id="colorbox4369"><span id="textcolor4370">"</span></span><span class="colorbox" id="colorbox4371"><span id="textcolor4372">Failed to make the database.</span></span><span class="colorbox" id="colorbox4373"><span id="textcolor4374">"</span></span>);<br class="fancyvrb"><a id="x32-163189r94"></a>94              <span id="textcolor4375">break</span>;
<br class="fancyvrb"><a id="x32-163191r95"></a>95  <br class="fancyvrb"><a id="x32-163193r96"></a>96          <span id="textcolor4376">default:</span><br class="fancyvrb"><a id="x32-163195r97"></a>97              sentinel(<span class="colorbox" id="colorbox4377"><span id="textcolor4378">"</span></span><span class="colorbox" id="colorbox4379"><span id="textcolor4380">Invalid command given.</span></span><span class="colorbox" id="colorbox4381"><span id="textcolor4382">"</span></span>);
                                                                  

                                                                  
<br class="fancyvrb"><a id="x32-163197r98"></a>98      }<br class="fancyvrb"><a id="x32-163199r99"></a>99  <br class="fancyvrb"><a id="x32-163201r100"></a>100  <br class="fancyvrb"><a id="x32-163203r101"></a>101      <span id="textcolor4383">return</span> <span id="textcolor4384">0</span>;<br class="fancyvrb"><a id="x32-163205r102"></a>102  <br class="fancyvrb"><a id="x32-163207r103"></a>103  <span id="textcolor4385">error:</span><br class="fancyvrb"><a id="x32-163209r104"></a>104      <span id="textcolor4386">return</span> <span id="textcolor4387">1</span>;<br class="fancyvrb"><a id="x32-163211r105"></a>105  }</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><h5 class="subsubsectionHead"><a id="x32-16400027.4.4"></a>挑战4: README 和测试文件</h5>
<!--l. 980--><p class="noindent">对于这个代码文件的挑战是弄懂参数是什么意思，以及它们是怎样被处理的。然后你需要创建一个 README 文件来说明该程序的用法。在你写 README 的同时再写一个简单的 test.sh，让它去运行./devpkg 以检查所有的命令是否都有效。在你的脚本最上方使用 <span class="obeylines-h"><span class="verb">set -e</span></span>，这样脚本就会在第一次发生错误的时候就停止执行。
<!--l. 985--></p><p class="indent">    最后，在 valgrind 下面运行程序，并确认一切工作正常。这也是期中考试前的最后一件事情。
<!--l. 987--></p><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">27.5    </span> <a id="x32-16500027.5"></a>测验</h3>
<!--l. 989--><p class="noindent">你的最后一项挑战就是期中考试了，你要完成三件事情：
<!--l. 991--></p><p class="indent">
     </p><ol class="enumerate1"><li class="enumerate" id="x32-165002x1">将你的代码和我放在网上的代码比较，以 100 分为基数，每一处写错的地方扣掉 1 分。
     </li>
     <li class="enumerate" id="x32-165004x2">将你记在 notes.txt 中的代码或者功能方面可以改进的地方通过修改程序去一一实现。
     </li>
     <li class="enumerate" id="x32-165006x3">用你喜欢或者熟悉的另外一门语言写个新版本的 devpkg，和 C 语言版的比较，然后通过你学到的东西去改进 C 语言版的 devpkg。</li></ol><!--l. 998--><p class="indent">    通过下面的方法比较你的代码和我的代码:
    <!--l. 1000-->
                                                                  

                                                                  
</p><div class="lstlisting" id="listing-45"><span class="label"><a id="x32-165007r1"></a>1</span>cd ..  # get one directory above your current one <br><span class="label"><a id="x32-165008r2"></a>2</span>git clone git://gitorious.org/devpkg/devpkg.git devpkgzed <br><span class="label"><a id="x32-165009r3"></a>3</span>diff -r devpkg devpkgzed
    </div>
<!--l. 1006--><p class="indent">    上面的命令实现的是将我写的的版本克隆（clone）到本地 devpkgzed 文件夹下，然后使用 diff 将其和你写的版本进行比较。本书中的代码直接来自于你刚克隆的这个项目，所以如果哪行和你的不一样，那就说明出错了。
<!--l. 1010--></p><p class="indent">    这次期中考试并没有及格不及格的说法，这样的练习方式是为了让你挑战自己，
让自己尽可能做到精确细致。
                                                                  

                                                                  
                                                                  

                                                                  
    <!--l. 53--></p><div class="crosslinks"><p class="noindent">[<a href="learn-c-the-hard-waypa2.html">next</a>] [<a href="learn-c-the-hard-waych26.html">prev</a>] [<a href="learn-c-the-hard-waych26.html#taillearn-c-the-hard-waych26.html">prev-tail</a>] [<a href="learn-c-the-hard-waych27.html">front</a>] [<a href="learn-c-the-hard-waypa1.html#learn-c-the-hard-waych27.html">up</a>] </p></div>
<!--l. 53--><p class="indent">    <a id="taillearn-c-the-hard-waych27.html"></a>   
</p></body></html>