<html><head><title>Exercise 16: Structs And Pointers To Them</title><meta content="text/html; charset=utf-8" http-equiv="Content-Type"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="generator"></meta><meta content="TeX4ht (http://www.cse.ohio-state.edu/~gurari/TeX4ht/)" name="originator"></meta><!-- index=1,2,next,fn-in,charset=utf-8,NoFonts,html --><meta content="learn-c-the-hard-way.tex" name="src"></meta><meta content="2012-04-11 10:56:00" name="date"></meta><link href="learn-c-the-hard-way.css" rel="stylesheet" type="text/css"></link></head><body>
    <!--l. 1--><div class="crosslinks"><p class="noindent">[<a>prev</a>] [<a href="#taillearn-c-the-hard-way">prev-tail</a>] [<a href="#tail">tail</a>] [<a href="# ">up</a>] </p></div>
    <h2 class="chapterHead"><span class="titlemark">Chapter 17</span><br><a id="x22-8200017"></a>Exercise 16: Structs And Pointers To Them</h2>
<!--l. 3--><p class="noindent">In this exercise you’ll learn how to make a struct, point a pointer at them, and use
them to make sense of internal memory structures. I’ll also apply the knowledge of
pointers from the last exercise and get you constructing these structures from raw
memory using malloc.
<!--l. 8--></p><p class="indent">    As usual, here’s the program we’ll talk about, so type it in and make it
work:
                                                                  

                                                                  
<!--l. 11--></p><p class="indent">    </p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<a id="x22-82001r41"></a>
 <div class="caption"><span class="id">Source 41: </span><span class="content">                                                                                                            ex16.c</span></div><!--tex4ht:label?: x22-82001r41 -->
<div class="fancyvrb" id="fancyvrb19"><a id="x22-82003r1"></a>1  <span id="textcolor1014">#</span><span id="textcolor1015">include <stdio.h></stdio.h></span><br class="fancyvrb"><a id="x22-82005r2"></a>2  <span id="textcolor1016">#</span><span id="textcolor1017">include <assert.h></assert.h></span><br class="fancyvrb"><a id="x22-82007r3"></a>3  <span id="textcolor1018">#</span><span id="textcolor1019">include <stdlib.h></stdlib.h></span><br class="fancyvrb"><a id="x22-82009r4"></a>4  <span id="textcolor1020">#</span><span id="textcolor1021">include <string.h></string.h></span>
<br class="fancyvrb"><a id="x22-82011r5"></a>5  <br class="fancyvrb"><a id="x22-82013r6"></a>6  <span id="textcolor1022">struct</span> Person {<br class="fancyvrb"><a id="x22-82015r7"></a>7      <span id="textcolor1023">char</span> ⋆name;<br class="fancyvrb"><a id="x22-82017r8"></a>8      <span id="textcolor1024">int</span> age;<br class="fancyvrb"><a id="x22-82019r9"></a>9      <span id="textcolor1025">int</span> height;<br class="fancyvrb"><a id="x22-82021r10"></a>10      <span id="textcolor1026">int</span> weight;
<br class="fancyvrb"><a id="x22-82023r11"></a>11  };<br class="fancyvrb"><a id="x22-82025r12"></a>12  <br class="fancyvrb"><a id="x22-82027r13"></a>13  <span id="textcolor1027">struct</span> Person ⋆<span id="textcolor1028">Person_create</span>(<span id="textcolor1029">char</span> ⋆name, <span id="textcolor1030">int</span> age, <span id="textcolor1031">int</span> height, <span id="textcolor1032">int</span> weight)
<br class="fancyvrb"><a id="x22-82029r14"></a>14  {<br class="fancyvrb"><a id="x22-82031r15"></a>15      <span id="textcolor1033">struct</span> Person ⋆who = malloc(<span id="textcolor1034">sizeof</span>(<span id="textcolor1035">struct</span> Person));
<br class="fancyvrb"><a id="x22-82033r16"></a>16      assert(who != <span id="textcolor1036">NULL</span>);<br class="fancyvrb"><a id="x22-82035r17"></a>17  <br class="fancyvrb"><a id="x22-82037r18"></a>18      who-&gt;name = strdup(name);<br class="fancyvrb"><a id="x22-82039r19"></a>19      who-&gt;age = age;
<br class="fancyvrb"><a id="x22-82041r20"></a>20      who-&gt;height = height;<br class="fancyvrb"><a id="x22-82043r21"></a>21      who-&gt;weight = weight;<br class="fancyvrb"><a id="x22-82045r22"></a>22  <br class="fancyvrb"><a id="x22-82047r23"></a>23      <span id="textcolor1037">return</span> who;<br class="fancyvrb"><a id="x22-82049r24"></a>24  }
<br class="fancyvrb"><a id="x22-82051r25"></a>25  <br class="fancyvrb"><a id="x22-82053r26"></a>26  <span id="textcolor1038">void</span> <span id="textcolor1039">Person_destroy</span>(<span id="textcolor1040">struct</span> Person ⋆who)<br class="fancyvrb"><a id="x22-82055r27"></a>27  {<br class="fancyvrb"><a id="x22-82057r28"></a>28      assert(who != <span id="textcolor1041">NULL</span>);<br class="fancyvrb"><a id="x22-82059r29"></a>29  
<br class="fancyvrb"><a id="x22-82061r30"></a>30      free(who-&gt;name);<br class="fancyvrb"><a id="x22-82063r31"></a>31      free(who);<br class="fancyvrb"><a id="x22-82065r32"></a>32  }<br class="fancyvrb"><a id="x22-82067r33"></a>33  <br class="fancyvrb"><a id="x22-82069r34"></a>34  <span id="textcolor1042">void</span> <span id="textcolor1043">Person_print</span>(<span id="textcolor1044">struct</span> Person ⋆who)
<br class="fancyvrb"><a id="x22-82071r35"></a>35  {<br class="fancyvrb"><a id="x22-82073r36"></a>36      printf(<span class="colorbox" id="colorbox1045"><span id="textcolor1046">"</span></span><span class="colorbox" id="colorbox1047"><span id="textcolor1048">Name: %s</span></span><span class="colorbox" id="colorbox1049"><span id="textcolor1050">\n</span></span><span class="colorbox" id="colorbox1051"><span id="textcolor1052">"</span></span>, who-&gt;name);<br class="fancyvrb"><a id="x22-82075r37"></a>37      printf(<span class="colorbox" id="colorbox1053"><span id="textcolor1054">"</span></span><span class="colorbox" id="colorbox1055"><span id="textcolor1056">\t</span></span><span class="colorbox" id="colorbox1057"><span id="textcolor1058">Age: %d</span></span><span class="colorbox" id="colorbox1059"><span id="textcolor1060">\n</span></span><span class="colorbox" id="colorbox1061"><span id="textcolor1062">"</span></span>, who-&gt;age);
<br class="fancyvrb"><a id="x22-82077r38"></a>38      printf(<span class="colorbox" id="colorbox1063"><span id="textcolor1064">"</span></span><span class="colorbox" id="colorbox1065"><span id="textcolor1066">\t</span></span><span class="colorbox" id="colorbox1067"><span id="textcolor1068">Height: %d</span></span><span class="colorbox" id="colorbox1069"><span id="textcolor1070">\n</span></span><span class="colorbox" id="colorbox1071"><span id="textcolor1072">"</span></span>, who-&gt;height);<br class="fancyvrb"><a id="x22-82079r39"></a>39      printf(<span class="colorbox" id="colorbox1073"><span id="textcolor1074">"</span></span><span class="colorbox" id="colorbox1075"><span id="textcolor1076">\t</span></span><span class="colorbox" id="colorbox1077"><span id="textcolor1078">Weight: %d</span></span><span class="colorbox" id="colorbox1079"><span id="textcolor1080">\n</span></span><span class="colorbox" id="colorbox1081"><span id="textcolor1082">"</span></span>, who-&gt;weight);
<br class="fancyvrb"><a id="x22-82081r40"></a>40  }<br class="fancyvrb"><a id="x22-82083r41"></a>41  <br class="fancyvrb"><a id="x22-82085r42"></a>42  <span id="textcolor1083">int</span> <span id="textcolor1084">main</span>(<span id="textcolor1085">int</span> argc, <span id="textcolor1086">char</span> ⋆argv[])<br class="fancyvrb"><a id="x22-82087r43"></a>43  {<br class="fancyvrb"><a id="x22-82089r44"></a>44      <span id="textcolor1087">// make two people structures</span>
<br class="fancyvrb"><a id="x22-82091r45"></a>45      <span id="textcolor1088">struct</span> Person ⋆joe = Person_create(<br class="fancyvrb"><a id="x22-82093r46"></a>46              <span class="colorbox" id="colorbox1089"><span id="textcolor1090">"</span></span><span class="colorbox" id="colorbox1091"><span id="textcolor1092">Joe Alex</span></span><span class="colorbox" id="colorbox1093"><span id="textcolor1094">"</span></span>, <span id="textcolor1095">32</span>, <span id="textcolor1096">64</span>, <span id="textcolor1097">140</span>);<br class="fancyvrb"><a id="x22-82095r47"></a>47  
<br class="fancyvrb"><a id="x22-82097r48"></a>48      <span id="textcolor1098">struct</span> Person ⋆frank = Person_create(<br class="fancyvrb"><a id="x22-82099r49"></a>49              <span class="colorbox" id="colorbox1099"><span id="textcolor1100">"</span></span><span class="colorbox" id="colorbox1101"><span id="textcolor1102">Frank Blank</span></span><span class="colorbox" id="colorbox1103"><span id="textcolor1104">"</span></span>, <span id="textcolor1105">20</span>, <span id="textcolor1106">72</span>, <span id="textcolor1107">180</span>);
<br class="fancyvrb"><a id="x22-82101r50"></a>50  <br class="fancyvrb"><a id="x22-82103r51"></a>51      <span id="textcolor1108">// print them out and where they are in memory</span>
<br class="fancyvrb"><a id="x22-82105r52"></a>52      printf(<span class="colorbox" id="colorbox1109"><span id="textcolor1110">"</span></span><span class="colorbox" id="colorbox1111"><span id="textcolor1112">Joe is at memory location %p:</span></span><span class="colorbox" id="colorbox1113"><span id="textcolor1114">\n</span></span><span class="colorbox" id="colorbox1115"><span id="textcolor1116">"</span></span>, joe);<br class="fancyvrb"><a id="x22-82107r53"></a>53      Person_print(joe);<br class="fancyvrb"><a id="x22-82109r54"></a>54  
<br class="fancyvrb"><a id="x22-82111r55"></a>55      printf(<span class="colorbox" id="colorbox1117"><span id="textcolor1118">"</span></span><span class="colorbox" id="colorbox1119"><span id="textcolor1120">Frank is at memory location %p:</span></span><span class="colorbox" id="colorbox1121"><span id="textcolor1122">\n</span></span><span class="colorbox" id="colorbox1123"><span id="textcolor1124">"</span></span>, frank);<br class="fancyvrb"><a id="x22-82113r56"></a>56      Person_print(frank);
<br class="fancyvrb"><a id="x22-82115r57"></a>57  <br class="fancyvrb"><a id="x22-82117r58"></a>58      <span id="textcolor1125">// make everyone age 20 years and print them again</span>
<br class="fancyvrb"><a id="x22-82119r59"></a>59      joe-&gt;age += <span id="textcolor1126">20</span>;<br class="fancyvrb"><a id="x22-82121r60"></a>60      joe-&gt;height -= <span id="textcolor1127">2</span>;<br class="fancyvrb"><a id="x22-82123r61"></a>61      joe-&gt;weight += <span id="textcolor1128">40</span>;
<br class="fancyvrb"><a id="x22-82125r62"></a>62      Person_print(joe);<br class="fancyvrb"><a id="x22-82127r63"></a>63  <br class="fancyvrb"><a id="x22-82129r64"></a>64      frank-&gt;age += <span id="textcolor1129">20</span>;<br class="fancyvrb"><a id="x22-82131r65"></a>65      frank-&gt;weight += <span id="textcolor1130">20</span>;
<br class="fancyvrb"><a id="x22-82133r66"></a>66      Person_print(frank);<br class="fancyvrb"><a id="x22-82135r67"></a>67  <br class="fancyvrb"><a id="x22-82137r68"></a>68      <span id="textcolor1131">// destroy them both so we clean up</span>
<br class="fancyvrb"><a id="x22-82139r69"></a>69      Person_destroy(joe);<br class="fancyvrb"><a id="x22-82141r70"></a>70      Person_destroy(frank);<br class="fancyvrb"><a id="x22-82143r71"></a>71  <br class="fancyvrb"><a id="x22-82145r72"></a>72      <span id="textcolor1132">return</span> <span id="textcolor1133">0</span>;<br class="fancyvrb"><a id="x22-82147r73"></a>73  }</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><!--l. 90--><p class="indent">    To describe this program, I’m going to use a different approach than before. I’m
not going to give you a line-by-line breakdown of the program, but I’m going
to make you write it. I’m going to give you a guide through the program
based on the parts it contains, and your job is to write out what each line
does.
     </p><dl class="description"><dt class="description">
includes </dt><dd class="description">I  include  some  new  header  files  here  to  gain  access  to  some  new
     functions. What does each give you?
     </dd><dt class="description">
struct Person </dt><dd class="description">This  is  where  I’m  creating  a  structure  that  has  4  elements  to
     describe a person. The final result is a new compound type that lets me
     reference these elements all as one, or each piece by name. It’s similar to
     a row of a database table or a class in an OOP language.
     </dd><dt class="description">
function Person_create </dt><dd class="description">I need a way to create these structures so I’ve made a
     function to do that. Here’s the important things this function is doing:
         <ol class="enumerate1"><li class="enumerate" id="x22-82149x1">I use malloc for ”memory allocate” to ask the OS to give me a piece
         of raw memory.
         </li>
         <li class="enumerate" id="x22-82151x2">I pass to malloc the <span class="obeylines-h"><span class="verb">sizeof(struct Person)</span></span> which calculates
         the total size of the struct, given all the fields inside it.
         </li>
         <li class="enumerate" id="x22-82153x3">I use assert to make sure that I have a valid piece of memory back
         from malloc. There’s a special constant called NULL that you use to
         mean ”unset or invalid pointer”. This assert is basically checking
         that malloc didn’t return a NULL invalid pointer.
         </li>
         <li class="enumerate" id="x22-82155x4">I initialize each field of struct Person using the <span class="obeylines-h"><span class="verb">x-&gt;y</span></span> syntax, to
         say what part of the struct I want to set.
                                                                  

                                                                  
         </li>
         <li class="enumerate" id="x22-82157x5">I use the strdup function to duplicate the string for the name, just to
         make sure that this structure actually owns it. The strdup actually
         is like malloc and it also copies the original string into the memory
         it creates.</li></ol></dd><dt class="description">
function Person_destroy </dt><dd class="description">If I have a create, then I always need a destroy function,
     and this is what destroys Person structs. I again use assert to make sure I’m
     not getting bad input. Then I use the function free to return the memory I got
     with malloc and strdup. If you don’t do this you get a ”memory
     leak”.
     </dd><dt class="description">
function Person_print </dt><dd class="description">I then need a way to print out people, which is all this
     function does. It uses the same <span class="obeylines-h"><span class="verb">x-&gt;y</span></span> syntax to get the field from the struct to
     print it.
     </dd><dt class="description">
function main </dt><dd class="description">In the main function I use all the previous functions and the struct
     Person to do the following:
         <ol class="enumerate1"><li class="enumerate" id="x22-82159x1">Create two people, joe and frank.
         </li>
         <li class="enumerate" id="x22-82161x2">Print them out, but notice I’m using the <span class="obeylines-h"><span class="verb">%p</span></span> format so you can see
         where the program has actually put your struct in memory.
         </li>
         <li class="enumerate" id="x22-82163x3">Age both of them by 20 years, with changes to their body too.
         </li>
         <li class="enumerate" id="x22-82165x4">Print each one after aging them.
         </li>
         <li class="enumerate" id="x22-82167x5">Finally destroy the structures so we can clean up correctly.</li></ol></dd></dl><!--l. 149--><p class="indent">    Go through this description carefully, and do the following:
     </p><ol class="enumerate1"><li class="enumerate" id="x22-82169x1">Look
     up every function and header file you don’t know about. Remember that
     you can usually do <span class="obeylines-h"><span class="verb">man 2 function</span></span> or <span class="obeylines-h"><span class="verb">man 3 function</span></span> and it’ll tell
     you about it. You can also search online for the information.
     </li>
     <li class="enumerate" id="x22-82171x2">Write a comment above each and every single line saying what the line
     does in English.
     </li>
     <li class="enumerate" id="x22-82173x3">Trace  through  each  function  call  and  variable  so  you  know  where  it
     comes from in the program.
     </li>
     <li class="enumerate" id="x22-82175x4">Look up any symbols you don’t know as well.</li></ol><h3 class="sectionHead"><span class="titlemark">17.1    </span> <a id="x22-8300017.1"></a>What You Should See</h3>
<!--l. 166--><p class="noindent">After you augment the program with your description comments, make sure it really
runs and produces this output:
                                                                  

                                                                  
<!--l. 169--></p><p class="indent">    </p><hr class="float"></hr><div class="float">
                                                                  

                                                                  
<a id="x22-83001r42"></a>
 <div class="caption"><span class="id">Source 42: </span><span class="content">                                                                                                               ex16
output</span></div><!--tex4ht:label?: x22-83001r42 -->
<!--l. 170-->
<div class="lstlisting" id="listing-27"><span class="label"><a id="x22-83002r1"></a>1</span>$ make ex16 <br><span class="label"><a id="x22-83003r2"></a>2</span>cc -Wall -g    ex16.c   -o ex16 <br><span class="label"><a id="x22-83004r3"></a>3</span> <br><span class="label"><a id="x22-83005r4"></a>4</span>$ ./ex16 <br><span class="label"><a id="x22-83006r5"></a>5</span>Joe is at memory location 0xeba010: <br><span class="label"><a id="x22-83007r6"></a>6</span>Name: Joe Alex <br><span class="label"><a id="x22-83008r7"></a>7</span>        Age: 32 <br><span class="label"><a id="x22-83009r8"></a>8</span>        Height: 64 <br><span class="label"><a id="x22-83010r9"></a>9</span>        Weight: 140 <br><span class="label"><a id="x22-83011r10"></a>10</span>Frank is at memory location 0xeba050: <br><span class="label"><a id="x22-83012r11"></a>11</span>Name: Frank Blank <br><span class="label"><a id="x22-83013r12"></a>12</span>        Age: 20 <br><span class="label"><a id="x22-83014r13"></a>13</span>        Height: 72 <br><span class="label"><a id="x22-83015r14"></a>14</span>        Weight: 180 <br><span class="label"><a id="x22-83016r15"></a>15</span>Name: Joe Alex <br><span class="label"><a id="x22-83017r16"></a>16</span>        Age: 52 <br><span class="label"><a id="x22-83018r17"></a>17</span>        Height: 62 <br><span class="label"><a id="x22-83019r18"></a>18</span>        Weight: 180 <br><span class="label"><a id="x22-83020r19"></a>19</span>Name: Frank Blank <br><span class="label"><a id="x22-83021r20"></a>20</span>        Age: 40 <br><span class="label"><a id="x22-83022r21"></a>21</span>        Height: 72 <br><span class="label"><a id="x22-83023r22"></a>22</span>        Weight: 200
</div>
                                                                  

                                                                  
    </div><hr class="endfloat"></hr><h3 class="sectionHead"><span class="titlemark">17.2    </span> <a id="x22-8400017.2"></a>Explaining Structures</h3>
<!--l. 199--><p class="noindent">If you’ve done the work I asked you then structures should be making sense, but let
me explain them explicitly just to make sure you’ve understood it.
<!--l. 203--></p><p class="indent">    A structure in C is a collection of other data types (variables) that are stored in
one block of memory but let you access each variable independently by name. They
are similar to a record in a database table, or a very simplistic class in an object
oriented language. We can break one down this way:
<!--l. 209--></p><p class="indent">
     </p><ol class="enumerate1"><li class="enumerate" id="x22-84002x1">In the above code, you make a struct that has the fields you’d expect
     for a person: name, age, weight, height.
     </li>
     <li class="enumerate" id="x22-84004x2">Each of those fields has a type, like int.
     </li>
     <li class="enumerate" id="x22-84006x3">C then packs those together so they can all be contained in one single
     struct.
     </li>
     <li class="enumerate" id="x22-84008x4">The  struct Person is  now  a  compound  data  type,  which  means  you
     can now refer to struct Person in the same kinds of expressions you
     would other data types.
     </li>
     <li class="enumerate" id="x22-84010x5">This lets you pass the whole cohesive grouping to other functions, as you
     did with Person_print.
     </li>
     <li class="enumerate" id="x22-84012x6">You  can  then  access  the  individual  parts  of  a  struct by  their  names
     using <span class="obeylines-h"><span class="verb">x-&gt;y</span></span> if you’re dealing with a pointer.
                                                                  

                                                                  
     </li>
     <li class="enumerate" id="x22-84014x7">There’s also a way to make a struct that doesn’t need a pointer, and you
     use the <span class="obeylines-h"><span class="verb">x.y</span></span> (period) syntax to work with it. You’ll do this in the Extra
     Credit.</li></ol><!--l. 228--><p class="indent">    If you didn’t have struct you’d need to figure out the size, packing, and
location of pieces of memory with contents like this. In fact, in most early assembler
code (and even some now) this is what you do. With C you can let C handle the
memory structuring of these compound data types and then focus on what you do
with them.
<!--l. 236--></p><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">17.3    </span> <a id="x22-8500017.3"></a>How To Break It</h3>
<!--l. 238--><p class="noindent">With this program the ways to break it involve how you use the pointers and the
malloc system:
<!--l. 241--></p><p class="indent">
     </p><ol class="enumerate1"><li class="enumerate" id="x22-85002x1">Try passing NULL to Person_destroy to see what it does. If it doesn’t
     abort then you must not have the -g option in your Makefile’s CFLAGS.
     </li>
     <li class="enumerate" id="x22-85004x2">Forget to call Person_destroy at the end, then run it under Valgrind
     to see it report that you forgot to free the memory. Figure out the options
     you  need  to  pass  to  Valgrind to  get  it  to  print  how  you  leaked  this
     memory.
     </li>
     <li class="enumerate" id="x22-85006x3">Forget to free who-&gt;name in Person_destroy and compare the output.
     Again, use the right options to see how Valgrind tells you exactly where
     you messed up.
     </li>
     <li class="enumerate" id="x22-85008x4">This time, pass NULL to Person_print and see what Valgrind thinks
                                                                  

                                                                  
     of that.
     </li>
     <li class="enumerate" id="x22-85010x5">You  should  be  figuring  out  that  NULL is  a  quick  way  to  crash  your
     program.</li></ol><!--l. 260--><p class="noindent">
    </p><h3 class="sectionHead"><span class="titlemark">17.4    </span> <a id="x22-8600017.4"></a>Extra Credit</h3>
<!--l. 262--><p class="noindent">In this exercise I want you to attempt something difficult for the extra credit: Convert
this program to not use pointers and malloc. This will be hard, so you’ll want to
research the following:
<!--l. 267--></p><p class="indent">
     </p><ol class="enumerate1"><li class="enumerate" id="x22-86002x1">How to create a struct on the stack, which means just like you’ve been
     making any other variable.
     </li>
     <li class="enumerate" id="x22-86004x2">How to initialize it using the <span class="obeylines-h"><span class="verb">x.y</span></span> (period) character instead of the <span class="obeylines-h"><span class="verb">x-&gt;y</span></span>
     syntax.
     </li>
     <li class="enumerate" id="x22-86006x3">How to pass a structure to other functions without using a pointer.</li></ol><!--l. 1--><div class="crosslinks"><p class="noindent">[<a>prev</a>] [<a href="#taillearn-c-the-hard-way">prev-tail</a>] [<a>front</a>] [<a href="# ">up</a>] </p></div>
<!--l. 1--><p class="indent">    <a id="tail"></a>   
</p></body></html>