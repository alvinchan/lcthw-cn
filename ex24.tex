\chapter{Exercise 24: Input, Output, Files}
\chapter{Exercise 24: 输入, 输出, 文件}

你已经用 \ident{printf} 来打印了, 这已经很棒了。但是你肯定想做的更多一些。 
在这一节，你将会用 \func{fscanf} 和 \func{fgets} 来构建一个包含某人信息的结构体。
在简单介绍过如何获得输入之后，你将会看到一个c语言拥有的处理IO的完整的函数列表。
你应该已经见过而且用过其中的一部分函数，所以这会是另一个唤醒记忆的练习。

\begin{code}{ex24.c}
<< d['code/ex24.c|pyg|l'] >>
\end{code}

这个程序表面看似简单，其实不然。这里面用到了一个函数 \func{fscanf}，它是用来做文件扫描 "file scanf"。
 \func{scanf} 相关的一系列函数与 \func{printf} 一系列函数作用正相反。 
 \func{printf} 按着指定格式输出数据, \func{scanf} 按着格式读取（或者扫描输入）。

原本文件的开头什么也没有，所以函数 \func{main} 做了如下一些事情：

\begin{description}
\item[ex24.c:24-28] 创建一些必须的变量。
\item[ex24.c:30-32] 用\func{fgets} 获取姓名中的名字, 这个函数从输入获取一个字符串
    (这里是从 \ident{stdin}) 输入名字的时候要小心，不要把存储名字的缓冲区搞溢出。
\item[ex24.c:34-36] 同样的在获取\ident{you.last\_name}的时候, 依然用 \func{fgets}。
\item[ex24.c:38-39] 用\func{fscanf} 从\func{stdin} 获取一个整数，而且这个整数存储在
    \ident{you.age}.  你可以看到在用\ident{printf} 打印整数的时候使用了同样的格式。
    你也看到为了让 \ident{fscanf} 可以把输入存储在某个指针变量指定的位置上，你必须提供把\emph{address} 的地址取出来作为指针变量的值。 
通过这个例子展示了如何把一串数据的内存地址作为输出参数。
\item[ex24.c:41-45] 通过遍历 \ident{EyeColor} 的枚举数值，来输出眼睛颜色的所有可能条件。
\item[ex24.c:47-50] 还是用 \func{fscanf} ，为\ident{you.eyes}获得一个数值， 
    同时确保这个数值是有效的。 这很重要，因为有的人会输入一个不在\ident{EYE\_COLOR\_NAMES}数组范围之外的数字从而导致一个segfault。
\item[ex24.c:52-53] 知道你挣了多少\ident{float} 收入知道你的到了多少收入 \ident{you.income}。
\item[ex24.c:55-61] 通过打印所有的东西来确认一下东西是对的。注意 \ident{EYE\_COLOR\_NAMES} 用来打印真正的\ident{EyeColor} 的内容。
\end{description}


\section{你将看到}

当你运行这个程序的时候，你会看到你的输入被适当的转换了。
试试给一些奇怪的输入来检查一下代码是不是能够有效的处理这种情况。

\begin{code}{ex24 output}
\begin{lstlisting}
<< d['code/ex24.out|dexy'] >>
\end{lstlisting}
\end{code}


\section{How To Break It}

This is all fine and good, but the real important part of this exercise is
how \func{scanf} actually sucks.  It's fine for simple conversion of numbers,
but fails for strings because it's difficult to tell \func{scanf} how big a buffer
is before you read.  There's also a problem with a function like \func{gets}
(not \func{fgets}, the non-f version) which we avoided.  That function has
no idea how big the input buffer is at all and will just trash your program.

To demonstrate the problems with \func{fscanf} and strings, change the lines
that use \func{fgets} so they are \verb|fscanf(stdin, "%50s", you.first_name)|
and then try to use it again.  Notice it seems to read too much and then 
eat your enter key?  This doesn't do what you think it does, and really
rather than deal with weird \func{scanf} issues, just use \func{fgets}.

Next, change the \func{fgets} to use \func{gets}, then bust out your
\program{valgrind} and do this:  \verb|valgrind ./ex24 < /dev/urandom|
to feed random garbage into your program.  This is called "fuzzing"
your program, and it is a good way to find input bugs.  In this case,
you're feeding garbage from the \file{/dev/urandom} file, and then watching
it crash.  On some platforms you may have to do this a few times, or even
adjust the \ident{MAX\_DATA} define so it's small enough.

The \func{gets} function is so bad that some platforms actually warn you
when the \emph{program} runs that you're using \func{gets}.  You should
never use this function, ever.

Finally, take the input for \ident{you.eyes} and remove the check that the
number given is within the right range.  Then feed it bad numbers like -1 or
1000.  Do this under Valgrind too so you can see what happens.

\section{The I/O Functions}

This is a short list of various I/O functions that you should look up and
create index cards that have the function name, what it does, and all the
variants similar to it.

\begin{enumerate}
\item fscanf
\item fgets
\item fopen
\item freopen
\item fdopen
\item fclose
\item fcloseall
\item fgetpos
\item fseek
\item ftell
\item rewind
\item fprintf
\item fwrite
\item fread
\end{enumerate}

Go through these and memorize the different variants and what they do.  For example,
for the card on \func{fscanf} you'll have \func{scanf}, \func{sscanf}, \func{vscanf},
etc. and then what each of those do on the back.

Finally, to get the information you need for these cards, use \program{man} to
read the help for it.  For example, the page for \func{fscanf} comes from 
\verb|man fscanf|.


\section{Extra Credit}

\begin{enumerate}
\item Rewrite this to not use \func{fscanf} at all.  You'll need to use
    functions like \func{atoi} to convert the input strings to numbers.
\item Change this to use plain \func{scanf} instead of \func{fscanf} to
    see what the difference is.
\item Fix it so that the input names get stripped of the trailing newline
    characters and any whitespace.
\item Use \ident{scanf} to write a function that reads a character at a time
    and files in the names but doesn't go past the end.  Make this function
    generic so it can take a size for the string, and make sure you end
    the string with \verb|'\0'| no matter what.
\end{enumerate}

